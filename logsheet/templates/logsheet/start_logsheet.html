{% extends "base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{% load static %}{% static 'css/logsheet.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Page Header -->
  <div class="row mb-4">
    <div class="col-12">
      <h1 class="display-6 fw-bold text-primary mb-1">
        <i class="bi bi-journal-plus me-2"></i>Create New Logsheet
      </h1>
      <p class="text-muted mb-0">Start a new flight operations logsheet with pre-populated duty crew information</p>
    </div>
  </div>

  <!-- Action Section -->
  <div class="row mb-4">
    <div class="col-12 text-center">
      <button type="button" class="btn btn-primary btn-lg btn-modern" data-bs-toggle="modal" data-bs-target="#createLogsheetModal">
        <i class="bi bi-plus-circle me-2"></i>Create New Logsheet
      </button>
    </div>
  </div>

{% if message %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
  {{ message }}
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}

{% if form.non_field_errors %}
  <div class="alert alert-danger">
    {{ form.non_field_errors }}
  </div>
{% endif %}

{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  {% endfor %}
{% endif %}

  <!-- Create Logsheet Modal -->
  <div class="modal fade" id="createLogsheetModal" tabindex="-1" aria-labelledby="createLogsheetModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
      <div class="modal-content logsheet-modal">
        <form method="POST">
          {% csrf_token %}

          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="createLogsheetModalLabel">
              <i class="bi bi-journal-plus me-2"></i>Create New Logsheet
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            {% if form.non_field_errors %}
              <div class="alert alert-danger">
                {{ form.non_field_errors }}
              </div>
            {% endif %}

            <!-- Basic Information Section -->
            <div class="section-header mb-3">
              <h6 class="fw-bold text-primary mb-3">
                <i class="bi bi-info-circle me-2"></i>Basic Information
              </h6>
            </div>

            <div class="row g-3 mb-4">
              <div class="col-md-6">
                <label for="{{ form.log_date.id_for_label }}" class="form-label fw-semibold">
                  <i class="bi bi-calendar3 me-1 text-primary"></i>{{ form.log_date.label }}
                </label>
                {{ form.log_date }}
                {% if form.log_date.errors %}
                  <div class="text-danger small mt-1">{{ form.log_date.errors }}</div>
                {% endif %}
              </div>
              <div class="col-md-6">
                <label for="{{ form.airfield.id_for_label }}" class="form-label fw-semibold">
                  <i class="bi bi-geo-alt me-1 text-primary"></i>{{ form.airfield.label }}
                </label>
                {{ form.airfield }}
                {% if form.airfield.errors %}
                  <div class="text-danger small mt-1">{{ form.airfield.errors }}</div>
                {% endif %}
              </div>
            </div>

            <!-- Duty Crew Section -->
            <div class="section-header mb-3">
              <h6 class="fw-bold text-primary mb-3">
                <i class="bi bi-people me-2"></i>Duty Crew Assignment
                <small class="text-muted fw-normal">(Auto-populated from duty roster)</small>
              </h6>
            </div>

            <div class="row g-3 mb-4">
              <div class="col-md-6">
                <label for="{{ form.duty_officer.id_for_label }}" class="form-label fw-semibold">
                  <i class="bi bi-person-badge me-1 text-primary"></i>{{ form.duty_officer.label }}
                </label>
                {{ form.duty_officer }}
                {% if form.duty_officer.errors %}
                  <div class="text-danger small mt-1">{{ form.duty_officer.errors }}</div>
                {% endif %}
              </div>
              <div class="col-md-6">
                <label for="{{ form.assistant_duty_officer.id_for_label }}" class="form-label fw-semibold">
                  <i class="bi bi-person-plus me-1 text-primary"></i>{{ form.assistant_duty_officer.label }}
                </label>
                {{ form.assistant_duty_officer }}
                {% if form.assistant_duty_officer.errors %}
                  <div class="text-danger small mt-1">{{ form.assistant_duty_officer.errors }}</div>
                {% endif %}
              </div>
            </div>

            <div class="row g-3 mb-4">
              <div class="col-md-6">
                <label for="{{ form.duty_instructor.id_for_label }}" class="form-label fw-semibold">
                  <i class="bi bi-mortarboard me-1 text-primary"></i>{{ form.duty_instructor.label }}
                </label>
                {{ form.duty_instructor }}
                {% if form.duty_instructor.errors %}
                  <div class="text-danger small mt-1">{{ form.duty_instructor.errors }}</div>
                {% endif %}
              </div>
              <div class="col-md-6">
                <label for="{{ form.surge_instructor.id_for_label }}" class="form-label fw-semibold">
                  <i class="bi bi-person-lines-fill me-1 text-primary"></i>{{ form.surge_instructor.label }}
                </label>
                {{ form.surge_instructor }}
                {% if form.surge_instructor.errors %}
                  <div class="text-danger small mt-1">{{ form.surge_instructor.errors }}</div>
                {% endif %}
              </div>
            </div>

            <div class="row g-3 mb-4">
              <div class="col-md-6">
                <label for="{{ form.tow_pilot.id_for_label }}" class="form-label fw-semibold">
                  <i class="bi bi-airplane me-1 text-primary"></i>{{ form.tow_pilot.label }}
                </label>
                {{ form.tow_pilot }}
                {% if form.tow_pilot.errors %}
                  <div class="text-danger small mt-1">{{ form.tow_pilot.errors }}</div>
                {% endif %}
              </div>
              <div class="col-md-6">
                <label for="{{ form.surge_tow_pilot.id_for_label }}" class="form-label fw-semibold">
                  <i class="bi bi-airplane-engines me-1 text-primary"></i>{{ form.surge_tow_pilot.label }}
                </label>
                {{ form.surge_tow_pilot }}
                {% if form.surge_tow_pilot.errors %}
                  <div class="text-danger small mt-1">{{ form.surge_tow_pilot.errors }}</div>
                {% endif %}
              </div>
            </div>

            <!-- Equipment Section -->
            <div class="section-header mb-3">
              <h6 class="fw-bold text-primary mb-3">
                <i class="bi bi-tools me-2"></i>Default Equipment
              </h6>
            </div>

            <div class="row g-3">
              <div class="col-md-6">
                <label for="{{ form.default_towplane.id_for_label }}" class="form-label fw-semibold">
                  <i class="bi bi-airplane me-1 text-primary"></i>{{ form.default_towplane.label }}
                </label>
                {{ form.default_towplane }}
                {% if form.default_towplane.errors %}
                  <div class="text-danger small mt-1">{{ form.default_towplane.errors }}</div>
                {% endif %}
              </div>
            </div>

            <!-- Warnings Display -->
            {% if form.warnings %}
              <div class="alert alert-warning mt-4">
                <h6 class="alert-heading">
                  <i class="bi bi-exclamation-triangle me-2"></i>Please Review
                </h6>
                {% for warning in form.warnings %}
                  <p class="mb-0">{{ warning }}</p>
                {% endfor %}
              </div>
            {% endif %}
          </div>

          <div class="modal-footer bg-light">
            <button type="submit" class="btn btn-success btn-modern">
              <i class="bi bi-check-circle me-2"></i>Start Logsheet
            </button>
            <button type="button" class="btn btn-outline-secondary btn-modern" data-bs-dismiss="modal">
              <i class="bi bi-x-circle me-2"></i>Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

</div>

<footer class="mt-5" style="font-size: 0.8em; color: gray;">
  Template: <code>logsheet/start_logsheet.html</code>
</footer>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  var dateInput = document.getElementById('id_log_date');
  if (dateInput) {
    // Auto-populate on page load if there's a date value
    if (dateInput.value) {
      console.log('Page loaded with date:', dateInput.value, '- fetching duty assignment');
      fetchDutyAssignment(dateInput.value);
    }

    // Auto-populate when date changes
    dateInput.addEventListener('change', function() {
      var dateVal = this.value;
      if (!dateVal) return;
      console.log('Date changed to:', dateVal, '- fetching duty assignment');
      fetchDutyAssignment(dateVal);
    });
  }

  function fetchDutyAssignment(dateVal) {
    fetch('/logsheet/api/duty-assignment/?date=' + encodeURIComponent(dateVal), {
      credentials: 'same-origin',
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    })
    .then(response => {
      if (!response.ok) {
        console.error('API request failed:', response.status, response.statusText);
        return {};
      }
      return response.json();
    })
    .then(data => {
      console.log('Duty assignment data received:', data);
      var fields = [
        'duty_officer', 'assistant_duty_officer', 'duty_instructor',
        'surge_instructor', 'tow_pilot', 'surge_tow_pilot'
      ];
      fields.forEach(function(field) {
        var select = document.getElementById('id_' + field);
        if (select && data[field]) {
          console.log('Setting', field, 'to', data[field]);
          select.value = data[field];
        }
      });
    })
    .catch(error => {
      console.error('Error fetching duty assignment:', error);
    });
  }

  // Validate default towplane before submitting the form
  var createForm = document.querySelector('form');
  if (createForm) {
    createForm.addEventListener('submit', function(e) {
      var towplane = document.getElementById('id_default_towplane');
      if (towplane && (!towplane.value || towplane.value === '')) {
        e.preventDefault();
        alert('Please select a default towplane before creating the logsheet.');
        towplane.focus();
      }
    });
  }
});
</script>
{% endblock %}

{% endblock %}

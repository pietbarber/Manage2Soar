{% extends "base.html" %}

{% block content %}
{% load member_extras %}
<h1>View / Manage Logsheet</h1>
{% if messages %}
  <div class="container mt-3">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  </div>
{% endif %}

<div class="d-flex justify-content-start mb-3 gap-2">
  {% if previous_logsheet %}
    <a href="{% url 'logsheet:manage' previous_logsheet.id %}" class="btn btn-outline-secondary">
      ‚Üê Show Previous ({{ previous_logsheet.log_date }})
    </a>
  {% else %}
    <span></span>
  {% endif %}

  <a href="{% url 'logsheet:index' %}" class="btn btn-outline-primary">
    üìã Return to Logsheet List
  </a>

  {% if next_logsheet %}
    <a href="{% url 'logsheet:manage' next_logsheet.id %}" class="btn btn-outline-secondary">
      Show Next ({{ next_logsheet.log_date }}) ‚Üí
    </a>
  {% endif %}
</div>


<div class="container-fluid">
  <div class="card mb-3" style="max-width: 800px;">
    <div class="card-body">
    <h5 class="card-title" id="logsheetContainer" data-logsheet-date="{{ logsheet.log_date|date:'Y-m-d' }}">Logsheet for {{ logsheet.log_date }}</h5>
    <p class="card-text">Airfield: {{ logsheet.airfield }}</p>
    <p class="card-text"><small class="text-muted">Created by {{ logsheet.created_by }} on {{ logsheet.created_at }}</small></p>
    {% if logsheet.revisions.exists %}
    <details class="mb-3">
      <summary>Revision History</summary>
      <ul class="mb-0">
        {% for rev in logsheet.revisions.all %}
          <li>
            {{ rev.revised_at|date:"Y-m-d H:i" }} ‚Äî {{ rev.note }}{% if rev.revised_by %} by {{ rev.revised_by|full_display_name }}{% endif %}
          </li>
        {% empty %}
          <li>No revisions logged.</li>
        {% endfor %}
      </ul>
    </details>

    {% endif %}
  </div>
<!-- Three buttons for Duty Officer to manage logsheet-->
<div class="d-flex flex-wrap gap-2 mb-3">
  <a href="{% url 'logsheet:manage_logsheet_finances' pk=logsheet.pk %}" class="btn {% if logsheet.finalized %}btn-outline-success{% else %}btn-success{% endif %} me-2 mb-3">
    üìä {% if logsheet.finalized %}View Finances{% else %}Edit Finances{% endif %}
  </a>

  {% if logsheet.finalized %}
    <a href="{% url 'logsheet:view_logsheet_closeout' pk=logsheet.pk %}" class="btn btn-outline-warning me-2 mb-3">
      üìù View Closeout
    </a>
  {% else %}
    <a href="{% url 'logsheet:edit_logsheet_closeout' pk=logsheet.pk %}" class="btn btn-warning me-2 mb-3">
      üìù Edit Closeout
    </a>
  {% endif %}

  {% if not logsheet.finalized %}
    <form method="post" class="d-inline me-2 mb-3" onsubmit="return confirmFinalize();">
      {% csrf_token %}
      <button type="submit" name="finalize" class="btn btn-danger">
        üîí Finalize Logsheet
      </button>
    </form>

    <script>
      function confirmFinalize() {
        return confirm("‚ö†Ô∏è Finalizing this logsheet will lock it and prevent further edits.\nAre you absolutely sure?");
      }
    </script>
  {% endif %}

  {% if logsheet.finalized and user.is_superuser %}
    <form method="post" class="d-inline mb-3">
      {% csrf_token %}
      <button type="submit" name="revise" class="btn btn-outline-danger">
        ‚úèÔ∏è Revise Logsheet
      </button>
    </form>
  {% endif %}
  </div>
  </div>
</div>


<hr>
<h2>Flights</h2>
{% if not logsheet.finalized %}
<a href="{% url 'logsheet:add_flight' logsheet_pk=logsheet.pk %}"
   class="btn btn-sm btn-primary mb-3"
   data-tow-pilot-ids="{{ logsheet.tow_pilot.pk }},{{ logsheet.surge_tow_pilot.pk }}"
   data-bs-toggle="modal"
   data-bs-target="#flightModal"
   data-url="{% url 'logsheet:add_flight' logsheet_pk=logsheet.pk %}">
  + Add Flight
{% endif %}
</a>

{% if logsheet.flights.exists %}
<table class="table table-bordered table-hover table-striped align-middle sort" id="flightsTable">
  <thead class="table-light">
    <tr>
      <th>Status</th>
      <th>Time</th>
      <th>Pilot</th>
      <th>Instructor</th>
      <th>Glider</th>
      <th>Towplane</th>
      <th>Release Alt</th>
      <th>Duration</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for flight in flights %}
    <tr>
      <td>
        {% if flight.launch_time and flight.landing_time %}
          <span class="badge bg-success">landed</span>
        {% elif flight.launch_time %}
          <span class="badge bg-primary">flying</span>
        {% else %}
          <span class="badge bg-warning text-dark">pending</span>
        {% endif %}
      </td>
      <td>
        {% if flight.launch_time %}
          {{ flight.launch_time|time:"H:i" }}
        {% endif %}
        ‚Äî
        {% if flight.landing_time %}
          {{ flight.landing_time|time:"H:i" }}
        {% endif %}
      </td>
      <td>{{ flight.pilot|full_display_name }}</td>
       <td>
        {% if flight.instructor %}
          {{ flight.instructor|full_display_name }}
        {% endif %}
      </td>
      <td>{{ flight.glider }}</td>
      <td>
          {% if flight.towplane %}
            {{ flight.towplane }}
          {% elif flight.is_incomplete %}
            <span class="badge bg-dark text-light" title="Missing: {{ flight.get_missing_fields|join:', ' }}">
              ‚ö†Ô∏è Missing data
            </span>
          {% endif %}
      </td>
      <td>
          {% if flight.release_altitude %}
            {{ flight.release_altitude }} ft
          {% elif flight.is_incomplete %}
            <span class="badge bg-dark text-light" title="Missing: {{ flight.get_missing_fields|join:', ' }}">
              ‚ö†Ô∏è Missing data
            </span>
          {% endif %}
          
      </td>
      <td>
        {% if not flight.landing_time %}
        <span class="live-duration" data-launch="{{ logsheet.log_date|date:'Y-m-d' }}T{{ flight.launch_time|time:'H:i:s' }}">
          üïí ‚Äî
        </span>
        {% else %}
          {{ flight.duration }}
        {% endif %}
      </td>

      <td class="text-left align-left">
        <a href="{% url 'logsheet:flight_view' flight.id %}" class="btn btn-sm btn-outline-secondary">
          View
        </a>

        {% if not logsheet.finalized %}
        <a href="{% url 'logsheet:edit_flight' logsheet_pk=logsheet.pk flight_pk=flight.pk %}"
           class="btn btn-sm btn-outline-secondary me-1"
           data-bs-toggle="modal" 
           data-bs-target="#flightModal"
           data-url="{% url 'logsheet:edit_flight' logsheet_pk=logsheet.pk flight_pk=flight.pk %}">
          Edit
        </a>
        <form method="post" 
              action="{% url 'logsheet:delete_flight' logsheet_pk=logsheet.pk flight_pk=flight.pk %}" 
              style="display:inline;" 
              onsubmit="return confirm('Are you sure you want to delete this flight?');">
          {% csrf_token %}
          <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete">
            <i class="bi bi-trash"></i>
          </button>
        </form>
        {% endif %}
      </td>
    </tr>
    {% empty %}
    <tr>
      <td colspan="9" class="text-center">No flights found.</td>
    </tr>
    {% endfor %}

  </tbody>
</table>

{% if logsheet.flights.exists %}
  <div class="mt-2 mb-4">
    <strong>{{ flight_total }} flights total</strong>,
    <span class="text-success">{{ flight_landed }} landed</span>,
    <span class="text-primary">{{ flight_flying }} flying</span>,
    <span class="text-warning">{{ flight_pending }} pending</span>
  </div>
{% endif %}

{% else %}
  <p>No flights recorded yet for this logsheet.</p>
{% endif %}
<form method="get" class="row mb-3">
  <div class="col-md-4">
    <input type="text" name="q" class="form-control" placeholder="Search by pilot or instructor" value="{{ query }}">
  </div>
  <div class="col-md-2">
    <button type="submit" class="btn btn-outline-primary">Filter</button>
  </div>
</form>

<div class="modal fade" id="flightModal" tabindex="-1" aria-labelledby="flightModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content" id="flightModalContent">
      <!-- The form will be loaded here via JS -->
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
  document.getElementById("flightModal").addEventListener("shown.bs.modal", function () {

    flatpickr("#id_launch_time", {
      enableTime: true,
      noCalendar: true,
      dateFormat: "H:i",
      time_24hr: true,
      allowInput: true,
      minuteIncrement: 1,
    });

    flatpickr("#id_landing_time", {
      enableTime: true,
      noCalendar: true,
      dateFormat: "H:i",
      time_24hr: true,
      allowInput: true,
      minuteIncrement: 1,
    });
  });
</script>

<script>
  const flightModal = document.getElementById("flightModal");

  flightModal.addEventListener("show.bs.modal", function (event) {
    const button = event.relatedTarget;
    const url = button.getAttribute("data-url");

    fetch(url, {
      headers: {
        "X-Requested-With": "XMLHttpRequest"
      }
    })
    .then(response => response.text())
    .then(html => {
      document.getElementById("flightModalContent").innerHTML = html;

      // Attach robust form submit handler for modal
      function attachFlightFormHandler() {
        const form = document.getElementById("edit-flight-form");
        if (!form) return;
        form.addEventListener("submit", function (e) {
          e.preventDefault();
          const url = form.action || window.location.href;
          const data = new FormData(form);
          fetch(url, {
            method: "POST",
            headers: { "X-Requested-With": "XMLHttpRequest" },
            body: data
          })
          .then(async response => {
            const contentType = response.headers.get("content-type") || "";
            if (response.ok) {
              // Success: expect JSON
              const data = await response.json();
              if (data.success) {
                location.reload();
              }
            } else if (contentType.includes("text/html")) {
              // Validation error: got HTML form, replace modal content and re-attach handler
              const html = await response.text();
              const modalContent = document.getElementById("flightModalContent");
              if (modalContent) {
                modalContent.innerHTML = html;
                attachFlightFormHandler();
              } else {
                document.body.innerHTML = html;
              }
            } else {
              alert("Could not save the flight. Please try again.");
            }
          })
          .catch(error => {
            alert("Could not save the flight. Please try again.");
          });
        });
      }
      attachFlightFormHandler();

      // üö® DOM inside modal is now ready, attach glider/instructor logic here
      const gliderField = flightModal.querySelector("#id_glider");
      const instructorField = flightModal.querySelector("#id_instructor");
      const passengerField = flightModal.querySelector("#id_passenger");
      const passengerNameField = flightModal.querySelector("#id_passenger_name");

      function updateFlightFormFields() {
        const selectedGlider = gliderField.options[gliderField.selectedIndex];
        const numSeats = parseInt(selectedGlider?.dataset.seats || "2");
        const instructorSelected = instructorField && instructorField.value !== "";

        const isSingleSeat = numSeats === 1;

        if (isSingleSeat) {
          instructorField.disabled = true;
          passengerField.disabled = true;
          passengerNameField.disabled = true;
          instructorField.value = "";
          passengerField.value = "";
          passengerNameField.value = "";
        } else {
          instructorField.disabled = false;

          if (instructorSelected) {
            passengerField.disabled = true;
            passengerNameField.disabled = true;
            passengerField.value = "";
            passengerNameField.value = "";
          } else {
            passengerField.disabled = false;
            passengerNameField.disabled = false;
          }
        }
      }

      function promoteTowPilots() {
        const towPilotField = document.getElementById("id_tow_pilot");
        const modalTrigger = document.querySelector("[data-bs-target='#flightModal']");
        const pilotIdsRaw = modalTrigger?.getAttribute("data-tow-pilot-ids") || "";
        const towPilotIds = pilotIdsRaw.split(",").filter(Boolean);

        if (towPilotIds.length === 0) return;

        const originalValue = towPilotField.value; // Save the current selection

        const options = Array.from(towPilotField.options);
        const promoted = [];
        const others = [];

        for (let option of options) {
          if (towPilotIds.includes(option.value)) {
            promoted.push(option);
          } else {
            others.push(option);
          }
        }

        towPilotField.innerHTML = "";
        promoted.concat(others).forEach(opt => towPilotField.appendChild(opt));

        // Restore the original selection
        towPilotField.value = originalValue;
      }

      function promoteGliderOwners() {
        const gliderField = document.getElementById("id_glider");
        const pilotField = document.getElementById("id_pilot");

        const selectedOption = gliderField.options[gliderField.selectedIndex];
        const ownerIds = (selectedOption.dataset.ownerIds || "").split(",").filter(Boolean);

        if (pilotField.options.length === 0) return;

        // Sort all pilot options by last name (case-insensitive)
        const options = Array.from(pilotField.options);
        options.sort((a, b) => {
          const aLast = (a.text.split(" ").slice(-1)[0] || "").toLowerCase();
          const bLast = (b.text.split(" ").slice(-1)[0] || "").toLowerCase();
          return aLast.localeCompare(bLast);
        });

        // Separate owners and non-owners
        const owners = [];
        const nonOwners = [];
        for (let option of options) {
          if (ownerIds.includes(option.value)) {
            owners.push(option);
          } else {
            nonOwners.push(option);
          }
        }

        // Clear and reinsert with owners first, then non-owners
        pilotField.innerHTML = "";
        owners.concat(nonOwners).forEach(opt => pilotField.appendChild(opt));

        // Auto-select the first owner if any
        if (owners.length > 0) {
          pilotField.value = owners[0].value;
        }
      }
      if (gliderField && instructorField) {
        gliderField.addEventListener("change", updateFlightFormFields);
        instructorField.addEventListener("change", updateFlightFormFields);
        updateFlightFormFields(); // Run once on modal load
      }
      gliderField.addEventListener("change", function () {
        updateFlightFormFields();  // your existing logic
        promoteGliderOwners();     // new logic
      });

      const towPilotField = document.getElementById("id_tow_pilot");
      towPilotField && promoteTowPilots();

      // Attach NOW and 2K/3K button logic after modal content is loaded
      const launchBtn = document.getElementById('now-launch-btn');
      const landingBtn = document.getElementById('now-landing-btn');
      const launchInput = document.getElementById('id_launch_time');
      const landingInput = document.getElementById('id_landing_time');
      // Always clear launch time field when modal loads
      if (launchInput) {
        launchInput.value = '';
      }
      function getNowTime24() {
        const now = new Date();
        const h = now.getHours();
        const m = now.getMinutes();
        return (h < 10 ? '0' : '') + h + ':' + (m < 10 ? '0' : '') + m;
      }
      if (launchBtn && launchInput) {
        launchBtn.addEventListener('click', function() {
          launchInput.value = getNowTime24();
          launchInput.dispatchEvent(new Event('input', { bubbles: true }));
        });
      }
      if (landingBtn && landingInput) {
        landingBtn.addEventListener('click', function() {
          landingInput.value = getNowTime24();
          landingInput.dispatchEvent(new Event('input', { bubbles: true }));
        });
      }

      // 2K/3K buttons for release altitude
      const alt2kBtn = document.getElementById('alt-2k-btn');
      const alt3kBtn = document.getElementById('alt-3k-btn');
      const altSelect = document.getElementById('id_release_altitude');
      if (alt2kBtn && altSelect) {
        alt2kBtn.addEventListener('click', function() {
          altSelect.value = '2000';
          altSelect.dispatchEvent(new Event('change', { bubbles: true }));
        });
      }
      if (alt3kBtn && altSelect) {
        alt3kBtn.addEventListener('click', function() {
          altSelect.value = '3000';
          altSelect.dispatchEvent(new Event('change', { bubbles: true }));
        });
      }
    });
  });

  document.addEventListener("DOMContentLoaded", function () {
    const clockEmojis = ["üïõ", "üïê", "üïë", "üïí", "üïì", "üïî", "üïï", "üïñ", "üïó", "üïò", "üïô", "üïö"];
    let emojiIndex = 0;
  
    function pad(n) {
      return n < 10 ? '0' + n : n;
    }
  
    function updateLiveDurations() {
      const now = new Date();
      document.querySelectorAll(".live-duration").forEach(el => {
        const launchStr = el.dataset.launch;
        if (!launchStr || launchStr.endsWith('T')) {
          // No launch time, show placeholder
          el.textContent = 'üïí ‚Äî';
          return;
        }
        const launch = new Date(launchStr);
        if (isNaN(launch.getTime())) {
          el.textContent = 'üïí ‚Äî';
          return;
        }
        const diffMs = now - launch;
        const totalSeconds = Math.floor(diffMs / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const emoji = clockEmojis[emojiIndex % clockEmojis.length];
        el.textContent = `${emoji} ${hours}:${pad(minutes)}`;
      });
      emojiIndex++;
    }

    const logsheetDate = document.getElementById("logsheetContainer")?.dataset?.logsheetDate;
    const today = new Date().toISOString().split("T")[0];

    if (logsheetDate !== today) {
      console.log("‚è±Ô∏è Skipping live duration updates ‚Äî logsheet is from a different day.");
      return;
    }

    updateLiveDurations();               // Run immediately
    setInterval(updateLiveDurations, 5000); // Update every 60 seconds
  });

</script>



<footer style="font-size: 0.8em; color: gray;">
  Template: <code>logsheet/logsheet_manage.html</code>
</footer>

<script src="https://cdn.jsdelivr.net/npm/tablesort@5.2.1/dist/tablesort.min.js"></script>
<script>
  var flights = document.getElementById('flightsTable')
  new Tablesort(flightsTable);
</script>

<script>
  document.getElementById('flightModal').addEventListener('hidden.bs.modal', function (event) {
    // Clear modal content to force reload next time
    document.getElementById('flightModalContent').innerHTML = '';
  });
</script>

{% endblock %}

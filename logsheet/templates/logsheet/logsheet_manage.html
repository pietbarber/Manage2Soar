{% extends "base.html" %}
{% load static %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'css/logsheet.css' %}">
{% endblock %}

{% block content %}
{% load member_extras %}

<!-- Header Section -->
<div class="management-header">
  <div class="header-content">
    <div class="d-flex align-items-center gap-3 mb-3">
      <i class="bi bi-journal-text" style="font-size: 2rem; color: white;"></i>
      <div>
        <h1 class="mb-1" style="color: white;">Logsheet Management</h1>
        <p class="mb-0" style="color: rgba(255, 255, 255, 0.9);">View and manage flight operations</p>
      </div>
    </div>

    <!-- Messages -->
    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          <i class="bi bi-info-circle me-2"></i>
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}

    <!-- Navigation Actions -->
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4">
      <div class="d-flex gap-2">
        {% if previous_logsheet %}
          <a href="{% url 'logsheet:manage' previous_logsheet.id %}" class="btn btn-outline-secondary">
            <i class="bi bi-chevron-left me-1"></i>
            Previous ({{ previous_logsheet.log_date|date:"M j" }})
          </a>
        {% endif %}

        <a href="{% url 'logsheet:index' %}" class="btn btn-outline-primary">
          <i class="bi bi-list-ul me-1"></i>
          Back to List
        </a>

        {% if next_logsheet %}
          <a href="{% url 'logsheet:manage' next_logsheet.id %}" class="btn btn-outline-secondary">
            Next ({{ next_logsheet.log_date|date:"M j" }})
            <i class="bi bi-chevron-right ms-1"></i>
          </a>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Main Management Card -->
<div class="container-fluid" id="logsheet-container" data-logsheet-id="{{ logsheet.pk }}">
  <div class="management-card">
    <div class="management-card-header">
      <div class="d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center gap-3">
          <div class="logsheet-date-badge">
            <i class="bi bi-calendar3 me-2"></i>
            {{ logsheet.log_date|date:"F j, Y" }}
          </div>
          <div class="logsheet-meta">
            <div class="meta-item">
              <i class="bi bi-geo-alt me-1" style="color: rgba(255, 255, 255, 0.8);"></i>
              <span style="color: rgba(255, 255, 255, 0.9);">{{ logsheet.airfield }}</span>
            </div>
            <div class="meta-item">
              <small style="color: rgba(255, 255, 255, 0.7);">
                <i class="bi bi-person me-1" style="color: rgba(255, 255, 255, 0.8);"></i>
                Created by {{ logsheet.created_by }} on {{ logsheet.created_at|date:"M j, Y" }}
              </small>
            </div>
          </div>
        </div>

        {% if logsheet.finalized %}
          <span class="status-badge status-badge-finalized">
            <i class="bi bi-lock-fill me-1"></i>
            Finalized
          </span>
        {% else %}
          <span class="status-badge status-active">
            <i class="bi bi-unlock-fill me-1"></i>
            Active
          </span>
        {% endif %}
      </div>

      <!-- Revision History -->
      {% if logsheet.revisions.exists %}
        <div class="revision-history mt-3">
          <details>
            <summary class="revision-summary">
              <i class="bi bi-clock-history me-2"></i>
              Revision History ({{ logsheet.revisions.count }} revision{{ logsheet.revisions.count|pluralize }})
            </summary>
            <div class="revision-list mt-2">
              {% for rev in logsheet.revisions.all %}
                <div class="revision-item">
                  <div class="revision-date">{{ rev.revised_at|date:"M j, Y H:i" }}</div>
                  <div class="revision-note">{{ rev.note }}</div>
                  {% if rev.revised_by %}
                    <div class="revision-author">by {{ rev.revised_by|full_display_name }}</div>
                  {% endif %}
                </div>
              {% empty %}
                <div class="text-muted">No revisions logged.</div>
              {% endfor %}
            </div>
          </details>
        </div>
      {% endif %}
    </div>

    <!-- Management Actions -->
    <div class="management-actions">
      <div class="actions-grid">
        <a href="{% url 'logsheet:manage_logsheet_finances' pk=logsheet.pk %}"
           class="action-card online-only-btn {% if logsheet.finalized %}action-card-view{% else %}action-card-edit{% endif %}">
          <div class="action-icon">
            <i class="bi bi-graph-up"></i>
          </div>
          <div class="action-content">
            <h6 class="action-title">
              {% if logsheet.finalized %}View Finances{% else %}Edit Finances{% endif %}
            </h6>
            <p class="action-description">Manage flight fees and payments</p>
          </div>
        </a>

        {% if logsheet.finalized %}
          <a href="{% url 'logsheet:view_logsheet_closeout' pk=logsheet.pk %}" class="action-card action-card-view online-only-btn">
            <div class="action-icon">
              <i class="bi bi-file-text"></i>
            </div>
            <div class="action-content">
              <h6 class="action-title">View Closeout</h6>
              <p class="action-description">Review day's summary</p>
            </div>
          </a>
        {% else %}
          <a href="{% url 'logsheet:edit_logsheet_closeout' pk=logsheet.pk %}" class="action-card action-card-edit online-only-btn">
            <div class="action-icon">
              <i class="bi bi-file-text"></i>
            </div>
            <div class="action-content">
              <h6 class="action-title">Edit Closeout</h6>
              <p class="action-description">Complete day's summary</p>
            </div>
          </a>
        {% endif %}

        {% if not logsheet.finalized %}
          <form method="post" class="action-form" onsubmit="return confirmFinalize();">
            {% csrf_token %}
            <button type="submit" name="finalize" class="action-card action-card-danger online-only-btn">
              <div class="action-icon">
                <i class="bi bi-lock"></i>
              </div>
              <div class="action-content">
                <h6 class="action-title">Finalize Logsheet</h6>
                <p class="action-description">Lock and complete</p>
              </div>
            </button>
          </form>

          <script>
            function confirmFinalize() {
              return confirm("⚠️ Finalizing this logsheet will lock it and prevent further edits.\nAre you absolutely sure?");
            }
          </script>
        {% endif %}

        {% if logsheet.finalized and user.is_superuser %}
          <form method="post" class="action-form">
            {% csrf_token %}
            <button type="submit" name="revise" class="action-card action-card-warning online-only-btn">
              <div class="action-icon">
                <i class="bi bi-unlock"></i>
              </div>
              <div class="action-content">
                <h6 class="action-title">Revise Logsheet</h6>
                <p class="action-description">Unlock for changes</p>
              </div>
            </button>
          </form>
        {% endif %}
      </div>
    </div>
  </div>
</div>


<!-- Glider Reservations Alert (Issue #410) -->
{% if reservations %}
<div class="container-fluid">
  <div class="alert alert-info mb-4 shadow-sm">
    <div class="d-flex align-items-start">
      <i class="bi bi-calendar-check text-info me-3" style="font-size: 1.5rem;"></i>
      <div class="flex-grow-1">
        <h6 class="alert-heading mb-2">
          <strong>Glider Reservations Today</strong>
          <span class="badge bg-info ms-2">{{ reservations|length }}</span>
        </h6>
        <ul class="mb-0 list-unstyled">
          {% for res in reservations %}
            <li class="mb-1">
              <strong>{{ res.glider }}</strong>
              reserved by {{ res.member.full_display_name }}
              <span class="text-muted">
                ({{ res.get_reservation_type_display }} -
                {% if res.time_preference == "specific" and res.start_time %}
                  {{ res.start_time|time:"g:i A" }}
                {% else %}
                  {{ res.get_time_preference_display }}
                {% endif %})
              </span>
              {% if res.is_trainer %}
                <span class="badge bg-secondary" title="Two-seater">2S</span>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Flights Section -->
<div class="flights-section" id="logsheetContainer" data-logsheet-date="{{ logsheet.log_date|date:'Y-m-d' }}">
  <div class="flights-header">
    <div class="d-flex align-items-center gap-3">
      <i class="bi bi-airplane text-primary" style="font-size: 1.5rem;"></i>
      <div>
        <h2 class="mb-1">Flight Operations</h2>
        <p class="text-muted mb-0">Manage today's flights</p>
      </div>
    </div>

    {% if not logsheet.finalized %}
      <div class="d-flex gap-2">
        <a href="{% url 'logsheet:add_flight' logsheet_pk=logsheet.pk %}"
           class="btn btn-primary"
           data-tow-pilot-ids="{{ logsheet.tow_pilot.pk }},{{ logsheet.surge_tow_pilot.pk }}"
           data-bs-toggle="modal"
           data-bs-target="#flightModal"
           data-url="{% url 'logsheet:add_flight' logsheet_pk=logsheet.pk %}">
          <i class="bi bi-plus-circle me-2"></i>
          Add Flight
        </a>

        {% if visiting_pilot_config and visiting_pilot_config.visiting_pilot_enabled %}
          <button type="button"
                  class="btn btn-outline-success online-only-btn"
                  data-bs-toggle="modal"
                  data-bs-target="#visitingPilotModal">
            <i class="bi bi-person-plus me-2"></i>
            Register Visiting Pilot
          </button>
        {% endif %}
      </div>

      <!-- Offline sync status indicator -->
      <div id="offline-sync-status" class="mt-2" style="display: none;">
        <!-- Populated by JavaScript when there are pending flights -->
      </div>
    {% endif %}
  </div>

  {% if logsheet.flights.exists %}
    <!-- Modern Bootstrap5 Flights Table -->
    <div class="flights-table-container">
      <div class="table-responsive">
        <table class="table flights-table align-middle" data-sort>
          <thead>
            <tr>
              <th class="status-col" data-sort-method="status">Status</th>
              <th class="time-col" data-sort-method="time">Time</th>
              <th class="pilot-col" data-sort-method="string">Pilot</th>
              <th class="instructor-col d-none d-md-table-cell" data-sort-method="string">Instructor</th>
              <th class="glider-col" data-sort-method="string">Glider</th>
              <th class="towplane-col d-none d-lg-table-cell" data-sort-method="string">Towplane</th>
              <th class="altitude-col d-none d-lg-table-cell" data-sort-method="number">Release Alt</th>
              <th class="duration-col d-none d-sm-table-cell" data-sort-method="duration">Duration</th>
              <th class="actions-col no-sort">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for flight in flights %}
              <tr class="flight-row">
                <td class="status-col" data-sort="{% if flight.launch_time and flight.landing_time %}3{% elif flight.launch_time %}2{% else %}1{% endif %}">
                  {% if flight.launch_time and flight.landing_time %}
                    <span class="flight-badge flight-badge-landed">
                      <i class="bi bi-check-circle-fill me-1"></i>
                      Landed
                    </span>
                  {% elif flight.launch_time %}
                    <span class="flight-badge flight-badge-flying">
                      <i class="bi bi-airplane-fill me-1"></i>
                      Flying
                    </span>
                  {% else %}
                    <span class="flight-badge flight-badge-pending">
                      <i class="bi bi-clock-fill me-1"></i>
                      Pending
                    </span>
                  {% endif %}
                </td>

                <td class="time-col" data-sort="{% if flight.launch_time %}{{ flight.launch_time|time:"Hi" }}{% else %}0000{% endif %}">
                  <div class="time-display">
                    {% if flight.launch_time %}
                      <span class="launch-time">{{ flight.launch_time|time:"H:i" }}</span>
                    {% else %}
                      <span class="launch-time text-muted">--:--</span>
                    {% endif %}
                    <span class="time-separator">—</span>
                    {% if flight.landing_time %}
                      <span class="landing-time">{{ flight.landing_time|time:"H:i" }}</span>
                    {% else %}
                      <span class="landing-time text-muted">--:--</span>
                    {% endif %}
                  </div>
                </td>

                <td class="pilot-col" data-sort="{{ flight.pilot|full_display_name }}">
                  <div class="pilot-info">
                    <strong>{{ flight.pilot|full_display_name }}</strong>
                    <!-- Mobile-only instructor display -->
                    <div class="d-md-none">
                      {% if flight.instructor %}
                        <small class="text-muted">
                          <i class="bi bi-mortarboard-fill me-1"></i>
                          {{ flight.instructor|full_display_name }}
                        </small>
                      {% endif %}
                    </div>
                  </div>
                </td>

                <td class="instructor-col d-none d-md-table-cell" data-sort="{% if flight.instructor %}{{ flight.instructor|full_display_name }}{% else %}{% endif %}">
                  {% if flight.instructor %}
                    <span class="instructor-name">
                      <i class="bi bi-mortarboard-fill text-success me-1"></i>
                      {{ flight.instructor|full_display_name }}
                    </span>
                  {% endif %}
                </td>

                <td class="glider-col" data-sort="{{ flight.glider }}">
                  <div class="glider-info">
                    <strong>{{ flight.glider }}</strong>
                    <!-- Mobile-only additional info -->
                    <div class="d-lg-none">
                      {% if flight.towplane %}
                        <small class="text-muted d-block">
                          <i class="bi bi-airplane-engines me-1"></i>
                          {{ flight.towplane }}
                        </small>
                      {% endif %}
                      {% if flight.release_altitude %}
                        <small class="text-muted d-block">
                          <i class="bi bi-arrow-up me-1"></i>
                          {{ flight.release_altitude }}ft
                        </small>
                      {% endif %}
                    </div>
                  </div>
                </td>

                <td class="towplane-col d-none d-lg-table-cell" data-sort="{% if flight.towplane %}{{ flight.towplane }}{% else %}{% endif %}">
                  {% if flight.towplane %}
                    <span class="towplane-name">
                      <i class="bi bi-airplane-engines text-warning me-1"></i>
                      {{ flight.towplane }}
                    </span>
                  {% elif flight.is_incomplete %}
                    <span class="missing-data-badge" title="Missing: {{ flight.get_missing_fields|join:', ' }}">
                      <i class="bi bi-exclamation-triangle text-warning"></i>
                      Missing data
                    </span>
                  {% endif %}
                </td>

                <td class="altitude-col d-none d-lg-table-cell" data-sort="{% if flight.release_altitude %}{{ flight.release_altitude }}{% else %}0{% endif %}">
                  {% if flight.release_altitude %}
                    <span class="altitude-value">
                      <i class="bi bi-arrow-up text-info me-1"></i>
                      {{ flight.release_altitude }} ft
                    </span>
                  {% elif flight.is_incomplete %}
                    <span class="missing-data-badge" title="Missing: {{ flight.get_missing_fields|join:', ' }}">
                      <i class="bi bi-exclamation-triangle text-warning"></i>
                      Missing
                    </span>
                  {% endif %}
                </td>

                <td class="duration-col d-none d-sm-table-cell" data-sort="{% if flight.duration %}{{ flight.duration|time:'Hi' }}{% elif flight.launch_time and not flight.landing_time %}9999{% else %}0{% endif %}">
                  {% if not flight.landing_time and flight.launch_time %}
                    <span class="live-duration" data-launch="{{ logsheet.log_date|date:'Y-m-d' }}T{{ flight.launch_time|time:'H:i:s' }}">
                      <i class="bi bi-stopwatch text-primary me-1"></i>
                      <span class="duration-text">--:--</span>
                    </span>
                  {% elif flight.duration %}
                    <span class="flight-duration">
                      <i class="bi bi-stopwatch text-muted me-1"></i>
                      {{ flight.duration }}
                    </span>
                  {% else %}
                    <span class="flight-duration text-muted">
                      <i class="bi bi-stopwatch me-1"></i>
                      --:--
                    </span>
                  {% endif %}
                </td>

                <td class="actions-col" data-sort="">
                  <div class="action-buttons">
                    <a href="{% url 'logsheet:flight_view' flight.id %}"
                       class="btn btn-outline-secondary btn-sm online-only-btn"
                       title="View flight details">
                      <i class="bi bi-eye"></i>
                      <span class="d-none d-md-inline ms-1">View</span>
                    </a>

                    {% if not logsheet.finalized %}
                      <a href="{% url 'logsheet:edit_flight' logsheet_pk=logsheet.pk flight_pk=flight.pk %}"
                         class="btn btn-outline-primary btn-sm edit-flight-btn"
                         data-bs-toggle="modal"
                         data-bs-target="#flightModal"
                         data-url="{% url 'logsheet:edit_flight' logsheet_pk=logsheet.pk flight_pk=flight.pk %}"
                         data-flight-id="{{ flight.pk }}"
                         data-pilot="{{ flight.pilot.pk }}"
                         data-pilot-name="{{ flight.pilot|full_display_name|escapejs }}"
                         {% if flight.instructor %}data-instructor="{{ flight.instructor.pk }}" data-instructor-name="{{ flight.instructor|full_display_name|escapejs }}"{% endif %}
                         data-glider="{% if flight.glider.pk %}{{ flight.glider.pk }}{% else %}{{ flight.glider }}{% endif %}"
                         data-glider-name="{{ flight.glider|escapejs }}"
                         {% if flight.towplane %}data-towplane="{{ flight.towplane.pk }}" data-towplane-name="{{ flight.towplane|escapejs }}"{% endif %}
                         {% if flight.tow_pilot %}data-tow-pilot="{{ flight.tow_pilot.pk }}" data-tow-pilot-name="{{ flight.tow_pilot|full_display_name|escapejs }}"{% endif %}
                         {% if flight.release_altitude %}data-release-altitude="{{ flight.release_altitude }}"{% endif %}
                         {% if flight.launch_time %}data-launch-time="{{ flight.launch_time|time:'H:i' }}"{% endif %}
                         {% if flight.landing_time %}data-landing-time="{{ flight.landing_time|time:'H:i' }}"{% endif %}
                         {% if flight.flight_type %}data-flight-type="{{ flight.flight_type }}"{% endif %}
                         {% if flight.passenger %}data-passenger="{{ flight.passenger.pk }}" data-passenger-name="{{ flight.passenger|full_display_name|escapejs }}"{% endif %}
                         {% if flight.passenger_name %}data-passenger-name-text="{{ flight.passenger_name|escapejs }}"{% endif %}
                         {% if flight.notes %}data-notes="{{ flight.notes|escapejs }}"{% endif %}>
                        <i class="bi bi-pencil"></i>
                        <span class="d-none d-md-inline ms-1">Edit</span>
                      </a>

                      <button type="button"
                              class="btn btn-outline-success btn-sm copy-flight-btn"
                              data-flight-id="{{ flight.pk }}"
                              data-pilot="{{ flight.pilot.pk }}"
                              data-pilot-name="{{ flight.pilot|full_display_name|escapejs }}"
                              {% if flight.instructor %}data-instructor="{{ flight.instructor.pk }}" data-instructor-name="{{ flight.instructor|full_display_name|escapejs }}"{% endif %}
                              data-glider="{% if flight.glider.pk %}{{ flight.glider.pk }}{% else %}{{ flight.glider }}{% endif %}"
                              data-glider-name="{{ flight.glider|escapejs }}"
                              {% if flight.release_altitude %}data-release-altitude="{{ flight.release_altitude }}"{% endif %}
                              title="Copy flight details">
                        <i class="bi bi-copy"></i>
                        <span class="d-none d-md-inline ms-1">Copy</span>
                      </button>

                      <button type="button"
                              class="btn btn-outline-danger btn-sm delete-flight-btn"
                              title="Delete"
                              data-flight-id="{{ flight.pk }}"
                              data-delete-url="{% url 'logsheet:delete_flight' logsheet_pk=logsheet.pk flight_pk=flight.pk %}">
                        <i class="bi bi-trash"></i>
                      </button>
                    {% endif %}
                  </div>
                </td>
              </tr>

              <!-- Launch Action Row for Pending Flights -->
              {% if not flight.launch_time and not flight.landing_time %}
                <tr class="action-row launch-action-row">
                  <td colspan="9" class="text-center py-2">
                    <button class="btn btn-success btn-sm launch-now-btn" data-flight-id="{{ flight.pk }}">
                      <i class="bi bi-rocket-takeoff me-2"></i>
                      Launch
                      {% if flight.pilot or flight.instructor or flight.passenger %}
                        {% if flight.pilot %}{{ flight.pilot.get_full_name|default:flight.pilot }}{% endif %}
                        {% if flight.instructor %}{% if flight.pilot %} and {% endif %}{{ flight.instructor.get_full_name|default:flight.instructor }}{% endif %}
                        {% if flight.passenger %}{% if flight.pilot or flight.instructor %} and {% endif %}{{ flight.passenger.get_full_name|default:flight.passenger }}{% endif %}
                      {% else %}
                        Flight
                      {% endif %}
                      Now
                    </button>
                  </td>
                </tr>
              {% endif %}

              <!-- Landing Action Row for Flying Flights -->
              {% if flight.launch_time and not flight.landing_time %}
                <tr class="action-row landing-action-row">
                  <td colspan="9" class="text-center py-2">
                    <button class="btn btn-warning btn-sm landing-now-btn" data-flight-id="{{ flight.pk }}">
                      <i class="bi bi-arrow-down-circle me-2"></i>
                      Record Landing for
                      {% if flight.pilot or flight.instructor or flight.passenger %}
                        {% if flight.pilot %}{{ flight.pilot.get_full_name|default:flight.pilot }}{% endif %}
                        {% if flight.instructor %}{% if flight.pilot %} and {% endif %}{{ flight.instructor.get_full_name|default:flight.instructor }}{% endif %}
                        {% if flight.passenger %}{% if flight.pilot or flight.instructor %} and {% endif %}{{ flight.passenger.get_full_name|default:flight.passenger }}{% endif %}
                      {% else %}
                        Flight
                      {% endif %}
                    </button>
                  </td>
                </tr>
              {% endif %}
            {% empty %}
              <tr>
                <td colspan="9" class="text-center py-4">
                  <div class="empty-state">
                    <i class="bi bi-airplane" style="font-size: 2rem; color: var(--bs-gray-400);"></i>
                    <div class="mt-2 text-muted">No flights recorded</div>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Flight Summary Stats -->
    {% if logsheet.flights.exists %}
      <div class="flight-summary">
        <div class="summary-cards">
          <div class="summary-card">
            <div class="summary-icon">
              <i class="bi bi-list-ol text-primary"></i>
            </div>
            <div class="summary-content">
              <div class="summary-number">{{ flight_total }}</div>
              <div class="summary-label">Total Flights</div>
            </div>
          </div>

          <div class="summary-card">
            <div class="summary-icon">
              <i class="bi bi-check-circle text-success"></i>
            </div>
            <div class="summary-content">
              <div class="summary-number">{{ flight_landed }}</div>
              <div class="summary-label">Landed</div>
            </div>
          </div>

          <div class="summary-card">
            <div class="summary-icon">
              <i class="bi bi-airplane text-primary"></i>
            </div>
            <div class="summary-content">
              <div class="summary-number">{{ flight_flying }}</div>
              <div class="summary-label">Flying</div>
            </div>
          </div>

          <div class="summary-card">
            <div class="summary-icon">
              <i class="bi bi-clock text-warning"></i>
            </div>
            <div class="summary-content">
              <div class="summary-number">{{ flight_pending }}</div>
              <div class="summary-label">Pending</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Search and Filter -->
      <div class="flight-search">
        <form method="get" class="search-form">
          <div class="input-group">
            <span class="input-group-text">
              <i class="bi bi-search"></i>
            </span>
            <input type="text"
                   name="q"
                   class="form-control"
                   placeholder="Search by pilot or instructor name..."
                   value="{{ query }}"
                   aria-label="Search flights">
            <button type="submit" class="btn btn-outline-primary">
              Filter
            </button>
            {% if query %}
              <a href="?" class="btn btn-outline-secondary">
                <i class="bi bi-x"></i>
                Clear
              </a>
            {% endif %}
          </div>
        </form>
      </div>
    {% endif %}

  {% else %}
    <div class="empty-state">
      <i class="bi bi-airplane" style="font-size: 4rem; color: var(--bs-gray-300);"></i>
      <h4 class="mt-3 text-muted">No flights recorded yet</h4>
      <p class="text-muted mb-4">Start by adding the first flight for this logsheet.</p>
      {% if not logsheet.finalized %}
        <a href="{% url 'logsheet:add_flight' logsheet_pk=logsheet.pk %}"
           class="btn btn-primary btn-lg"
           data-tow-pilot-ids="{{ logsheet.tow_pilot.pk }},{{ logsheet.surge_tow_pilot.pk }}"
           data-bs-toggle="modal"
           data-bs-target="#flightModal"
           data-url="{% url 'logsheet:add_flight' logsheet_pk=logsheet.pk %}">
          <i class="bi bi-plus-circle me-2"></i>
          Add First Flight
        </a>
      {% endif %}
    </div>
  {% endif %}
</div>

<script>
// Global toast function for offline notifications (defined early so it's available everywhere)
window.showOfflineToast = window.showOfflineToast || function(message) {
  let toastContainer = document.getElementById('offline-toast-container');
  if (!toastContainer) {
    toastContainer = document.createElement('div');
    toastContainer.id = 'offline-toast-container';
    toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3 mt-5';
    toastContainer.style.zIndex = '1100';
    document.body.appendChild(toastContainer);
  }

  const toastId = 'offline-toast-' + Date.now();
  const toastHtml = `
    <div id="${toastId}" class="toast align-items-center text-white bg-info border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body">
          <i class="bi bi-cloud-slash me-2"></i>
          ${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  `;

  toastContainer.insertAdjacentHTML('beforeend', toastHtml);
  const toastEl = document.getElementById(toastId);
  const toast = new bootstrap.Toast(toastEl, { delay: 4000 });
  toast.show();
};

// Shared function to attach NOW and 2K/3K button handlers to flight modal form
// This must be called after any modal content is loaded (normal open, clone, etc.)
// Uses clone-and-replace pattern to prevent duplicate event listeners
window.attachModalButtonHandlers = function() {
  function getNowTime24() {
    const now = new Date();
    const h = now.getHours();
    const m = now.getMinutes();
    return (h < 10 ? '0' : '') + h + ':' + (m < 10 ? '0' : '') + m;
  }

  // Helper to clone button and remove all event listeners
  function cloneButton(btn) {
    if (!btn) return null;
    const clone = btn.cloneNode(true);
    btn.parentNode.replaceChild(clone, btn);
    return clone;
  }

  // NOW buttons for launch/landing time
  const launchInput = document.getElementById('id_launch_time');
  const landingInput = document.getElementById('id_landing_time');
  const launchBtn = cloneButton(document.getElementById('now-launch-btn'));
  const landingBtn = cloneButton(document.getElementById('now-landing-btn'));

  if (launchBtn && launchInput) {
    launchBtn.addEventListener('click', function() {
      launchInput.value = getNowTime24();
      launchInput.dispatchEvent(new Event('input', { bubbles: true }));
    });
  }
  if (landingBtn && landingInput) {
    landingBtn.addEventListener('click', function() {
      landingInput.value = getNowTime24();
      landingInput.dispatchEvent(new Event('input', { bubbles: true }));
    });
  }

  // 2K/3K buttons for release altitude
  const altSelect = document.getElementById('id_release_altitude');
  const alt2kBtn = cloneButton(document.getElementById('alt-2k-btn'));
  const alt3kBtn = cloneButton(document.getElementById('alt-3k-btn'));

  if (alt2kBtn && altSelect) {
    alt2kBtn.addEventListener('click', function() {
      altSelect.value = '2000';
      altSelect.dispatchEvent(new Event('change', { bubbles: true }));
    });
  }
  if (alt3kBtn && altSelect) {
    alt3kBtn.addEventListener('click', function() {
      altSelect.value = '3000';
      altSelect.dispatchEvent(new Event('change', { bubbles: true }));
    });
  }
};

// Handle "Launch them now" and "Landing now" button clicks
document.addEventListener("click", async function(e) {
  if (e.target && e.target.classList.contains("launch-now-btn")) {
    e.preventDefault();
    const btn = e.target;
    const flightId = btn.getAttribute("data-flight-id");
    // Get user's local time in HH:MM (24h)
    const now = new Date();
    const hh = now.getHours().toString().padStart(2, '0');
    const mm = now.getMinutes().toString().padStart(2, '0');
    const launchTime = `${hh}:${mm}`;

    // Check if offline
    if (!navigator.onLine && typeof M2SIndexedDB !== 'undefined') {
      try {
        const logsheetId = parseInt(document.getElementById('logsheet-container').dataset.logsheetId, 10);
        await M2SIndexedDB.createPendingOperation('launch', parseInt(flightId), launchTime, logsheetId);
        window.showOfflineToast(`Launch time ${launchTime} saved offline. Will sync when back online.`);
        // Update the UI to show pending state
        btn.classList.remove('btn-success');
        btn.classList.add('btn-warning');
        btn.innerHTML = '<i class="bi bi-cloud-arrow-up me-1"></i>Pending Sync...';
        btn.disabled = true;
        // Update the pending indicator
        if (window.M2SOffline) window.M2SOffline.updatePendingIndicator();
      } catch (err) {
        console.error('[Offline] Failed to save launch:', err);
        alert('Failed to save launch time offline. Please try again.');
      }
      return;
    }

    // POST to endpoint to set launch_time (online mode)
    fetch(`/logsheet/flight/${flightId}/launch_now/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": (document.querySelector('[name=csrfmiddlewaretoken]') || {}).value,
        "X-Requested-With": "XMLHttpRequest"
      },
      body: JSON.stringify({ launch_time: launchTime })
    })
    .then(resp => resp.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert(data.error || "Could not launch flight.");
      }
    })
    .catch(async () => {
      // Network error - try to save offline
      if (typeof M2SIndexedDB !== 'undefined') {
        try {
          const logsheetId = parseInt(document.getElementById('logsheet-container').dataset.logsheetId, 10);
          await M2SIndexedDB.createPendingOperation('launch', parseInt(flightId), launchTime, logsheetId);
          window.showOfflineToast(`Launch time ${launchTime} saved offline. Will sync when back online.`);
          btn.classList.remove('btn-success');
          btn.classList.add('btn-warning');
          btn.innerHTML = '<i class="bi bi-cloud-arrow-up me-1"></i>Pending Sync...';
          btn.disabled = true;
          if (window.M2SOffline) window.M2SOffline.updatePendingIndicator();
        } catch (err) {
          console.error('[Offline] Failed to save launch:', err);
          alert('Could not launch flight. Please try again.');
        }
      } else {
        alert("Could not launch flight. Please try again.");
      }
    });
  }
  if (e.target && e.target.classList.contains("landing-now-btn")) {
    e.preventDefault();
    const btn = e.target;
    const flightId = btn.getAttribute("data-flight-id");
    // Get user's local time in HH:MM (24h)
    const now = new Date();
    const hh = now.getHours().toString().padStart(2, '0');
    const mm = now.getMinutes().toString().padStart(2, '0');
    const landingTime = `${hh}:${mm}`;

    // Check if offline
    if (!navigator.onLine && typeof M2SIndexedDB !== 'undefined') {
      try {
        const logsheetId = parseInt(document.getElementById('logsheet-container').dataset.logsheetId, 10);
        await M2SIndexedDB.createPendingOperation('landing', parseInt(flightId), landingTime, logsheetId);
        window.showOfflineToast(`Landing time ${landingTime} saved offline. Will sync when back online.`);
        // Update the UI to show pending state
        btn.classList.remove('btn-warning');
        btn.classList.add('btn-secondary');
        btn.innerHTML = '<i class="bi bi-cloud-arrow-up me-1"></i>Pending Sync...';
        btn.disabled = true;
        // Update the pending indicator
        if (window.M2SOffline) window.M2SOffline.updatePendingIndicator();
      } catch (err) {
        console.error('[Offline] Failed to save landing:', err);
        alert('Failed to save landing time offline. Please try again.');
      }
      return;
    }

    // POST to endpoint to set landing_time (online mode)
    fetch(`/logsheet/flight/${flightId}/landing_now/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": (document.querySelector('[name=csrfmiddlewaretoken]') || {}).value,
        "X-Requested-With": "XMLHttpRequest"
      },
      body: JSON.stringify({ landing_time: landingTime })
    })
    .then(resp => resp.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert(data.error || "Could not mark landing.");
      }
    })
    .catch(async () => {
      // Network error - try to save offline
      if (typeof M2SIndexedDB !== 'undefined') {
        try {
          const logsheetId = parseInt(document.getElementById('logsheet-container').dataset.logsheetId, 10);
          await M2SIndexedDB.createPendingOperation('landing', parseInt(flightId), landingTime, logsheetId);
          window.showOfflineToast(`Landing time ${landingTime} saved offline. Will sync when back online.`);
          btn.classList.remove('btn-warning');
          btn.classList.add('btn-secondary');
          btn.innerHTML = '<i class="bi bi-cloud-arrow-up me-1"></i>Pending Sync...';
          btn.disabled = true;
          if (window.M2SOffline) window.M2SOffline.updatePendingIndicator();
        } catch (err) {
          console.error('[Offline] Failed to save landing:', err);
          alert('Could not mark landing. Please try again.');
        }
      } else {
        alert("Could not mark landing. Please try again.");
      }
    });
  }

  // Handle delete flight button clicks
  if (e.target && (e.target.classList.contains("delete-flight-btn") || e.target.closest(".delete-flight-btn"))) {
    e.preventDefault();
    const btn = e.target.classList.contains("delete-flight-btn") ? e.target : e.target.closest(".delete-flight-btn");
    const flightId = btn.getAttribute("data-flight-id");
    const deleteUrl = btn.getAttribute("data-delete-url");

    // Confirmation dialog
    if (!confirm("Are you sure you want to delete this flight?")) {
      return;
    }

    // Check if offline
    if (!navigator.onLine && typeof M2SIndexedDB !== 'undefined') {
      try {
        const logsheetId = parseInt(document.getElementById('logsheet-container').dataset.logsheetId, 10);
        await M2SIndexedDB.createPendingOperation('delete', parseInt(flightId), null, logsheetId);
        window.showOfflineToast(`Flight deletion saved offline. Will sync when back online.`);
        // Update the UI to show pending delete state
        const row = btn.closest('tr');
        if (row) {
          row.classList.add('table-secondary', 'text-muted');
          row.style.opacity = '0.6';
          // Add pending delete badge
          const statusCell = row.querySelector('.status-col');
          if (statusCell) {
            statusCell.innerHTML = '<span class="badge bg-danger">Pending Delete</span>';
          }
        }
        btn.disabled = true;
        btn.classList.add('disabled');
        // Update the pending indicator
        if (window.M2SOffline) window.M2SOffline.updatePendingIndicator();
      } catch (err) {
        console.error('[Offline] Failed to save delete:', err);
        alert('Failed to save deletion offline. Please try again.');
      }
      return;
    }

    // POST to delete endpoint (online mode)
    fetch(deleteUrl, {
      method: "POST",
      headers: {
        "X-CSRFToken": (document.querySelector('[name=csrfmiddlewaretoken]') || {}).value,
        "X-Requested-With": "XMLHttpRequest"
      }
    })
    .then(resp => {
      if (resp.ok || resp.redirected) {
        location.reload();
      } else {
        return resp.text().then(text => { throw new Error(text); });
      }
    })
    .catch(async (error) => {
      // Network error - try to save offline
      if (typeof M2SIndexedDB !== 'undefined') {
        try {
          const logsheetId = parseInt(document.getElementById('logsheet-container').dataset.logsheetId, 10);
          await M2SIndexedDB.createPendingOperation('delete', parseInt(flightId), null, logsheetId);
          window.showOfflineToast(`Flight deletion saved offline. Will sync when back online.`);
          const row = btn.closest('tr');
          if (row) {
            row.classList.add('table-secondary', 'text-muted');
            row.style.opacity = '0.6';
            const statusCell = row.querySelector('.status-col');
            if (statusCell) {
              statusCell.innerHTML = '<span class="badge bg-danger">Pending Delete</span>';
            }
          }
          btn.disabled = true;
          btn.classList.add('disabled');
          if (window.M2SOffline) window.M2SOffline.updatePendingIndicator();
        } catch (err) {
          console.error('[Offline] Failed to save delete:', err);
          alert('Could not delete flight. Please try again.');
        }
      } else {
        alert("Could not delete flight. Please try again.");
      }
    });
  }

  // Handle copy flight button clicks
  if (e.target && (e.target.classList.contains("copy-flight-btn") || e.target.closest(".copy-flight-btn"))) {
    e.preventDefault();
    const btn = e.target.classList.contains("copy-flight-btn") ? e.target : e.target.closest(".copy-flight-btn");

    // Extract flight data from data attributes
    const flightData = {
      pilot: btn.getAttribute("data-pilot"),
      pilot_name: btn.getAttribute("data-pilot-name"),
      instructor: btn.getAttribute("data-instructor"),
      instructor_name: btn.getAttribute("data-instructor-name"),
      glider: btn.getAttribute("data-glider"),
      glider_name: btn.getAttribute("data-glider-name"),
      release_altitude: btn.getAttribute("data-release-altitude")
    };

    // Helper function to pre-fill the form with copied data
    function prefillCopyForm() {
      const form = document.querySelector('#flightModalContent form');
      if (form) {
        // Set pilot
        const pilotSelect = form.querySelector('select[name="pilot"]');
        if (pilotSelect && flightData.pilot) {
          pilotSelect.value = flightData.pilot;
          // Trigger change event for any dependent logic
          pilotSelect.dispatchEvent(new Event('change', { bubbles: true }));
        }

        // Set instructor
        const instructorSelect = form.querySelector('select[name="instructor"]');
        if (instructorSelect && flightData.instructor) {
          instructorSelect.value = flightData.instructor;
          instructorSelect.dispatchEvent(new Event('change', { bubbles: true }));
        }

        // Set glider
        const gliderSelect = form.querySelector('select[name="glider"]');
        if (gliderSelect && flightData.glider) {
          gliderSelect.value = flightData.glider;
          gliderSelect.dispatchEvent(new Event('change', { bubbles: true }));
        }

        // Set release altitude
        const altitudeSelect = form.querySelector('select[name="release_altitude"]');
        if (altitudeSelect && flightData.release_altitude) {
          altitudeSelect.value = flightData.release_altitude;
        }
        // Also try input in case it's an input field
        const altitudeInput = form.querySelector('input[name="release_altitude"]');
        if (altitudeInput && flightData.release_altitude) {
          altitudeInput.value = flightData.release_altitude;
        }

        // Clear time fields
        const launchTimeInput = form.querySelector('input[name="launch_time"]');
        if (launchTimeInput) launchTimeInput.value = '';

        const landingTimeInput = form.querySelector('input[name="landing_time"]');
        if (landingTimeInput) landingTimeInput.value = '';
      }
    }

    // Helper function to escape HTML special characters
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Helper to add clone notice to modal
    function addCloneNotice() {
      const modalContent = document.getElementById('flightModalContent');
      const existingHeader = modalContent.querySelector('.modal-header');
      if (existingHeader && !modalContent.querySelector('.clone-notice')) {
        const cloneNotice = document.createElement('div');
        cloneNotice.className = 'alert alert-success clone-notice mb-0';
        const pilotName = escapeHtml(flightData.pilot_name || 'pilot');
        const instructorName = flightData.instructor_name ? ` & ${escapeHtml(flightData.instructor_name)}` : '';
        const gliderName = escapeHtml(flightData.glider_name || 'glider');
        cloneNotice.innerHTML = `
          <i class="bi bi-copy me-2"></i>
          <strong>Cloned Flight:</strong> Pre-filled from ${pilotName}${instructorName} in ${gliderName}
        `;
        existingHeader.insertAdjacentElement('afterend', cloneNotice);
      }
    }

    // Check if offline - use offline form with pre-filled data
    if (!navigator.onLine && window.M2SOffline) {
      (async () => {
        try {
          if (await window.M2SOffline.hasReferenceData()) {
            const refData = await window.M2SOffline.getReferenceData();
            if (refData) {
              const logsheetId = parseInt(document.getElementById('logsheet-container').dataset.logsheetId, 10);
              const html = window.M2SOffline.renderOfflineFlightForm(refData, logsheetId);
              document.getElementById('flightModalContent').innerHTML = html;

              // Add visual indication that this is a cloned flight
              const modalElement = document.getElementById('flightModal');
              modalElement.classList.add('cloned-flight-modal');

              // Add clone notice and pre-fill form after a small delay
              setTimeout(() => {
                addCloneNotice();
                prefillCopyForm();
              }, 50);

              // Initialize offline form handlers
              window.M2SOffline.initOfflineFormHandlers(() => {
                window.M2SOffline.updatePendingIndicator();
              });

              // Show the modal
              const modal = new bootstrap.Modal(document.getElementById('flightModal'));
              modal.show();
              return;
            }
          }
        } catch (err) {
          console.error('[Offline] Error loading offline copy form:', err);
        }

        // Fall through to show error if offline form failed
        document.getElementById('flightModalContent').innerHTML = `
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-wifi-off me-2"></i>You're Offline</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-warning">
              <i class="bi bi-exclamation-triangle me-2"></i>
              No cached data available for offline entry. Please connect to the internet at least once to cache flight data.
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        `;
        const modal = new bootstrap.Modal(document.getElementById('flightModal'));
        modal.show();
      })();
      return;
    }

    // Online mode - fetch the add flight form from server
    const addFlightUrl = "{% url 'logsheet:add_flight' logsheet_pk=logsheet.pk %}";

    fetch(addFlightUrl)
      .then(response => response.text())
      .then(html => {
        // Load the form into the modal
        document.getElementById('flightModalContent').innerHTML = html;

        // Add visual indication that this is a cloned flight
        const modalElement = document.getElementById('flightModal');
        modalElement.classList.add('cloned-flight-modal');

        // Add clone notice, pre-fill form, and attach button handlers
        setTimeout(() => {
          addCloneNotice();
          prefillCopyForm();
          // Attach NOW and 2K/3K button handlers
          if (window.attachModalButtonHandlers) {
            window.attachModalButtonHandlers();
          }
        }, 100);

        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('flightModal'));
        modal.show();
      })
      .catch(error => {
        console.error('Error loading add flight form:', error);
        // Show error in modal instead of alert
        const isOffline = !navigator.onLine;
        document.getElementById('flightModalContent').innerHTML = `
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-wifi-off me-2"></i>
              ${isOffline ? "You're Offline" : "Connection Error"}
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-warning">
              <i class="bi bi-exclamation-triangle me-2"></i>
              Could not load the flight form. ${isOffline ? 'Please check your internet connection.' : 'Please try again.'}
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" onclick="location.reload()">
              <i class="bi bi-arrow-clockwise me-1"></i>Retry
            </button>
          </div>
        `;
        const modal = new bootstrap.Modal(document.getElementById('flightModal'));
        modal.show();
      });
  }
});
</script>


<div class="modal fade" id="flightModal" tabindex="-1" aria-labelledby="flightModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false" data-logsheet-id="{{ logsheet.pk }}">
  <div class="modal-dialog modal-lg">
    <div class="modal-content" id="flightModalContent">
      <!-- The form will be loaded here via JS -->
    </div>
  </div>
</div>

<!-- Visiting Pilot Registration Modal -->
{% if visiting_pilot_config and visiting_pilot_config.visiting_pilot_enabled %}
<div class="modal fade" id="visitingPilotModal" tabindex="-1" aria-labelledby="visitingPilotModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="visitingPilotModalLabel">
          👤 Register Visiting Pilot
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <p class="mb-3">
          <strong>For visiting pilots to register:</strong><br>
          Have them scan this QR code with their phone camera
        </p>

        <div class="mb-3">
          <img src="{% url 'members:visiting_pilot_qr_code' %}"
               alt="QR Code for Visiting Pilot Registration"
               class="img-fluid border rounded"
               style="max-width: 300px;">
        </div>

        <div class="alert alert-info">
          <small>
            <strong>Instructions:</strong><br>
            1. Point phone camera at QR code<br>
            2. Tap the notification to open signup form<br>
            3. Complete registration<br>
            4. They'll appear in the pilot dropdown for logging flights
          </small>
        </div>

        <div class="text-muted">
          <small>Direct URL: <code>{{ request.scheme }}://{{ request.get_host }}{% url 'members:visiting_pilot_signup' visiting_pilot_config.visiting_pilot_token %}</code></small>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Close
        </button>
        <a href="{% url 'members:visiting_pilot_signup' visiting_pilot_config.visiting_pilot_token %}"
           target="_blank"
           class="btn btn-outline-primary">
          Open in New Tab
        </a>
      </div>
    </div>
  </div>
</div>
{% endif %}


<!-- Load offline support scripts (non-ES-module bundles to avoid CORS issues with GCS) -->
<script src="{% static 'js/offline/indexeddb-bundle.js' %}"></script>
<script src="{% static 'js/offline/offline-form-bundle.js' %}"></script>

<script>
  // Offline data caching - runs after the bundle scripts are loaded
  (function() {
    'use strict';

    // Check if modules loaded
    if (!window.M2SIndexedDB || !window.M2SOffline) {
      console.warn('[Offline] Offline modules not loaded');
      return;
    }

    const db = window.M2SIndexedDB;

    // Update pending indicator on load
    window.M2SOffline.updatePendingIndicator();

    // Pre-cache reference data when online
    async function cacheReferenceData() {
      if (!navigator.onLine) {
        console.log('[Offline] Skipping reference data cache - offline');
        return;
      }

      try {
        console.log('[Offline] Fetching reference data for cache...');
        const response = await fetch('/logsheet/api/offline/reference-data/', {
          credentials: 'same-origin'
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        if (!data.success) {
          throw new Error(data.error || 'Unknown error');
        }

        // Open database and cache each data type
        await db.openDatabase();

        // Cache members
        await db.clear('members');
        for (const member of data.members) {
          await db.put('members', {
            id: member.id,
            name: member.name,
            displayName: member.display_name,
            nickname: member.nickname,
            lastName: member.name.split(' ').pop(), // For sorting
            isActive: true
          });
        }

        // Cache gliders
        await db.clear('gliders');
        for (const glider of data.gliders) {
          await db.put('gliders', {
            id: glider.id,
            displayName: glider.display_name,
            nNumber: glider.n_number,
            competitionNumber: glider.competition_number,
            model: glider.model,
            seats: glider.seats,
            rentalRate: glider.rental_rate,
            clubOwned: glider.club_owned,
            isActive: true
          });
        }

        // Cache towplanes
        await db.clear('towplanes');
        for (const towplane of data.towplanes) {
          await db.put('towplanes', {
            id: towplane.id,
            name: towplane.name,
            nNumber: towplane.n_number,
            displayName: towplane.display_name,
            isActive: true
          });
        }

        // Cache airfields
        await db.clear('airfields');
        for (const airfield of data.airfields) {
          await db.put('airfields', {
            id: airfield.id,
            identifier: airfield.identifier,
            name: airfield.name,
            displayName: airfield.display_name,
            isActive: true
          });
        }

        // Update metadata
        await db.put('metadata', {
          key: 'referenceDataCached',
          value: new Date().toISOString()
        });
        await db.put('metadata', {
          key: 'referenceDataVersion',
          value: data.version
        });

        console.log('[Offline] Reference data cached successfully');

      } catch (e) {
        console.error('[Offline] Failed to cache reference data:', e);
      }
    }

    // Cache data on page load if online
    if (navigator.onLine) {
      // Delay slightly to not block initial render
      setTimeout(cacheReferenceData, 2000);
    }

    // Listen for online/offline events
    window.addEventListener('online', () => {
      console.log('[Offline] Back online - triggering sync check');
      window.M2SOffline.updatePendingIndicator();
      // Re-cache reference data when we come back online
      cacheReferenceData();
      // Trigger sync of pending flights
      syncPendingFlights();
      // Re-enable online-only buttons
      updateOnlineOnlyButtons(true);
    });

    window.addEventListener('offline', () => {
      console.log('[Offline] Gone offline');
      // Disable online-only buttons
      updateOnlineOnlyButtons(false);
    });

    // Validate URL is safe for href assignment
    function isSafeHref(url) {
      if (!url) return false;
      // Allow relative paths
      if (url.startsWith('/') || url.startsWith('./') || url.startsWith('#')) return true;
      // Allow http/https URLs
      if (url.startsWith('http://') || url.startsWith('https://')) return true;
      return false;
    }

    // Manage buttons that only work online (View, Register Visiting Pilot, Finances, Closeout, Finalize)
    function updateOnlineOnlyButtons(isOnline) {
      const buttons = document.querySelectorAll('.online-only-btn');
      buttons.forEach(btn => {
        if (isOnline) {
          btn.classList.remove('disabled');
          btn.removeAttribute('aria-disabled');
          btn.style.pointerEvents = '';
          btn.style.opacity = '';
          // Restore title using textContent to avoid XSS
          const originalTitle = btn.getAttribute('data-original-title');
          if (originalTitle !== null) {
            btn.title = originalTitle;
          } else {
            btn.title = '';
          }
          // Restore href for links (validate URL is safe first)
          if (btn.tagName === 'A' && btn.hasAttribute('data-original-href')) {
            const originalHref = btn.getAttribute('data-original-href');
            if (isSafeHref(originalHref)) {
              btn.href = originalHref;
            }
          }
        } else {
          btn.classList.add('disabled');
          btn.setAttribute('aria-disabled', 'true');
          btn.style.pointerEvents = 'none';
          btn.style.opacity = '0.5';
          // Save original title and set offline message
          if (!btn.hasAttribute('data-original-title')) {
            btn.setAttribute('data-original-title', btn.title || '');
          }
          btn.title = 'Available when online';
          // For links, save and remove href to prevent navigation
          if (btn.tagName === 'A' && !btn.hasAttribute('data-original-href')) {
            btn.setAttribute('data-original-href', btn.href);
            btn.href = 'javascript:void(0)';
          }
        }
      });
    }

    // Set initial state based on current online status
    updateOnlineOnlyButtons(navigator.onLine);

    // Listen for messages from Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.addEventListener('message', async (event) => {
        console.log('[Offline] Service Worker message:', event.data.type);

        if (event.data.type === 'perform-sync') {
          // Service Worker is asking us to sync pending flights
          await syncPendingFlights();
        }
      });
    }

    // Sync pending flights to the server
    async function syncPendingFlights() {
      if (!navigator.onLine) {
        console.log('[Offline] Cannot sync - offline');
        return;
      }

      try {
        const pendingFlights = await db.getPendingFlights();
        if (pendingFlights.length === 0) {
          console.log('[Offline] No pending flights to sync');
          return;
        }

        console.log('[Offline] Syncing', pendingFlights.length, 'pending item(s)...');

        for (const flight of pendingFlights) {
          try {
            // Mark as syncing
            await db.updateFlightSyncStatus(flight.localId, db.SyncStatus.SYNCING);

            // Check if this is a launch/landing/delete operation
            if (flight.editType === 'operation') {
              await syncOperation(flight);
              continue;
            }

            // Determine if this is a new flight or an edit
            const isEdit = flight.serverId !== null && flight.editType === 'update';

            let url, method;
            if (isEdit) {
              // Edit existing flight
              url = `/logsheet/manage/${flight.logsheetId}/edit-flight/${flight.serverId}/`;
              method = 'POST';
            } else {
              // Create new flight
              url = `/logsheet/manage/${flight.logsheetId}/add-flight/`;
              method = 'POST';
            }

            // Build form data
            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]')?.value || '');

            // Add flight fields
            const fieldMap = {
              'pilot_id': 'pilot',
              'instructor_id': 'instructor',
              'glider_id': 'glider',
              'towplane_id': 'towplane',
              'tow_pilot_id': 'tow_pilot',
              'passenger_id': 'passenger',
              'launch_time': 'launch_time',
              'landing_time': 'landing_time',
              'release_altitude': 'release_altitude',
              'flight_type': 'flight_type',
              'passenger_name': 'passenger_name',
              'notes': 'notes'
            };

            for (const [dataKey, formKey] of Object.entries(fieldMap)) {
              const value = flight[dataKey] || flight[formKey];
              if (value !== null && value !== undefined && value !== '') {
                formData.append(formKey, value);
              }
            }

            // Add idempotency key header
            const response = await fetch(url, {
              method: method,
              headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-Idempotency-Key': flight.idempotencyKey
              },
              body: formData,
              credentials: 'same-origin'
            });

            if (response.ok) {
              const result = await response.json();
              if (result.success) {
                // Mark as synced
                await db.markFlightSynced(flight.localId, result.flight_id || flight.serverId);
                console.log('[Offline] Flight synced:', flight.localId, '->', result.flight_id || flight.serverId);
              } else {
                throw new Error(result.error || 'Sync failed');
              }
            } else if (response.status === 409) {
              // Conflict - mark for user resolution
              const result = await response.json();
              await db.markFlightConflict(flight.localId, result);
              console.warn('[Offline] Flight conflict:', flight.localId);
            } else {
              throw new Error(`HTTP ${response.status}`);
            }

          } catch (e) {
            console.error('[Offline] Failed to sync flight:', flight.localId, e);
            await db.markFlightError(flight.localId, e.message);
          }
        }

        // Update UI
        window.M2SOffline.updatePendingIndicator();

        // Show sync complete notification
        showSyncCompleteToast();

        // Reload page to show updated data
        setTimeout(() => location.reload(), 2000);

      } catch (e) {
        console.error('[Offline] Sync process failed:', e);
      }
    }

    // Sync a launch/landing/delete operation
    async function syncOperation(operation) {
      let endpoint, body, contentType;

      if (operation.operationType === 'delete') {
        // Delete operation - POST to delete URL
        endpoint = `/logsheet/manage/${operation.logsheetId}/delete-flight/${operation.serverId}/`;
        body = null;  // No body needed for delete
        contentType = null;
      } else {
        // Launch or landing operation
        endpoint = operation.operationType === 'launch'
          ? `/logsheet/flight/${operation.serverId}/launch_now/`
          : `/logsheet/flight/${operation.serverId}/landing_now/`;

        body = operation.operationType === 'launch'
          ? { launch_time: operation.time }
          : { landing_time: operation.time };
        contentType = 'application/json';
      }

      const headers = {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
        'X-Requested-With': 'XMLHttpRequest',
        'X-Idempotency-Key': operation.idempotencyKey
      };
      if (contentType) {
        headers['Content-Type'] = contentType;
      }

      const fetchOptions = {
        method: 'POST',
        headers: headers,
        credentials: 'same-origin'
      };
      if (body) {
        fetchOptions.body = JSON.stringify(body);
      }

      const response = await fetch(endpoint, fetchOptions);

      if (response.ok || response.redirected) {
        // For delete, we may get a redirect on success
        if (operation.operationType === 'delete') {
          await db.markFlightSynced(operation.localId, operation.serverId);
          console.log(`[Offline] delete synced for flight ${operation.serverId}`);
        } else {
          const result = await response.json();
          if (result.success) {
            await db.markFlightSynced(operation.localId, operation.serverId);
            console.log(`[Offline] ${operation.operationType} synced for flight ${operation.serverId}`);
          } else {
            throw new Error(result.error || 'Operation sync failed');
          }
        }
      } else {
        throw new Error(`HTTP ${response.status}`);
      }
    }

    // Show sync complete toast
    function showSyncCompleteToast() {
      let toastContainer = document.getElementById('offline-toast-container');
      if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'offline-toast-container';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3 mt-5';
        toastContainer.style.zIndex = '1100';
        document.body.appendChild(toastContainer);
      }

      const toastId = 'sync-complete-toast-' + Date.now();
      const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-white bg-success border-0" role="alert">
          <div class="d-flex">
            <div class="toast-body">
              <i class="bi bi-cloud-check me-2"></i>
              <strong>Flights synced!</strong>
              Refreshing page...
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        </div>
      `;

      toastContainer.insertAdjacentHTML('beforeend', toastHtml);
      const toastEl = document.getElementById(toastId);
      const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
      toast.show();
    }

  })();
</script>

<script>
  const flightModal = document.getElementById("flightModal");
  const LOGSHEET_ID = parseInt(flightModal.dataset.logsheetId, 10);

  // Helper function to extract pre-fill data from Edit button's data attributes (DRY)
  function extractPrefillDataFromButton(button, flightId) {
    if (!button || !flightId) return null;
    return {
      flightId: parseInt(flightId, 10),
      pilot: button.getAttribute('data-pilot'),
      pilotName: button.getAttribute('data-pilot-name'),
      instructor: button.getAttribute('data-instructor'),
      instructorName: button.getAttribute('data-instructor-name'),
      glider: button.getAttribute('data-glider'),
      gliderName: button.getAttribute('data-glider-name'),
      towplane: button.getAttribute('data-towplane'),
      towplaneName: button.getAttribute('data-towplane-name'),
      towPilot: button.getAttribute('data-tow-pilot'),
      towPilotName: button.getAttribute('data-tow-pilot-name'),
      releaseAltitude: button.getAttribute('data-release-altitude'),
      launchTime: button.getAttribute('data-launch-time'),
      landingTime: button.getAttribute('data-landing-time'),
      flightType: button.getAttribute('data-flight-type'),
      passenger: button.getAttribute('data-passenger'),
      passengerName: button.getAttribute('data-passenger-name'),
      passengerNameText: button.getAttribute('data-passenger-name-text'),
      notes: button.getAttribute('data-notes')
    };
  }

  flightModal.addEventListener("show.bs.modal", async function (event) {
    // Get the button that triggered the modal - may be an icon inside the button
    let button = event.relatedTarget;
    if (button && !button.hasAttribute('data-url')) {
      // Clicked on child element (icon/span), find the parent with data-url
      button = button.closest('[data-url]');
    }

    // Guard against null button
    if (!button) {
      console.error('[Modal] No trigger button found');
      return;
    }

    const url = button.getAttribute("data-url");
    const isAddFlight = url && url.includes('/add-flight/');
    const isEditFlight = url && url.includes('/edit-flight/');
    const flightId = button.getAttribute("data-flight-id");

    // Show loading indicator
    document.getElementById("flightModalContent").innerHTML = `
      <div class="modal-header">
        <h5 class="modal-title">Loading...</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
    `;

    // Check if we're offline BEFORE trying to fetch - Add and Edit flights work offline
    if (!navigator.onLine && (isAddFlight || isEditFlight)) {
      console.log('[Offline] Detected offline state, using offline form for', isEditFlight ? 'edit' : 'add');
      try {
        // Check if we have cached reference data
        if (window.M2SOffline && await window.M2SOffline.hasReferenceData()) {
          const refData = await window.M2SOffline.getReferenceData();
          if (refData) {
            // For edit, extract pre-fill data from button's data attributes
            const prefillData = isEditFlight ? extractPrefillDataFromButton(button, flightId) : null;
            const html = window.M2SOffline.renderOfflineFlightForm(refData, LOGSHEET_ID, prefillData);
            document.getElementById("flightModalContent").innerHTML = html;
            window.M2SOffline.initOfflineFormHandlers(() => {
              // Callback after save - update UI
              window.M2SOffline.updatePendingIndicator();
            });
            return; // Don't try to fetch
          }
        }
      } catch (e) {
        console.error('[Offline] Error loading offline form:', e);
      }
      // Fall through to show offline error if we couldn't load offline form
    }

    fetch(url, {
      headers: {
        "X-Requested-With": "XMLHttpRequest"
      }
    })
    .then(response => {
      if (!response.ok) {
        // Handle offline/error responses
        if (!navigator.onLine || response.status === 503) {
          throw new Error('offline');
        }
        throw new Error('server_error');
      }
      return response.text();
    })
    .then(html => {
      document.getElementById("flightModalContent").innerHTML = html;

      // Attach robust form submit handler for modal
      function attachFlightFormHandler() {
        const form = document.getElementById("edit-flight-form");
        if (!form) return;
        form.addEventListener("submit", function (e) {
          e.preventDefault();
          const formUrl = form.action || window.location.href;
          const data = new FormData(form);

          // Extract flight ID from URL if this is an edit (not add)
          const editMatch = formUrl.match(/\/edit-flight\/(\d+)\//);
          const flightId = editMatch ? parseInt(editMatch[1], 10) : null;
          const isEdit = flightId !== null;

          fetch(formUrl, {
            method: "POST",
            headers: { "X-Requested-With": "XMLHttpRequest" },
            body: data
          })
          .then(async response => {
            const contentType = response.headers.get("content-type") || "";
            if (response.ok) {
              // Success: expect JSON
              const jsonData = await response.json();
              if (jsonData.success) {
                location.reload();
              }
            } else if (contentType.includes("text/html")) {
              // Validation error: got HTML form, replace modal content and re-attach handler
              const html = await response.text();
              const modalContent = document.getElementById("flightModalContent");
              if (modalContent) {
                modalContent.innerHTML = html;
                attachFlightFormHandler();
              } else {
                document.body.innerHTML = html;
              }
            } else {
              throw new Error('server_error');
            }
          })
          .catch(async error => {
            // Check if we're offline and can save locally
            if (!navigator.onLine && window.M2SIndexedDB) {
              console.log('[Offline] Saving flight edit locally...');
              try {
                // Convert FormData to object
                const flightData = {};
                for (const [key, value] of data.entries()) {
                  // Skip CSRF token
                  if (key === 'csrfmiddlewaretoken') continue;
                  // Convert empty strings to null for optional fields
                  flightData[key] = value === '' ? null : value;
                }

                // Convert IDs to integers
                ['pilot', 'instructor', 'glider', 'towplane', 'tow_pilot', 'passenger', 'release_altitude'].forEach(field => {
                  if (flightData[field]) {
                    flightData[field] = parseInt(flightData[field], 10) || null;
                  }
                });

                const db = window.M2SIndexedDB;
                let localId;

                if (isEdit && flightId) {
                  // This is an edit to an existing flight
                  localId = await db.createPendingEdit(flightId, flightData, LOGSHEET_ID);
                } else {
                  // This is a new flight
                  localId = await db.createPendingFlight(flightData, LOGSHEET_ID);
                }

                console.log('[Offline] Flight saved with local ID:', localId);

                // Close the modal
                const modalEl = document.getElementById('flightModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) {
                  modal.hide();
                }

                // Show success toast
                showOfflineSaveToast(isEdit ? 'edit' : 'add');

                // Update pending indicator
                if (window.M2SOffline) {
                  window.M2SOffline.updatePendingIndicator();
                }

                // Register for background sync
                if ('serviceWorker' in navigator && 'SyncManager' in window) {
                  const registration = await navigator.serviceWorker.ready;
                  await registration.sync.register('sync-flights');
                }

              } catch (dbError) {
                console.error('[Offline] Failed to save locally:', dbError);
                alert("Could not save the flight offline. Please try again when online.");
              }
            } else {
              alert("Could not save the flight. Please check your connection and try again.");
            }
          });
        });
      }

      // Helper to show offline save toast
      function showOfflineSaveToast(action) {
        let toastContainer = document.getElementById('offline-toast-container');
        if (!toastContainer) {
          toastContainer = document.createElement('div');
          toastContainer.id = 'offline-toast-container';
          toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3 mt-5';
          toastContainer.style.zIndex = '1100';
          document.body.appendChild(toastContainer);
        }

        const toastId = 'offline-saved-toast-' + Date.now();
        const message = action === 'edit' ? 'Flight edit saved offline!' : 'New flight saved offline!';
        const toastHtml = `
          <div id="${toastId}" class="toast align-items-center text-white bg-warning border-0" role="alert">
            <div class="d-flex">
              <div class="toast-body">
                <i class="bi bi-download me-2"></i>
                <strong>${message}</strong>
                Will sync when online.
              </div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
          </div>
        `;

        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        const toastEl = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastEl, { delay: 5000 });
        toast.show();
        toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
      }

      attachFlightFormHandler();

      // 🚨 DOM inside modal is now ready, attach glider/instructor logic here
      const gliderField = flightModal.querySelector("#id_glider");
      const instructorField = flightModal.querySelector("#id_instructor");
      const passengerField = flightModal.querySelector("#id_passenger");
      const passengerNameField = flightModal.querySelector("#id_passenger_name");

      function updateFlightFormFields() {
        const selectedGlider = gliderField.options[gliderField.selectedIndex];
        const numSeats = parseInt(selectedGlider?.dataset.seats || "2");
        const instructorSelected = instructorField && instructorField.value !== "";

        const isSingleSeat = numSeats === 1;

        if (isSingleSeat) {
          instructorField.disabled = true;
          passengerField.disabled = true;
          passengerNameField.disabled = true;
          instructorField.value = "";
          passengerField.value = "";
          passengerNameField.value = "";
        } else {
          instructorField.disabled = false;

          if (instructorSelected) {
            passengerField.disabled = true;
            passengerNameField.disabled = true;
            passengerField.value = "";
            passengerNameField.value = "";
          } else {
            passengerField.disabled = false;
            passengerNameField.disabled = false;
          }
        }
      }

      function promoteTowPilots() {
        const towPilotField = document.getElementById("id_tow_pilot");
        const modalTrigger = document.querySelector("[data-bs-target='#flightModal']");
        const pilotIdsRaw = modalTrigger?.getAttribute("data-tow-pilot-ids") || "";
        const towPilotIds = pilotIdsRaw.split(",").filter(Boolean);

        if (towPilotIds.length === 0) return;

        const originalValue = towPilotField.value; // Save the current selection

        // If there are optgroups, preserve them and promote within each group
        const optgroups = towPilotField.querySelectorAll('optgroup');
        if (optgroups.length > 0) {
          for (const group of optgroups) {
            const options = Array.from(group.children);
            const promoted = [];
            const others = [];
            for (let option of options) {
              if (towPilotIds.includes(option.value)) {
                promoted.push(option);
              } else {
                others.push(option);
              }
            }
            group.innerHTML = '';
            promoted.concat(others).forEach(opt => group.appendChild(opt));
          }
        } else {
          // No optgroups, fallback to flat promotion
          const options = Array.from(towPilotField.options);
          const promoted = [];
          const others = [];
          for (let option of options) {
            if (towPilotIds.includes(option.value)) {
              promoted.push(option);
            } else {
              others.push(option);
            }
          }
          towPilotField.innerHTML = "";
          promoted.concat(others).forEach(opt => towPilotField.appendChild(opt));
        }

        // Restore the original selection
        towPilotField.value = originalValue;
      }

      function promoteGliderOwners() {
        const gliderField = document.getElementById("id_glider");
        const pilotField = document.getElementById("id_pilot");

        const selectedOption = gliderField.options[gliderField.selectedIndex];
        const ownerIds = (selectedOption.dataset.ownerIds || "").split(",").filter(Boolean);

        if (pilotField.options.length === 0) return;

        // Find the first owner option in the existing optgroups
        let foundOwner = false;
        let ownerValue = "";
        const optgroups = pilotField.querySelectorAll('optgroup');
        for (const group of optgroups) {
          for (const option of group.children) {
            if (ownerIds.includes(option.value)) {
              ownerValue = option.value;
              foundOwner = true;
              break;
            }
          }
          if (foundOwner) break;
        }

        // If not found in optgroups, check direct children (if any)
        if (!foundOwner) {
          for (const option of pilotField.children) {
            if (option.tagName === 'OPTION' && ownerIds.includes(option.value)) {
              ownerValue = option.value;
              foundOwner = true;
              break;
            }
          }
        }

        // Only set the value if an owner is found, otherwise leave as is
        if (foundOwner) {
          pilotField.value = ownerValue;
        }
      }
      if (gliderField && instructorField) {
        gliderField.addEventListener("change", updateFlightFormFields);
        instructorField.addEventListener("change", updateFlightFormFields);
        updateFlightFormFields(); // Run once on modal load
      }
      gliderField.addEventListener("change", function () {
        updateFlightFormFields();  // your existing logic
        promoteGliderOwners();     // new logic
      });

      const towPilotField = document.getElementById("id_tow_pilot");
      towPilotField && promoteTowPilots();

      // Attach NOW and 2K/3K button logic after modal content is loaded
      if (window.attachModalButtonHandlers) {
        window.attachModalButtonHandlers();
      }
    })
    .catch(async error => {
      // Handle offline/network errors gracefully
      const isOffline = error.message === 'offline' || !navigator.onLine;
      const isAddFlight = url && url.includes('/add-flight/');
      const isEditFlight = url && url.includes('/edit-flight/');
      const modalContent = document.getElementById("flightModalContent");

      // If offline and adding/editing a flight, try to use offline form
      if (isOffline && (isAddFlight || isEditFlight) && window.M2SOffline) {
        try {
          if (await window.M2SOffline.hasReferenceData()) {
            const refData = await window.M2SOffline.getReferenceData();
            if (refData) {
              // For edit, extract pre-fill data from button's data attributes
              const prefillData = isEditFlight ? extractPrefillDataFromButton(button, flightId) : null;
              const html = window.M2SOffline.renderOfflineFlightForm(refData, LOGSHEET_ID, prefillData);
              modalContent.innerHTML = html;
              window.M2SOffline.initOfflineFormHandlers(() => {
                window.M2SOffline.updatePendingIndicator();
              });
              return;
            }
          }
        } catch (e) {
          console.error('[Offline] Error loading offline form from catch:', e);
        }
      }

      // Show error with option to use offline form if available
      modalContent.innerHTML = `
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-wifi-off me-2"></i>
            ${isOffline ? "You're Offline" : "Connection Error"}
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning mb-3">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>${isOffline ? "No internet connection." : "Could not load the form."}</strong>
            <p class="mb-0 mt-2">
              ${isOffline && (isAddFlight || isEditFlight)
                ? "No cached data available for offline entry. Please connect to the internet at least once to cache flight data."
                : isOffline
                  ? "This action requires an internet connection."
                  : "There was a problem connecting to the server. Please try again."}
            </p>
          </div>
          <div id="offline-modal-status" class="text-muted small">
            ${isOffline ? '<i class="bi bi-hourglass-split me-1"></i>Waiting for connection...' : ''}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="location.reload()">
            <i class="bi bi-arrow-clockwise me-1"></i>Retry
          </button>
        </div>
      `;

      // If offline, listen for reconnection
      if (isOffline) {
        function checkOnlineStatus() {
          if (navigator.onLine) {
            const statusEl = document.getElementById('offline-modal-status');
            if (statusEl) {
              statusEl.innerHTML = '<i class="bi bi-wifi text-success me-1"></i>Connection restored! Reloading...';
            }
            setTimeout(() => location.reload(), 1000);
          }
        }
        window.addEventListener('online', checkOnlineStatus);
        // Also poll as backup
        const pollInterval = setInterval(() => {
          if (navigator.onLine) {
            checkOnlineStatus();
            clearInterval(pollInterval);
          }
        }, 1000);
      }

      console.error('Failed to load flight form:', error);
    });
  });

  document.addEventListener("DOMContentLoaded", function () {
    const clockEmojis = ["🕛", "🕐", "🕑", "🕒", "🕓", "🕔", "🕕", "🕖", "🕗", "🕘", "🕙", "🕚"];
    let emojiIndex = 0;

    function pad(n) {
      return n < 10 ? '0' + n : n;
    }

    function updateLiveDurations() {
      const now = new Date();
      document.querySelectorAll(".live-duration").forEach(el => {
        const launchStr = el.dataset.launch;
        if (!launchStr || launchStr.endsWith('T')) {
          // No launch time, show placeholder
          el.textContent = '🕒 —';
          return;
        }
        const launch = new Date(launchStr);
        if (isNaN(launch.getTime())) {
          el.textContent = '🕒 —';
          return;
        }
        const diffMs = now - launch;
        const totalSeconds = Math.floor(diffMs / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const emoji = clockEmojis[emojiIndex % clockEmojis.length];
        el.textContent = `${emoji} ${hours}:${pad(minutes)}`;
      });
      emojiIndex++;
    }

    const logsheetDate = document.getElementById("logsheetContainer")?.dataset?.logsheetDate;
    const today = new Date().toISOString().split("T")[0];

    if (logsheetDate !== today) {
      console.log("⏱️ Skipping live duration updates — logsheet is from a different day.");
      return;
    }

    updateLiveDurations();               // Run immediately
    setInterval(updateLiveDurations, 5000); // Update every 60 seconds
  });

</script>



<footer style="font-size: 0.8em; color: gray;">
  Template: <code>logsheet/logsheet_manage.html</code>
</footer>

<script src="https://cdn.jsdelivr.net/npm/tablesort@5.2.1/dist/tablesort.min.js"></script>
  <!-- Tablesort: shared CDN + initializer included in base.html now -->

<script>
  // Custom tablesort methods
  if (typeof Tablesort !== 'undefined') {
    // Custom status sort
    Tablesort.extend('status', function(item) {
      return item.search(/data-sort="[123]"/) !== -1;
    }, function(a, b) {
      const aVal = parseInt(a.getAttribute('data-sort')) || 0;
      const bVal = parseInt(b.getAttribute('data-sort')) || 0;
      return aVal - bVal;
    });

    // Custom time sort
    Tablesort.extend('time', function(item) {
      return item.search(/data-sort="\d{4}"/) !== -1;
    }, function(a, b) {
      const aVal = parseInt(a.getAttribute('data-sort')) || 0;
      const bVal = parseInt(b.getAttribute('data-sort')) || 0;
      return aVal - bVal;
    });

    // Custom duration sort
    Tablesort.extend('duration', function(item) {
      return item.search(/duration-col/) !== -1;
    }, function(a, b) {
      const aVal = parseInt(a.getAttribute('data-sort')) || 0;
      const bVal = parseInt(b.getAttribute('data-sort')) || 0;
      return aVal - bVal;
    });

    // Initialize table sorting
    document.addEventListener('DOMContentLoaded', function() {
      const table = document.querySelector('[data-sort]');
      if (table) {
        new Tablesort(table);
      }
    });
  }

  // Live duration updates for flying aircraft - re-cache elements each update for dynamic flights
  function updateLiveDurations() {
    const now = new Date();
    // Re-cache elements each time to handle dynamically added flights
    const liveDurationElements = document.querySelectorAll('.live-duration');
    liveDurationElements.forEach(el => {
      const launchTimeStr = el.getAttribute('data-launch');
      if (launchTimeStr) {
        const launchTime = new Date(launchTimeStr);
        const diffMs = now - launchTime;
        const hours = Math.floor(diffMs / (1000 * 60 * 60));
        const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
        const durationText = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;

        const durationSpan = el.querySelector('.duration-text');
        if (durationSpan) {
          durationSpan.textContent = durationText;
        } else {
          // Handle cases where duration-text span doesn't exist yet
          el.innerHTML = `<i class="bi bi-stopwatch text-primary me-1"></i> ${durationText}`;
        }

        // Update sort data for live durations
        const cell = el.closest('td');
        if (cell && hours >= 0 && minutes >= 0) {
          const sortValue = hours * 100 + minutes + 10000; // Add offset to put live flights at top
          cell.setAttribute('data-sort', sortValue.toString());
        }
      }
    });
  }

  // Update durations every 30 seconds (elements are re-cached each time)
  setInterval(updateLiveDurations, 30000);
  // Initial update
  updateLiveDurations();

  document.getElementById('flightModal').addEventListener('hidden.bs.modal', function (event) {
    // Clear modal content to force reload next time
    document.getElementById('flightModalContent').innerHTML = '';
    // Remove cloned flight styling
    document.getElementById('flightModal').classList.remove('cloned-flight-modal');
  });
</script>

{% endblock %}

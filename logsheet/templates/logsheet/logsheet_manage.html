{% extends "base.html" %}

{% block content %}
{% load member_extras %}
<h1>Manage Logsheet</h1>
{% if messages %}
  <div class="container mt-3">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  </div>
{% endif %}

<div class="card">
  <div class="card-body">
    <h5 class="card-title">Logsheet for {{ logsheet.log_date }}</h5>
    <p class="card-text">Airfield: {{ logsheet.airfield }}</p>
    <p class="card-text"><small class="text-muted">Created by {{ logsheet.created_by }} on {{ logsheet.created_at }}</small></p>
    {% if logsheet.revisions.exists %}
    <details>Revision History
      <ul class="mb-0">
        {% for rev in logsheet.revisions.all %}
        <li> Reopened by {{ rev.revised_by }} on {{ rev.revised_at|date:"Y-m-d H:i" }}</li>
        {% endfor %}
      </ul>
    </details>
    {% endif %}
  </div>
</div>
{% if logsheet.finalized and user.is_superuser %}
  <form method="post" class="mt-2">
    {% csrf_token %}
    <button type="submit" name="revise" class="btn btn-outline-danger">
      Revise Logsheet
    </button>
  </form>
{% endif %}

<div class="d-flex flex-wrap gap-2 mb-3">
  <a href="{% url 'logsheet:manage_logsheet_finances' pk=logsheet.pk %}" class="btn btn-outline-success">
    üìä View Finances</a>
    <a href="{% url 'logsheet:edit_logsheet_closeout' pk=logsheet.pk %}" class="btn btn-warning mb-3">
      üìù Edit Closeout
    </a>

  {% if not logsheet.finalized %}
    <form method="post" onsubmit="return confirmFinalize();" class="d-inline">
      {% csrf_token %}
      <button type="submit" name="finalize" class="btn btn-danger">
        üîí Finalize Logsheet
      </button>
    </form>
  {% endif %}
</div>

{% if logsheet.finalized %}
  <div class="alert alert-warning mt-3">
    <strong>This logsheet is finalized.</strong> No further changes are allowed.
  </div>
{% endif %}

<script>
  function confirmFinalize() {
    return confirm("‚ö†Ô∏è Finalizing this logsheet will lock it and prevent further edits.\nAre you absolutely sure?");
  }
</script>

<hr>
<h2>Flights</h2>
{% if not logsheet.finalized %}
<a href="{% url 'logsheet:add_flight' logsheet_pk=logsheet.pk %}"
   class="btn btn-sm btn-primary mb-3"
   data-bs-toggle="modal"
   data-bs-target="#flightModal"
   data-url="{% url 'logsheet:add_flight' logsheet_pk=logsheet.pk %}">
  + Add Flight
{% endif %}
</a>

{% if logsheet.flights.exists %}
<table class="table table-bordered table-hover align-middle sort" id="flightsTable">
  <thead class="table-light">
    <tr>
      <th>Status</th>
      <th>Time</th>
      <th>Pilot</th>
      <th>Instructor</th>
      <th>Glider</th>
      <th>Towplane</th>
      <th>Release Alt</th>
      <th>Duration</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for flight in flights %}
    <tr>
      <td>
        {% if flight.launch_time and flight.landing_time %}
          <span class="badge bg-success">landed</span>
        {% elif flight.launch_time %}
          <span class="badge bg-primary">flying</span>
        {% endif %}
      </td>
      <td>
        {% if flight.launch_time %}
          {{ flight.launch_time|time:"H:i" }}
        {% endif %}
        ‚Äî
        {% if flight.landing_time %}
          {{ flight.landing_time|time:"H:i" }}
        {% endif %}
      </td>
      <td>{{ flight.pilot|full_display_name }}</td>
       <td>
        {% if flight.instructor %}
          {{ flight.instructor|full_display_name }}
        {% endif %}
      </td>
      <td>{{ flight.glider }}</td>
      <td>{{ flight.towplane }}</td>
      <td>
          {% if flight.release_altitude %}
            {{ flight.release_altitude }} ft</td>
          {% endif %}
     <td>
        {% if flight.duration %}
          {{ flight.duration }}
        {% endif %}
      </td>

      <td class="text-end">
        {% if not logsheet.finalized %}
        <a href="{% url 'logsheet:edit_flight' logsheet_pk=logsheet.pk flight_pk=flight.pk %}"
           class="btn btn-sm btn-outline-secondary me-1"
           data-bs-toggle="modal" 
           data-bs-target="#flightModal"
           data-url="{% url 'logsheet:edit_flight' logsheet_pk=logsheet.pk flight_pk=flight.pk %}">
          Edit
        </a>
        <form method="post" 
              action="{% url 'logsheet:delete_flight' logsheet_pk=logsheet.pk flight_pk=flight.pk %}" 
              style="display:inline;" 
              onsubmit="return confirm('Are you sure you want to delete this flight?');">
          {% csrf_token %}
          <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete">
            <i class="bi bi-trash"></i>
          </button>
        </form>
        {% endif %}
      </td>
    </tr>
    {% empty %}
    <tr>
      <td colspan="9" class="text-center">No flights found.</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

{% else %}
  <p>No flights recorded yet for this logsheet.</p>
{% endif %}
<form method="get" class="row mb-3">
  <div class="col-md-4">
    <input type="text" name="q" class="form-control" placeholder="Search by pilot or instructor" value="{{ query }}">
  </div>
  <div class="col-md-2">
    <button type="submit" class="btn btn-outline-primary">Filter</button>
  </div>
</form>

<div class="modal fade" id="flightModal" tabindex="-1" aria-labelledby="flightModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content" id="flightModalContent">
      <!-- The form will be loaded here via JS -->
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
  function togglePassengerFields() {
    const instructor = document.getElementById("id_instructor");
    const passenger = document.getElementById("id_passenger");
    const passengerName = document.getElementById("id_passenger_name");

    const instructorSelected = instructor && instructor.value !== "";

    if (passenger) passenger.disabled = instructorSelected;
    if (passengerName) passengerName.disabled = instructorSelected;
  }

  document.addEventListener("DOMContentLoaded", function () {
    const modal = document.getElementById("flightModal");
    modal.addEventListener("shown.bs.modal", function () {
      togglePassengerFields();
      const instructor = document.getElementById("id_instructor");
      if (instructor) {
        instructor.addEventListener("change", togglePassengerFields);
      }
    });
  });

</script>

<script>
  document.getElementById("flightModal").addEventListener("shown.bs.modal", function () {

    flatpickr("#id_launch_time", {
      enableTime: true,
      noCalendar: true,
      dateFormat: "H:i",
      time_24hr: true,
    });

    flatpickr("#id_landing_time", {
      enableTime: true,
      noCalendar: true,
      dateFormat: "H:i",
      time_24hr: true,
    });
  });
</script>



<script>
  const flightModal = document.getElementById("flightModal");

  flightModal.addEventListener("show.bs.modal", function (event) {
    const button = event.relatedTarget;
    const url = button.getAttribute("data-url");

    fetch(url, {
      headers: {
        "X-Requested-With": "XMLHttpRequest"
      }
    })
    .then(response => response.text())
    .then(html => {
      document.getElementById("flightModalContent").innerHTML = html;
    });
  });
</script>

<footer style="font-size: 0.8em; color: gray;">
  Template: <code>logsheet/logsheet_manage.html</code>
</footer>

<script src="https://cdn.jsdelivr.net/npm/tablesort@5.2.1/dist/tablesort.min.js"></script>
<script>
  var flights = document.getElementById('flightsTable')
  new Tablesort(flightsTable);
</script>



{% endblock %}

{% block content %}
<style>
input[type="time"], input.timeinput {
  max-width: 6em;
  min-width: 4em;
  display: inline-block;
}
.now-btn {
  margin-left: 0.5em !important;
}
</style>

{% load static %}
{% load crispy_forms_tags %}
{% load member_extras %}

<div class="modal-header">
  <h5 class="modal-title">
    {% if form.instance.pk %}Edit Flight{% else %}Add Flight{% endif %}
  </h5>
  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<form method="post" enctype="multipart/form-data" id="edit-flight-form"
    action="{% if flight.pk %}
            {% url 'logsheet:edit_flight' logsheet_pk=logsheet.pk flight_pk=flight.pk %}
            {% else %}
            {% url 'logsheet:add_flight' logsheet_pk=logsheet.pk %}
            {% endif %}">
  <div class="modal-body">
    {% if form.non_field_errors %}
      <div class="alert alert-danger" role="alert">
        {{ form.non_field_errors }}
      </div>
    {% endif %}
    {% csrf_token %}
    <table class="table table-borderless align-middle">
      <tbody>
        <tr>
          <th scope="row" class="text-end">Glider*</th>
          <td>
            <select name="{{ form.glider.name }}" id="{{ form.glider.id_for_label }}" class="form-select">
              <option value="">---------</option>
              <optgroup label="Club gliders">
                {% for glider in club_gliders %}
                  <option value="{{ glider.pk }}"
                          data-seats="{{ glider.seats }}"
                          data-owner-ids="{% for owner in glider.owners.all %}{{ owner.pk }}{% if not forloop.last %},{% endif %}{% endfor %}"
                    {% if form.glider.value|stringformat:"s" == glider.pk|stringformat:"s" %}selected{% endif %}>
                    {{ glider }}
                  </option>
                {% endfor %}
              </optgroup>
              <optgroup label="Private gliders">
                {% for glider in club_private %}
                  <option value="{{ glider.pk }}"
                          data-seats="{{ glider.seats }}"
                          data-owner-ids="{% for owner in glider.owners.all %}{{ owner.pk }}{% if not forloop.last %},{% endif %}{% endfor %}"
                    {% if form.glider.value|stringformat:"s" == glider.pk|stringformat:"s" %}selected{% endif %}>
                    {{ glider }}
                  </option>
                {% endfor %}
              </optgroup>
              <optgroup label="Inactive gliders">
                {% for glider in inactive_gliders %}
                  <option value="{{ glider.pk }}"
                          data-seats="{{ glider.seats }}"
                          data-owner-ids="{% for owner in glider.owners.all %}{{ owner.pk }}{% if not forloop.last %},{% endif %}{% endfor %}"
                    {% if form.glider.value|stringformat:"s" == glider.pk|stringformat:"s" %}selected{% endif %}>
                    {{ glider }}
                  </option>
                {% endfor %}
              </optgroup>
            </select>
            {{ form.glider.errors }}
          </td>
        </tr>
        <tr>
          <th scope="row" class="text-end">Pilot*</th>
          <td>
            {{ form.pilot }}
            {{ form.pilot.errors }}
          </td>
        </tr>
        <tr>
          <th scope="row" class="text-end">Instructor</th>
          <td>
            {{ form.instructor }}
            {{ form.instructor.errors }}
          </td>
        </tr>

        <tr>
          <th scope="row" class="text-end">Passenger</th>
          <td>
            {{ form.passenger }}
            {{ form.passenger.errors }}
          </td>
        </tr>
        <tr>
          <th scope="row" class="text-end">Passenger Name</th>
          <td>
            {{ form.passenger_name }}
            {{ form.passenger_name.errors }}
          </td>
        </tr>

       <tr>
          <th scope="row" class="text-end">Towpilot</th>
          <td>
            {{ form.tow_pilot }}
            {{ form.tow_pilot.errors }}
          </td>
        </tr>
        <tr>
          <th scope="row" class="text-end">Towplane</th>
          <td>
            {{ form.towplane }}
            {{ form.towplane.errors }}
          </td>
        </tr>
        <tr>
          <th scope="row" class="text-end">Launch Time</th>
          <td class="d-flex align-items-center">
            {# Render launch_time field with no initial value and narrow width #}
            <input type="time"
                   name="{{ form.launch_time.name }}"
                   id="{{ form.launch_time.id_for_label }}"
                   class="form-control timeinput"
                   value="{{ form.launch_time.value|default_if_none:'' }}"
                   placeholder="--:-- ðŸ•“">
            <button type="button" class="btn btn-outline-secondary btn-sm now-btn" id="now-launch-btn">NOW</button>
            {{ form.launch_time.errors }}
          </td>
        </tr>
        <tr>
          <th scope="row" class="text-end">Landing Time</th>
          <td class="d-flex align-items-center gap-2">
            <input type="time"
                   name="{{ form.landing_time.name }}"
                   id="{{ form.landing_time.id_for_label }}"
                   class="form-control timeinput"
                   value="{{ form.landing_time.value|default_if_none:'' }}"
                   placeholder="--:-- ðŸ•“">
            <button type="button" class="btn btn-outline-secondary btn-sm ms-2" id="now-landing-btn">NOW</button>
            {{ form.landing_time.errors }}
          </td>
        </tr>
        <tr>
          <th scope="row" class="text-end">Release Altitude</th>
          <td class="d-flex align-items-center gap-2">
            {{ form.release_altitude }}
            <button type="button" class="btn btn-outline-secondary btn-sm ms-2" id="alt-2k-btn">2K</button>
            <button type="button" class="btn btn-outline-secondary btn-sm ms-1" id="alt-3k-btn">3K</button>
            {{ form.release_altitude.errors }}
            <div class="form-text" class="text-end">Release altitude in feet (0â€“7000 in 100ft steps)</div>
          </td>
        </tr>
        <tr>
          <th scope="row" class="text-end">Split With</th>
          <td>
            {{ form.split_with }}
            {{ form.split_with.errors }}
          </td>
        </tr>
        <tr>
          <th scope="row" class="text-end">Split Type</th>
          <td>
            {{ form.split_type }}
            {{ form.split_type.errors }}
            <div class="form-text">Choose how to split the cost</div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="modal-footer">
    <button type="submit" class="btn btn-primary">
      {% if form.instance.pk %}Save Changes{% else %}Add Flight{% endif %}
    </button>
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
  </div>
</form>



<!-- Form submit JS is now managed in logsheet_manage.html for robust modal handling. -->


  <footer style="font-size: 0.8em; color: gray;">
    Template: <code>logsheet/edit_flight_form.html</code>
  </footer>
{% endblock %}
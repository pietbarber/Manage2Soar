
{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/logsheet.css' %}">
{% endblock %}

{% block content %}
<div id="top"></div>

<!-- Header Section -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="display-6 fw-bold text-primary mb-1">
      <i class="bi bi-journal-text me-2"></i>Flight Logsheets
    </h1>
    <p class="text-muted mb-0">Track and manage daily flight operations</p>
  </div>
  <button type="button" class="btn btn-success btn-modern" data-bs-toggle="modal" data-bs-target="#createLogsheetModal">
    <i class="bi bi-plus-circle me-2"></i>Create New Logsheet
  </button>
</div>

{% if messages %}
  <div class="container mt-3">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  </div>
{% endif %}


<!-- Modal HTML structure for creating a new logsheet -->
<div class="modal fade" id="createLogsheetModal" tabindex="-1" aria-labelledby="createLogsheetModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{% url 'logsheet:create' %}">
        {% csrf_token %}
        {{ form.non_field_errors }}
        <div class="modal-header">
          <h5 class="modal-title" id="createLogsheetModalLabel">Create New Logsheet</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            {{ form.log_date.label_tag }}
            {{ form.log_date }}
            {{ form.log_date.errors }}
          </div>
          <div class="mb-3">
            {{ form.airfield.label_tag }}
            {{ form.airfield }}
            {{ form.airfield.errors }}
          </div>
          <div class="mb-3">
            {{ form.duty_officer.label_tag }}
            {{ form.duty_officer }}
            {{ form.duty_officer.errors }}
          </div>
          <div class="mb-3">
            {{ form.assistant_duty_officer.label_tag }}
            {{ form.assistant_duty_officer }}
            {{ form.assistant_duty_officer.errors }}
          </div>
          <div class="mb-3">
            {{ form.duty_instructor.label_tag }}
            {{ form.duty_instructor }}
            {{ form.duty_instructor.errors }}
          </div>
          <div class="mb-3">
            {{ form.surge_instructor.label_tag }}
            {{ form.surge_instructor }}
            {{ form.surge_instructor.errors }}
          </div>
          <div class="mb-3">
            {{ form.tow_pilot.label_tag }}
            {{ form.tow_pilot }}
            {{ form.tow_pilot.errors }}
          </div>
          <div class="mb-3">
            {{ form.surge_tow_pilot.label_tag }}
            {{ form.surge_tow_pilot }}
            {{ form.surge_tow_pilot.errors }}
          </div>
          <div class="mb-3">
            {{ form.default_towplane.label_tag }}
            {{ form.default_towplane }}
            {{ form.default_towplane.errors }}
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Start Logsheet</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- Search Section -->
<div class="search-section">
  <div class="row">
    <div class="col-lg-8 mx-auto">
      <form method="get" class="d-flex gap-2">
        <div class="input-group input-group-lg flex-grow-1">
          <span class="input-group-text bg-white border-end-0">
            <i class="bi bi-search text-muted"></i>
          </span>
          <input type="text" name="q" class="form-control search-input border-start-0"
                 placeholder="Search by date, location, or user..."
                 value="{{ query }}" aria-label="Search logsheets">
        </div>
        <button type="submit" class="btn btn-primary btn-modern">
          <i class="bi bi-search me-2"></i>Search
        </button>
      </form>
    </div>
  </div>
</div>

<!-- Filter Section -->
<div class="filter-section">
  <form method="get" class="d-flex align-items-center justify-content-between flex-wrap gap-3">
    <div class="d-flex align-items-center gap-2">
      <label for="year" class="fw-semibold text-primary">
        <i class="bi bi-calendar3 me-1"></i>Show logsheets from:
      </label>
      <select name="year" class="form-select" style="width: auto;" onchange="this.form.submit()">
        {% for y in available_years %}
          <option value="{{ y }}" {% if year|stringformat:"s" == y|stringformat:"s" %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
    </div>
    {% if query %}
      <input type="hidden" name="q" value="{{ query }}">
      <a href="{% url 'logsheet:index' %}" class="btn btn-outline-secondary btn-modern">
        <i class="bi bi-arrow-clockwise me-2"></i>Clear Search
      </a>
    {% endif %}
  </form>
</div>

<!-- Logsheets Grid -->
<div class="row g-4" id="logsheetsGrid">
  {% for log in logsheets %}
  <div class="col-xl-4 col-lg-6 col-md-6">
    <div class="card logsheet-card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div>
            <h5 class="card-title mb-1">
              <i class="bi bi-calendar-date me-2 text-primary"></i>
              {{ log.log_date|date:"M j, Y" }}
            </h5>
            <div class="logsheet-stats">
              <div class="stat-item">
                <i class="bi bi-geo-alt"></i>
                {{ log.airfield }}
              </div>
            </div>
          </div>
          <div class="text-end">
            {% if log.finalized %}
              <span class="badge closeout-status-finalized fs-6">
                <i class="bi bi-lock me-1"></i>Finalized
              </span>
            {% else %}
              <span class="badge status-open text-dark fs-6">
                <i class="bi bi-unlock me-1"></i>Open
              </span>
            {% endif %}
          </div>
        </div>

        <!-- Flight Count and Creator Info -->
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div class="d-flex align-items-center">
            <div class="flight-count me-2">
              {{ log.flights.count }}
            </div>
            <div>
              <div class="fw-semibold">Flight{{ log.flights.count|pluralize }}</div>
              <small class="text-muted">{{ log.created_by.first_name }} {{ log.created_by.last_name }}</small>
            </div>
          </div>
          <small class="text-muted">
            <i class="bi bi-clock me-1"></i>{{ log.created_at|date:"M j" }}
          </small>
        </div>

        <!-- Additional Stats -->
        {% if log.finalized %}
        <div class="alert alert-success alert-sm border-0 mb-3">
          <i class="bi bi-check-circle me-2"></i>
          <strong>Complete:</strong> All flights logged and finances closed
        </div>
        {% else %}
        <div class="alert alert-warning alert-sm border-0 mb-3">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <strong>In Progress:</strong> Accepting flights and entries
        </div>
        {% endif %}
      </div>

      <!-- Card Footer with Actions -->
      <div class="card-footer bg-transparent border-0 pt-0">
        <div class="d-grid gap-2">
          <a href="{% url 'logsheet:manage' pk=log.pk %}"
             class="btn {% if log.finalized %}btn-outline-secondary{% else %}btn-primary{% endif %} btn-modern">
            <i class="bi bi-{% if log.finalized %}eye{% else %}pencil-square{% endif %} me-2"></i>
            {% if log.finalized %}View Logsheet{% else %}Manage Logsheet{% endif %}
          </a>

          {% if log.flights.count == 0 and not log.closeout and log.payments.count == 0 and not log.finalized and log.towplane_closeouts.count == 0 %}
          <form method="post" action="{% url 'logsheet:delete' pk=log.pk %}" class="d-grid">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-danger btn-modern btn-sm"
                    onclick="return confirm('Are you sure you want to delete this empty logsheet? This cannot be undone.');">
              <i class="bi bi-trash me-2"></i>Delete Empty Logsheet
            </button>
          </form>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% empty %}
  <!-- Empty State -->
  <div class="col-12">
    <div class="empty-state">
      <i class="bi bi-journal-x display-1"></i>
      <h3 class="text-muted">No logsheets found</h3>
      <p class="text-muted mb-4">
        {% if query %}
          No logsheets match your search criteria. Try adjusting your search terms.
        {% else %}
          Get started by creating your first logsheet for today's flights.
        {% endif %}
      </p>
      {% if not query %}
      <button type="button" class="btn btn-primary btn-modern" data-bs-toggle="modal" data-bs-target="#createLogsheetModal">
        <i class="bi bi-plus-circle me-2"></i>Create First Logsheet
      </button>
      {% endif %}
    </div>
  </div>
  {% endfor %}
</div>


<!-- Pagination -->
{% if page_obj.paginator.num_pages > 1 %}
<nav aria-label="Logsheet list pagination" class="mt-5">
  <ul class="pagination pagination-modern justify-content-center">
    {% if page_obj.has_previous %}
    <li class="page-item">
      <a class="page-link" href="?page=1{% if year %}&year={{ year }}{% endif %}{% if query %}&q={{ query }}{% endif %}">
        <i class="bi bi-chevron-double-left"></i>
      </a>
    </li>
    <li class="page-item">
      <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if year %}&year={{ year }}{% endif %}{% if query %}&q={{ query }}{% endif %}">
        <i class="bi bi-chevron-left"></i> Previous
      </a>
    </li>
    {% endif %}

    <!-- Page numbers -->
    {% for num in page_obj.paginator.page_range %}
      {% if page_obj.number == num %}
      <li class="page-item active">
        <span class="page-link">{{ num }}</span>
      </li>
      {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
      <li class="page-item">
        <a class="page-link" href="?page={{ num }}{% if year %}&year={{ year }}{% endif %}{% if query %}&q={{ query }}{% endif %}">{{ num }}</a>
      </li>
      {% endif %}
    {% endfor %}

    {% if page_obj.has_next %}
    <li class="page-item">
      <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if year %}&year={{ year }}{% endif %}{% if query %}&q={{ query }}{% endif %}">
        Next <i class="bi bi-chevron-right"></i>
      </a>
    </li>
    <li class="page-item">
      <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if year %}&year={{ year }}{% endif %}{% if query %}&q={{ query }}{% endif %}">
        <i class="bi bi-chevron-double-right"></i>
      </a>
    </li>
    {% endif %}
  </ul>

  <div class="text-center text-muted mt-3">
    <small>
      Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} logsheets
    </small>
  </div>
</nav>
{% endif %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  var dateInput = document.getElementById('id_log_date');
  if (dateInput) {
    dateInput.addEventListener('change', function() {
      var dateVal = this.value;
      if (!dateVal) return;
      fetch('/logsheet/api/duty-assignment/?date=' + encodeURIComponent(dateVal), {
        credentials: 'same-origin'
      })
      .then(response => response.json())
      .then(data => {
        var fields = [
          'duty_officer', 'assistant_duty_officer', 'duty_instructor',
          'surge_instructor', 'tow_pilot', 'surge_tow_pilot'
        ];
        fields.forEach(function(field) {
          var select = document.getElementById('id_' + field);
          if (select && data[field]) {
            select.value = data[field];
          }
        });
      });
    });
  }

  // Validate default towplane before submitting the modal form
  var createForm = document.querySelector('#createLogsheetModal form');
  if (createForm) {
    createForm.addEventListener('submit', function(e) {
      var towplane = document.getElementById('id_default_towplane');
      if (towplane && (!towplane.value || towplane.value === '')) {
        e.preventDefault();
        alert('Please select a default towplane before creating the logsheet.');
        towplane.focus();
      }
    });
  }
});
</script>

{% endblock %}


<!-- Back to Top Button -->
<button class="back-to-top" onclick="document.getElementById('top').scrollIntoView({behavior: 'smooth'})" title="Back to Top">
  <i class="bi bi-arrow-up"></i>
</button>

{% endblock %}

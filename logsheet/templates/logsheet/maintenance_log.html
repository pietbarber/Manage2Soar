{% extends "base.html" %}
{% load static %}
{% load logsheet_tags %}

{% block content %}
<div class="container mt-4">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-2xl font-semibold mb-0">Maintenance Log</h2>
    <a href="{% url 'logsheet:maintenance_issues' %}" class="btn btn-primary">
      <i class="bi bi-exclamation-triangle"></i> View Active Issues Only
    </a>
  </div>

  <!-- Statistics Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title text-muted">Total Issues</h5>
          <p class="display-6">{{ total_issues }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center border-warning">
        <div class="card-body">
          <h5 class="card-title text-warning">Open</h5>
          <p class="display-6 text-warning">{{ open_issues_count }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center border-success">
        <div class="card-body">
          <h5 class="card-title text-success">Resolved</h5>
          <p class="display-6 text-success">{{ resolved_issues_count }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center border-danger">
        <div class="card-body">
          <h5 class="card-title text-danger">Grounded</h5>
          <p class="display-6 text-danger">{{ grounded_count }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Filter Form -->
  <div class="card mb-4">
    <div class="card-body">
      <form method="get" class="row g-3 align-items-end">
        <div class="col-md-4">
          <label for="aircraft-select" class="form-label">Filter by Aircraft</label>
          <select id="aircraft-select" name="aircraft_id" class="form-select"
                  onchange="updateTypeField(this)">
            <option value="">All Aircraft</option>
            <optgroup label="Gliders">
              {% for glider in gliders %}
              <option value="{{ glider.id }}" data-type="glider"
                {% if selected_type == 'glider' and selected_aircraft_id == glider.id %}selected{% endif %}>
                {{ glider.n_number }} - {{ glider.model }}
              </option>
              {% endfor %}
            </optgroup>
            <optgroup label="Towplanes">
              {% for towplane in towplanes %}
              <option value="{{ towplane.id }}" data-type="towplane"
                {% if selected_type == 'towplane' and selected_aircraft_id == towplane.id %}selected{% endif %}>
                {{ towplane.n_number }} - {{ towplane.name }}
              </option>
              {% endfor %}
            </optgroup>
          </select>
          <input type="hidden" name="type" id="type-field" value="{{ selected_type|default:'' }}">
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-outline-primary">Filter</button>
          {% if selected_aircraft_id %}
          <a href="{% url 'logsheet:maintenance_log' %}" class="btn btn-outline-secondary">Clear</a>
          {% endif %}
        </div>
      </form>
    </div>
  </div>

  <!-- Maintenance Log Table -->
  <table class="table table-striped table-bordered align-middle">
    <thead class="table-dark">
      <tr>
        <th style="width: 100px;">Photo</th>
        <th style="width: 120px;">Aircraft</th>
        <th style="width: 110px;">Report Date</th>
        <th>Description</th>
        <th style="width: 100px;">Status</th>
        <th style="width: 110px;">Resolved</th>
      </tr>
    </thead>
    <tbody>
      {% for issue in issues %}
      <tr class="{% if issue.grounded and not issue.resolved %}table-danger{% elif not issue.resolved %}table-warning{% endif %}">
        <td class="text-center">
          {% if issue.glider and issue.glider.photo %}
            <img src="{{ issue.glider.photo_url_small }}" style="max-width: 80px; max-height: 60px;" class="rounded shadow">
          {% elif issue.towplane and issue.towplane.photo %}
            <img src="{{ issue.towplane.photo_url_small }}" style="max-width: 80px; max-height: 60px;" class="rounded shadow">
          {% else %}
            <span class="text-muted">✈️</span>
          {% endif %}
        </td>

        <td>
          {% if issue.glider %}
            <strong>{{ issue.glider.n_number }}</strong><br>
            <small class="text-muted">{{ issue.glider.model }}</small>
          {% elif issue.towplane %}
            <strong>{{ issue.towplane.n_number }}</strong><br>
            <small class="text-muted">{{ issue.towplane.name }}</small>
          {% else %}
            Unknown
          {% endif %}
        </td>

        <td>
          {{ issue.report_date|date:"M d, Y" }}
          {% if issue.reported_by %}
          <br><small class="text-muted">by {{ issue.reported_by.get_full_name|default:issue.reported_by.username }}</small>
          {% endif %}
        </td>

        <td>
          <div class="mb-2">{{ issue.description }}</div>
          {% if issue.resolved and issue.resolution_notes %}
          <div class="small text-success">
            <strong>Resolution:</strong> {{ issue.resolution_notes }}
          </div>
          {% endif %}
        </td>

        <td class="text-center">
          {% if issue.resolved %}
            <span class="badge bg-success">Resolved</span>
          {% elif issue.grounded %}
            <span class="badge bg-danger">Grounded</span>
          {% else %}
            <span class="badge bg-warning text-dark">Open</span>
          {% endif %}
        </td>

        <td>
          {% if issue.resolved %}
            {{ issue.resolved_date|date:"M d, Y" }}
            {% if issue.resolved_by %}
            <br><small class="text-muted">by {{ issue.resolved_by.get_full_name|default:issue.resolved_by.username }}</small>
            {% endif %}
          {% else %}
            <span class="text-muted">—</span>
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="6" class="text-center text-muted py-4">
          No maintenance issues found. ✈️✅
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

</div>

<script>
function updateTypeField(select) {
  const option = select.options[select.selectedIndex];
  const type = option.getAttribute('data-type') || '';
  document.getElementById('type-field').value = type;
}
</script>
{% endblock %}

{% extends "base.html" %}
{% load static %}
{% load logsheet_tags %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="{% static 'css/equipment_logbook.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'css/logsheet.css' %}">
{% endblock %}


{% block content %}
<div class="container mt-4">

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        <i class="bi bi-info-circle me-2"></i>{{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-2xl font-semibold mb-0">Active Maintenance Issues</h2>
    <div>
      <button type="button" class="btn btn-danger me-2" data-bs-toggle="modal" data-bs-target="#addIssueModal">
        <i class="bi bi-plus-circle me-1"></i>Add Issue
      </button>
      <a href="{% url 'logsheet:maintenance_log' %}" class="btn btn-outline-secondary">
        <i class="bi bi-journal-text"></i> View Full Maintenance Log
      </a>
    </div>
  </div>

  <table class="table table-striped table-bordered align-middle text-center">
    <thead>
      <tr>
        <th>Photo</th>
        <th>Aircraft</th>
        <th>Description</th>
        <th>Status</th>
        {% if user.is_authenticated %}
        <th>Action</th>
        {% endif %}
      </tr>
    </thead>
    <tbody>
      {% for issue in open_issues %}
      <tr>
        <td>
          {% if issue.glider and issue.glider.photo %}
            <img src="{{ issue.glider.photo_url_small }}" style="max-width: 100px; max-height: 100px;" class="rounded shadow">
          {% elif issue.towplane and issue.towplane.photo %}
            <img src="{{ issue.towplane.photo_url_small }}" style="max-width: 100px; max-height: 100px;" class="rounded shadow">
          {% else %}
            ✈️ No Photo
          {% endif %}
        </td>

        <td>
          {% if issue.glider %}
            {{ issue.glider.n_number }}<br>{{ issue.glider.model }}
          {% elif issue.towplane %}
            {{ issue.towplane.n_number }}<br>{{ issue.towplane.name }}
          {% else %}
            Unknown
          {% endif %}
        </td>

          <td class="logbook-events-col text-start">
            <div class="text-muted small mb-1">
              Reported on {{ issue.report_date }}
            </div>
            {{ issue.description }}
        </td>

        <td>
          {% if issue.grounded %}
            <span class="badge bg-danger">Grounded</span>
          {% else %}
            <span class="badge bg-primary">Available</span>
          {% endif %}
        </td>

        {% if user.is_authenticated %}
        <td>
          {% if issue|can_be_resolved_by:user %}
          <button
            class="btn btn-success btn-sm"
            hx-get="{% url 'logsheet:maintenance_resolve_modal' issue.id %}"
            hx-target="#modal-body"
            hx-swap="innerHTML"
            onclick="bootstrap.Modal.getOrCreateInstance(document.getElementById('calendarModal')).show();"
          >
            ✅ Mark Resolved
          </button>

          {% endif %}

        {% else %}
          <button class="btn btn-sm btn-outline-secondary" disabled>✍️ No Access</button>
        {% endif %}
        </td>

      </tr>
      {% empty %}
      <tr>
        <td colspan="5" class="text-center text-muted">No active maintenance issues. ✈️✅</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

</div>

<!-- Add Maintenance Issue Modal (reusable include) -->
{% with form_action_url=form_action_url|default_if_none:"" %}
  {% if not form_action_url %}
    {% url 'logsheet:add_maintenance_issue_standalone' as form_action_url %}
  {% endif %}
  {% include "logsheet/includes/add_maintenance_issue_modal.html" with form_action_url=form_action_url gliders=gliders towplanes=towplanes %}
{% endwith %}

<!-- Resolve Issue Modal (HTMX) -->
<div class="modal fade" id="calendarModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" id="modal-body">
        <!-- HTMX will swap here -->
      </div>
    </div>
  </div>
<!-- Table Sorting -->
<!-- Table Sorting: handled centrally; add per-page hooks via tablesort:ready if needed -->
<script>
  document.addEventListener('tablesort:ready', function () {
    // No page-specific configuration needed currently for maintenance list
  });
</script>
{% endblock %}

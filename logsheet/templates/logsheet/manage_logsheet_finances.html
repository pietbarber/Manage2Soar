
{% extends "base.html" %}
{% load humanize %}


{% block content %}
{% load member_extras %}

<h2>Finances for {{ logsheet.log_date }} @ {{ logsheet.airfield }}</h2>
{% if messages %}
  <div class="container mt-3">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  </div>
{% endif %}

<h4 class="mt-5">Summary by Pilot</h4>

<table class="table table-striped table-sm sort">
  <thead>
    <tr>
      <th data-sort-method="last-name">Pilot</th>
      <th># Flights</th>
      <th class="text-end">Tow Total</th>
      <th class="text-end">Rental Total</th>
      <th class="text-end">Grand Total</th>
    </tr>
  </thead>
  <tbody>
    {% for pilot, summary in pilot_summary_sorted %}
    <tr>
      <td data-sort-value="{{ pilot.last_name|default:'' }}">{{ pilot|full_display_name }}</td>
      <td>{{ summary.count }}</td>
      <td class="text-end">${{ summary.tow|floatformat:2 }}</td>
      <td class="text-end">${{ summary.rental|floatformat:2 }}</td>
      <td class="text-end fw-bold">${{ summary.total|floatformat:2 }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<h4 class="mt-5">Member Charges</h4>
<p class="text-muted">This reflects who is financially responsible for each flight, including splits.</p>

<table class="table table-sm table-striped sort">
  <thead>
    <tr>
      <th data-sort-method="last-name">Member</th>
      <th class="text-end">Tow</th>
      <th class="text-end">Rental</th>
      <th class="text-end">Total</th>
    </tr>
  </thead>
  <tbody>
    {% for member, summary in member_charges_sorted %}
    <tr>
      <td data-sort-value="{{ member.last_name|default:'' }}">{{ member|full_display_name }}</td>
      <td class="text-end">${{ summary.tow|floatformat:2 }}</td>
      <td class="text-end">${{ summary.rental|floatformat:2 }}</td>
      <td class="text-end fw-bold">${{ summary.total|floatformat:2 }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<h4 class="mt-5">Payment Method Tracker</h4>
<!-- start form -->

<form method="post">
  {% csrf_token %}
  <table class="table table-sm table-striped table-bordered sort">
    <thead>
      <tr>
        <th data-sort-method="last-name">Member</th>
        <th>Amount</th>
        <th>Payment Method</th>
        <th>Note</th>
      </tr>
    </thead>
    <tbody>
      {% for row in member_payment_data_sorted %}
      <tr>
        <td data-sort-value="{{ row.member.last_name|default:'' }}">{{ row.member|full_display_name }}</td>
        <td>${{ row.amount|floatformat:2 }}</td>
        <td>
          <select name="payment_method_{{ row.member.id }}" 
                  class="form-select form-select-sm"
                  {% if logsheet.finalized %}disabled{% endif %}>
            <option value="">—</option>
            <option value="account" {% if row.payment_method == "account" %}selected{% endif %}>On Account</option>
            <option value="check" {% if row.payment_method == "check" %}selected{% endif %}>Check</option>
            <option value="zelle" {% if row.payment_method == "zelle" %}selected{% endif %}>Zelle</option>
            <option value="cash" {% if row.payment_method == "cash" %}selected{% endif %}>Cash</option>
          </select>
        </td>
        <td>
          <input type="text" name="note_{{ row.member.id }}" class="form-control form-control-sm"
                 value="{{ row.note }}"
                 {% if logsheet.finalized %}disabled{% endif %}>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if not logsheet.finalized %}
    <button type="submit" class="btn btn-success">Update Payments</button>
  {% endif %}
</form>

<!-- end form -->

<h4 class="mt-5">Summary by Flight</h4>
<table class="table table-striped table-bordered table-sm align-middle sort">
  <thead>
    <tr>
      <th data-sort-method="last-name">Pilot</th>
      <th>Glider</th>
      <th>Duration</th>
      <th class="text-end">Tow Cost</th>
      <th class="text-end">Rental Cost</th>
      <th class="text-end">Total</th>
      <th class="text-end">Split</th>
  {# Only show the Splits column for Payment Method Tracker, not Member Charges #}
    </tr>
  </thead>
  <tbody>
    {% for flight, costs in flight_data_sorted %}
        <tr>
          <td>{{ flight.pilot|full_display_name }}</td>
          <td>{{ flight.glider }}</td>
          <td>{{ flight.duration }}</td>
          <td class="text-end">${{ costs.tow|floatformat:2 }}</td>
          <td class="text-end">${{ costs.rental|floatformat:2 }}</td>
          <td class="text-end fw-bold">${{ costs.total|floatformat:2 }}</td>
          <td>
            {% if flight.split_with and flight.split_type %}
            <button type="button" class="btn btn-primary btn-sm edit-split-btn" data-flight-id="{{ flight.id }}"
              data-split-with="{{ flight.split_with.id|default:'' }}"
              data-split-type="{{ flight.split_type|default:'' }}"
              data-pilot-name="{{ flight.pilot|full_display_name }}"
              data-glider="{{ flight.glider }}"
              >Edit Split</button>
            {% else %}
            <button type="button" class="btn btn-outline-secondary btn-sm edit-split-btn" data-flight-id="{{ flight.id }}"
              data-split-with="{{ flight.split_with.id|default:'' }}"
              data-split-type="{{ flight.split_type|default:'' }}"
              data-pilot-name="{{ flight.pilot|full_display_name }}"
              data-glider="{{ flight.glider }}"
              >Edit Split</button>
            {% endif %}
          </td>
        </tr>
<!-- Edit Split Modal -->
<div class="modal fade" id="editSplitModal" tabindex="-1" aria-labelledby="editSplitModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editSplitModalLabel">Edit Cost Split</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="edit-split-form">
          <input type="hidden" name="flight_id" id="split-flight-id">
          <div class="mb-3">
            <label for="split-with" class="form-label">Split With</label>
            <select class="form-select" id="split-with" name="split_with">
              <option value="">— None —</option>
              {% with pilot_id=flight.pilot.id %}
                {% if active_members %}
                  <optgroup label="Active Members">
                  {% for member in active_members %}
                    {% if member.id != pilot_id %}
                      <option value="{{ member.id }}">{{ member|full_display_name }}</option>
                    {% endif %}
                  {% endfor %}
                  </optgroup>
                {% endif %}
                {% if inactive_members %}
                  <optgroup label="Non-Active Members">
                  {% for member in inactive_members %}
                    {% if member.id != pilot_id %}
                      <option value="{{ member.id }}">{{ member|full_display_name }}</option>
                    {% endif %}
                  {% endfor %}
                  </optgroup>
                {% endif %}
              {% endwith %}
            </select>
          </div>
          <div class="mb-3">
            <label for="split-type" class="form-label">Split Type</label>
            <select class="form-select" id="split-type" name="split_type">
              <option value="">— None —</option>
              <option value="even">50/50</option>
              <option value="tow">Tow Only</option>
              <option value="rental">Rental Only</option>
              <option value="full">Full Cost</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="save-split-btn">Save</button>
      </div>
    </div>
  </div>
</div>
    {% endfor %}
  </tbody>
  <tfoot>
    <tr class="table-light">
      <th colspan="3" class="text-end">Totals:</th>
      <th class="text-end">${{ total_tow|floatformat:2 }}</th>
      <th class="text-end">${{ total_rental|floatformat:2 }}</th>
      <th class="text-end">${{ total_sum|floatformat:2 }}</th>
    </tr>
  </tfoot>
</table>

<a href="{% url 'logsheet:manage' pk=logsheet.pk %}" class="btn btn-secondary">Back to Flight Log</a>

<!-- Table Sorting: use shared initializer. Attach page-specific behavior after tablesort is ready -->
<script>
  document.addEventListener('tablesort:ready', function () {
    try {
      // Ensure parser is available (tablesort-init defines it but may have been defined earlier)
      try {
        Tablesort.extend('last-name',
          function () { return true; },
          function (a, b) { return a.localeCompare(b); },
          function (td) { return td.getAttribute && td.getAttribute('data-sort-value') ? td.getAttribute('data-sort-value') : td.textContent.trim(); }
        );
      } catch (e) { /* already defined; ignore */ }

      document.querySelectorAll('table.sort').forEach(function (table) {
        var ths = table.querySelectorAll('th');
        if (ths.length > 0) {
          ths[0].setAttribute('data-sort-method', 'last-name');
        }
      });
    } catch (e) {
      console.error('Error setting up tablesort on finances page:', e);
    }
  });
</script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  var editModal = new bootstrap.Modal(document.getElementById('editSplitModal'));
  document.querySelectorAll('.edit-split-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var flightId = btn.getAttribute('data-flight-id');
      var splitWith = btn.getAttribute('data-split-with');
      var splitType = btn.getAttribute('data-split-type');
      document.getElementById('split-flight-id').value = flightId;
      document.getElementById('split-with').value = splitWith || '';
      document.getElementById('split-type').value = splitType || '';
      editModal.show();
    });
  });
  document.getElementById('save-split-btn').addEventListener('click', function() {
    var form = document.getElementById('edit-split-form');
    var data = new FormData(form);
    var flightId = document.getElementById('split-flight-id').value;
    var url = '/logsheet/flight/' + flightId + '/update_split/';
    var saveBtn = this;
    saveBtn.disabled = true;
    fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: data
    })
    .then(response => response.json())
    .then(result => {
      saveBtn.disabled = false;
      if (result.success) {
        var editModal = bootstrap.Modal.getInstance(document.getElementById('editSplitModal'));
        if (editModal) editModal.hide();
        location.reload();
      } else {
        alert(result.error || 'Failed to update split.');
      }
    })
    .catch(error => {
      saveBtn.disabled = false;
      alert('AJAX error: ' + error);
    });
  });
});
</script>



{% endblock %}

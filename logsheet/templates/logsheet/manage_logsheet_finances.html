
{% extends "base.html" %}
{% load humanize %}
{% load static %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'css/logsheet.css' %}">
{% endblock %}

{% block content %}
{% load member_extras %}

<!-- Financial Management Header -->
<div class="financial-header">
  <div class="container">
    <!-- Breadcrumb Navigation -->
    <div class="financial-breadcrumb">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a href="{% url 'logsheet:manage' pk=logsheet.pk %}">
              <i class="bi bi-journal-text me-1"></i>
              Management
            </a>
          </li>
          <li class="breadcrumb-item active" aria-current="page">
            <i class="bi bi-currency-dollar me-1"></i>
            Finances
          </li>
        </ol>
      </nav>
    </div>

    <!-- Header Content -->
    <div class="header-content">
      <div class="d-flex align-items-center gap-3 mb-3">
        <i class="bi bi-currency-dollar" style="font-size: 2rem; color: white;"></i>
        <div>
          <h1 class="mb-1" style="color: white;">Financial Management</h1>
          <p class="mb-0" style="color: rgba(255, 255, 255, 0.9);">
            {{ logsheet.log_date|date:"F j, Y" }} @ {{ logsheet.airfield }}
          </p>
        </div>
      </div>

      <!-- Status Indicator -->
      <div class="logsheet-status {% if logsheet.finalized %}logsheet-status-finalized{% else %}logsheet-status-editable{% endif %}">
        {% if logsheet.finalized %}
          <i class="bi bi-lock-fill me-2"></i>
          Finalized - View Only
        {% else %}
          <i class="bi bi-pencil me-2"></i>
          Editable
        {% endif %}
      </div>
    </div>

    <!-- Messages -->
    {% if messages %}
      <div class="mt-3">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            <i class="bi bi-info-circle me-2"></i>
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>
</div>

<!-- Main Content Container -->
<div class="container">
  <h4 class="mb-4">
    <i class="bi bi-person-circle text-primary me-2"></i>
    Summary by Pilot
  </h4>

<div class="finance-table-container">
  <table class="table finance-table align-middle" data-sort>
    <thead>
      <tr>
        <th data-sort-method="string">Pilot</th>
        <th data-sort-method="number"># Flights</th>
        <th class="text-end" data-sort-method="number">Tow Total</th>
        <th class="text-end" data-sort-method="number">Rental Total</th>
        <th class="text-end" data-sort-method="number">Grand Total</th>
      </tr>
    </thead>
  <tbody>
    {% for pilot, summary in pilot_summary_sorted %}
    <tr>
      <td data-sort-value="{{ pilot.last_name|default:'' }}">{{ pilot|full_display_name }}</td>
      <td>{{ summary.count }}</td>
      <td class="text-end">${{ summary.tow|floatformat:2 }}</td>
      <td class="text-end">${{ summary.rental|floatformat:2 }}</td>
      <td class="text-end fw-bold">${{ summary.total|floatformat:2 }}</td>
    </tr>
    {% endfor %}
    </tbody>
  </table>
</div>

<h4 class="mb-3 mt-5">
  <i class="bi bi-credit-card text-success me-2"></i>
  Member Charges
</h4>
<p class="text-muted mb-4">This reflects who is financially responsible for each flight, including splits.</p>

<div class="finance-table-container">
  <table class="table finance-table align-middle" data-sort>
    <thead>
      <tr>
        <th data-sort-method="string">Member</th>
        <th class="text-end" data-sort-method="number">Tow</th>
        <th class="text-end" data-sort-method="number">Rental</th>
        {% if towplane_rental_enabled %}<th class="text-end" data-sort-method="number">Towplane Rental</th>{% endif %}
        <th class="text-end" data-sort-method="number">Total</th>
      </tr>
    </thead>
  <tbody>
    {% for member, summary in member_charges_sorted %}
    <tr>
      <td data-sort-value="{{ member.last_name|default:'' }}">{{ member|full_display_name }}</td>
      <td class="text-end">${{ summary.tow|floatformat:2 }}</td>
      <td class="text-end">${{ summary.rental|floatformat:2 }}</td>
      {% if towplane_rental_enabled %}<td class="text-end">${{ summary.towplane_rental|floatformat:2 }}</td>{% endif %}
      <td class="text-end fw-bold">${{ summary.total|floatformat:2 }}</td>
    </tr>
    {% endfor %}
    </tbody>
  </table>
</div>

{% if towplane_data and towplane_rental_enabled %}
<h4 class="mb-3 mt-5">
  <i class="bi bi-airplane-engines text-secondary me-2"></i>
  Towplane Rental Charges
</h4>
<p class="text-muted mb-4">Non-towing towplane usage (sightseeing, flight reviews, retrieval flights, etc.)</p>

<div class="finance-table-container">
  <table class="table finance-table align-middle" data-sort>
    <thead>
      <tr>
        <th data-sort-method="string">Towplane</th>
        <th data-sort-method="number">Rental Hours</th>
        <th data-sort-method="string">Charged To</th>
        <th class="text-end" data-sort-method="number">Cost</th>
      </tr>
    </thead>
  <tbody>
    {% for closeout, rental_cost in towplane_data %}
    {% if closeout.rental_hours_chargeable %}
    <tr>
      <td>{{ closeout.towplane }}</td>
      <td>{{ closeout.rental_hours_chargeable }} hrs</td>
      <td>{{ closeout.rental_charged_to.full_display_name|default:"—" }}</td>
      <td class="text-end">{{ closeout.rental_cost_display }}</td>
    </tr>
    {% endif %}
    {% endfor %}
    </tbody>
  </table>
</div>
{% endif %}

<h4 class="mb-3 mt-5">
  <i class="bi bi-wallet2 text-warning me-2"></i>
  Payment Method Tracker
</h4>
<!-- start form -->

<form method="post">
  {% csrf_token %}
  <div class="finance-table-container">
    <table class="table finance-table align-middle" data-sort>
      <thead>
        <tr>
          <th data-sort-method="string">Member</th>
          <th data-sort-method="number">Amount</th>
          <th class="no-sort">Payment Method</th>
          <th class="no-sort">Note</th>
        </tr>
      </thead>
    <tbody>
      {% for row in member_payment_data_sorted %}
      <tr>
        <td data-sort-value="{{ row.member.last_name|default:'' }}">{{ row.member|full_display_name }}</td>
        <td>${{ row.amount|floatformat:2 }}</td>
        <td>
          <select name="payment_method_{{ row.member.id }}"
                  class="form-select form-select-sm"
                  {% if logsheet.finalized %}disabled{% endif %}>
            <option value="">—</option>
            <option value="account" {% if row.payment_method == "account" %}selected{% endif %}>On Account</option>
            <option value="check" {% if row.payment_method == "check" %}selected{% endif %}>Check</option>
            <option value="zelle" {% if row.payment_method == "zelle" %}selected{% endif %}>Zelle</option>
            <option value="cash" {% if row.payment_method == "cash" %}selected{% endif %}>Cash</option>
          </select>
        </td>
        <td>
          <input type="text" name="note_{{ row.member.id }}" class="form-control form-control-sm"
                 value="{{ row.note }}"
                 {% if logsheet.finalized %}disabled{% endif %}>
        </td>
      </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  {% if not logsheet.finalized %}
    <button type="submit" class="payment-update-btn">Update Payments</button>
  {% endif %}
</form>

<!-- end form -->

<h4 class="mb-3 mt-5">
  <i class="bi bi-airplane text-info me-2"></i>
  Summary by Flight
</h4>
<div class="finance-table-container">
  <table class="table finance-table align-middle" data-sort>
    <thead>
      <tr>
        <th data-sort-method="string">Pilot</th>
        <th data-sort-method="string">Glider</th>
        <th data-sort-method="duration">Duration</th>
        <th class="text-end" data-sort-method="number">Tow Cost</th>
        <th class="text-end" data-sort-method="number">Rental Cost</th>
        <th class="text-end" data-sort-method="number">Total</th>
        <th class="text-end no-sort">Split</th>
        {# Only show the Splits column for Payment Method Tracker, not Member Charges #}
      </tr>
    </thead>
  <tbody>
    {% for flight, costs in flight_data_sorted %}
        <tr>
          <td>{{ flight.pilot|full_display_name }}</td>
          <td>{{ flight.glider }}</td>
          <td>{{ flight.duration }}</td>
          <td class="text-end">${{ costs.tow|floatformat:2 }}</td>
          <td class="text-end">${{ costs.rental|floatformat:2 }}</td>
          <td class="text-end fw-bold">${{ costs.total|floatformat:2 }}</td>
          <td>
            {% if not logsheet.finalized %}
              {% if flight.split_with and flight.split_type %}
              <button type="button" class="btn btn-primary btn-sm edit-split-btn" data-flight-id="{{ flight.id }}"
                data-split-with="{{ flight.split_with.id|default:'' }}"
                data-split-type="{{ flight.split_type|default:'' }}"
                data-pilot-name="{{ flight.pilot|full_display_name }}"
                data-glider="{{ flight.glider }}"
                >Edit Split</button>
              {% else %}
              <button type="button" class="btn btn-outline-secondary btn-sm edit-split-btn" data-flight-id="{{ flight.id }}"
                data-split-with="{{ flight.split_with.id|default:'' }}"
                data-split-type="{{ flight.split_type|default:'' }}"
                data-pilot-name="{{ flight.pilot|full_display_name }}"
                data-glider="{{ flight.glider }}"
                >Edit Split</button>
              {% endif %}
            {% else %}
              {% if flight.split_with and flight.split_type %}
                <button type="button" class="btn btn-info btn-sm view-split-btn"
                  data-flight-id="{{ flight.id }}"
                  data-pilot-name="{{ flight.pilot|full_display_name }}"
                  data-split-with-name="{{ flight.split_with|full_display_name }}"
                  data-split-type="{{ flight.split_type }}"
                  data-glider="{{ flight.glider }}"
                  data-duration="{{ flight.duration }}"
                  data-tow-cost="{{ costs.tow|floatformat:2 }}"
                  data-rental-cost="{{ costs.rental|floatformat:2 }}"
                  data-total-cost="{{ costs.total|floatformat:2 }}">
                  <i class="bi bi-eye me-1"></i>View Split
                </button>
              {% else %}
                <span class="text-muted"><i class="bi bi-dash-circle me-1"></i>No split</span>
              {% endif %}
            {% endif %}
          </td>
        </tr>
<!-- Edit Split Modal -->
<div class="modal fade" id="editSplitModal" tabindex="-1" aria-labelledby="editSplitModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editSplitModalLabel">Edit Cost Split</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="edit-split-form">
          <input type="hidden" name="flight_id" id="split-flight-id">
          <div class="mb-3">
            <label for="split-with" class="form-label">Split With</label>
            <select class="form-select" id="split-with" name="split_with">
              <option value="">— None —</option>
              {% with pilot_id=flight.pilot.id %}
                {% if active_members %}
                  <optgroup label="Active Members">
                  {% for member in active_members %}
                    {% if member.id != pilot_id %}
                      <option value="{{ member.id }}">{{ member|full_display_name }}</option>
                    {% endif %}
                  {% endfor %}
                  </optgroup>
                {% endif %}
                {% if inactive_members %}
                  <optgroup label="Non-Active Members">
                  {% for member in inactive_members %}
                    {% if member.id != pilot_id %}
                      <option value="{{ member.id }}">{{ member|full_display_name }}</option>
                    {% endif %}
                  {% endfor %}
                  </optgroup>
                {% endif %}
              {% endwith %}
            </select>
          </div>
          <div class="mb-3">
            <label for="split-type" class="form-label">Split Type</label>
            <select class="form-select" id="split-type" name="split_type">
              <option value="">— None —</option>
              <option value="even">50/50</option>
              <option value="tow">Tow Only</option>
              <option value="rental">Rental Only</option>
              <option value="full">Full Cost</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="save-split-btn">Save</button>
      </div>
    </div>
  </div>
</div>
    {% endfor %}
  </tbody>
  <tfoot>
    <tr class="table-light">
      <th colspan="3" class="text-end">Totals:</th>
      <th class="text-end">${{ total_tow|floatformat:2 }}</th>
      <th class="text-end">${{ total_rental|floatformat:2 }}</th>
      <th class="text-end">${{ total_tow|add:total_rental|floatformat:2 }}</th>
      <th></th>
    </tr>
    </tfoot>
  </table>
</div>

<!-- View Split Modal (Read-only for finalized logsheets) -->
<div class="modal fade" id="viewSplitModal" tabindex="-1" aria-labelledby="viewSplitModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="viewSplitModalLabel">
          <i class="bi bi-eye me-2"></i>View Cost Split Details
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <h6 class="text-muted mb-2">Flight Details</h6>
            <div class="border rounded p-3 bg-light">
              <div><strong>Pilot:</strong> <span id="view-pilot-name"></span></div>
              <div><strong>Glider:</strong> <span id="view-glider"></span></div>
              <div><strong>Duration:</strong> <span id="view-duration"></span></div>
            </div>
          </div>
          <div class="col-md-6">
            <h6 class="text-muted mb-2">Split Information</h6>
            <div class="border rounded p-3 bg-light">
              <div><strong>Split With:</strong> <span id="view-split-with-name"></span></div>
              <div><strong>Split Type:</strong> <span id="view-split-type-display"></span></div>
            </div>
          </div>
        </div>

        <h6 class="text-muted mb-2">Cost Breakdown</h6>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead class="table-light">
              <tr>
                <th>Cost Type</th>
                <th class="text-end">Total Amount</th>
                <th class="text-end">Pilot Pays</th>
                <th class="text-end">Partner Pays</th>
              </tr>
            </thead>
            <tbody id="view-split-breakdown">
              <!-- Cost breakdown will be populated by JavaScript -->
            </tbody>
            <tfoot class="table-info">
              <tr>
                <th>Total</th>
                <th class="text-end" id="view-total-amount"></th>
                <th class="text-end" id="view-pilot-total"></th>
                <th class="text-end" id="view-partner-total"></th>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<a href="{% url 'logsheet:manage' pk=logsheet.pk %}" class="btn btn-secondary">Back to Flight Log</a>

<!-- Table Sorting: use shared initializer. Attach page-specific behavior after tablesort is ready -->
<script>
  // Initialize all sortable tables on page load
  document.addEventListener('DOMContentLoaded', function() {
    const tables = document.querySelectorAll('[data-sort]');
    tables.forEach(table => {
      if (typeof Tablesort !== 'undefined') {
        new Tablesort(table);
      }
    });
  });

  document.addEventListener('tablesort:ready', function () {
    try {
      // Ensure parser is available (tablesort-init defines it but may have been defined earlier)
      try {
        Tablesort.extend('last-name',
          function () { return true; },
          function (a, b) { return a.localeCompare(b); },
          function (td) { return td.getAttribute && td.getAttribute('data-sort-value') ? td.getAttribute('data-sort-value') : td.textContent.trim(); }
        );
      } catch (e) { /* already defined; ignore */ }

      document.querySelectorAll('table.sort').forEach(function (table) {
        var ths = table.querySelectorAll('th');
        if (ths.length > 0) {
          ths[0].setAttribute('data-sort-method', 'last-name');
        }
      });
    } catch (e) {
      console.error('Error setting up tablesort on finances page:', e);
    }
  });
</script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  var editModal = new bootstrap.Modal(document.getElementById('editSplitModal'));
  document.querySelectorAll('.edit-split-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var flightId = btn.getAttribute('data-flight-id');
      var splitWith = btn.getAttribute('data-split-with');
      var splitType = btn.getAttribute('data-split-type');
      document.getElementById('split-flight-id').value = flightId;
      document.getElementById('split-with').value = splitWith || '';
      document.getElementById('split-type').value = splitType || '';
      editModal.show();
    });
  });
  document.getElementById('save-split-btn').addEventListener('click', function() {
    var form = document.getElementById('edit-split-form');
    var data = new FormData(form);
    var flightId = document.getElementById('split-flight-id').value;
    var url = '/logsheet/flight/' + flightId + '/update_split/';
    var saveBtn = this;
    saveBtn.disabled = true;
    fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: data
    })
    .then(response => response.json())
    .then(result => {
      saveBtn.disabled = false;
      if (result.success) {
        var editModal = bootstrap.Modal.getInstance(document.getElementById('editSplitModal'));
        if (editModal) editModal.hide();
        location.reload();
      } else {
        alert(result.error || 'Failed to update split.');
      }
    })
    .catch(error => {
      saveBtn.disabled = false;
      alert('AJAX error: ' + error);
    });
  });

  // View Split Modal Handler
  var viewModal = new bootstrap.Modal(document.getElementById('viewSplitModal'));
  document.querySelectorAll('.view-split-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var pilotName = btn.getAttribute('data-pilot-name');
      var splitWithName = btn.getAttribute('data-split-with-name');
      var splitType = btn.getAttribute('data-split-type');
      var glider = btn.getAttribute('data-glider');
      var duration = btn.getAttribute('data-duration');
      var towCost = parseFloat(btn.getAttribute('data-tow-cost'));
      var rentalCost = parseFloat(btn.getAttribute('data-rental-cost'));
      var totalCost = parseFloat(btn.getAttribute('data-total-cost'));

      // Populate flight details
      document.getElementById('view-pilot-name').textContent = pilotName;
      document.getElementById('view-glider').textContent = glider;
      document.getElementById('view-duration').textContent = duration;
      document.getElementById('view-split-with-name').textContent = splitWithName;

      // Display readable split type
      var splitTypeDisplay = '';
      switch(splitType) {
        case 'even': splitTypeDisplay = '50/50 Split'; break;
        case 'tow': splitTypeDisplay = 'Tow Only'; break;
        case 'rental': splitTypeDisplay = 'Rental Only'; break;
        case 'full': splitTypeDisplay = 'Full Cost'; break;
        default: splitTypeDisplay = splitType;
      }
      document.getElementById('view-split-type-display').textContent = splitTypeDisplay;

      // Calculate split amounts
      // IMPORTANT: This logic must match the backend calculation in views.py lines 990-997
      // If split calculation changes, update BOTH locations!
      var pilotTow = 0, pilotRental = 0, partnerTow = 0, partnerRental = 0;

      if (splitType === 'even') {
        // For 50/50 splits, divide both tow and rental costs equally
        var halfTow = towCost / 2;
        var halfRental = rentalCost / 2;
        pilotTow = halfTow;
        pilotRental = halfRental;
        partnerTow = halfTow;
        partnerRental = halfRental;
      } else if (splitType === 'tow') {
        pilotTow = 0;
        pilotRental = rentalCost;
        partnerTow = towCost;
        partnerRental = 0;
      } else if (splitType === 'rental') {
        pilotTow = towCost;
        pilotRental = 0;
        partnerTow = 0;
        partnerRental = rentalCost;
      } else if (splitType === 'full') {
        pilotTow = 0;
        pilotRental = 0;
        partnerTow = towCost;
        partnerRental = rentalCost;
      }

      // Build cost breakdown table
      var breakdown = document.getElementById('view-split-breakdown');
      breakdown.innerHTML = '';

      if (splitType === 'even') {
        breakdown.innerHTML = `
          <tr>
            <td>Total Cost (Split 50/50)</td>
            <td class="text-end">$${totalCost.toFixed(2)}</td>
            <td class="text-end">$${(totalCost/2).toFixed(2)}</td>
            <td class="text-end">$${(totalCost/2).toFixed(2)}</td>
          </tr>`;
      } else {
        breakdown.innerHTML = `
          <tr>
            <td>Tow Cost</td>
            <td class="text-end">$${towCost.toFixed(2)}</td>
            <td class="text-end">$${pilotTow.toFixed(2)}</td>
            <td class="text-end">$${partnerTow.toFixed(2)}</td>
          </tr>
          <tr>
            <td>Rental Cost</td>
            <td class="text-end">$${rentalCost.toFixed(2)}</td>
            <td class="text-end">$${pilotRental.toFixed(2)}</td>
            <td class="text-end">$${partnerRental.toFixed(2)}</td>
          </tr>`;
      }

      // Update totals
      var pilotTotal = pilotTow + pilotRental;
      var partnerTotal = partnerTow + partnerRental;

      document.getElementById('view-total-amount').textContent = '$' + totalCost.toFixed(2);
      document.getElementById('view-pilot-total').textContent = '$' + pilotTotal.toFixed(2);
      document.getElementById('view-partner-total').textContent = '$' + partnerTotal.toFixed(2);

      viewModal.show();
    });
  });
});
</script>

</div> <!-- Close main content container -->

{% endblock %}

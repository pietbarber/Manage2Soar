{% extends "base.html" %}
{% load static %}
{% load member_extras %}
{% block title %}Member Directory{% endblock %}

{% block content %}
<div id="top"></div>

<!-- Header Section -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="display-6 fw-bold text-primary mb-1">
      <i class="bi bi-people me-2"></i>Club Members
    </h1>
    <p class="text-muted mb-0">Connect with fellow soaring enthusiasts</p>
  </div>
  {% if user.is_staff %}
  <a href="/admin/members/member/add/" class="btn btn-success btn-modern">
    <i class="bi bi-person-plus me-2"></i>Add New Member
  </a>
  {% endif %}
</div>

<!-- Role Badge Legend -->
{% duty_emoji_legend %}

<!-- Search Section -->
<div class="search-section">
  <div class="row">
    <div class="col-lg-6 mx-auto">
      <div class="input-group input-group-lg">
        <span class="input-group-text bg-white border-end-0">
          <i class="bi bi-search text-muted"></i>
        </span>
        <input type="text" class="form-control search-input border-start-0" placeholder="Search members by name, email, or role..." id="memberSearch">
      </div>
    </div>
  </div>
</div>

<!-- Filter Section -->
<div class="filter-section">
  <form method="get" id="filterForm">
    <div class="row g-3">
      <div class="col-md-6">
        <h6 class="fw-bold text-primary mb-3">
          <i class="bi bi-funnel me-2"></i>Filter by Status
        </h6>
        <div class="d-flex flex-wrap gap-3">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="status" value="active" id="statusActive" checked>
            <label class="form-check-label" for="statusActive">
              <span class="badge bg-success me-1">Active</span>
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="status" value="pending" id="statusPending">
            <label class="form-check-label" for="statusPending">
              <span class="badge bg-warning text-dark me-1">Pending</span>
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="status" value="inactive" id="statusInactive">
            <label class="form-check-label" for="statusInactive">
              <span class="badge bg-secondary me-1">Inactive</span>
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="status" value="nonmember" id="statusNonmember">
            <label class="form-check-label" for="statusNonmember">
              <span class="badge bg-danger me-1">Non-member</span>
            </label>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <h6 class="fw-bold text-primary mb-3">
          <i class="bi bi-person-badge me-2"></i>Filter by Role
        </h6>
        <div class="d-flex flex-wrap gap-3">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="role" value="towpilot" id="roleTowpilot" {% if 'towpilot' in selected_roles %}checked{% endif %}>
            <label class="form-check-label" for="roleTowpilot">
              <span class="badge bg-success me-1"><i class="bi bi-airplane"></i> Tow Pilot</span>
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="role" value="instructor" id="roleInstructor" {% if 'instructor' in selected_roles %}checked{% endif %}>
            <label class="form-check-label" for="roleInstructor">
              <span class="badge bg-primary me-1"><i class="bi bi-mortarboard"></i> Instructor</span>
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="role" value="director" id="roleDirector" {% if 'director' in selected_roles %}checked{% endif %}>
            <label class="form-check-label" for="roleDirector">
              <span class="badge bg-danger me-1"><i class="bi bi-person-badge"></i> Director</span>
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="role" value="dutyofficer" id="roleDutyOfficer" {% if 'duty_officer' in selected_roles %}checked{% endif %}>
            <label class="form-check-label" for="roleDutyOfficer">
              <span class="badge bg-warning text-dark me-1"><i class="bi bi-clipboard-check"></i> Duty Officer</span>
            </label>
          </div>
        </div>
      </div>
    </div>
    <div class="row mt-3">
      <div class="col-12 text-center">
        <button type="submit" class="btn btn-primary btn-modern me-2">
          <i class="bi bi-funnel me-2"></i>Apply Filters
        </button>
        <a href="{% url 'members:member_list' %}" class="btn btn-outline-secondary btn-modern">
          <i class="bi bi-arrow-clockwise me-2"></i>Reset
        </a>
      </div>
    </div>
  </form>
</div>
<!-- Members Grid -->
<div class="row g-4" id="membersGrid">
  {% for member in members %}
  <div class="col-xl-4 col-lg-6 col-md-6 member-item" data-name="{{ member.full_display_name|lower }}" data-email="{{ member.email|lower }}" data-roles="{{ member|member_roles }}">
    <div class="card member-card h-100">
      <div class="card-body">
        <div class="d-flex align-items-start mb-3">
          <!-- Profile Photo -->
          <div class="flex-shrink-0 me-3">
            {% if member.profile_photo %}
            <img src="{{ member.profile_photo.url }}" alt="Profile photo" width="80" height="80" class="rounded-circle member-avatar">
            {% else %}
            <img src="{% static 'images/default-avatar-100px.png' %}" width="80" height="80" class="rounded-circle member-avatar">
            {% endif %}
          </div>

          <!-- Member Info -->
          <div class="flex-grow-1">
            <h5 class="member-name mb-1">
              {{ member.full_display_name }}
              {% if member.biography %}
              <i class="bi bi-journal-text text-primary ms-1" title="Has biography"></i>
              {% endif %}
            </h5>

            <!-- Membership Status -->
            <div class="mb-2">
              {% if member.membership_status == "Full Member" %}
              <span class="badge bg-success">{{ member.membership_status }}</span>
              {% elif member.membership_status == "Pending" %}
              <span class="badge bg-warning text-dark">{{ member.membership_status }}</span>
              {% elif member.membership_status == "Inactive" %}
              <span class="badge bg-secondary">{{ member.membership_status }}</span>
              {% else %}
              <span class="badge bg-danger">{{ member.membership_status }}</span>
              {% endif %}
            </div>

            <!-- Contact Information -->
            <div class="member-contact small">
              {% if not member.redact_contact %}
                <div class="mb-1">
                  <i class="bi bi-envelope text-muted me-1"></i>
                  <a href="mailto:{{ member.email }}" class="text-decoration-none">{{ member.email }}</a>
                </div>
                {% if member.phone and member.phone == member.mobile_phone %}
                <div class="mb-1">
                  <i class="bi bi-telephone text-muted me-1"></i>
                  <a href="tel:{{ member.phone }}" class="text-decoration-none">{{ member.phone|format_us_phone }}</a>
                </div>
                {% else %}
                  {% if member.phone %}
                  <div class="mb-1">
                    <i class="bi bi-telephone text-muted me-1"></i>
                    <a href="tel:{{ member.phone }}" class="text-decoration-none">{{ member.phone|format_us_phone }}</a>
                  </div>
                  {% endif %}
                  {% if member.mobile_phone %}
                  <div class="mb-1">
                    <i class="bi bi-phone text-muted me-1"></i>
                    <a href="tel:{{ member.mobile_phone }}" class="text-decoration-none">{{ member.mobile_phone|format_us_phone }}</a>
                  </div>
                  {% endif %}
                {% endif %}
              {% else %}
                <div class="text-muted fst-italic">
                  <i class="bi bi-eye-slash me-1"></i>Contact information redacted
                </div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Duties Section -->
        <div class="member-duties">
          <h6 class="small text-muted mb-2">
            <i class="bi bi-person-workspace me-1"></i>Roles & Duties
          </h6>
          <div class="d-flex flex-wrap">
            {{ member|render_duties|safe }}
          </div>
        </div>
      </div>

      <!-- Card Footer -->
      <div class="card-footer bg-transparent border-0 pt-0">
        <div class="d-grid">
          <a href="{% url 'members:member_view' member.id %}" class="btn btn-outline-primary btn-modern">
            <i class="bi bi-person-lines-fill me-2"></i>View Profile
          </a>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Empty State -->
{% if not members %}
<div class="text-center py-5">
  <i class="bi bi-people display-1 text-muted mb-3"></i>
  <h3 class="text-muted">No members found</h3>
  <p class="text-muted">Try adjusting your filters or search criteria.</p>
</div>
{% endif %}

<!-- Pagination -->
{% if page_obj.paginator.num_pages > 1 %}
<nav aria-label="Member list pagination" class="mt-5">
  <ul class="pagination pagination-modern">
    {% if page_obj.has_previous %}
    <li class="page-item">
      <a class="page-link" href="?{{ request.GET.urlencode }}&page=1">
        <i class="bi bi-chevron-double-left"></i>
      </a>
    </li>
    <li class="page-item">
      <a class="page-link" href="?{{ request.GET.urlencode }}&page={{ page_obj.previous_page_number }}">
        <i class="bi bi-chevron-left"></i> Previous
      </a>
    </li>
    {% endif %}

    <!-- Page numbers -->
    {% for num in page_obj.paginator.page_range %}
      {% if page_obj.number == num %}
      <li class="page-item active">
        <span class="page-link">{{ num }}</span>
      </li>
      {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
      <li class="page-item">
        <a class="page-link" href="?{{ request.GET.urlencode }}&page={{ num }}">{{ num }}</a>
      </li>
      {% endif %}
    {% endfor %}

    {% if page_obj.has_next %}
    <li class="page-item">
      <a class="page-link" href="?{{ request.GET.urlencode }}&page={{ page_obj.next_page_number }}">
        Next <i class="bi bi-chevron-right"></i>
      </a>
    </li>
    <li class="page-item">
      <a class="page-link" href="?{{ request.GET.urlencode }}&page={{ page_obj.paginator.num_pages }}">
        <i class="bi bi-chevron-double-right"></i>
      </a>
    </li>
    {% endif %}
  </ul>

  <div class="text-center text-muted mt-3">
    <small>
      Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} members
    </small>
  </div>
</nav>
{% endif %}

<!-- Back to Top Button -->
<button class="back-to-top" onclick="document.getElementById('top').scrollIntoView({behavior: 'smooth'})" title="Back to Top">
  <i class="bi bi-arrow-up"></i>
</button>

{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Live search functionality
    const searchInput = document.getElementById('memberSearch');
    const memberItems = document.querySelectorAll('.member-item');

    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();

            memberItems.forEach(function(item) {
                const name = item.dataset.name || '';
                const email = item.dataset.email || '';
                const roles = item.dataset.roles || '';

                if (name.includes(searchTerm) || email.includes(searchTerm) || roles.includes(searchTerm)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    }    // Auto-submit form on role filter changes only (not status filters)
    const roleCheckboxes = document.querySelectorAll('#filterForm input[name="role"]');
    let memberListFilterTimeout;
    roleCheckboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            // Add a small delay to allow multiple rapid changes
            clearTimeout(memberListFilterTimeout);
            memberListFilterTimeout = setTimeout(function() {
                document.getElementById('filterForm').submit();
            }, 300);
        });
    });
});
</script>
{% endblock %}

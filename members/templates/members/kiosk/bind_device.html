{% extends "base.html" %}
{% load static %}

{% block title %}Register Device - {{ kiosk_token.name }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-laptop me-2"></i>
                        Kiosk Device Registration
                    </h4>
                </div>
                <div class="card-body text-center py-5">
                    <div id="status-registering">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Registering device...</span>
                        </div>
                        <h5>Registering this device...</h5>
                        <p class="text-muted">Please wait while we securely bind this kiosk token to your device.</p>
                    </div>

                    <div id="status-success" class="d-none">
                        <i class="bi bi-check-circle text-success" style="font-size: 4rem;"></i>
                        <h4 class="mt-3 text-success">Device Registered!</h4>
                        <p class="text-muted">Redirecting to operations...</p>
                    </div>

                    <div id="status-error" class="d-none">
                        <i class="bi bi-x-circle text-danger" style="font-size: 4rem;"></i>
                        <h4 class="mt-3 text-danger">Registration Failed</h4>
                        <p id="error-message" class="text-muted"></p>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <small class="text-muted">
                        <i class="bi bi-shield-check me-1"></i>
                        Token: <strong>{{ kiosk_token.name }}</strong> |
                        This device will be bound to this token for secure access.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Import shared fingerprinting module -->
<script src="{% static 'js/kiosk_fingerprint.js' %}"></script>
<script>
/**
 * Device Binding Script
 * Uses kiosk_fingerprint.js for fingerprint collection (addresses Copilot issue #485)
 */
(function() {
    'use strict';

    /**
     * Send fingerprint to server for binding
     */
    async function bindDevice(fingerprint) {
        const response = await fetch('{% url "members:kiosk_bind_device" token=token %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(),
            },
            body: JSON.stringify({ fingerprint: fingerprint }),
        });

        return await response.json();
    }

    /**
     * Show success state and redirect
     */
    function showSuccess(redirectUrl) {
        document.getElementById('status-registering').classList.add('d-none');
        document.getElementById('status-success').classList.remove('d-none');

        setTimeout(function() {
            window.location.href = redirectUrl;
        }, 1500);
    }

    /**
     * Show error state
     */
    function showError(message) {
        document.getElementById('status-registering').classList.add('d-none');
        document.getElementById('status-error').classList.remove('d-none');
        document.getElementById('error-message').textContent = message;
    }

    /**
     * Main initialization
     */
    async function init() {
        try {
            // Collect fingerprint using shared module
            const fingerprint = await collectFingerprint();

            // Send to server
            const result = await bindDevice(fingerprint);

            if (result.success) {
                showSuccess(result.redirect);
            } else {
                showError(result.error || 'Unknown error occurred');
            }
        } catch (error) {
            console.error('Device binding error:', error);
            showError('Failed to register device. Please try again.');
        }
    }

    // Run on page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
</script>
{% endblock %}

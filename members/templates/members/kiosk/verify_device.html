{% extends "base.html" %}
{% load static %}

{% block title %}Verify Device - {{ kiosk_token.name }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-shield-check me-2"></i>
                        Kiosk Device Verification
                    </h4>
                </div>
                <div class="card-body text-center py-5">
                    <div id="status-verifying">
                        <div class="spinner-border text-info mb-3" role="status">
                            <span class="visually-hidden">Verifying device...</span>
                        </div>
                        <h5>Verifying device identity...</h5>
                        <p class="text-muted">Please wait while we confirm this is the authorized device.</p>
                    </div>

                    <div id="status-success" class="d-none">
                        <i class="bi bi-check-circle text-success" style="font-size: 4rem;"></i>
                        <h4 class="mt-3 text-success">Device Verified!</h4>
                        <p class="text-muted">Welcome back. Redirecting...</p>
                    </div>

                    <div id="status-error" class="d-none">
                        <i class="bi bi-shield-x text-danger" style="font-size: 4rem;"></i>
                        <h4 class="mt-3 text-danger">Device Mismatch</h4>
                        <p id="error-message" class="text-muted">
                            This token is registered to a different device.
                        </p>
                        <hr>
                        <p class="small text-muted">
                            If the original device is no longer available, please contact
                            the club administrator to reset the token binding.
                        </p>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <small class="text-muted">
                        <i class="bi bi-laptop me-1"></i>
                        Token: <strong>{{ kiosk_token.name }}</strong>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Import shared fingerprinting module -->
<script src="{% static 'js/kiosk_fingerprint.js' %}"></script>
<script>
/**
 * Device Verification Script
 * Uses kiosk_fingerprint.js for fingerprint collection (addresses Copilot issue #485)
 */
(function() {
    'use strict';

    /**
     * Send fingerprint to server for verification
     */
    async function verifyDevice(fingerprint) {
        const response = await fetch('{% url "members:kiosk_verify_device" token=token %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(),
            },
            body: JSON.stringify({ fingerprint: fingerprint }),
        });

        return await response.json();
    }

    /**
     * Show success state and redirect
     */
    function showSuccess(redirectUrl) {
        document.getElementById('status-verifying').classList.add('d-none');
        document.getElementById('status-success').classList.remove('d-none');

        setTimeout(function() {
            window.location.href = redirectUrl;
        }, 1000);
    }

    /**
     * Show error state
     */
    function showError(message) {
        document.getElementById('status-verifying').classList.add('d-none');
        document.getElementById('status-error').classList.remove('d-none');
        if (message) {
            document.getElementById('error-message').textContent = message;
        }
    }

    /**
     * Main initialization
     */
    async function init() {
        try {
            // Collect fingerprint using shared module
            const fingerprint = await collectFingerprint();
            const result = await verifyDevice(fingerprint);

            if (result.success) {
                showSuccess(result.redirect);
            } else {
                showError(result.error);
            }
        } catch (error) {
            console.error('Device verification error:', error);
            showError('Failed to verify device. Please try again.');
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
</script>
{% endblock %}

{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load static %}
{% load member_extras %}

{% block title %}View Member: {{ member.full_display_name }}{% endblock %}

{% block content %}
{% duty_emoji_legend %}

<div class="container mt-4">
  {% if member.redact_contact and request.user.rostermeister %}
  <!-- Modal shown to rostermeisters to inform about redaction policy -->
  <div class="modal fade" id="redaction-alert-modal" tabindex="-1" aria-labelledby="redactionAlertLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="redactionAlertLabel">Redacted Contact Information</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>This member has chosen to redact their personal contact information on the public members directory.</p>
          <p>As a rostermeister, you may view this information when necessary. Please exercise discretion when sharing or using it.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Dismiss</button>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  {# can_view_personal_info is computed in the view and passed in context #}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>{{ member.full_display_name }}</h2>
    {% if request.user.rostermeister or request.user.is_staff %}
    <a href="{% url 'admin:members_member_change' member.id %}" class="btn btn-success btn-sm">
      Edit this member
    </a>
    {% endif %}
  </div>

  <div class="row">
    <div class="col-md-4">
      {% if member.profile_photo %}
      <img src="{{ member.profile_photo.url }}" class="img-thumbnail" alt="Profile Photo">
      {% else %}
      <img src="{% static 'images/default-avatar-large.png' %}" class="img-thumbnail" alt="Default Avatar">
      {% endif %}
      {% if is_self %}
      <h5>Update Profile Photo</h5>
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        {{ form.profile_photo|as_crispy_field }}
        <button type="submit" class="btn btn-primary mt-2">Update Photo</button>
      </form>
      {% endif %}
      <br><br>
      {% if not member.redact_contact or request.user == member or request.user.is_staff %}
      <h5>Contact Card QR Code</h5>
      <img src="data:image/png;base64,{{ qr_base64 }}" alt="vCard QR Code" class="img-thumbnail"
        style="max-width: 200px;">
      {% elif request.user.rostermeister %}
      <h5>Contact Card QR Code</h5>
      <div>
        <button type="button" class="btn btn-outline-secondary btn-sm spoiler-blind-btn" data-field="qr" data-member-id="{{ member.id }}">Redacted ‚Äî click to reveal</button>
        <div class="mt-2 d-none spoiler-hidden" id="qr-{{ member.id }}">
          <img src="data:image/png;base64,{{ qr_base64 }}" alt="vCard QR Code" class="img-thumbnail" style="max-width:200px;">
        </div>
      </div>
      {% else %}
      <h5>Contact Card QR Code</h5>
      <div class="text-muted"><em>Redacted</em></div>
      {% endif %}
    </div>

    <div class="col-md-8">
      <ul class="list-group">
        <li class="list-group-item">
          <strong>Email:</strong>
          {% if not member.redact_contact or request.user == member or request.user.is_staff %}
            {% if member.email and "@" in member.email %}
              <a href="mailto:{{ member.email }}">{{ member.email }}</a>
            {% else %}
              {{ member.email }}
            {% endif %}
          {% elif request.user.rostermeister %}
            <button type="button" class="btn btn-sm btn-outline-secondary spoiler-blind-btn" data-field="email" data-member-id="{{ member.id }}">Redacted ‚Äî click to reveal</button>
            <span class="ms-2 d-none spoiler-hidden" id="email-{{ member.id }}">
              {% if member.email and "@" in member.email %}
                <a href="mailto:{{ member.email }}">{{ member.email }}</a>
              {% else %}
                {{ member.email }}
              {% endif %}
            </span>
          {% else %}
            <em class="text-muted">Redacted</em>
          {% endif %}
        </li>

        {% if member.phone %}
        <li class="list-group-item">
          <strong>Phone:</strong>
          {% if phone_display and not member.redact_contact or phone_display and request.user == member or phone_display and request.user.is_staff %}
            {% if phone_link %}
              üìû <a href="tel:{{ phone_display }}">{{ phone_display|format_us_phone }}</a>
            {% else %}
              üìû {{ phone_display }}
            {% endif %}
          {% elif request.user.rostermeister and phone_display %}
            <button type="button" class="btn btn-sm btn-outline-secondary spoiler-blind-btn" data-field="phone" data-member-id="{{ member.id }}">Redacted ‚Äî click to reveal</button>
            <span class="ms-2 d-none spoiler-hidden" id="phone-{{ member.id }}">{% if phone_link %}üìû <a href="tel:{{ phone_display }}">{{ phone_display|format_us_phone }}</a>{% else %}üìû {{ phone_display }}{% endif %}</span>
          {% else %}
            <em class="text-muted">Redacted</em>
          {% endif %}
        </li>
        {% endif %}

        {% if member.mobile_phone %}
        <li class="list-group-item">
          <strong>Mobile:</strong>
          {% if mobile_display and not member.redact_contact or mobile_display and request.user == member or mobile_display and request.user.is_staff %}
            {% if mobile_link %}
              üì± <a href="tel:{{ mobile_display }}">{{ mobile_display|format_us_phone }}</a>
            {% else %}
              üì± {{ mobile_display }}
            {% endif %}
          {% elif request.user.rostermeister and mobile_display %}
            <button type="button" class="btn btn-sm btn-outline-secondary spoiler-blind-btn" data-field="mobile" data-member-id="{{ member.id }}">Redacted ‚Äî click to reveal</button>
            <span class="ms-2 d-none spoiler-hidden" id="mobile-{{ member.id }}">{% if mobile_link %}üì± <a href="tel:{{ mobile_display }}">{{ mobile_display|format_us_phone }}</a>{% else %}üì± {{ mobile_display }}{% endif %}</span>
          {% else %}
            <em class="text-muted">Redacted</em>
          {% endif %}
        </li>
        {% endif %}

        <li class="list-group-item"><strong>Address:</strong> <br>
          {% if member.address and not member.redact_contact or member.address and request.user == member or member.address and request.user.is_staff %}
            {{ member.address }}<br>
            {{ member.city }}, {{ member.state_code }} {% if member.state_freeform %} {{ member.state_freeform }}
            {% endif %} {{ member.zip_code }}<br>
            {{ member.country }}
          {% elif request.user.rostermeister and member.address %}
            <button type="button" class="btn btn-sm btn-outline-secondary spoiler-blind-btn" data-field="address" data-member-id="{{ member.id }}">Redacted ‚Äî click to reveal</button>
            <div class="mt-2 d-none spoiler-hidden" id="address-{{ member.id }}">
              {{ member.address }}<br>
              {{ member.city }}, {{ member.state_code }} {% if member.state_freeform %} {{ member.state_freeform }}{% endif %} {{ member.zip_code }}<br>
              {{ member.country }}
            </div>
          {% else %}
            <em class="text-muted">Redacted</em>
          {% endif %}
        </li>

        <li class="list-group-item"><strong>Duties:</strong> {{ member|render_duties|safe }}</li>
        <li class="list-group-item"><strong>Glider Rating:</strong> {{ member.get_glider_rating_display }}</li>
        {% if pilot_certificate_number %}
        <li class="list-group-item"><strong>Certificate Number: </strong>
          {{ member.pilot_certificate_number }}</li>
        {% endif %}
        <li class="list-group-item"><strong>Membership Status:</strong> {{ member.membership_status }}</li>
        <li class="list-group-item"><strong>Joined Club:</strong> {{ member.joined_club }}</li>
        {% if member.private_glider_checkride_date %}
        <li class="list-group-item"><strong>Rated Glider Pilot Since: </strong>
          {{ member.private_glider_checkride_date }}
        </li>
        {% endif %}
        {% if request.user == member %}
        <li class="list-group-item">
          <strong>User Name:</strong> {{ member.username }}<br>
          <a href="{% url 'members:set_password' %}" class="btn btn-secondary mt-3 ms-3">Set Password</a>
        </li>
        {% endif %}
        <li class="list-group-item p-0">
          <div class="accordion" id="emergencyContactAccordion">
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingEmergencyContact">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEmergencyContact" aria-expanded="false" aria-controls="collapseEmergencyContact">
                  Emergency Contact
                </button>
              </h2>
              <div id="collapseEmergencyContact" class="accordion-collapse collapse" aria-labelledby="headingEmergencyContact" data-bs-parent="#emergencyContactAccordion">
                <div class="accordion-body">
                  {{ member.emergency_contact|linebreaksbr }}
                </div>
              </div>
            </div>
          </div>
        </li>
        <li class="list-group-item"><strong>Public Notes:</strong><br>{{ member.public_notes|safe }}</li>
      </ul>

    {% if request.user == member or request.user.instructor %}
      {% if show_need_buttons %}
      {% if not member.solo_date %}
      <a class="btn btn-warning" href="{% url 'instructors:needed_for_solo' member.id %}">
        What's still needed to solo?
      </a>
      {% endif %}
        {% if not member.checkride_date %}
        <a class="btn btn-danger" href="{% url 'instructors:needed_for_checkride' member.id %}">
          What's still needed for checkride?
        </a>
        {% endif %}
      {% endif %}

      <div class="mt-3">
        <a href="{% if request.user.instructor %}
                  {% url 'instructors:member_training_grid' member.id %}
               {% else %}
                  {% url 'members:training_progress' %}
               {% endif %}" class="btn btn-outline-primary btn-sm my-2">
          üìä View Training Grid
        </a>
        <a href="{% url 'instructors:member_instruction_record' member.id %}"
          class="btn btn-outline-primary btn-sm my-1">
          üìò View Instruction Record
        </a>
      </div>
      {% endif %}
      {% if request.user.instructor and request.user != member %}

      <div class="mt-3">
        <a href="{% url 'instructors:log_ground_instruction' %}?student={{ member.id }}"
          class="btn btn-outline-primary btn-sm">
          ‚úçÔ∏è Log Ground Instruction
        </a>
        <a href="{% url 'instructors:select_instruction_date' member.id %}" class="btn btn-sm btn-outline-primary">
          Create Instruction Report
        </a>
        <a href="{% url 'instructors:assign_qualification' member.id %}" class="btn btn-sm btn-outline-primary">
          ‚ûï Assign Qualification
        </a>
      </div>
      {% endif %}

      <!-- QUALIFICATIONS HERE -->
      <div class="accordion mb-4" id="qualificationAccordion">
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingQuals">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              data-bs-target="#collapseQuals" aria-expanded="false" aria-controls="collapseQuals">
              Qualifications
              <span class="ms-3">
                {% for q in qualifications %}
                {% if q.qualification.icon %}
                <img src="{{ q.qualification.icon.url }}" alt="{{ q.qualification.code }}"
                  title="{{ q.qualification.name }}" width="24" height="24" class="ms-1">
                {% endif %}
                {% endfor %}
              </span>
            </button>
          </h2>
          <div id="collapseQuals" class="accordion-collapse collapse" aria-labelledby="headingQuals"
            data-bs-parent="#qualificationAccordion">
            <div class="accordion-body">
              {% if qualifications %}
              <ul class="list-group">
                {% for q in qualifications %}


                <li class="list-group-item">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="d-flex align-items-start">
                      {% if q.qualification.icon %}
                      <img src="{{ q.qualification.icon.url }}" alt="{{ q.qualification.code }}" width="48" height="48"
                        class="me-2 mt-1">
                      {% endif %}
                      <div>
                        <strong>{{ q.qualification.name }}</strong><br>
                        <small class="text-muted">
                          {% if q.date_awarded %}
                          Awarded {{ q.date_awarded|date:"Y-m-d" }}
                          {% endif %}
                          {% if q.instructor %}
                          by {{ q.instructor.full_display_name }}
                          {% endif %}
                        </small>
                        {% if q.notes %}
                        <div class="text-muted small">{{ q.notes }}</div>
                        {% endif %}
                      </div>
                    </div>
                    <div>
                      {% if q.expiration_date %}
                      {% if q.expiration_date < today %} <span class="badge bg-danger">Expired {{
                        q.expiration_date|date:"Y-m-d" }}</span>
                        {% else %}
                        <span class="badge bg-warning">Expires {{ q.expiration_date|date:"Y-m-d" }}</span>
                        {% endif %}
                        {% else %}
                        <span class="badge bg-success">Permanent</span>
                        {% endif %}
                    </div>
                  </div>
                </li>




                {% endfor %}
              </ul>
              {% else %}
              <p class="text-muted"><em>No qualifications recorded.</em></p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      <!-- BADGES HERE -->
      <div class="accordion mb-4" id="ssaBadgeAccordion">
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingBadges">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              data-bs-target="#collapseBadges" aria-expanded="false" aria-controls="collapseBadges">
              üèÖ SSA Badges
              <span class="ms-3">
                {% for badge in member.badges.all %}
                {% if badge.badge.image %}
                <img src="{{ badge.badge.image.url }}" alt="{{ badge.badge.name }}" width="24" height="24" class="ms-1"
                  title="{{ badge.badge.name }}">
                {% endif %}
                {% endfor %}
              </span>
            </button>
          </h2>
          <div id="collapseBadges" class="accordion-collapse collapse" aria-labelledby="headingBadges"
            data-bs-parent="#ssaBadgeAccordion">
            <div class="accordion-body">
              {% if member.badges.exists %}
              <div class="row row-cols-auto g-3 justify-content-start">
                {% for badge in member.badges.all %}
                <div class="col text-center">
                  {% if badge.badge.image %}
                  <img src="{{ badge.badge.image.url }}" alt="{{ badge.badge.name }}" class="img-thumbnail mb-1"
                    style="max-width: 100px;">
                  {% endif %}
                  <div class="small">{{ badge.badge.name }}</div>
                  <div class="text-muted small">{{ badge.date_awarded|date:"Y-m-d" }}</div>
                </div>
                {% endfor %}
              </div>
              {% else %}
              <p class="text-muted">No badges awarded yet.</p>
              {% endif %}

              {# SSA link placed directly under the badges list per request #}
              {% if member.ssa_url %}
              <div class="mt-2">
                <a href="{{ member.ssa_url }}" target="_blank" rel="noopener" class="btn btn-outline-info btn-sm">View SSA badges on SSA.org &rarr;</a>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
  <hr>
  <h4>üßæ Biography</h4>
  {% if member.biography %}
  <div class="prose max-w-none">
    {{ member.biography.content|safe }}
  </div>
  {% if can_edit %}
  <a href="{% url 'members:biography_view' member.id %}" class="btn btn-sm btn-outline-secondary mt-2">Edit
    Biography</a>
  {% endif %}
  {% else %}
  <p>{{ member.first_name }} {{ member.last_name }} hasn‚Äôt uploaded a biography yet.</p>
  {% if can_edit %}
  <a href="{% url 'members:biography_view' member.id %}" class="btn btn-sm btn-outline-secondary mt-2">Write
    Biography</a>
  {% endif %}
  {% endif %}

</div>
  {# Redaction button/modal visible to the profile owner, placed after the main content so it's easy to find #}
  {% if request.user == member %}
  <div class="container mt-3">
    <button type="button" class="btn btn-danger btn-lg" data-bs-toggle="modal" data-bs-target="#redactConfirmModal">
      {% if member.redact_contact %}Make my contact details visible to other members{% else %}Redact my personal information on members site{% endif %}
    </button>

    <!-- Redaction confirmation modal -->
    <div class="modal fade" id="redactConfirmModal" tabindex="-1" aria-labelledby="redactConfirmModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="redactConfirmModalLabel">{% if member.redact_contact %}Make your details visible?{% else %}Hide your contact details?{% endif %}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            {% if member.redact_contact %}
              If you proceed, your personal contact details (email, phone numbers, address and contact QR) will be visible to other members again.
            {% else %}
              If you proceed, your personal contact details (email, phone numbers, address and contact QR) will be hidden from other members. Club officers and administrators will still be able to see this information when necessary.
            {% endif %}
            <p class="mt-2"><strong>What is suppressed</strong></p>
            <ul>
              <li>Email address</li>
              <li>Phone and mobile numbers</li>
              <li>Postal address and QR contact card</li>
            </ul>
            <p class="text-muted small">You can reverse this at any time from your profile.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <form method="post" action="{% url 'members:toggle_redaction' member.id %}">
              {% csrf_token %}
              <button type="submit" class="btn btn-danger">{% if member.redact_contact %}Make Visible{% else %}Hide My Contact Details{% endif %}</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
{% endblock %}

{% block extra_scripts %}
  <script src="{% static 'js/redaction-blind.js' %}"></script>
{% endblock %}
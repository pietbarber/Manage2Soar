{% extends "base.html" %}
{% load static %}
{% load member_extras %}
{% load siteconfig_tags %}

{% block title %}{{ member.full_display_name }} - Member Profile{% endblock %}

{% block content %}
{% duty_emoji_legend %}

<div class="container-fluid mt-4">
  {% get_siteconfig as siteconfig %}
  {% can_view_personal_info_tag member as can_view_personal %}

  {% if member.redact_contact and request.user.member_manager %}
  <!-- Modal shown to member_managers to inform about redaction policy -->
  <div class="modal fade" id="redaction-alert-modal" tabindex="-1" aria-labelledby="redactionAlertLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="redactionAlertLabel">Redacted Contact Information</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>This member has chosen to redact their personal contact information on the public members directory.</p>
          <p>As {{ siteconfig.membership_manager_title|default:'Member Meister' }}, you may view this information when necessary. Please exercise discretion when sharing or using it.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Dismiss</button>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Profile Header Card -->
  <div class="card profile-card mb-4">
    <div class="profile-header">
      <div class="d-flex justify-content-between align-items-start">
        <div class="d-flex align-items-center">
          <i class="bi bi-person-circle display-6 me-3"></i>
          <div>
            <h1 class="mb-1">{{ member.full_display_name }}</h1>
            <p class="mb-0 opacity-75">
              {% if member.membership_status == "Full Member" %}
              <span class="badge bg-light text-dark fs-6">{{ member.membership_status }}</span>
              {% elif member.membership_status == "Pending" %}
              <span class="badge bg-warning text-dark fs-6">{{ member.membership_status }}</span>
              {% elif member.membership_status == "Inactive" %}
              <span class="badge bg-secondary fs-6">{{ member.membership_status }}</span>
              {% else %}
              <span class="badge bg-danger fs-6">{{ member.membership_status }}</span>
              {% endif %}
              {% if member.joined_club %}
              â€¢ Member since {{ member.joined_club|date:"M Y" }}
              {% endif %}
            </p>
          </div>
        </div>
        {% if request.user.member_manager or request.user.is_staff %}
        <a href="{% url 'admin:members_member_change' member.id %}" class="btn btn-light btn-modern">
          <i class="bi bi-pencil-square me-2"></i>Edit Member
        </a>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Left Column - Photo and QR Code -->
    <div class="col-md-4 col-lg-4">
      <!-- Profile Photo Section -->
      <div class="card profile-photo-container">
        <div class="card-body text-center">
          {% if member.profile_photo %}
          <img src="{{ member.profile_photo.url }}" class="profile-photo img-fluid" alt="Profile Photo">
          {% else %}
          <img src="{% static 'images/default-avatar-large.png' %}" class="profile-photo img-fluid" alt="Default Avatar">
          {% endif %}

          {% if is_self %}
          <!-- Modern Profile Photo Upload Section -->
          <div class="card mt-4 shadow-sm border-0">
            <div class="card-header bg-primary text-white py-2">
              <h6 class="mb-0">
                <i class="bi bi-camera me-2"></i>Update Profile Photo
              </h6>
            </div>
            <div class="card-body p-3">
              <form method="post" enctype="multipart/form-data" class="mb-0">
                {% csrf_token %}
                <div class="mb-3">
                  <label for="{{ form.profile_photo.id_for_label }}" class="form-label fw-semibold">
                    <i class="bi bi-image me-1"></i>Choose New Photo
                  </label>
                  <input type="file" class="form-control{% if form.profile_photo.errors %} is-invalid{% endif %}" id="{{ form.profile_photo.id_for_label }}" name="{{ form.profile_photo.name }}" accept="image/*">
                  {% if form.profile_photo.errors %}
                    <div class="invalid-feedback">
                      {% for error in form.profile_photo.errors %}{{ error }}{% endfor %}
                    </div>
                  {% endif %}
                  <div class="form-text">
                    <i class="bi bi-info-circle me-1"></i>JPG, PNG, or GIF files accepted. Max size: 5MB
                  </div>
                </div>
                {% if form.non_field_errors %}
                  <div class="alert alert-danger alert-sm border-0 mb-3">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    {% for error in form.non_field_errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
                <button type="submit" class="btn btn-primary btn-sm w-100">
                  <i class="bi bi-upload me-2"></i>Update Photo
                </button>
              </form>
            </div>
            <div class="card-footer bg-light py-2">
              <small class="text-muted">
                <i class="bi bi-shield-check me-1"></i>Photo will be visible to all club members
              </small>
            </div>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- QR Code Section -->
      {% if not member.redact_contact or request.user == member or request.user.is_staff or request.user.member_manager %}
      <div class="qr-container mt-4">
        <h6 class="fw-bold text-center mb-3">
          <i class="bi bi-qr-code me-2"></i>Contact Card
        </h6>
        {% if not member.redact_contact or request.user == member or request.user.is_staff %}
        <img src="data:image/png;base64,{{ qr_base64 }}" alt="QR code for {{ member.full_display_name }}'s contact information" class="img-fluid">
        <p class="small text-muted mt-2 mb-0">Scan to add contact info to your phone</p>
        {% else %}
        <div class="text-muted text-center">
          <i class="bi bi-eye-slash display-6"></i>
          <p class="mt-2 mb-0"><em>Contact information redacted</em></p>
        </div>
        {% endif %}
      </div>
      {% endif %}
    </div>

    <!-- Right Column - Member Information -->
    <div class="col-md-8 col-lg-8">
      <!-- Contact Information Card -->
      <div class="card contact-info mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-person-lines-fill me-2"></i>Contact Information
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <div class="d-flex align-items-center mb-3">
                <i class="bi bi-envelope text-primary me-3 fs-5"></i>
                <div>
                  <strong class="d-block">Email</strong>
                  {% if can_view_personal %}
                    {% if member.email and "@" in member.email %}
                      <a href="mailto:{{ member.email }}" class="text-decoration-none">{{ member.email }}</a>
                    {% else %}
                      <span class="text-muted">{{ member.email }}</span>
                    {% endif %}
                  {% else %}
                    <span class="text-muted fst-italic">Redacted</span>
                  {% endif %}
                </div>
              </div>

              {% if member.phone %}
              <div class="d-flex align-items-center mb-3">
                <i class="bi bi-telephone text-success me-3 fs-5"></i>
                <div>
                  <strong class="d-block">Phone</strong>
                  {% if can_view_personal and phone_display %}
                    {% if phone_link %}
                      <a href="tel:{{ phone_display }}" class="text-decoration-none">{{ phone_display|format_us_phone }}</a>
                    {% else %}
                      <span class="text-muted">{{ phone_display|format_us_phone }}</span>
                    {% endif %}
                  {% else %}
                    <span class="text-muted fst-italic">Redacted</span>
                  {% endif %}
                </div>
              </div>
              {% endif %}

              {% if member.mobile_phone %}
              <div class="d-flex align-items-center mb-3">
                <i class="bi bi-phone text-info me-3 fs-5"></i>
                <div>
                  <strong class="d-block">Mobile</strong>
                  {% if can_view_personal and mobile_display %}
                    {% if mobile_link %}
                      <a href="tel:{{ mobile_display }}" class="text-decoration-none">{{ mobile_display|format_us_phone }}</a>
                    {% else %}
                      <span class="text-muted">{{ mobile_display|format_us_phone }}</span>
                    {% endif %}
                  {% else %}
                    <span class="text-muted fst-italic">Redacted</span>
                  {% endif %}
                </div>
              </div>
              {% endif %}
            </div>

            <div class="col-md-6">
              <div class="d-flex align-items-start mb-3">
                <i class="bi bi-geo-alt text-warning me-3 fs-5 mt-1"></i>
                <div>
                  <strong class="d-block">Address</strong>
                  {% if can_view_personal and member.address %}
                    <address class="mb-0">
                      {{ member.address }}<br>
                      {{ member.city }}, {{ member.state_code }}{% if member.state_freeform %} {{ member.state_freeform }}{% endif %} {{ member.zip_code }}<br>
                      {{ member.country }}
                    </address>
                  {% else %}
                    <span class="text-muted fst-italic">Redacted</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Member Details Card -->
      <div class="card contact-info mb-4">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">
            <i class="bi bi-person-badge me-2"></i>Member Details
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <div class="mb-3">
                <strong class="text-primary">Roles & Duties</strong>
                <div class="mt-2">
                  {{ member|render_duties|safe }}
                </div>
              </div>

              <div class="mb-3">
                <strong class="text-primary">Glider Rating</strong>
                <div class="mt-1">
                  <span class="badge bg-info">{{ member.get_glider_rating_display }}</span>
                </div>
              </div>

              {% if pilot_certificate_number %}
              <div class="mb-3">
                <strong class="text-primary">Certificate Number</strong>
                <div class="mt-1">{{ member.pilot_certificate_number }}</div>
              </div>
              {% endif %}
            </div>

            <div class="col-md-6">
              <div class="mb-3">
                <strong class="text-primary">Membership Status</strong>
                <div class="mt-1">
                  {% if member.membership_status == "Full Member" %}
                  <span class="badge bg-success fs-6">{{ member.membership_status }}</span>
                  {% elif member.membership_status == "Pending" %}
                  <span class="badge bg-warning text-dark fs-6">{{ member.membership_status }}</span>
                  {% elif member.membership_status == "Inactive" %}
                  <span class="badge bg-secondary fs-6">{{ member.membership_status }}</span>
                  {% else %}
                  <span class="badge bg-danger fs-6">{{ member.membership_status }}</span>
                  {% endif %}
                </div>
              </div>

              {% if member.joined_club %}
              <div class="mb-3">
                <strong class="text-primary">Joined Club</strong>
                <div class="mt-1">{{ member.joined_club|date:"F j, Y" }}</div>
              </div>
              {% endif %}

              {% if member.private_glider_checkride_date %}
              <div class="mb-3">
                <strong class="text-primary">Rated Glider Pilot Since</strong>
                <div class="mt-1">{{ member.private_glider_checkride_date|date:"F j, Y" }}</div>
              </div>
              {% endif %}
            </div>
          </div>

          {% if request.user == member %}
          <hr>
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong class="text-primary">Username:</strong> {{ member.username }}
            </div>
            <a href="{% url 'members:set_password' %}" class="btn btn-outline-secondary btn-modern">
              <i class="bi bi-key me-2"></i>Change Password
            </a>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Emergency Contact & Notes -->
      <div class="accordion accordion-modern mb-4" id="additionalInfoAccordion">
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingEmergencyContact">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEmergencyContact" aria-expanded="false" aria-controls="collapseEmergencyContact">
              <i class="bi bi-telephone-plus me-2"></i>Emergency Contact
            </button>
          </h2>
          <div id="collapseEmergencyContact" class="accordion-collapse collapse" aria-labelledby="headingEmergencyContact" data-bs-parent="#additionalInfoAccordion">
            <div class="accordion-body">
              {% if member.emergency_contact %}
                {{ member.emergency_contact|linebreaksbr }}
              {% else %}
                <span class="text-muted fst-italic">No emergency contact information provided</span>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="accordion-item">
          <h2 class="accordion-header" id="headingPublicNotes">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePublicNotes" aria-expanded="false" aria-controls="collapsePublicNotes">
              <i class="bi bi-chat-square-text me-2"></i>Public Notes
            </button>
          </h2>
          <div id="collapsePublicNotes" class="accordion-collapse collapse" aria-labelledby="headingPublicNotes" data-bs-parent="#additionalInfoAccordion">
            <div class="accordion-body">
              {% if member.public_notes %}
                {{ member.public_notes|safe }}
              {% else %}
                <span class="text-muted fst-italic">No public notes available</span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Instructor Tools Section -->
      {% if request.user == member or request.user.instructor %}
      <div class="card contact-info mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-tools me-2"></i>Training & Instruction Tools
          </h5>
        </div>
        <div class="card-body">
          {% if show_need_buttons %}
          <div class="row g-2 mb-3">
            {% if not member.solo_date %}
            <div class="col-sm-6">
              <a class="btn btn-warning btn-modern w-100" href="{% url 'instructors:needed_for_solo' member.id %}">
                <i class="bi bi-list-check me-2"></i>What's needed to solo?
              </a>
            </div>
            {% endif %}
            {% if not member.checkride_date %}
            <div class="col-sm-6">
              <a class="btn btn-danger btn-modern w-100" href="{% url 'instructors:needed_for_checkride' member.id %}">
                <i class="bi bi-clipboard-check me-2"></i>What's needed for checkride?
              </a>
            </div>
            {% endif %}
          </div>
          {% endif %}

          <div class="row g-2">
            <div class="col-sm-6">
              <a href="{% if request.user.instructor %}{% url 'instructors:member_training_grid' member.id %}{% else %}{% url 'members:training_progress' %}{% endif %}" class="btn btn-outline-primary btn-modern w-100">
                <i class="bi bi-grid-3x3 me-2"></i>View Training Grid
              </a>
            </div>
            <div class="col-sm-6">
              <a href="{% url 'instructors:member_instruction_record' member.id %}" class="btn btn-outline-primary btn-modern w-100">
                <i class="bi bi-journal-bookmark me-2"></i>View Instruction Record
              </a>
            </div>
          </div>

          {% if request.user.instructor and request.user != member %}
          <hr>
          <h6 class="text-primary mb-3">
            <i class="bi bi-person-workspace me-2"></i>Instructor Actions
          </h6>
          <div class="row g-2">
            <div class="col-lg-4">
              <a href="{% url 'instructors:log_ground_instruction' %}?student={{ member.id }}" class="btn btn-outline-success btn-modern w-100">
                <i class="bi bi-pencil-square me-2"></i>Log Ground Instruction
              </a>
            </div>
            <div class="col-lg-4">
              <a href="{% url 'instructors:select_instruction_date' member.id %}" class="btn btn-outline-success btn-modern w-100">
                <i class="bi bi-airplane me-2"></i>Log Flight Instruction
              </a>
            </div>
            <div class="col-lg-4">
              <button type="button" class="btn btn-outline-info btn-modern w-100"
                      data-qualification-url="{% url 'instructors:assign_qualification_modal' member.id %}"
                      onclick="loadQualificationModal(this.dataset.qualificationUrl)">
                <i class="bi bi-plus-circle me-2"></i>Assign Qualification
              </button>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
      {% endif %}

      <!-- Training & Qualifications Section -->
      <div class="row g-4 mb-4">
        <!-- Qualifications -->
        <div class="col-lg-6">
          <div class="accordion accordion-modern" id="qualificationAccordion">
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingQuals">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseQuals" aria-expanded="false" aria-controls="collapseQuals">
                  <i class="bi bi-award me-2"></i>Qualifications
                  <span class="ms-3">
                    {% for q in qualifications %}
                    {% if q.qualification.icon %}
                    <img src="{{ q.qualification.icon.url }}" alt="{{ q.qualification.code }}" title="{{ q.qualification.name }}" width="20" height="20" class="ms-1 rounded">
                    {% endif %}
                    {% endfor %}
                  </span>
                </button>
              </h2>
              <div id="collapseQuals" class="accordion-collapse collapse" aria-labelledby="headingQuals" data-bs-parent="#qualificationAccordion">
                <div class="accordion-body">
                  {% if qualifications %}
                  <div class="row g-3">
                    {% for q in qualifications %}
                    <div class="col-12">
                      <div class="card h-100 border-0 shadow-sm">
                        <div class="card-body p-3">
                          <div class="d-flex justify-content-between align-items-start">
                            <div class="d-flex align-items-start">
                              {% if q.qualification.icon %}
                              <img src="{{ q.qualification.icon.url }}" alt="{{ q.qualification.code }}" width="40" height="40" class="me-3 mt-1 rounded">
                              {% endif %}
                              <div>
                                <h6 class="fw-bold mb-1">{{ q.qualification.name }}</h6>
                                <small class="text-muted">
                                  {% if q.date_awarded %}Awarded {{ q.date_awarded|date:"M j, Y" }}{% endif %}
                                  {% if q.instructor %} by {{ q.instructor.full_display_name }}{% endif %}
                                </small>
                                {% if q.notes %}
                                <div class="text-muted small mt-1">{{ q.notes }}</div>
                                {% endif %}
                              </div>
                            </div>
                            <div class="text-end">
                              {% if q.expiration_date %}
                                {% if q.expiration_date < today %}
                                <span class="qualification-badge qualification-expired">Expired {{ q.expiration_date|date:"M j, Y" }}</span>
                                {% else %}
                                <span class="qualification-badge qualification-expiring">Expires {{ q.expiration_date|date:"M j, Y" }}</span>
                                {% endif %}
                              {% else %}
                              <span class="qualification-badge">Permanent</span>
                              {% endif %}
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                  {% else %}
                  <div class="text-center text-muted py-4">
                    <i class="bi bi-award display-6"></i>
                    <p class="mb-0 mt-2"><em>No qualifications recorded</em></p>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- SSA Badges -->
        <div class="col-lg-6">
          <div class="accordion accordion-modern" id="ssaBadgeAccordion">
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingBadges">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBadges" aria-expanded="false" aria-controls="collapseBadges">
                  <i class="bi bi-trophy me-2"></i>SSA Badges
                  <span class="ms-3">
                    {% for badge in member.badges.all %}
                    {% if badge.badge.image %}
                    <img src="{{ badge.badge.image.url }}" alt="{{ badge.badge.name }}" width="20" height="20" class="ms-1 rounded" title="{{ badge.badge.name }}">
                    {% endif %}
                    {% endfor %}
                  </span>
                </button>
              </h2>
              <div id="collapseBadges" class="accordion-collapse collapse" aria-labelledby="headingBadges" data-bs-parent="#ssaBadgeAccordion">
                <div class="accordion-body">
                  {% if member.badges.exists %}
                  <div class="row g-3">
                    {% for badge in member.badges.all %}
                    <div class="col-6 col-sm-4 text-center">
                      <div class="card h-100 border-0 shadow-sm">
                        <div class="card-body p-3">
                          {% if badge.badge.image %}
                          <img src="{{ badge.badge.image.url }}" alt="{{ badge.badge.name }}" class="img-fluid mb-2 badge-image">
                          {% endif %}
                          <h6 class="small fw-bold mb-1">{{ badge.badge.name }}</h6>
                          <small class="text-muted">{{ badge.date_awarded|date:"M j, Y" }}</small>
                        </div>
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                  {% if member.ssa_url %}
                  <div class="text-center mt-3">
                    <a href="{{ member.ssa_url }}" target="_blank" rel="noopener" class="btn btn-outline-info btn-modern">
                      <i class="bi bi-box-arrow-up-right me-2"></i>View on SSA.org
                    </a>
                  </div>
                  {% endif %}
                  {% else %}
                  <div class="text-center text-muted py-4">
                    <i class="bi bi-trophy display-6"></i>
                    <p class="mb-0 mt-2"><em>No badges awarded yet</em></p>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

      <!-- Biography Section -->
      <div class="card contact-info mb-4">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">
            <i class="bi bi-journal-text me-2"></i>Biography
          </h5>
        </div>
        <div class="card-body">
          {% if member.biography %}
          <div class="prose">
            {{ member.biography.content|safe }}
          </div>
          {% if can_edit %}
          <div class="mt-3">
            <a href="{% url 'members:biography_view' member.id %}" class="btn btn-outline-info btn-modern">
              <i class="bi bi-pencil-square me-2"></i>Edit Biography
            </a>
          </div>
          {% endif %}
          {% else %}
          <div class="text-center text-muted py-4">
            <i class="bi bi-journal-plus display-6"></i>
            <p class="mb-0 mt-2">{{ member.first_name }} {{ member.last_name }} hasn't shared a biography yet.</p>
            {% if can_edit %}
            <div class="mt-3">
              <a href="{% url 'members:biography_view' member.id %}" class="btn btn-info btn-modern">
                <i class="bi bi-pencil-square me-2"></i>Write Biography
              </a>
            </div>
            {% endif %}
          </div>
          {% endif %}
        </div>
      </div>

    </div>
  </div>

</div>

</div>
<!-- Privacy Controls -->
{% if request.user == member %}
<div class="container-fluid mt-4">
  <div class="card border-warning">
    <div class="card-header bg-warning text-dark">
      <h5 class="mb-0">
        <i class="bi bi-shield-exclamation me-2"></i>Privacy Controls
      </h5>
    </div>
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h6 class="mb-1">Contact Information Visibility</h6>
          <p class="text-muted mb-0">
            {% if member.redact_contact %}
            Your contact details are currently <strong>hidden</strong> from other members.
            {% else %}
            Your contact details are currently <strong>visible</strong> to other members.
            {% endif %}
          </p>
        </div>
        <button type="button" class="btn {% if member.redact_contact %}btn-success{% else %}btn-danger{% endif %} btn-modern" data-bs-toggle="modal" data-bs-target="#redactConfirmModal">
          <i class="bi bi-{% if member.redact_contact %}eye{% else %}eye-slash{% endif %} me-2"></i>
          {% if member.redact_contact %}Make Visible{% else %}Hide Details{% endif %}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Redaction confirmation modal -->
<div class="modal fade" id="redactConfirmModal" tabindex="-1" aria-labelledby="redactConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="redactConfirmModalLabel">
          <i class="bi bi-shield-exclamation me-2"></i>
          {% if member.redact_contact %}Make your details visible?{% else %}Hide your contact details?{% endif %}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        {% if member.redact_contact %}
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>
          If you proceed, your personal contact details will be visible to other members again.
        </div>
        {% else %}
        <div class="alert alert-warning">
          <i class="bi bi-exclamation-triangle me-2"></i>
          If you proceed, your personal contact details will be hidden from other members. Club officers and administrators will still be able to see this information when necessary.
        </div>
        {% endif %}

        <h6 class="mt-3">What will be affected:</h6>
        <ul class="list-unstyled">
          <li><i class="bi bi-envelope me-2 text-primary"></i>Email address</li>
          <li><i class="bi bi-telephone me-2 text-success"></i>Phone and mobile numbers</li>
          <li><i class="bi bi-geo-alt me-2 text-warning"></i>Postal address</li>
          <li><i class="bi bi-qr-code me-2 text-info"></i>QR contact card</li>
        </ul>

        <div class="alert alert-light border">
          <small class="text-muted">
            <i class="bi bi-info-circle me-1"></i>
            You can change this setting at any time from your profile page.
          </small>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form method="post" action="{% url 'members:toggle_redaction' member.id %}" class="d-inline">
          {% csrf_token %}
          <button type="submit" class="btn {% if member.redact_contact %}btn-success{% else %}btn-danger{% endif %}">
            <i class="bi bi-{% if member.redact_contact %}eye{% else %}eye-slash{% endif %} me-2"></i>
            {% if member.redact_contact %}Make Visible{% else %}Hide My Contact Details{% endif %}
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

{% endif %}

<!-- Qualification Assignment Modal (available to all instructors) -->
<div class="modal fade" id="qualification-modal" tabindex="-1" aria-labelledby="qualification-modal-label" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="qualification-modal-label">
          <i class="bi bi-award me-2"></i>Assign Qualification to {{ member.full_display_name }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="qualification-modal-content">
        <!-- Content loaded via HTMX -->
        <div class="text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
  <script>
    // Defensive modal auto-show for membership managers when viewing a redacted member.
    (function showRedactionModal(retries) {
      try {
        var modalEl = document.getElementById('redaction-alert-modal');
        if (!modalEl) return;
        if (window.bootstrap && window.bootstrap.Modal) {
          var m = new bootstrap.Modal(modalEl);
          m.show();
          return;
        }
      } catch (e) {
        // ignore and retry below
      }
      if (retries > 0) {
        setTimeout(function () { showRedactionModal(retries - 1); }, 100);
      }
    })(20);

    // Load qualification modal content via HTMX and show modal
    function loadQualificationModal(url) {
      const modalContent = document.getElementById('qualification-modal-content');
      const modal = document.getElementById('qualification-modal');

      // Show loading spinner
      modalContent.innerHTML = `
        <div class="text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      `;

      // Load content via HTMX
      htmx.ajax('GET', url, {
        target: '#qualification-modal-content',
        swap: 'innerHTML'
      }).then(() => {
        // Show modal after content is loaded
        const bootstrapModal = new bootstrap.Modal(modal);
        bootstrapModal.show();
      });
    }
  </script>
{% endblock %}

{% extends "base.html" %}
{% load roster_extras %}
{% load siteconfig_tags %}
{% block title %}Create and Propose Duty Roster{% endblock %}

{% block content %}

{% if incomplete %}
  <div class="alert alert-warning">
    ‚ö†Ô∏è Could not fully auto-generate a complete roster for {{ month }}/{{ year }}.
    Showing weekend dates so you can review (or try "üîÑ Roll Again").
  </div>
{% endif %}

{% if operational_info %}
<div class="alert alert-info">
  <h5>üìÖ Operational Calendar Information</h5>
  {% if siteconfig %}
    <p><strong>Club Operations Period:</strong> {{ siteconfig.operations_start_period }} through {{ siteconfig.operations_end_period }}</p>
  {% endif %}
  {% if operational_info.season_start and operational_info.season_end %}
    <p><strong>{{ year }} Season:</strong> {{ operational_info.season_start }} through {{ operational_info.season_end }}</p>
  {% endif %}
  {% if filtered_dates %}
    <div class="mt-2">
      <strong>‚ö†Ô∏è Dates excluded from roster (outside operational season):</strong>
      <ul class="mb-0">
        {% for date in filtered_dates %}
          <li>{{ date|date:"l, F j" }} ({{ date }})</li>
        {% endfor %}
      </ul>
      <small class="text-muted">These dates were automatically filtered out based on your operational calendar configuration.</small>
    </div>
  {% endif %}
</div>
{% endif %}

<h2>üìù Proposed Duty Roster ‚Äî {{ month }}/{{ year }} (Draft)</h2>
{% if no_scheduling %}
  <div class="alert alert-info">
    This club does not schedule operations. If you want to change this, please configure the site to schedule volunteers.
  </div>
{% else %}
<form method="post">
  {% csrf_token %}
  <input type="hidden" name="year"  value="{{ year }}">
  <input type="hidden" name="month" value="{{ month }}">


  {% if draft %}
  <div class="alert alert-secondary">
    <strong>üí° Easy Date Removal:</strong> If you want to remove specific dates from this roster (e.g., only want first 2 weekends of December), check the boxes below and click "Remove Selected Dates".
  </div>
  {% endif %}

  <table class="table">
    <thead>
      <tr>
        <th>Remove?</th>
        <th>Date</th>
        {% for role in enabled_roles %}
          <th>
            {% if siteconfig %}
              {% if role == 'duty_officer' %}{{ siteconfig.duty_officer_title }}
              {% elif role == 'assistant_duty_officer' %}{{ siteconfig.assistant_duty_officer_title }}
              {% elif role == 'towpilot' %}{{ siteconfig.towpilot_title }}
              {% elif role == 'instructor' %}{{ siteconfig.instructor_title }}
              {% elif role == 'surge_towpilot' %}{{ siteconfig.surge_towpilot_title|default:'Surge Tow Pilot' }}
              {% elif role == 'surge_instructor' %}{{ siteconfig.surge_instructor_title|default:'Surge Instructor' }}
              {% else %}{{ role|title }}
              {% endif %}
            {% else %}
              {{ role|title }}
            {% endif %}
          </th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for entry in draft %}
        <tr>
          <td>
            <input type="checkbox" name="remove_date" value="{{ entry.date|date:'Y-m-d' }}" class="form-check-input">
          </td>
          <td>
            <strong>{{ entry.date|date:"l, F j" }}</strong><br>
            <small class="text-muted">{{ entry.date }}</small>
          </td>
          {% for role in enabled_roles %}
            <td class="roster-slot {% if not entry.slots|dict_get:role %}empty-slot{% endif %} editable-slot"
                data-role="{{ role }}"
                data-date="{{ entry.date|date:'Y-m-d' }}"
                {% if not entry.slots|dict_get:role and entry.diagnostics|dict_get:role %}
                data-diagnostic='{{ entry.diagnostics|dict_get:role|to_json }}'
                {% endif %}
                data-current-member="{% if entry.slots|dict_get:role %}{{ entry.slots|dict_get:role }}{% endif %}"
                style="cursor: pointer;"
                title="{% if entry.slots|dict_get:role %}Click to edit assignment{% else %}Click to assign someone or view why empty{% endif %}">
              {% if entry.slots|dict_get:role %}
                <span class="slot-content">{{ entry.slots|dict_get:role|get_member_name }}</span> <small class="text-muted">‚úèÔ∏è</small>
              {% else %}
                <span class="text-muted slot-content">‚Äî</span> <small class="text-primary">‚ûï</small>
              {% endif %}
            </td>
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if draft %}
  <div class="d-flex gap-2 mb-3">
    <button name="action" value="remove_dates" class="btn btn-warning">üóëÔ∏è Remove Selected Dates</button>
    <button name="action" value="roll" class="btn btn-secondary">üîÑ Roll Again</button>
  </div>
  {% endif %}

  <div class="d-flex gap-2">
    <button name="action" value="publish" class="btn btn-success">‚úÖ Accept & Publish</button>
    <button name="action" value="cancel" class="btn btn-danger">‚ùå Cancel</button>
  </div>
</form>
{% endif %}

<!-- Edit Slot Modal -->
<div class="modal fade" id="editSlotModal" tabindex="-1" aria-labelledby="editSlotModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editSlotModalLabel">‚úèÔ∏è Edit Roster Slot</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="editSlotModalBody">
        <div class="text-center">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveSlotBtn">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Diagnostic Modal -->
<div class="modal fade" id="diagnosticModal" tabindex="-1" aria-labelledby="diagnosticModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="diagnosticModalLabel">üîç Why this slot is empty</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="diagnosticModalBody">
        <!-- Content will be populated by JavaScript -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="assignFromDiagnosticBtn">Assign Someone</button>
      </div>
    </div>
  </div>
</div>

<!-- Role title data from siteconfig (JSON format to avoid Pylance errors) -->
<script id="role-titles-data" type="application/json">
{
  {% if siteconfig %}
    "instructor": "{{ siteconfig.instructor_title|default:'Instructor' }}",
    "duty_officer": "{{ siteconfig.duty_officer_title|default:'Duty Officer' }}",
    "assistant_duty_officer": "{{ siteconfig.assistant_duty_officer_title|default:'Assistant Duty Officer' }}",
    "towpilot": "{{ siteconfig.towpilot_title|default:'Tow Pilot' }}"
  {% else %}
    "instructor": "Instructor",
    "duty_officer": "Duty Officer",
    "assistant_duty_officer": "Assistant Duty Officer",
    "towpilot": "Tow Pilot"
  {% endif %}
}
</script>

<script>
// Role title mappings from siteconfig
const ROLE_TITLES = JSON.parse(document.getElementById('role-titles-data').textContent);

// Global variables for tracking current slot being edited
let currentEditSlot = null;
let eligibleMembersData = null;

document.addEventListener('DOMContentLoaded', function() {
  // Add click handlers to all editable slots
  const editableSlots = document.querySelectorAll('.editable-slot');

  // HTML escape function to prevent XSS
  function escapeHtml(unsafe) {
    if (!unsafe) return '';
    const div = document.createElement('div');
    div.textContent = unsafe;
    return div.innerHTML;
  }

  editableSlots.forEach(slot => {
    slot.addEventListener('click', function() {
      const role = this.dataset.role;
      const date = this.dataset.date;
      const currentMember = this.dataset.currentMember;
      const diagnostic = this.dataset.diagnostic;

      // Store current slot info
      currentEditSlot = {
        role: role,
        date: date,
        currentMember: currentMember,
        element: this
      };

      // If slot is empty and has diagnostic, show option to view diagnostic
      if (!currentMember && diagnostic) {
        showEditOrDiagnosticChoice(role, date, diagnostic);
      } else {
        showEditSlotModal(role, date, currentMember);
      }
    });
  });

  // Save button handler
  document.getElementById('saveSlotBtn').addEventListener('click', saveSlotAssignment);

  // Assign from diagnostic button handler
  document.getElementById('assignFromDiagnosticBtn').addEventListener('click', function() {
    const diagnosticModal = bootstrap.Modal.getInstance(document.getElementById('diagnosticModal'));
    diagnosticModal.hide();
    showEditSlotModal(currentEditSlot.role, currentEditSlot.date, currentEditSlot.currentMember);
  });
});

function showEditOrDiagnosticChoice(role, date, diagnosticJson) {
  // For empty slots with diagnostics, show a choice
  const modal = new bootstrap.Modal(document.getElementById('editSlotModal'));
  const modalBody = document.getElementById('editSlotModalBody');
  const modalTitle = document.getElementById('editSlotModalLabel');
  const saveBtn = document.getElementById('saveSlotBtn');

  saveBtn.style.display = 'none'; // Hide save button for choice screen

  const roleName = escapeHtml(ROLE_TITLES[role] || role);
  const displayDate = formatDateForDisplay(date);
  modalTitle.textContent = `Empty Slot: ${ROLE_TITLES[role] || role} for ${displayDate}`;

  modalBody.innerHTML = `
    <div class="text-center">
      <p>This slot is currently empty. Would you like to:</p>
      <div class="d-grid gap-2">
        <button id="assignSlotFromChoiceBtn" class="btn btn-primary btn-lg">
          ‚ûï Assign Someone to This Slot
        </button>
        <button id="viewDiagnosticFromChoiceBtn" class="btn btn-secondary">
          üîç View Why This Slot Is Empty
        </button>
      </div>
    </div>
  `;

  modal.show();

  // Wire up event handlers after modal is shown
  setTimeout(() => {
    const assignBtn = document.getElementById('assignSlotFromChoiceBtn');
    const viewDiagnosticBtn = document.getElementById('viewDiagnosticFromChoiceBtn');

    if (assignBtn) {
      assignBtn.addEventListener('click', function() {
        modal.hide();
        showEditSlotModal(role, date, '');
      });
    }

    if (viewDiagnosticBtn) {
      viewDiagnosticBtn.addEventListener('click', function() {
        modal.hide();
        try {
          const diagnostic = JSON.parse(diagnosticJson);
          showDiagnosticModal(role, date, diagnostic);
        } catch (e) {
          console.error('Error parsing diagnostic:', e);
        }
      });
    }
  }, 100);
}

function formatDateForDisplay(isoDateString) {
  // Convert ISO date (YYYY-MM-DD) to readable format
  const dateObj = new Date(isoDateString + 'T00:00:00');
  const options = { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' };
  return dateObj.toLocaleDateString('en-US', options);
}

function showEditSlotModal(role, date, currentMember) {
  const modal = new bootstrap.Modal(document.getElementById('editSlotModal'));
  const modalBody = document.getElementById('editSlotModalBody');
  const modalTitle = document.getElementById('editSlotModalLabel');
  const saveBtn = document.getElementById('saveSlotBtn');

  saveBtn.style.display = 'block'; // Show save button

  // Update title
  const roleName = ROLE_TITLES[role] || role;
  const displayDate = formatDateForDisplay(date);

  modalTitle.innerHTML = `‚úèÔ∏è Edit ${roleName} for ${displayDate}`;

  // Show loading spinner
  modalBody.innerHTML = `
    <div class="text-center">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading eligible members...</span>
      </div>
    </div>
  `;

  modal.show();

  // Fetch eligible members
  fetch('{% url "duty_roster:get_eligible_members_for_slot" %}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    },
    body: `date=${date}&role=${role}`
  })
  .then(response => {
    if (!response.ok) {
      return response.json().then(err => {
        throw new Error(err.error || `HTTP ${response.status}`);
      });
    }
    return response.json();
  })
  .then(data => {
    if (data.error) {
      throw new Error(data.error);
    }
    eligibleMembersData = data;
    renderEditSlotForm(data, roleName);
  })
  .catch(error => {
    console.error('Error:', error);
    modalBody.innerHTML = `<div class="alert alert-danger"><strong>Error loading eligible members:</strong><br>${escapeHtml(error.message)}</div>`;
  });
}

function renderEditSlotForm(data, roleName) {
  const modalBody = document.getElementById('editSlotModalBody');

  let html = '';

  if (data.current_assignment) {
    const currentMember = data.eligible_members.find(m => m.id == data.current_assignment) ||
                          {id: data.current_assignment, name: 'Unknown'};
    html += `<div class="alert alert-info">
      <strong>Currently assigned:</strong> ${escapeHtml(currentMember.name)}
    </div>`;
  } else {
    html += `<div class="alert alert-warning">
      <strong>Currently:</strong> No one assigned
    </div>`;
  }

  html += `<div class="mb-3">
    <label for="memberSelect" class="form-label"><strong>Select Member for ${escapeHtml(roleName)}:</strong></label>
    <select class="form-select form-select-lg" id="memberSelect">
      <option value="">‚Äî Leave Empty ‚Äî</option>`;

  if (data.eligible_members.length === 0) {
    html += '</select><div class="alert alert-danger mt-2">No eligible members found for this slot!</div>';
  } else {
    data.eligible_members.forEach(member => {
      const selected = member.id == data.current_assignment ? 'selected' : '';
      const warnings = [];
      if (member.warnings.avoids_someone) warnings.push('‚ö†Ô∏è Avoids someone');
      if (member.warnings.already_assigned) warnings.push('‚ö†Ô∏è Already assigned');
      if (member.warnings.at_max) warnings.push('üéØ At max');

      const warningText = warnings.length > 0 ? ` (${warnings.join(', ')})` : '';
      const assignmentText = ` [${member.assignments_this_month}/${member.max_assignments}]`;

      html += `<option value="${escapeHtml(member.id)}" ${selected}>${escapeHtml(member.name)}${escapeHtml(assignmentText)}${escapeHtml(warningText)}</option>`;
    });
    html += '</select>';

    html += `<small class="form-text text-muted d-block mt-2">
      <strong>Legend:</strong> [current/max assignments this month] |
      ‚ö†Ô∏è = Warning (you can still assign) |
      üéØ = At max assignments
    </small>`;
  }

  html += '</div>';

  modalBody.innerHTML = html;
}

function saveSlotAssignment() {
  const memberSelect = document.getElementById('memberSelect');
  if (!memberSelect) return;

  const memberId = memberSelect.value;
  const saveBtn = document.getElementById('saveSlotBtn');

  // Disable button during save
  saveBtn.disabled = true;
  saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Saving...';

  fetch('{% url "duty_roster:update_roster_slot" %}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    },
    body: `date=${currentEditSlot.date}&role=${currentEditSlot.role}&member_id=${memberId}`
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update the cell in the table
      const slotElement = currentEditSlot.element;
      const slotContent = slotElement.querySelector('.slot-content');

      if (data.member_id) {
        slotContent.textContent = data.member_name;
        slotElement.classList.remove('empty-slot');
        slotElement.dataset.currentMember = data.member_id;
        slotElement.title = 'Click to edit assignment';

        // Update the edit icon
        const editIcon = slotElement.querySelector('small');
        if (editIcon) {
          editIcon.className = 'text-muted';
          editIcon.textContent = '‚úèÔ∏è';
        }
      } else {
        slotContent.textContent = '‚Äî';
        slotContent.className = 'text-muted slot-content';
        slotElement.classList.add('empty-slot');
        slotElement.dataset.currentMember = '';
        slotElement.title = 'Click to assign someone or view why empty';

        // Update the add icon
        const addIcon = slotElement.querySelector('small');
        if (addIcon) {
          addIcon.className = 'text-primary';
          addIcon.textContent = '‚ûï';
        }
      }

      // Close modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('editSlotModal'));
      modal.hide();
    } else {
      alert('Error saving assignment: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error saving assignment');
  })
  .finally(() => {
    saveBtn.disabled = false;
    saveBtn.innerHTML = 'Save Changes';
  });
}

function showDiagnosticModal(role, date, diagnostic) {
  const modal = new bootstrap.Modal(document.getElementById('diagnosticModal'));
  const modalBody = document.getElementById('diagnosticModalBody');
  const modalTitle = document.getElementById('diagnosticModalLabel');

  // Format role name nicely
  const roleName = ROLE_TITLES[role] || role;
  const displayDate = formatDateForDisplay(date);

  // Update title (use textContent to avoid XSS)
  modalTitle.textContent = `Why no ${roleName} on ${displayDate}?`;

  // Build detailed content with proper escaping
  let content = `<div class="alert alert-info"><strong>Summary:</strong> ${escapeHtml(diagnostic.summary)}</div>`;

  content += `<p><strong>Total members with ${escapeHtml(roleName)} role:</strong> ${escapeHtml(diagnostic.total_members_with_role)}</p>`;

  content += '<h6>Detailed Breakdown:</h6><ul>';

  const reasons = diagnostic.reasons;

  // Helper function to escape array of names
  const escapeNames = (names) => names.map(n => escapeHtml(n)).join(', ');

  if (reasons.blacked_out && reasons.blacked_out.length > 0) {
    content += `<li><strong>üö´ Blacked out (${reasons.blacked_out.length}):</strong> ${escapeNames(reasons.blacked_out)}</li>`;
  }

  if (reasons.already_assigned_today && reasons.already_assigned_today.length > 0) {
    content += `<li><strong>üìÖ Already assigned this day (${reasons.already_assigned_today.length}):</strong> ${escapeNames(reasons.already_assigned_today)}</li>`;
  }

  if (reasons.max_assignments_reached && reasons.max_assignments_reached.length > 0) {
    content += `<li><strong>üéØ At max assignments for month (${reasons.max_assignments_reached.length}):</strong> ${escapeNames(reasons.max_assignments_reached)}</li>`;
  }

  if (reasons.scheduling_suspended && reasons.scheduling_suspended.length > 0) {
    content += `<li><strong>‚è∏Ô∏è Scheduling suspended (${reasons.scheduling_suspended.length}):</strong> ${escapeNames(reasons.scheduling_suspended)}</li>`;
  }

  if (reasons.dont_schedule && reasons.dont_schedule.length > 0) {
    content += `<li><strong>üôÖ Opted out of duty scheduling (${reasons.dont_schedule.length}):</strong> ${escapeNames(reasons.dont_schedule)}</li>`;
  }

  if (reasons.percent_zero && reasons.percent_zero.length > 0) {
    content += `<li><strong>0Ô∏è‚É£ Role percentage set to 0% (${reasons.percent_zero.length}):</strong> ${escapeNames(reasons.percent_zero)}</li>`;
  }

  if (reasons.avoids_someone && reasons.avoids_someone.length > 0) {
    content += `<li><strong>üë• Avoids someone already assigned (${reasons.avoids_someone.length}):</strong> ${escapeNames(reasons.avoids_someone)}</li>`;
  }

  if (reasons.no_preference && reasons.no_preference.length > 0) {
    content += `<li><strong>‚ùì No duty preference set (${reasons.no_preference.length}):</strong> ${escapeNames(reasons.no_preference)}</li>`;
  }

  // Check if all reasons are empty
  const hasAnyReason = Object.values(reasons).some(arr => arr && arr.length > 0);
  if (!hasAnyReason) {
    content += '<li><em>No specific constraints identified. This may indicate an algorithm issue.</em></li>';
  }

  content += '</ul>';

  content += '<div class="alert alert-secondary mt-3">';
  content += '<strong>üí° Tip:</strong> To fill this slot, you can:';
  content += '<ul class="mb-0">';
  content += '<li>Click "Assign Someone" below to manually assign a member (with warnings if constraints exist)</li>';
  content += '<li>Adjust blackout dates for the members listed above</li>';
  content += '<li>Increase max assignments per month for available members</li>';
  content += '</ul>';
  content += '</div>';

  modalBody.innerHTML = content;
  modal.show();
}
</script>
{% endblock %}

{% load siteconfig_tags %}
{% load duty_extras %}
{% get_siteconfig as config %}
{% get_roster_message as roster_message %}
<div id="calendar-body" data-current-year="{{ year }}" data-current-month="{{ month }}">
    {# Issue #551: Rich HTML message from DutyRosterMessage model #}
    {% if roster_message %}
    <div class="alert alert-info alert-dismissible fade show mb-4" role="alert">
      <div class="d-flex align-items-start">
        <i class="bi bi-megaphone-fill me-2 fs-5 text-info" aria-hidden="true"></i>
        <div class="flex-grow-1">
          <div class="d-flex justify-content-between align-items-start">
            <strong class="d-block mb-1">Roster Manager Announcement:</strong>
            {% if user.rostermeister or user.is_staff or user.is_superuser %}
            <a href="{% url 'duty_roster:edit_roster_message' %}" class="btn btn-sm btn-outline-primary ms-2" title="Edit announcement">
              <i class="bi bi-pencil"></i>
            </a>
            {% endif %}
          </div>
          <div class="cms-content">{{ roster_message.content|safe }}</div>
        </div>
      </div>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% elif user.rostermeister or user.is_staff or user.is_superuser %}
    {# Show "Add Message" button for rostermeisters when no message exists #}
    <div class="mb-4 text-end">
      <a href="{% url 'duty_roster:edit_roster_message' %}" class="btn btn-sm btn-outline-secondary" title="Add roster announcement">
        <i class="bi bi-megaphone me-1"></i> Add Announcement
      </a>
    </div>
    {% endif %}

    {# Top navigation with full header #}
    {% include "duty_roster/_calendar_month_nav.html" with show_full_header=True %}

    <!-- Calendar View -->
    <div id="calendar-view-content">
      {% include "duty_roster/_calendar_table.html" %}
    </div>

    <!-- Agenda View -->
    <div id="agenda-view-content" style="display: none;">
      {% include "duty_roster/_calendar_agenda.html" %}
    </div>

    <!-- Calendar Legend (Issue #690) -->
    <div class="d-flex flex-wrap gap-2 justify-content-center mt-3 mb-1 px-2" aria-label="Calendar legend">
      <span class="duty-badge badge-instructor"><i class="bi bi-mortarboard" aria-hidden="true"></i> {{ config.instructor_title|default:'Instructor' }}</span>
      <span class="duty-badge badge-tow-pilot"><i class="bi bi-airplane" aria-hidden="true"></i> {{ config.towpilot_title|default:'Tow Pilot' }}</span>
      <span class="duty-badge badge-duty-officer"><i class="bi bi-clipboard-check" aria-hidden="true"></i> {{ config.duty_officer_title|default:'Duty Officer' }}</span>
      <span class="duty-badge badge-assistant-duty-officer"><i class="bi bi-person-badge" aria-hidden="true"></i> {{ config.assistant_duty_officer_title|default:'Assistant DO' }}</span>
      <span class="duty-badge badge-surge"><i class="bi bi-exclamation-triangle" aria-hidden="true"></i> Surge Demand</span>
    </div>

    {# Bottom navigation with simplified center (reuse shared month navigation partial) #}
    {% include "duty_roster/_calendar_month_nav.html" with show_full_header=False margin_class="mt-4" %}

    <script>
      function toggleCalendarView(view) {
        const calendarView = document.getElementById('calendar-view-content');
        const agendaView = document.getElementById('agenda-view-content');

        if (view === 'calendar') {
          calendarView.style.display = 'block';
          agendaView.style.display = 'none';
        } else if (view === 'agenda') {
          calendarView.style.display = 'none';
          agendaView.style.display = 'block';
        }

        // Store the current view preference
        localStorage.setItem('duty-roster-view', view);
      }

      // Restore view state after HTMX loads new content
      function restoreViewState() {
        // URL param takes priority (e.g. ?view=agenda from the navbar link)
        const params = new URLSearchParams(window.location.search);
        const urlView = params.get('view');
        const savedView = urlView || localStorage.getItem('duty-roster-view') || 'calendar';
        const calendarRadio = document.getElementById('calendar-view');
        const agendaRadio = document.getElementById('agenda-view');

        if (savedView === 'agenda') {
          agendaRadio.checked = true;
          calendarRadio.checked = false;
          toggleCalendarView('agenda');
        } else {
          calendarRadio.checked = true;
          agendaRadio.checked = false;
          toggleCalendarView('calendar');
        }
      }

      // Restore state when page loads or HTMX updates content
      document.addEventListener('DOMContentLoaded', restoreViewState);
      document.addEventListener('htmx:afterSettle', function(event) {
        if (event.detail.target.id === 'calendar-body') {
          restoreViewState();
        }
      });
    </script>
  </div>

{% load siteconfig_tags %}
{% load duty_extras %}
{% get_siteconfig as config %}
{% get_roster_message as roster_message %}
<div id="calendar-body" data-current-year="{{ year }}" data-current-month="{{ month }}">
    {# Issue #551: Rich HTML message from DutyRosterMessage model #}
    {% if roster_message %}
    <div class="alert alert-info alert-dismissible fade show mb-4" role="alert">
      <div class="d-flex align-items-start">
        <i class="bi bi-megaphone-fill me-2 fs-5 text-info" aria-hidden="true"></i>
        <div class="flex-grow-1">
          <div class="d-flex justify-content-between align-items-start">
            <strong class="d-block mb-1">Roster Manager Announcement:</strong>
            {% if user.rostermeister or user.is_staff or user.is_superuser %}
            <a href="{% url 'duty_roster:edit_roster_message' %}" class="btn btn-sm btn-outline-primary ms-2" title="Edit announcement">
              <i class="bi bi-pencil"></i>
            </a>
            {% endif %}
          </div>
          <div class="cms-content">{{ roster_message.content|safe }}</div>
        </div>
      </div>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% elif user.rostermeister or user.is_staff or user.is_superuser %}
    {# Show "Add Message" button for rostermeisters when no message exists #}
    <div class="mb-4 text-end">
      <a href="{% url 'duty_roster:edit_roster_message' %}" class="btn btn-sm btn-outline-secondary" title="Add roster announcement">
        <i class="bi bi-megaphone me-1"></i> Add Announcement
      </a>
    </div>
    {% endif %}
    <div class="d-flex justify-content-between align-items-center mb-4">
      <button
        hx-get="{% url 'duty_roster:duty_calendar_month' year=prev_year month=prev_month %}"
        hx-target="#calendar-body"
        hx-swap="innerHTML"
        class="btn btn-sm btn-outline-primary"
        title="Go to {{ prev_month_name }} {{ prev_year }}"
      >
        <i class="fas fa-chevron-left"></i> {{ prev_month_name }}
      </button>

      <div class="text-center">
        <h3 class="mb-2 text-primary fw-bold">ðŸ“… {{ formatted_date }}</h3>

        <!-- Swap Navigation Links -->
        {% if user.is_authenticated %}
        <div class="mb-2">
          <a href="{% url 'duty_roster:my_swap_requests' %}" class="btn btn-sm btn-outline-primary me-1">
            <i class="fas fa-exchange-alt me-1"></i>My Swap Requests
          </a>
          <a href="{% url 'duty_roster:open_swap_requests' %}" class="btn btn-sm btn-outline-success">
            <i class="fas fa-hands-helping me-1"></i>Help Others
          </a>
        </div>
        {% endif %}

        <!-- View Toggle -->
        <div class="btn-group btn-group-sm" role="group" aria-label="Calendar View Toggle">
          <input type="radio" class="btn-check" name="view-toggle" id="calendar-view" autocomplete="off"
                 onchange="toggleCalendarView('calendar')" checked>
          <label class="btn btn-outline-secondary" for="calendar-view">
            <i class="fas fa-calendar-alt"></i> Calendar
          </label>

          <input type="radio" class="btn-check" name="view-toggle" id="agenda-view" autocomplete="off"
                 onchange="toggleCalendarView('agenda')">
          <label class="btn btn-outline-secondary" for="agenda-view">
            <i class="fas fa-list"></i> Agenda
          </label>
        </div>
      </div>

      <button
        hx-get="{% url 'duty_roster:duty_calendar_month' year=next_year month=next_month %}"
        hx-target="#calendar-body"
        hx-swap="innerHTML"
        class="btn btn-sm btn-outline-primary"
        title="Go to {{ next_month_name }} {{ next_year }}"
      >
        {{ next_month_name }} <i class="fas fa-chevron-right"></i>
      </button>
    </div>

    <!-- Calendar View -->
    <div id="calendar-view-content">
      {% include "duty_roster/_calendar_table.html" %}
    </div>

    <!-- Agenda View -->
    <div id="agenda-view-content" style="display: none;">
      {% include "duty_roster/_calendar_agenda.html" %}
    </div>

    <!-- Bottom Navigation (duplicated for convenience, especially in Agenda view) -->
    <div class="d-flex justify-content-between align-items-center mt-4">
      <button
        hx-get="{% url 'duty_roster:duty_calendar_month' year=prev_year month=prev_month %}"
        hx-target="#calendar-body"
        hx-swap="innerHTML"
        class="btn btn-sm btn-outline-primary"
        title="Go to {{ prev_month_name }} {{ prev_year }}"
      >
        <i class="fas fa-chevron-left"></i> {{ prev_month_name }}
      </button>

      <div class="text-center">
        <span class="text-muted">{{ formatted_date }}</span>
      </div>

      <button
        hx-get="{% url 'duty_roster:duty_calendar_month' year=next_year month=next_month %}"
        hx-target="#calendar-body"
        hx-swap="innerHTML"
        class="btn btn-sm btn-outline-primary"
        title="Go to {{ next_month_name }} {{ next_year }}"
      >
        {{ next_month_name }} <i class="fas fa-chevron-right"></i>
      </button>
    </div>

    <script>
      function toggleCalendarView(view) {
        const calendarView = document.getElementById('calendar-view-content');
        const agendaView = document.getElementById('agenda-view-content');

        if (view === 'calendar') {
          calendarView.style.display = 'block';
          agendaView.style.display = 'none';
        } else if (view === 'agenda') {
          calendarView.style.display = 'none';
          agendaView.style.display = 'block';
        }

        // Store the current view preference
        localStorage.setItem('duty-roster-view', view);
      }

      // Restore view state after HTMX loads new content
      function restoreViewState() {
        const savedView = localStorage.getItem('duty-roster-view') || 'calendar';
        const calendarRadio = document.getElementById('calendar-view');
        const agendaRadio = document.getElementById('agenda-view');

        if (savedView === 'agenda') {
          agendaRadio.checked = true;
          calendarRadio.checked = false;
          toggleCalendarView('agenda');
        } else {
          calendarRadio.checked = true;
          agendaRadio.checked = false;
          toggleCalendarView('calendar');
        }
      }

      // Restore state when page loads or HTMX updates content
      document.addEventListener('DOMContentLoaded', restoreViewState);
      document.addEventListener('htmx:afterSettle', function(event) {
        if (event.detail.target.id === 'calendar-body') {
          restoreViewState();
        }
      });
    </script>
  </div>

{% extends "base.html" %}
{% load static %}
{% block title %}Duty Roster Calendar{% endblock %}

{% block content %}

    <!-- Messages Section -->
    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
          {% if message.tags == "success" %}
            <i class="fas fa-check-circle me-2"></i>
          {% elif message.tags == "danger" or message.tags == "error" %}
            <i class="fas fa-exclamation-circle me-2"></i>
          {% elif message.tags == "warning" %}
            <i class="fas fa-exclamation-triangle me-2"></i>
          {% elif message.tags == "info" %}
            <i class="fas fa-info-circle me-2"></i>
          {% endif %}
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}

    {% include "duty_roster/_calendar_body.html" %}


    <div class="modal fade" id="calendarModal" tabindex="-1" role="dialog" aria-labelledby="calendarModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="calendarModalLabel">Duty Day</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modal-body">
              <!-- HTMX content will load here -->
            </div>
          </div>
        </div>
      </div>

      <script>
        function showModalWithLoading() {
          // Clear any previous content and show loading state
          const modalBody = document.getElementById('modal-body');

          // Show only the loading spinner with smooth transition
          modalBody.innerHTML = `
            <div id="modal-loading" class="text-center py-4" style="opacity: 0;">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-3 text-muted">Loading duty information...</p>
            </div>
          `;

          // Show the modal
          bootstrap.Modal.getOrCreateInstance(document.getElementById('calendarModal')).show();

          // Fade in the loading spinner
          setTimeout(() => {
            const loadingDiv = document.getElementById('modal-loading');
            if (loadingDiv) {
              loadingDiv.style.transition = 'opacity 0.2s ease-in';
              loadingDiv.style.opacity = '1';
            }
          }, 50);
        }

        // Only add event listeners once - check if they're already added
        if (!window.dutyRosterModalListenersAdded) {
          // Hide loading spinner when HTMX content loads
          document.body.addEventListener('htmx:afterRequest', function(event) {
            if (event.detail.target.id === 'modal-body') {
              // Content has loaded, remove loading state if it exists
              const loadingDiv = document.getElementById('modal-loading');
              if (loadingDiv) {
                loadingDiv.remove();
              }
            }
          });

          // Handle HTMX errors gracefully
          document.body.addEventListener('htmx:responseError', function(event) {
            if (event.detail.target.id === 'modal-body') {
              document.getElementById('modal-body').innerHTML = `
                <div class="text-center py-4">
                  <div class="text-danger">
                    <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                    <p>Sorry, there was an error loading the duty information.</p>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  </div>
                </div>
              `;
            }
          });

          // Handle calendar refresh trigger - preserves current month context
          document.body.addEventListener('refreshCalendar', function(event) {
            let year, month;

            // Try to get year/month from event detail (passed from server)
            if (event.detail && event.detail.year && event.detail.month) {
              year = event.detail.year;
              month = event.detail.month;
            } else {
              // Fallback: get from calendar body data attributes
              const calendarBody = document.getElementById('calendar-body');
              if (calendarBody) {
                year = calendarBody.getAttribute('data-current-year');
                month = calendarBody.getAttribute('data-current-month');
              }
            }

            if (year && month) {
              // Refresh with the correct month context
              const refreshUrl = `/duty_roster/calendar/${year}/${month}/`;
              htmx.ajax('GET', refreshUrl, {target: '#calendar-body', swap: 'innerHTML'});
            } else {
              // Final fallback: refresh current URL
              htmx.ajax('GET', window.location.pathname, {target: '#calendar-body', swap: 'innerHTML'});
            }
          });

          // Mark listeners as added
          window.dutyRosterModalListenersAdded = true;
        }
      </script>

{% endblock %}

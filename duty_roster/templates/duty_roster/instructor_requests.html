{% extends "base.html" %}
{% load static %}
{% load siteconfig_tags %}

{% block title %}Instructor - Student Requests{% endblock %}

{% block content %}
<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-chalkboard-teacher me-2"></i>Student Requests</h1>
    <a href="{% url 'duty_roster:duty_calendar' %}" class="btn btn-outline-secondary">
      <i class="fas fa-calendar me-1"></i>Back to Calendar
    </a>
  </div>

  {% include "duty_roster/_messages.html" %}

  <div class="row">
    <!-- Pending Requests Column -->
    <div class="col-lg-6 mb-4">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0">
            <i class="fas fa-clock me-2"></i>Pending Requests
            {% if pending_count %}
              <span class="badge bg-dark ms-2">{{ pending_count }}</span>
            {% endif %}
          </h5>
        </div>
        <div class="card-body">
          {% if pending_by_date %}
            {% for day, slots in pending_by_date.items %}
              <div class="mb-4">
                <h6 class="border-bottom pb-2">
                  <i class="fas fa-calendar-day me-2"></i>{{ day|date:"l, F j, Y" }}
                  {% if day == today %}
                    <span class="badge bg-danger ms-1">TODAY</span>
                  {% endif %}
                </h6>
                {% for slot in slots %}
                  <div class="card mb-2">
                    <div class="card-body py-2 px-3">
                      <div class="d-flex justify-content-between align-items-start">
                        <div>
                          <strong>{{ slot.student.full_display_name }}</strong>
                          {% if slot.instruction_types %}
                            <br><small><i class="fas fa-graduation-cap me-1 text-success"></i><strong>{{ slot.get_instruction_types_text }}</strong></small>
                          {% endif %}
                          {% if slot.student_notes %}
                            <br><small class="text-muted"><i class="fas fa-comment me-1"></i>{{ slot.student_notes|truncatewords:20 }}</small>
                          {% endif %}
                          {% if slot.student.phone %}
                            <br><small class="text-muted"><i class="fas fa-phone me-1"></i>{{ slot.student.phone }}</small>
                          {% endif %}
                          {% if slot.student.email %}
                            <br><small class="text-muted"><i class="fas fa-envelope me-1"></i>{{ slot.student.email }}</small>
                          {% endif %}
                          <br><small class="text-muted">Requested: {{ slot.created_at|date:"M j, g:i a" }}</small>
                        </div>
                        <div class="text-end">
                          <form action="{% url 'duty_roster:instructor_respond' slot_id=slot.id %}" method="post" class="d-inline">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="accept">
                            <button type="submit" class="btn btn-sm btn-success mb-1" title="Accept this student">
                              <i class="fas fa-check"></i>
                            </button>
                          </form>
                          <br>
                          <button type="button" class="btn btn-sm btn-outline-danger"
                                  data-bs-toggle="modal"
                                  data-bs-target="#rejectModal{{ slot.id }}"
                                  title="Decline with note">
                            <i class="fas fa-times"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Reject Modal -->
                  <div class="modal fade" id="rejectModal{{ slot.id }}" tabindex="-1">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <form action="{% url 'duty_roster:instructor_respond' slot_id=slot.id %}" method="post">
                          {% csrf_token %}
                          <input type="hidden" name="action" value="reject">
                          <div class="modal-header">
                            <h5 class="modal-title">Decline {{ slot.student.first_name }}?</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                          </div>
                          <div class="modal-body">
                            <p>Declining instruction request from <strong>{{ slot.student.full_display_name }}</strong>
                               for {{ slot.assignment.date|date:"l, F j" }}.</p>
                            <div class="mb-3">
                              <label class="form-label">Note to student (optional)</label>
                              <textarea name="instructor_note" class="form-control" rows="3"
                                        placeholder="e.g., 'Already at capacity, please try another day'"></textarea>
                            </div>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-danger">Decline Request</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% endfor %}
          {% else %}
            <div class="text-center py-4">
              <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
              <p class="text-muted mb-0">No pending requests.</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Accepted Students Column -->
    <div class="col-lg-6 mb-4">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">
            <i class="fas fa-check-circle me-2"></i>Accepted Students
            {% if accepted_count %}
              <span class="badge bg-light text-success ms-2">{{ accepted_count }}</span>
            {% endif %}
          </h5>
        </div>
        <div class="card-body">
          {% if accepted_by_date %}
            {% for day, slots in accepted_by_date.items %}
              <div class="mb-4">
                <h6 class="border-bottom pb-2">
                  <i class="fas fa-calendar-day me-2"></i>{{ day|date:"l, F j, Y" }}
                  {% if day == today %}
                    <span class="badge bg-warning text-dark ms-1">TODAY</span>
                  {% endif %}
                  <span class="badge bg-secondary ms-1">{{ slots|length }} student{{ slots|length|pluralize }}</span>
                </h6>
                {% for slot in slots %}
                  <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                    <div>
                      <strong>{{ slot.student.full_display_name }}</strong>
                      {% if slot.instruction_types %}
                        <br><small><i class="fas fa-graduation-cap me-1 text-success"></i>{{ slot.get_instruction_types_text }}</small>
                      {% endif %}
                      {% if slot.student_notes %}
                        <br><small class="text-muted"><i class="fas fa-comment me-1"></i>{{ slot.student_notes|truncatewords:15 }}</small>
                      {% endif %}
                      {% if slot.student.phone %}
                        <br><small class="text-muted"><i class="fas fa-phone me-1"></i>{{ slot.student.phone }}</small>
                      {% endif %}
                    </div>
                    <span class="badge bg-success">Confirmed</span>
                  </div>
                {% endfor %}

                {% if slots|length >= instruction_surge_threshold %}
                  {% with assignment=slots.0.assignment %}
                    {% if assignment.surge_instructor %}
                      <div class="alert alert-success mt-2 mb-0 py-2">
                        <i class="fas fa-check-circle me-1"></i>
                        <small>Surge instructor assigned: <strong>{{ assignment.surge_instructor.full_display_name }}</strong></small>
                      </div>
                    {% elif assignment.instructor == request.user %}
                      <div class="alert alert-warning mt-2 mb-0 py-2 d-flex align-items-center justify-content-between flex-wrap gap-2">
                        <span>
                          <i class="fas fa-exclamation-triangle me-1"></i>
                          <small>High student count &mdash; a surge instructor may be needed.</small>
                        </span>
                        <form action="{% url 'duty_roster:request_surge_instructor' assignment_id=assignment.id %}" method="post" class="d-inline">
                          {% csrf_token %}
                          {% if assignment.surge_notified %}
                            <button type="submit" class="btn btn-sm btn-warning" title="Send another surge request to the instructors list">
                              <i class="fas fa-redo me-1"></i>Re-send Surge Request
                            </button>
                          {% else %}
                            <button type="submit" class="btn btn-sm btn-warning" title="Notify instructors that a surge instructor is needed">
                              <i class="fas fa-user-plus me-1"></i>Request Surge Instructor
                            </button>
                          {% endif %}
                        </form>
                      </div>
                    {% else %}
                      <div class="alert alert-warning mt-2 mb-0 py-2">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        <small>High student count &mdash; consider requesting a surge instructor if needed.</small>
                      </div>
                    {% endif %}
                  {% endwith %}
                {% endif %}
              </div>
            {% endfor %}
          {% else %}
            <div class="text-center py-4">
              <i class="fas fa-user-graduate fa-3x text-muted mb-3"></i>
              <p class="text-muted mb-0">No accepted students yet.</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div><!-- /.row -->

  {% if allocation_by_date %}
  <!-- ========================================================
       Student Allocation Section (Issue #664)
       Shown only for days that have both a primary and surge instructor.
       ======================================================== -->
  <div class="row mt-2">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">
            <i class="fas fa-users-cog me-2"></i>Student Allocation
            <small class="fw-normal ms-2">Move students between instructors for surge days</small>
          </h5>
        </div>
        <div class="card-body">
          {% for day, alloc in allocation_by_date.items %}
            <div class="mb-4">
              <h6 class="border-bottom pb-2">
                <i class="fas fa-calendar-day me-2"></i>{{ day|date:"l, F j, Y" }}
                {% if day == today %}
                  <span class="badge bg-danger ms-1">TODAY</span>
                {% endif %}
                {% with primary_count=alloc.primary_slots|length surge_count=alloc.surge_slots|length unassigned_count=alloc.unassigned_slots|length %}
                {% with total_students=primary_count|add:surge_count|add:unassigned_count %}
                <span class="badge bg-secondary ms-1">{{ total_students }} student{{ total_students|pluralize }}</span>
                {% endwith %}{% endwith %}
              </h6>

              <div class="row g-3">
                <!-- Primary instructor's students -->
                <div class="col-md-6">
                  <div class="card border-primary h-100">
                    <div class="card-header py-2 bg-primary bg-opacity-10 d-flex justify-content-between align-items-center">
                      <span class="fw-bold text-primary">
                        <i class="fas fa-user-tie me-1"></i>{{ alloc.primary.full_display_name }}
                      </span>
                      <span class="badge bg-primary">{{ alloc.primary_slots|length }} student{{ alloc.primary_slots|length|pluralize }}</span>
                    </div>
                    <div class="card-body p-2">
                      {% for slot in alloc.primary_slots %}
                        <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                          <div class="flex-grow-1">
                            <strong class="small">{{ slot.student.full_display_name }}</strong>
                            {% if slot.instruction_types %}
                              <br><small class="text-muted">{{ slot.get_instruction_types_text }}</small>
                            {% endif %}
                          </div>
                          <form action="{% url 'duty_roster:assign_student_to_instructor' slot_id=slot.id %}" method="post" class="ms-2 flex-shrink-0">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="surge">
                            <button type="submit" class="btn btn-sm btn-outline-success" title="Move to {{ alloc.surge.full_display_name }}">
                              <i class="fas fa-arrow-right me-1"></i>Surge
                            </button>
                          </form>
                        </div>
                      {% empty %}
                        <p class="text-muted small text-center py-3 mb-0">
                          <i class="fas fa-inbox me-1"></i>No students assigned yet
                        </p>
                      {% endfor %}
                    </div>
                  </div>
                </div><!-- /.col primary -->

                <!-- Surge instructor's students -->
                <div class="col-md-6">
                  <div class="card border-success h-100">
                    <div class="card-header py-2 bg-success bg-opacity-10 d-flex justify-content-between align-items-center">
                      <span class="fw-bold text-success">
                        <i class="fas fa-user-plus me-1"></i>{{ alloc.surge.full_display_name }}
                        <span class="badge bg-secondary ms-1">Surge</span>
                      </span>
                      <span class="badge bg-success">{{ alloc.surge_slots|length }} student{{ alloc.surge_slots|length|pluralize }}</span>
                    </div>
                    <div class="card-body p-2">
                      {% for slot in alloc.surge_slots %}
                        <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                          <form action="{% url 'duty_roster:assign_student_to_instructor' slot_id=slot.id %}" method="post" class="me-2 flex-shrink-0">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="primary">
                            <button type="submit" class="btn btn-sm btn-outline-primary" title="Move to {{ alloc.primary.full_display_name }}">
                              <i class="fas fa-arrow-left me-1"></i>Primary
                            </button>
                          </form>
                          <div class="flex-grow-1 text-end">
                            <strong class="small">{{ slot.student.full_display_name }}</strong>
                            {% if slot.instruction_types %}
                              <br><small class="text-muted">{{ slot.get_instruction_types_text }}</small>
                            {% endif %}
                          </div>
                        </div>
                      {% empty %}
                        <p class="text-muted small text-center py-3 mb-0">
                          <i class="fas fa-inbox me-1"></i>No students assigned yet
                        </p>
                      {% endfor %}
                    </div>
                  </div>
                </div><!-- /.col surge -->
              </div><!-- /.row students -->

              {% if alloc.unassigned_slots %}
                <div class="alert alert-warning mt-2 py-2">
                  <i class="fas fa-exclamation-triangle me-1"></i>
                  <strong>{{ alloc.unassigned_slots|length }} unassigned student{{ alloc.unassigned_slots|length|pluralize }}:</strong>
                  {% for slot in alloc.unassigned_slots %}
                    <span class="badge bg-warning text-dark ms-1">{{ slot.student.full_display_name }}</span>
                    <form action="{% url 'duty_roster:assign_student_to_instructor' slot_id=slot.id %}" method="post" class="d-inline ms-1">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="primary">
                      <button type="submit" class="btn btn-sm btn-outline-primary">→ Primary</button>
                    </form>
                    <form action="{% url 'duty_roster:assign_student_to_instructor' slot_id=slot.id %}" method="post" class="d-inline ms-1">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="surge">
                      <button type="submit" class="btn btn-sm btn-outline-success">→ Surge</button>
                    </form>
                  {% endfor %}
                </div>
              {% endif %}

            </div><!-- /.mb-4 per day -->
          {% endfor %}
        </div><!-- /.card-body -->
      </div><!-- /.card -->
    </div>
  </div><!-- /.row allocation -->
  {% endif %}

  <!-- Quick Tips -->
  <div class="card shadow-sm mt-3">
    <div class="card-header bg-light">
      <h6 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Tips for Managing Instruction Requests</h6>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-4">
          <p class="small mb-0">
            <i class="fas fa-check text-success me-1"></i>
            <strong>Accept</strong> students you can work with. They'll receive email confirmation.
          </p>
        </div>
        <div class="col-md-4">
          <p class="small mb-0">
            <i class="fas fa-times text-danger me-1"></i>
            <strong>Decline</strong> with a note if you can't take a student. Suggest alternative dates.
          </p>
        </div>
        <div class="col-md-4">
          <p class="small mb-0">
            <i class="fas fa-users text-warning me-1"></i>
            <strong>3+ students?</strong> The system will automatically notify other instructors.
          </p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

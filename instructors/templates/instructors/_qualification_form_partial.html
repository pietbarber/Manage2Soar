{% load dict_extras %}
{% load static %}

<!-- Qualification Assignment Form Partial -->
<form method="post" hx-post="{% url 'instructors:assign_qualification_modal' member.id %}" hx-target="#qualification-modal-content" hx-swap="innerHTML">
  {% csrf_token %}

  {% if form.errors %}
    <div class="alert alert-danger">
      <strong>Please correct the following errors:</strong>
      <ul class="mb-0 mt-2">
        {% for field, errors in form.errors.items %}
          {% for error in errors %}
            <li>{{ error }}</li>
          {% endfor %}
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <div class="row g-3">
    <div class="col-12">
      <label for="{{ form.qualification.id_for_label }}" class="form-label">
        <strong>
          <i class="bi bi-award me-2"></i>Qualification
        </strong>
      </label>
      <div class="d-flex align-items-center gap-2">
        <select name="qualification" id="{{ form.qualification.id_for_label }}" class="form-select qualification-select">
          <option value="">Select a qualification...</option>
          {% for qual in all_qualifications %}
            <option value="{{ qual.pk }}"
                    {% if form.qualification.value == qual.pk %}selected{% endif %}>
              {{ qual.name }}
            </option>
          {% endfor %}
        </select>
        {# Pre-render all qualification icons - show/hide with CSS based on selection #}
        <div class="qualification-icon-container">
          {% for qual in all_qualifications %}
            {% if qual.icon %}
              <img src="{{ qual.icon.url }}"
                   alt="{{ qual.name }} icon"
                   title="{{ qual.name }}"
                   class="qualification-icon qual-icon-{{ qual.pk }}"
                   width="24"
                   height="24"
                   style="display: {% if form.qualification.value == qual.pk %}inline-block{% else %}none{% endif %}; vertical-align: middle;">
            {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <label class="form-label">
        <strong>
          <i class="bi bi-check-circle me-2"></i>Status
        </strong>
      </label>
      <div class="form-check">
        {{ form.is_qualified|add_class:"form-check-input" }}
        <label class="form-check-label" for="{{ form.is_qualified.id_for_label }}">
          {{ form.is_qualified.label }}
        </label>
      </div>
    </div>

    <div class="col-md-6">
      <label for="{{ form.date_awarded.id_for_label }}" class="form-label">
        <strong>
          <i class="bi bi-calendar-event me-2"></i>{{ form.date_awarded.label }}
        </strong>
      </label>
      {{ form.date_awarded|add_class:"form-control" }}
    </div>

    <div class="col-12">
      <label for="{{ form.expiration_date.id_for_label }}" class="form-label">
        <strong>
          <i class="bi bi-calendar-x me-2"></i>{{ form.expiration_date.label }}
        </strong>
      </label>
      {{ form.expiration_date|add_class:"form-control" }}
    </div>

    <div class="col-12">
      <label for="{{ form.notes.id_for_label }}" class="form-label">
        <strong>
          <i class="bi bi-journal-text me-2"></i>Notes
        </strong>
      </label>
      {{ form.notes|add_class:"form-control" }}
      <div class="form-text">Optional additional information about this qualification</div>
    </div>
  </div>

  <div class="d-flex justify-content-end gap-2 mt-4">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
      <i class="bi bi-x-circle me-2"></i>Cancel
    </button>
    <button type="submit" class="btn btn-primary">
      <i class="bi bi-check-circle me-2"></i>Assign Qualification
    </button>
  </div>
</form>

<script>
// Qualification icon preview - pure show/hide, no DOM text manipulation
document.addEventListener('DOMContentLoaded', function() {
  const qualSelect = document.querySelector('#qualification-modal .qualification-select');
  if (qualSelect) {
    qualSelect.addEventListener('change', function() {
      // Hide all icons in this modal
      document.querySelectorAll('#qualification-modal .qualification-icon').forEach(icon => {
        icon.style.display = 'none';
      });

      // Show selected icon (if one exists)
      if (this.value) {
        const selectedIcon = document.querySelector('#qualification-modal .qual-icon-' + this.value);
        if (selectedIcon) {
          selectedIcon.style.display = 'inline-block';
        }
      }
    });
  }
});
</script>

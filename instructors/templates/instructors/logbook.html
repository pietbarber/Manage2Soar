{% extends "base.html" %}
{% block title %}Pilot Logbook{% endblock %}
{% block head_extra %}{% endblock %}

{% block content %}

<div id="top"></div>
<h2>Logbook for {{ member.full_display_name }}</h2>

<a href="{% url 'instructors:member_logbook_export_csv' %}" class="btn btn-success mb-3">Export as CSV (Excel/Google Sheets)</a>

<!-- Show All Years Button -->
<form method="post" action="{% url 'instructors:logbook_loading' %}" id="show-all-years-form" style="margin-bottom: 1em;">
  {% csrf_token %}
  <button type="submit" class="btn btn-warning">
    <span style="font-size:1.2em;">‚è≥</span> Show All Years
  </button>
</form>

<!-- Year Navigation -->
{% if years %}
<div class="year-navigation">
  <h5 class="mb-3">üìÖ Jump to Year:</h5>
  <div class="year-links">
    {% for year in all_years %}
      {% if year in years %}
        <a href="#year-{{ year }}" class="btn btn-primary year-link" style="margin-bottom:0.25em;">{{ year }}</a>
      {% else %}
        <form method="get" style="display:inline">
          <input type="hidden" name="year" value="{{ year }}">
          <button type="submit" class="btn btn-outline-secondary year-link" style="margin-bottom:0.25em;">{{ year }}</button>
        </form>
      {% endif %}
    {% endfor %}
  </div>
  <small class="text-muted mt-2 d-block">
    Click on any year to jump to that section. Years with no flights are not shown.
  </small>
</div>
{% endif %}


{% for page in pages %}

{% if page.is_first_for_year %}
<div id="year-{{ page.year_start }}" class="year-anchor">
  <div class="year-marker">
    üìÖ {{ page.year_start }}
  </div>
</div>
{% endif %}

<div class="table-responsive">
  <table class="table table-bordered table-sm mb-1">
    <thead class="table-dark">
      <tr>
        <th>Date</th>
        <th>#</th>
        <th>Model</th>
        <th>Glider</th>
        <th>A</th>
        <th>G</th>
        <th>S</th>
        <th>Rel</th>
        <th>Max</th>
        <th>Loc</th>
        <th class="text-end">Gnd</th>
        <th class="text-end">Dual</th>
        <th class="text-end">Solo</th>
        <th class="text-end">PIC</th>
        <th class="text-end">Inst</th>
        <th class="text-end">Total</th>
        <th>Comments</th>
      </tr>
    </thead>
    <tbody>
      {% for r in page.rows %}
      <tr>
        <td>{{ r.date|date:"Y-m-d" }}</td>
        <td class="text-end">{{ r.flight_no }}
          {% if r.flight_id %}

          <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#flightModal"
            hx-get="{% url 'logsheet:flight_view' r.flight_id %}" hx-target="#flightModal .modal-content"
            hx-trigger="click">üîç</button>
          {% endif %}
        </td>
        <td>{{ r.model }}</td>
        <td>{{ r.n_number }}</td>
        <td class="text-end">{{ r.A }}</td>
        <td class="text-end">{{ r.G }}</td>
        <td class="text-end">{{ r.S }}</td>
        <td class="text-end">{{ r.release }}</td>
        <td class="text-end">{{ r.maxh }}</td>
        <td>{{ r.airfield }}</td>
        <td class="text-end">{{ r.ground_inst }}</td>
        <td class="text-end">{{ r.dual_received }}</td>
        <td class="text-end">{{ r.solo }}</td>
        <td class="text-end">{{ r.pic }}</td>
        <td class="text-end">{{ r.inst_given }}</td>
        <td class="text-end">
          {% if r.is_passenger %}
          [{{ r.total }}]
          {% else %}
          {{ r.total }}
          {% endif %}
        </td>

        <td class="text-start logbook-comments">
          {{ r.signature_html|safe }}

          {% if r.report_id %}
          <button class="btn btn-sm btn-outline-secondary ms-1" data-bs-toggle="modal" data-bs-target="#trainingModal"
            hx-get="{% url 'instructors:instruction_report_detail' r.report_id %}"
            hx-target="#trainingModal .modal-content" hx-trigger="click">üîç</button>
          {% endif %}
        </td>
      </tr>
      {% endfor %}

      {# Page Totals #}
      <tr class="table-secondary fw-bold">
        <td colspan="3" class="text-end">Page Totals:</td>
        <td></td>
        <td class="text-end">{{ page.sums.A }}</td>
        <td class="text-end">{{ page.sums.G }}</td>
        <td class="text-end">{{ page.sums.S }}</td>
        <td colspan="3"></td>
        <td class="text-end">{{ page.sums.ground_inst }}</td>
        <td class="text-end">{{ page.sums.dual_received }}</td>
        <td class="text-end">{{ page.sums.solo }}</td>
        <td class="text-end">{{ page.sums.pic }}</td>
        <td class="text-end">{{ page.sums.inst_given }}</td>
        <td class="text-end">{{ page.sums.total }}</td>
        </td>

        <td></td>
      </tr>

      {# Running Totals #}
      <tr class="table-info fw-bold">
        <td colspan="3" class="text-end">Running Totals:</td>
        <td></td>
        <td class="text-end">{{ page.cumulative.A }}</td>
        <td class="text-end">{{ page.cumulative.G }}</td>
        <td class="text-end">{{ page.cumulative.S }}</td>
        <td colspan="3"></td>
        <td class="text-end">{{ page.cumulative.ground_inst }}</td>
        <td class="text-end">{{ page.cumulative.dual_received }}</td>
        <td class="text-end">{{ page.cumulative.solo }}</td>
        <td class="text-end">{{ page.cumulative.pic }}</td>
        <td class="text-end">{{ page.cumulative.inst_given }}</td>
        <td class="text-end">{{ page.cumulative.total }}</td>
        <td></td>
      </tr>

    </tbody>
  </table>
</div>

{% if not forloop.last %}
<div class="page-break"></div>
{% endif %}
{% endfor %}

<!-- Back to Top Button -->

<!-- Back to Top Button -->
<button class="back-to-top" onclick="document.getElementById('top').scrollIntoView({behavior: 'smooth'})" title="Back to Top">
  ‚Üë
</button>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center p-4">
      <div style="font-size:2em;">‚è≥</div>
      <div class="mt-2">Loading logbook... This may take a while.</div>
    </div>
  </div>
</div>

<div class="modal fade" id="flightModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      {% comment %}HTMX will drop in the content fragment here{% endcomment %}
    </div>
  </div>
</div>
<div class="modal fade" id="trainingModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <!-- HTMX will swap in the training-report fragment here -->
    </div>
  </div>
</div>


{% endblock %}
document.addEventListener('DOMContentLoaded', function() {

<script>
// Show loading modal on "Show All Years" form submit
document.addEventListener('DOMContentLoaded', function() {
  var form = document.getElementById('show-all-years-form');
  var modal = new bootstrap.Modal(document.getElementById('loadingModal'));
  if (form) {
    form.addEventListener('submit', function() {
      setTimeout(function() { modal.show(); }, 10);
    });
  }
  // Hide modal when page is loaded
  window.addEventListener('load', function() {
    var modalEl = document.getElementById('loadingModal');
    if (modalEl.classList.contains('show')) {
      var modalInstance = bootstrap.Modal.getInstance(modalEl);
      if (modalInstance) modalInstance.hide();
    }
  });
});
</script>

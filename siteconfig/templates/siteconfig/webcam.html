{% extends "base.html" %}
{% load static %}

{% block title %}Webcam{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <h2 class="mb-1">ðŸ“· Airport Webcam</h2>
      <p class="text-muted small mb-3">
        Live view refreshes every 10 seconds while this page is open.
        Refresh pauses automatically when you switch to another tab.
      </p>

      <div class="card shadow-sm">
        <div class="card-body p-2 text-center">
          <!--
            Start hidden; JavaScript shows the element after the first
            successful load, preventing a broken-image icon on initial
            camera errors.
          -->
          <img id="webcam-img"
               src="{% url 'siteconfig:webcam_snapshot' %}"
               alt="Airport webcam snapshot"
               class="img-fluid rounded"
               style="display:none; max-height: 720px;"
               onload="this.style.display=''"
               onerror="this.style.display='none'; document.getElementById('webcam-error').style.display='block';">
          <div id="webcam-error" class="alert alert-warning mt-3 mb-0" style="display:none;">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            Camera feed is temporarily unavailable. The image will resume automatically once the camera responds.
          </div>
        </div>
        <div class="card-footer text-muted small d-flex justify-content-between align-items-center">
          <span id="webcam-status">Auto-refreshingâ€¦</span>
          <span id="webcam-last-updated"></span>
        </div>
      </div>

    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function () {
  "use strict";

  var img            = document.getElementById("webcam-img");
  var errorDiv       = document.getElementById("webcam-error");
  var statusSpan     = document.getElementById("webcam-status");
  var lastUpdatedSpan = document.getElementById("webcam-last-updated");
  var INTERVAL_MS    = 10000;
  var timer          = null;
  var snapshotBase   = "{% url 'siteconfig:webcam_snapshot' %}";

  function refreshImage() {
    if (document.visibilityState === "hidden") return;

    var url = snapshotBase + "?t=" + Date.now();

    // Update the existing <img> directly â€” one network request per cycle.
    // (A separate Image() preload would cause a second request because the
    //  snapshot endpoint carries Cache-Control: no-store.)
    img.onload = function () {
      img.style.display = "";
      errorDiv.style.display = "none";
      lastUpdatedSpan.textContent = "Updated " + new Date().toLocaleTimeString();
    };
    img.onerror = function () {
      img.style.display = "none";
      errorDiv.style.display = "block";
      lastUpdatedSpan.textContent = "Last attempt: " + new Date().toLocaleTimeString();
    };

    img.src = url;
  }

  function startRefresh() {
    if (timer) return;
    timer = setInterval(refreshImage, INTERVAL_MS);
    statusSpan.textContent = "Auto-refreshing every 10 sâ€¦";
  }

  function stopRefresh() {
    if (timer) {
      clearInterval(timer);
      timer = null;
    }
    statusSpan.textContent = "Refresh paused (tab hidden)";
  }

  // Pause/resume based on tab visibility so the camera is only polled
  // while someone is actively looking at this page.
  document.addEventListener("visibilitychange", function () {
    if (document.visibilityState === "visible") {
      refreshImage();   // immediate catch-up refresh when tab is foregrounded
      startRefresh();
    } else {
      stopRefresh();
    }
  });

  startRefresh();

  // Clean up the interval on page unload.  We use "pagehide" rather than
  // "beforeunload" because beforeunload does not fire for back/forward-cache
  // (bfcache) navigations; pagehide fires reliably for both bfcache and
  // regular unloads.  The visibilitychange handler above already pauses the
  // timer while the tab is hidden, so this is an extra safety net.
  window.addEventListener("pagehide", function () {
    if (timer) {
      clearInterval(timer);
      timer = null;
    }
  });
})();
</script>
{% endblock %}

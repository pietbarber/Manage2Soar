{% extends "base.html" %}
{% block content %}
  <div style="display:flex;align-items:center;justify-content:space-between;">
    <h1 style="margin:0">{{ page.title }}</h1>
    {% if can_edit_page %}
      <div>
        <a class="btn btn-sm btn-primary me-2" href="{% url 'cms:edit_page' page.id %}">✏️ Edit Page</a>
        <a class="btn btn-sm btn-outline-secondary" href="{% url 'admin:cms_page_change' page.pk %}">⚙️ Admin</a>
      </div>
    {% endif %}
  </div>
  {% if breadcrumbs %}
    <nav aria-label="breadcrumb" style="margin:0.5rem 0;">
      <ol class="breadcrumb cms-breadcrumb">
        {% for crumb in breadcrumbs %}
          <li class="breadcrumb-item">
            <a href="{{ crumb.url }}">{{ crumb.title }}</a>
          </li>
        {% endfor %}
        <li class="breadcrumb-item active" aria-current="page">{{ page.title }}</li>
      </ol>
    </nav>
  {% endif %}

  <!-- Access Control Information -->
  {% if not page.is_public %}
    <div class="alert alert-info mb-3">
      <i class="bi bi-shield-lock me-2"></i>
      <strong>Access Restricted:</strong>
      {% if not page_has_role_restrictions %}
        This page is available to all active club members.
      {% else %}
        This page is restricted to members with the following roles:
        {% for role in page_required_roles %}
          <span class="badge bg-primary ms-1">{{ role }}</span>
        {% endfor %}
      {% endif %}
    </div>
  {% endif %}

  <div>{{ page.content|safe }}</div>
  {% if subpages %}
    <h3>Subpages</h3>
    <table id="subpagesTable" class="table table-sm table-bordered table-striped" style="max-width:1000px;">
      <thead>
        <tr>
          <th data-sort="text" data-key="title" style="cursor:pointer">Title &#x25B2;&#x25BC;</th>
          <th data-sort="number" data-key="items" style="cursor:pointer">Items &#x25B2;&#x25BC;</th>
          <th data-sort="datetime" data-key="updated" style="cursor:pointer">Last updated &#x25B2;&#x25BC;</th>
          <th>Access</th>
        </tr>
      </thead>
      <tbody>
        {% for item in subpages %}
          <tr>
            <td data-key-title><a href="{{ item.page.get_absolute_url }}">{{ item.page.title|escape }}</a></td>
            <td data-key-items>{{ item.doc_count }}</td>
            <td data-key-updated>
              {% if item.last_updated %}
                <time datetime="{{ item.last_updated|date:'c' }}">{{ item.last_updated|date:"Y-m-d H:i" }}</time>
                <br/>
                <small class="text-muted">({{ item.last_updated|timesince }} ago)</small>
              {% else %}
                <small class="text-muted">No updates</small>
              {% endif %}
            </td>
            <td>
              {% if item.page.is_public %}
                <span class="badge bg-success">Public</span>
              {% elif not item.has_role_restrictions %}
                <span class="badge bg-info">Members</span>
              {% else %}
                <span class="badge bg-warning text-dark">Roles</span>
                {% for role in item.required_roles %}
                  <br><small class="text-muted">{{ role }}</small>
                {% endfor %}
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}
  <script>
    // Simple table sorter for the subpages table. Works without external libs.
    (function() {
      const table = document.getElementById('subpagesTable');
      if (!table) return;
      const tbody = table.tBodies[0];
      const headers = table.querySelectorAll('th[data-sort]');

      function parseDateTime(cell) {
        const time = cell.querySelector('time');
        if (!time) return 0;
        return Date.parse(time.getAttribute('datetime')) || 0;
      }

      headers.forEach((th, idx) => {
        let asc = true;
        th.addEventListener('click', () => {
          const type = th.getAttribute('data-sort');
          const rows = Array.from(tbody.querySelectorAll('tr'));
          rows.sort((a, b) => {
            let aVal, bVal;
            if (type === 'number') {
              aVal = parseInt(a.querySelector('[data-key-items]').textContent.trim()) || 0;
              bVal = parseInt(b.querySelector('[data-key-items]').textContent.trim()) || 0;
            } else if (type === 'datetime') {
              aVal = parseDateTime(a.querySelector('[data-key-updated]'));
              bVal = parseDateTime(b.querySelector('[data-key-updated]'));
            } else {
              aVal = a.querySelector('[data-key-title]').textContent.trim().toLowerCase();
              bVal = b.querySelector('[data-key-title]').textContent.trim().toLowerCase();
            }
            if (aVal === bVal) return 0;
            if (asc) return aVal > bVal ? 1 : -1;
            return aVal < bVal ? 1 : -1;
          });
          // Re-attach rows in sorted order
          rows.forEach(r => tbody.appendChild(r));
          asc = !asc;
        });
      });
    })();
  </script>
  {% if has_documents %}
    <h2>Documents</h2>
    <nav class="doc-nav">
      <ul>
        {% for doc in page.documents.all %}
          {% if doc.is_pdf %}
            <li><a href="#heading{{ forloop.counter }}">{{ doc.title|default:doc.file.name }}</a></li>
          {% endif %}
        {% endfor %}
      </ul>
    </nav>
    <div class="accordion" id="pdfAccordion">
      {% for doc in page.documents.all %}
        {% if doc.is_pdf %}
        <div class="accordion-item">
          <h2 class="accordion-header" id="heading{{ forloop.counter }}">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ forloop.counter }}" aria-expanded="false" aria-controls="collapse{{ forloop.counter }}">
              <div style="display:flex;flex-direction:column;align-items:flex-start;width:100%;">
                <span><strong>{{ doc.title|default:"Untitled PDF" }}</strong></span>
                <span style="font-size:0.95em;color:#555;">
                  {% if doc.uploaded_by %}Uploaded by {{ doc.uploaded_by.get_full_name|default:doc.uploaded_by.username }}{% endif %}
                  {% if doc.uploaded_at %} on {{ doc.uploaded_at|date:"Y-m-d H:i" }}{% endif %}
                  {% if doc.file.size %} &bull; {{ doc.file.size|filesizeformat }}{% endif %}
                </span>
              </div>
            </button>
          </h2>
          <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse" aria-labelledby="heading{{ forloop.counter }}" data-bs-parent="#pdfAccordion">
            <div class="accordion-body">
              <a href="{{ doc.file.url }}" target="_blank" rel="noopener" title="Open PDF in new tab" style="display:inline-block;vertical-align:middle;margin-bottom:4px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="none" style="vertical-align:middle;">
                  <path d="M14 3H17V6" stroke="#007bff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M10 10L17 3" stroke="#007bff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M17 10V17H3V3H10" stroke="#007bff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span style="font-size:0.9em;">Open PDF in new tab</span>
              </a>
              <div id="pdfContainer{{ forloop.counter }}"></div>
              <div id="pdfFallback_{{ forloop.counter }}" style="display:none;">
                <p>PDF viewer is not working. <a href="{{ doc.file.url }}">Download PDF</a> or <a href="https://support.google.com/chrome/answer/6213030?hl=en">see instructions to enable PDF viewing</a>.</p>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
      {% endfor %}
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        var accordions = document.querySelectorAll('.accordion-button');
        accordions.forEach(function(btn, idx) {
          btn.addEventListener('click', function() {
            var num = idx + 1;
            var container = document.getElementById('pdfContainer' + num);
            if (!container.dataset.loaded) {
              var embed = document.createElement('embed');
              embed.id = 'pdfEmbed_' + num;
              embed.src = btn.closest('.accordion-item').querySelector('a[target="_blank"]').href;
              embed.type = 'application/pdf';
              embed.width = '100%';
              embed.height = '600px';
              container.appendChild(embed);
              setTimeout(function() {
                if (embed.offsetHeight < 100) {
                  document.getElementById('pdfFallback_' + num).style.display = 'block';
                }
              }, 1000);
              container.dataset.loaded = 'true';
            }
          });
        });
      });
    </script>
    <style>
      .doc-nav { margin-bottom: 1.5em; background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 4px; padding: 0.5em 1em; }
      .doc-nav ul { list-style: none; margin: 0; padding: 0; display: flex; flex-wrap: wrap; gap: 1em; }
      .doc-nav li { margin: 0; }
      .doc-nav a { text-decoration: none; color: #007bff; font-weight: 500; }
      .doc-nav a:hover { text-decoration: underline; }
      .accordion-button { cursor: pointer; }
      .accordion-item { border: 1px solid #ddd; border-radius: 4px; margin-bottom: 8px; }
      .accordion-header { background: #f7f7f7; padding: 0; }
      .accordion-body { background: #fff; padding: 1em; }
    </style>
  {% endif %}
{% endblock %}

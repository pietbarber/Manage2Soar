# GCP Database Server Playbook
#
# This playbook provisions and configures a GCP VM for PostgreSQL database server.
# It supports both creating new VMs and configuring existing ones.
#
# Prerequisites:
#   1. Install GCP Ansible collection:
#      ansible-galaxy collection install google.cloud
#
#   2. Set up GCP authentication (one of):
#      - gcloud auth application-default login
#      - Service account JSON key file
#
#   3. Copy and configure inventory/gcp_database.yml from .example
#   4. Copy and configure group_vars/gcp_database/ with vars.yml and vault.yml
#   5. Set up vault password file: ~/.ansible_vault_pass
#
# Usage:
#   # Create VM and configure database
#   ansible-playbook -i inventory/gcp_database.yml \
#     --vault-password-file ~/.ansible_vault_pass \
#     playbooks/gcp-database.yml
#
#   # Configure existing VM only (skip GCP provisioning)
#   ansible-playbook -i inventory/gcp_database.yml \
#     --vault-password-file ~/.ansible_vault_pass \
#     playbooks/gcp-database.yml --skip-tags gcp-provision
#
#   # Only run PostgreSQL setup
#   ansible-playbook -i inventory/gcp_database.yml \
#     --vault-password-file ~/.ansible_vault_pass \
#     playbooks/gcp-database.yml --tags postgresql
#
# Tags:
#   - gcp-provision: GCP VM provisioning
#   - base: Base system setup
#   - postgresql: Database setup
#   - ssl: SSL/TLS configuration
#   - multi-tenant: Multi-tenant database setup

---
# ============================================================
# PHASE 1: GCP VM Provisioning (runs on localhost)
# ============================================================
- name: Provision GCP Database Server
  hosts: localhost
  connection: local
  gather_facts: false
  tags: [gcp-provision]
  vars_files:
    - ../group_vars/gcp_provisioner/vars.yml
    - ../group_vars/gcp_provisioner/vault.yml

  pre_tasks:
    - name: Validate GCP configuration
      ansible.builtin.assert:
        that:
          - gcp_project is defined
          - gcp_project | length > 0
        fail_msg: |
          GCP project is required. Set gcp_project in your group_vars.

    # ============================================================
    # PRE-FLIGHT GCP API CHECKS
    # ============================================================
    - name: Check GCP project exists and is accessible
      google.cloud.gcp_resourcemanager_project_info:
        project: "{{ gcp_project }}"
        auth_kind: "{{ gcp_auth_kind | default('application') }}"
        service_account_file: "{{ gcp_service_account_file | default(omit) }}"
      register: gcp_project_info
      ignore_errors: true
      tags: [gcp-provision, preflight]

    - name: Validate GCP project access
      ansible.builtin.assert:
        that:
          - gcp_project_info is defined
          - gcp_project_info.resources is defined
          - gcp_project_info.resources | length > 0
        fail_msg: |
          ========================================
          GCP PRE-FLIGHT CHECK FAILED
          ========================================
          Cannot access GCP project: {{ gcp_project }}

          Possible causes:
          1. Project doesn't exist
          2. Authentication not configured (run: gcloud auth application-default login)
          3. Service account doesn't have required permissions
          4. Project ID is incorrect

          Current auth method: {{ gcp_auth_kind | default('application') }}
          {% if gcp_service_account_file is defined %}
          Service account file: {{ gcp_service_account_file }}
          {% endif %}

          To verify your setup:
            gcloud projects describe {{ gcp_project }}
          ========================================
      tags: [gcp-provision, preflight]

    - name: Check Compute Engine API availability
      google.cloud.gcp_compute_zone_info:
        zone: "{{ gcp_zone | default('us-east1-b') }}"
        project: "{{ gcp_project }}"
        auth_kind: "{{ gcp_auth_kind | default('application') }}"
        service_account_file: "{{ gcp_service_account_file | default(omit) }}"
      register: gcp_compute_check
      ignore_errors: true
      tags: [gcp-provision, preflight]

    - name: Validate Compute Engine API
      ansible.builtin.assert:
        that:
          - gcp_compute_check is defined
          - not (gcp_compute_check.failed | default(false))
        fail_msg: |
          ========================================
          GCP COMPUTE ENGINE API CHECK FAILED
          ========================================
          The Compute Engine API may not be enabled for project: {{ gcp_project }}

          To enable it, run:
            gcloud services enable compute.googleapis.com --project={{ gcp_project }}

          Or visit:
            https://console.cloud.google.com/apis/library/compute.googleapis.com?project={{ gcp_project }}

          Error: {{ gcp_compute_check.msg | default('Unknown error') }}
          ========================================
      tags: [gcp-provision, preflight]

    - name: Display pre-flight check results
      ansible.builtin.debug:
        msg: |
          ========================================
          GCP PRE-FLIGHT CHECKS PASSED
          ========================================
          ✓ Project exists and is accessible
          ✓ Authentication is working
          ✓ Compute Engine API is enabled

          Project Details:
            Project ID: {{ gcp_project_info.resources[0].projectId }}
            Project Name: {{ gcp_project_info.resources[0].name }}
            Project Number: {{ gcp_project_info.resources[0].projectNumber }}
            State: {{ gcp_project_info.resources[0].lifecycleState }}
          ========================================
      tags: [gcp-provision, preflight]

    - name: Display provisioning plan
      ansible.builtin.debug:
        msg: |
          ========================================
          GCP Database Provisioning Plan
          ========================================
          Project: {{ gcp_project }}
          Zone: {{ gcp_zone | default('us-east1-b') }}
          VM Name: {{ gcp_vm_name | default('m2s-database') }}
          Machine Type: {{ gcp_machine_type | default('e2-small') }}
          Provision New VM: {{ gcp_vm_provision | default(true) }}
          ========================================

  roles:
    - role: gcp-vm
      tags: [gcp-provision]
      vars:
        gcp_target_inventory_group: gcp_database_servers

# ============================================================
# PHASE 2: Base System Configuration
# ============================================================
- name: Configure Database Server
  hosts: gcp_database_servers
  become: true
  gather_facts: true
  tags: [configure]
  vars_files:
    - ../group_vars/gcp_provisioner/vars.yml
    - ../group_vars/gcp_provisioner/vault.yml

  pre_tasks:
    - name: Validate required variables
      ansible.builtin.assert:
        that:
          # In single-tenant mode, require the primary PostgreSQL password
          - (postgresql_multi_tenant | default(false)) or (vault_postgresql_password is defined)
          # In multi-tenant mode, require that the tenants list is defined and non-empty
          - (not (postgresql_multi_tenant | default(false))) or
            (postgresql_tenants is defined and (postgresql_tenants | length) > 0)
        fail_msg: |
          PostgreSQL credentials are not fully configured.

          When postgresql_multi_tenant is false (single-tenant mode), you must set:
            - vault_postgresql_password in your vault.yml

          When postgresql_multi_tenant is true (multi-tenant mode), you must:
            - define postgresql_tenants in your vars.yml
            - provide a vault_postgresql_password_<prefix> entry in vault.yml
              for each tenant listed in postgresql_tenants.

    - name: Validate multi-tenant tenant structure
      ansible.builtin.assert:
        that:
          - item.prefix is defined
          - item.name is defined
        fail_msg: |
          Multi-tenant configuration error: tenant entry is malformed.

          Each tenant in postgresql_tenants must have:
            - prefix: database/user identifier (e.g., 'ssc', 'masa')
            - name: human-readable name (e.g., 'Skyline Soaring Club')

          Malformed entry: {{ item }}
      loop: "{{ postgresql_tenants | default([]) }}"
      when: postgresql_multi_tenant | default(false)

    - name: Validate multi-tenant tenant passwords
      ansible.builtin.assert:
        that:
          - (lookup('vars', 'vault_postgresql_password_' + item.prefix, default='') | length) > 0
        fail_msg: |
          PostgreSQL multi-tenant credentials are not fully configured.

          You have enabled postgresql_multi_tenant and defined tenant "{{ item.prefix }}",
          but the corresponding vault variable is missing or empty.

          Define the following non-empty password variable in your vault.yml:
            - vault_postgresql_password_{{ item.prefix }}
      loop: "{{ postgresql_tenants | default([]) }}"
      when: postgresql_multi_tenant | default(false)

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      tags: [base]

    - name: Install essential packages
      ansible.builtin.apt:
        name:
          - fail2ban
          - htop
          - vim
          - curl
          - gnupg2
        state: present
      tags: [base]

    - name: Display configuration info
      ansible.builtin.debug:
        msg: |
          ========================================
          Database Server Configuration
          ========================================
          Hostname: {{ ansible_hostname }}
          PostgreSQL Version: {{ postgresql_version | default('17') }}
          Multi-Tenant Mode: {{ postgresql_multi_tenant | default(false) }}
          SSL Enabled: {{ postgresql_ssl_enabled | default(false) }}
          {% if postgresql_multi_tenant | default(false) %}
          Tenants: {{ postgresql_tenants | map(attribute='prefix') | join(', ') }}
          {% endif %}
          ========================================

    - name: Build UFW port configuration for PostgreSQL
      ansible.builtin.set_fact:
        postgresql_ufw_ports: |
          {% set ports = [] %}
          {% for cidr in postgresql_remote_access_cidrs | default([]) %}
          {%   set _ = ports.append({'port': 5432, 'proto': 'tcp', 'src': cidr, 'comment': 'PostgreSQL'}) %}
          {% endfor %}
          {{ ports }}
      tags: [firewall]

  roles:
    # UFW firewall
    - role: ufw
      tags: [firewall]
      vars:
        ufw_allow_ports: "{{ postgresql_ufw_ports | from_yaml }}"

    # PostgreSQL database
    - role: postgresql
      tags: [postgresql, database]

  post_tasks:
    - name: Display connection information
      ansible.builtin.debug:
        msg: |
          ========================================
          PostgreSQL Database Ready
          ========================================
          Host: {{ ansible_host }}
          Port: {{ postgresql_port | default(5432) }}
          {% if postgresql_multi_tenant | default(false) %}
          Databases:
          {% for tenant in postgresql_tenants %}
            - m2s_{{ tenant.prefix }} (user: m2s_{{ tenant.prefix }})
          {% endfor %}
          {% else %}
          Database: {{ postgresql_db | default('m2s') }}
          User: {{ postgresql_user | default('m2s') }}
          {% endif %}
          SSL: {{ 'Required' if (postgresql_ssl_enabled | default(false) and postgresql_ssl_require_remote | default(true)) else 'Optional' if postgresql_ssl_enabled | default(false) else 'Disabled' }}

          Connection string example:
          {% if postgresql_multi_tenant | default(false) %}
          postgresql://m2s_{{ postgresql_tenants[0].prefix }}:PASSWORD@{{ ansible_host }}:{{ postgresql_port | default(5432) }}/m2s_{{ postgresql_tenants[0].prefix }}{% if postgresql_ssl_enabled | default(false) %}?sslmode=require{% endif %}
          {% else %}
          postgresql://{{ postgresql_user | default('m2s') }}:PASSWORD@{{ ansible_host }}:{{ postgresql_port | default(5432) }}/{{ postgresql_db | default('m2s') }}{% if postgresql_ssl_enabled | default(false) %}?sslmode=require{% endif %}
          {% endif %}
          ========================================

    # ============================================================
    # POST-DEPLOYMENT VERIFICATION
    # ============================================================
    - name: Gather service facts
      ansible.builtin.service_facts:
      tags: [verify]

    - name: Check PostgreSQL service status
      ansible.builtin.set_fact:
        postgresql_service_running: "{{ ansible_facts.services['postgresql.service'].state == 'running' }}"
      tags: [verify]

    - name: Verify PostgreSQL port is accessible
      ansible.builtin.wait_for:
        port: "{{ postgresql_port | default(5432) }}"
        host: "{{ ansible_host }}"
        timeout: 10
      delegate_to: localhost
      become: false
      register: port_check
      failed_when: false
      tags: [verify]

    - name: Test database connection via TCP (single-tenant)
      ansible.builtin.command: >
        psql -h 127.0.0.1 -U {{ postgresql_user | default('m2s') }}
        -d {{ postgresql_db | default('m2s') }}
        -c "SELECT version();"
      become: true
      become_user: postgres
      environment:
        PGPASSWORD: "{{ vault_postgresql_password }}"
      register: db_test_single
      changed_when: false
      failed_when: false
      when: not (postgresql_multi_tenant | default(false))
      tags: [verify]

    - name: Test database connections via TCP (multi-tenant)
      ansible.builtin.command: >
        psql -h 127.0.0.1 -U m2s_{{ item.prefix }}
        -d m2s_{{ item.prefix }}
        -c "SELECT version();"
      become: true
      become_user: postgres
      environment:
        PGPASSWORD: "{{ lookup('vars', 'vault_postgresql_password_' + item.prefix) }}"
      loop: "{{ postgresql_tenants | default([]) }}"
      register: db_test_multi
      changed_when: false
      failed_when: false
      when: postgresql_multi_tenant | default(false)
      tags: [verify]

    - name: Display verification results
      ansible.builtin.debug:
        msg: |
          ========================================
          PostgreSQL Deployment Verification
          ========================================
          Service Status: {{ 'Running' if postgresql_service_running else 'NOT RUNNING - CHECK LOGS' }}
          Port {{ postgresql_port | default(5432) }}: {{ 'Accessible' if not (port_check.failed | default(false)) else 'NOT ACCESSIBLE - Check UFW/GCP firewall rules' }}
          {% if not (postgresql_multi_tenant | default(false)) %}
          Database Connection (TCP): {{ 'SUCCESS' if (db_test_single.rc | default(1)) == 0 else 'FAILED - Check credentials, pg_hba.conf, or password' }}
          {% else %}
          Database Connections (TCP):
          {% for result in (db_test_multi.results | default([])) %}
          {% if not (result.skipped | default(false)) %}
            - m2s_{{ result.item.prefix }}: {{ 'SUCCESS' if (result.rc | default(1)) == 0 else 'FAILED - Check credentials' }}
          {% else %}
            - m2s_{{ result.item.prefix }}: SKIPPED
          {% endif %}
          {% endfor %}
          {% endif %}

          Note: Database connections tested via TCP (127.0.0.1) to validate
                full authentication stack including pg_hba.conf and passwords.
          ========================================
      tags: [verify]

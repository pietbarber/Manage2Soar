# GKE Cluster Provisioning Playbook
#
# This playbook provisions Google Kubernetes Engine (GKE) clusters using
# the google.cloud Ansible collection. It supports both Standard and
# Autopilot cluster types.
#
# Prerequisites:
#   1. Install required Ansible collections:
#      ansible-galaxy collection install google.cloud
#      ansible-galaxy collection install community.general
#
#   2. Authenticate with GCP:
#      gcloud auth application-default login
#
#   3. Copy and configure inventory:
#      cp inventory/gcp_cluster.yml.example inventory/gcp_cluster.yml
#      # Edit inventory/gcp_cluster.yml with your project settings
#
# Usage:
#   # Provision a new GKE cluster
#   ansible-playbook -i inventory/gcp_cluster.yml \
#     playbooks/gcp-cluster-provision.yml
#
#   # Dry run (check what would be created)
#   ansible-playbook -i inventory/gcp_cluster.yml \
#     playbooks/gcp-cluster-provision.yml --check
#
#   # Provision with custom settings
#   ansible-playbook -i inventory/gcp_cluster.yml \
#     playbooks/gcp-cluster-provision.yml \
#     -e gke_cluster_name=my-cluster \
#     -e gke_machine_type=e2-standard-4
#
#   # Provision Autopilot cluster
#   ansible-playbook -i inventory/gcp_cluster.yml \
#     playbooks/gcp-cluster-provision.yml \
#     -e gke_cluster_type=autopilot
#
# Tags:
#   - apis: Enable required GCP APIs
#   - network: VPC and subnet creation
#   - cluster: GKE cluster creation
#   - nodepool: Node pool configuration (Standard only)
#   - verify: Verification and status checks

---
- name: Provision GKE Cluster
  hosts: localhost
  connection: local
  become: false
  gather_facts: true

  pre_tasks:
    # ============================================================
    # VALIDATION
    # ============================================================
    - name: Validate GCP project is defined
      ansible.builtin.assert:
        that:
          - gcp_project is defined
          - gcp_project | length > 0
        fail_msg: |
          GCP project is not configured.
          Please set gcp_project in inventory/gcp_cluster.yml

    - name: Validate GCP project is not placeholder
      ansible.builtin.assert:
        that:
          - gcp_project not in ['your-gcp-project-id', 'CHANGEME', 'changeme', 'example-project', '']
          - gcp_project | lower is not match('^your-')
        fail_msg: |
          GCP project is set to a placeholder value: {{ gcp_project }}
          Please set gcp_project to your actual GCP project ID.

    - name: Validate cluster type
      ansible.builtin.assert:
        that:
          - gke_cluster_type in ['standard', 'autopilot']
        fail_msg: |
          Invalid cluster type: {{ gke_cluster_type }}
          Must be 'standard' or 'autopilot'.

    - name: Validate IPv6 requires custom VPC
      ansible.builtin.assert:
        that:
          - not (gke_enable_ipv6 | default(false) | bool) or (gke_create_vpc | default(false) | bool)
        fail_msg: |
          IPv6 dual-stack requires a custom VPC.
          Auto-mode VPCs (default network) do not support IPv6.
          Please set gke_create_vpc: true when gke_enable_ipv6: true

    - name: Validate IPv6 not used with Autopilot
      ansible.builtin.assert:
        that:
          - not ((gke_enable_ipv6 | default(false) | bool) and (gke_cluster_type | default('standard')) == 'autopilot')
        fail_msg: |
          IPv6 dual-stack is only implemented for Standard GKE clusters in this playbook.
          Autopilot clusters may support IPv6, but the flags are not yet configured.
          Please use gke_cluster_type: standard when gke_enable_ipv6: true

    - name: Verify GCP project exists and user has access
      ansible.builtin.command:
        cmd: "gcloud projects describe {{ gcp_project }}"
      register: project_check
      changed_when: false
      failed_when: project_check.rc != 0

    - name: Display provisioning configuration
      ansible.builtin.debug:
        msg: |
          ========================================
          GKE Cluster Provisioning Configuration
          ========================================
          Project: {{ gcp_project }}
          Region: {{ gcp_region }}
          Zone: {{ gcp_zone }}
          Cluster Name: {{ gke_cluster_name }}
          Cluster Type: {{ gke_cluster_type }}
          {% if gke_cluster_type == 'standard' %}
          Machine Type: {{ gke_machine_type }}
          Initial Nodes: {{ gke_initial_node_count }}
          Autoscaling: {{ gke_enable_autoscaling }} ({{ gke_min_nodes }}-{{ gke_max_nodes }})
          Spot VMs: {{ gke_use_spot_vms }}
          {% endif %}
          Create VPC: {{ gke_create_vpc }}
          Workload Identity: {{ gke_enable_workload_identity }}
          ========================================

  tasks:
    # ============================================================
    # ENABLE GCP APIS
    # ============================================================
    - name: Enable required GCP APIs
      ansible.builtin.command:
        cmd: "gcloud services enable {{ item }} --project={{ gcp_project }}"
      loop: "{{ gcp_apis_to_enable }}"
      register: api_enable_result
      changed_when: "'already enabled' not in item.stdout | default('') and 'already enabled' not in item.stderr | default('')"
      tags: [apis]

    - name: Wait for APIs to propagate
      ansible.builtin.pause:
        seconds: 30
      when: api_enable_result.results | selectattr('changed', 'equalto', true) | list | length > 0
      tags: [apis]

    # ============================================================
    # VPC NETWORKING (Optional)
    # ============================================================
    - name: Create VPC network
      google.cloud.gcp_compute_network:
        name: "{{ gke_vpc_name }}"
        project: "{{ gcp_project }}"
        auto_create_subnetworks: false
        routing_config:
          routing_mode: REGIONAL
        auth_kind: application
        state: present
      register: gke_vpc
      when: gke_create_vpc | bool
      tags: [network]

    # For IPv6 support, we need to use gcloud command to create dual-stack subnet
    # The google.cloud.gcp_compute_subnetwork module doesn't fully support IPv6 yet
    #
    # IMPORTANT: If subnet already exists as IPv4-only, attempting to create it as dual-stack
    # will fail with a different error than "already exists". Manual intervention required:
    # either delete the subnet or use a different name.
    - name: Create dual-stack VPC subnet (IPv6 enabled)
      ansible.builtin.command:
        cmd: >
          gcloud compute networks subnets create {{ gke_subnet_name }}
          --project={{ gcp_project }}
          --region={{ gcp_region }}
          --network={{ gke_vpc_name }}
          --range={{ gke_subnet_cidr }}
          --stack-type=IPV4_IPV6
          --ipv6-access-type=EXTERNAL
          --secondary-range=pods={{ gke_pods_cidr }},services={{ gke_services_cidr }}
      register: subnet_create_ipv6
      when:
        - gke_create_vpc | bool
        - gke_enable_ipv6 | default(false) | bool
      changed_when: subnet_create_ipv6.rc == 0
      failed_when: >
        subnet_create_ipv6.rc != 0 and
        'already exists' not in (subnet_create_ipv6.stderr | default('') | lower)
      tags: [network]

    - name: Create VPC subnet (IPv4 only)
      google.cloud.gcp_compute_subnetwork:
        name: "{{ gke_subnet_name }}"
        project: "{{ gcp_project }}"
        region: "{{ gcp_region }}"
        network: "{{ gke_vpc.selfLink }}"
        ip_cidr_range: "{{ gke_subnet_cidr }}"
        secondary_ip_ranges:
          - range_name: "pods"
            ip_cidr_range: "{{ gke_pods_cidr }}"
          - range_name: "services"
            ip_cidr_range: "{{ gke_services_cidr }}"
        auth_kind: application
        state: present
      register: gke_subnet
      when:
        - gke_create_vpc | bool
        - not (gke_enable_ipv6 | default(false) | bool)
      tags: [network]

    # ============================================================
    # GKE CLUSTER CREATION
    # ============================================================
    - name: Check if Standard cluster already exists
      ansible.builtin.command:
        cmd: >
          gcloud container clusters describe {{ gke_cluster_name }}
          --zone={{ gcp_zone }}
          --project={{ gcp_project }}
          --format=json
      register: existing_standard_cluster
      failed_when: false
      changed_when: false
      when: gke_cluster_type == 'standard'
      tags: [cluster]

    - name: Create GKE Standard cluster
      ansible.builtin.command:
        cmd: >
          gcloud container clusters create {{ gke_cluster_name }}
          --project={{ gcp_project }}
          --zone={{ gcp_zone }}
          --num-nodes={{ gke_initial_node_count }}
          --machine-type={{ gke_machine_type }}
          --disk-size={{ gke_disk_size_gb }}
          --disk-type={{ gke_disk_type }}
          --scopes=gke-default
          {%- if gke_use_spot_vms %}
          --spot
          {%- endif %}
          {%- if gke_enable_workload_identity %}
          --workload-pool={{ gcp_project }}.svc.id.goog
          {%- endif %}
          {%- if gke_enable_http_load_balancing %}
          --addons=HttpLoadBalancing
          {%- endif %}
          --network={{ gke_vpc_name if gke_create_vpc else 'default' }}
          {%- if gke_create_vpc %}
          --subnetwork={{ gke_subnet_name }}
          --cluster-secondary-range-name=pods
          --services-secondary-range-name=services
          {%- endif %}
          --enable-ip-alias
          {%- if gke_enable_ipv6 | default(false) %}
          --enable-dataplane-v2
          --stack-type=ipv4-ipv6
          {%- endif %}
          --enable-autoscaling
          --min-nodes={{ gke_min_nodes }}
          --max-nodes={{ gke_max_nodes }}
          --enable-autorepair
          --enable-autoupgrade
          --logging=SYSTEM,WORKLOAD
          --monitoring=SYSTEM
      register: gke_cluster_create
      changed_when: gke_cluster_create.rc == 0
      when:
        - gke_cluster_type == 'standard'
        - existing_standard_cluster.rc != 0
      tags: [cluster]

    - name: Get actual node pool name from Standard cluster
      ansible.builtin.command:
        cmd: >
          gcloud container node-pools list
          --cluster={{ gke_cluster_name }}
          --project={{ gcp_project }}
          --zone={{ gcp_zone }}
          --format="value(name)"
      register: actual_nodepool_name
      changed_when: false
      when: gke_cluster_type == 'standard'
      tags: [cluster]

    - name: Set node pool name fact
      ansible.builtin.set_fact:
        gke_node_pool_name: "{{ actual_nodepool_name.stdout_lines[0] | default(gke_node_pool_name) }}"
      when:
        - gke_cluster_type == 'standard'
        - actual_nodepool_name.stdout_lines | length > 0
      tags: [cluster]

    - name: Validate node pool name exists
      ansible.builtin.assert:
        that:
          - gke_node_pool_name is defined
          - gke_node_pool_name | length > 0
        fail_msg: "Node pool name could not be determined for autoscaling configuration"
      when: gke_cluster_type == 'standard'
      tags: [cluster]

    - name: Create GKE Autopilot cluster
      ansible.builtin.command:
        cmd: >
          gcloud container clusters create-auto {{ gke_cluster_name }}
          --project={{ gcp_project }}
          --region={{ gcp_region }}
          {% if gke_create_vpc %}
          --network={{ gke_vpc_name }}
          --subnetwork={{ gke_subnet_name }}
          {% endif %}
          {% if gke_enable_workload_identity %}
          --workload-pool={{ gcp_project }}.svc.id.goog
          {% endif %}
      register: autopilot_result
      when: gke_cluster_type == 'autopilot'
      changed_when: autopilot_result.rc == 0
      failed_when: >
        autopilot_result.rc != 0 and
        'already exists' not in (autopilot_result.stderr | default('') | lower) and
        'already exists' not in (autopilot_result.stdout | default('') | lower)
      tags: [cluster]

    # ============================================================
    # AUTOSCALING (Standard clusters)
    # ============================================================
    - name: Get node pool information
      ansible.builtin.command:
        cmd: >
          gcloud container node-pools describe {{ gke_node_pool_name }}
          --cluster={{ gke_cluster_name }}
          --project={{ gcp_project }}
          --zone={{ gcp_zone }}
      register: nodepool_check
      changed_when: false
      failed_when: false
      when: gke_cluster_type == 'standard' and gke_enable_autoscaling
      tags: [cluster, autoscaling]

    - name: Configure node pool autoscaling
      ansible.builtin.command:
        cmd: >
          gcloud container node-pools update {{ gke_node_pool_name }}
          --cluster={{ gke_cluster_name }}
          --project={{ gcp_project }}
          --zone={{ gcp_zone }}
          --enable-autoscaling
          --min-nodes={{ gke_min_nodes }}
          --max-nodes={{ gke_max_nodes }}
      when:
        - gke_cluster_type == 'standard'
        - gke_enable_autoscaling | bool
        - nodepool_check.rc == 0
      register: autoscaling_result
      changed_when: autoscaling_result.rc == 0
      failed_when: >
        autoscaling_result.rc != 0 and
        'already has autoscaling' not in (autoscaling_result.stderr | default('') | lower) and
        'already configured' not in (autoscaling_result.stderr | default('') | lower)
      tags: [cluster, autoscaling]

    # ============================================================
    # GET CREDENTIALS
    # ============================================================
    - name: Get cluster credentials
      ansible.builtin.command:
        cmd: >
          gcloud container clusters get-credentials {{ gke_cluster_name }}
          --project={{ gcp_project }}
          {% if gke_cluster_type == 'autopilot' %}
          --region={{ gcp_region }}
          {% else %}
          --zone={{ gcp_zone }}
          {% endif %}
      changed_when: false
      tags: [verify]

    # ============================================================
    # VERIFICATION
    # ============================================================
    - name: Verify kubectl access
      ansible.builtin.command:
        cmd: kubectl cluster-info
      register: kubectl_result
      changed_when: false
      tags: [verify]

    - name: Get cluster nodes
      ansible.builtin.command:
        cmd: kubectl get nodes -o wide
      register: nodes_result
      changed_when: false
      tags: [verify]

    - name: Display cluster status
      ansible.builtin.debug:
        msg: |
          ========================================
          GKE Cluster Provisioned Successfully!
          ========================================
          Cluster: {{ gke_cluster_name }}
          Type: {{ gke_cluster_type }}
          Location: {{ gcp_zone if gke_cluster_type == 'standard' else gcp_region }}

          Cluster Info:
          {{ kubectl_result.stdout }}

          Nodes:
          {{ nodes_result.stdout }}

          ========================================
          Next Steps:
          1. Deploy your application:
             ansible-playbook -i inventory/gcp_app.yml \
               --vault-password-file ~/.ansible_vault_pass \
               playbooks/gcp-app-deploy.yml

          2. Or use kubectl directly:
             kubectl get pods --all-namespaces
          ========================================
      tags: [verify]

# Single-Host M2S Deployment Playbook
#
# This playbook deploys a complete Manage2Soar instance on a single host.
# It includes: PostgreSQL, Django/Gunicorn, NGINX, and optionally mail server.
#
# Prerequisites:
#   1. Copy and configure inventory/single_host.yml from .example
#   2. Copy and configure group_vars/single_host.yml from .example
#   3. Ensure SSH access to target server with sudo privileges
#
# Usage:
#   ansible-playbook -i inventory/single_host.yml playbooks/single-host.yml
#
# Tags:
#   - common: Base system setup
#   - postgresql: Database setup
#   - nginx: Web server setup
#   - app: Django/Gunicorn application
#   - mail: Mail server (if enabled)
#   - backup: Backup configuration

---
- name: Deploy Manage2Soar Single-Host Solution
  hosts: single_host
  become: true

  pre_tasks:
    - name: Validate required variables
      ansible.builtin.assert:
        that:
          - postgresql_password is defined
          - postgresql_password != "CHANGE_ME_GENERATE_STRONG_PASSWORD"
          - django_secret_key is defined
          - django_secret_key != "CHANGE_ME_GENERATE_50_CHAR_SECRET"
          - m2s_domain is defined
        fail_msg: |
          Required variables are not set or still have default values.
          Please configure group_vars/single_host.yml with your actual values.

    - name: Display deployment info
      ansible.builtin.debug:
        msg: |
          Deploying Manage2Soar to {{ inventory_hostname }}
          Domain: {{ m2s_domain }}
          Club: {{ club_name }} ({{ club_prefix }})
          PostgreSQL: {{ postgresql_version }}
          Deploy method: {{ deploy_method }}

  roles:
    # Base system setup
    - role: common
      tags: [common, always]

    # PostgreSQL database
    - role: postgresql
      tags: [postgresql, database]

    # TODO: Add these roles as they are developed
    # - role: nginx
    #   tags: [nginx, web]
    #
    # - role: m2s-app
    #   tags: [app, django]
    #
    # - role: m2s-backup
    #   tags: [backup]
    #   when: backup_enabled | default(true)

    # Mail server (optional)
    # - role: postfix
    #   tags: [mail, postfix]
    #   when: mail_server_enabled | default(false)
    #
    # - role: opendkim
    #   tags: [mail, opendkim]
    #   when: mail_server_enabled | default(false)
    #
    # - role: rspamd
    #   tags: [mail, rspamd]
    #   when: mail_server_enabled | default(false)

  post_tasks:
    - name: Deployment complete
      ansible.builtin.debug:
        msg: |
          ========================================
          Manage2Soar deployment complete!
          ========================================

          Server: {{ inventory_hostname }}
          Domain: {{ m2s_domain }}

          Database:
            Host: localhost
            Port: 5432
            Database: {{ postgresql_db }}
            User: {{ postgresql_user }}

          Next steps:
            1. Configure DNS A record for {{ m2s_domain }}
            2. Run Django migrations
            3. Create superuser
            4. Configure OAuth (if using)

          ========================================

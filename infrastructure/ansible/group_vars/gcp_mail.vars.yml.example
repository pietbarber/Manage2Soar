# GCP Mail Server Variables
#
# COPY THIS FILE AND FILL IN YOUR VALUES:
#   mkdir -p group_vars/gcp_mail
#   cp group_vars/gcp_mail.vars.yml.example group_vars/gcp_mail/vars.yml
#
# NOTE: Use group_vars/gcp_mail/ to match the playbook's vars_files paths.
# This file is gitignored when placed in group_vars/gcp_mail/
#
# For secrets (passwords, keys), use a separate vault.yml file.
# See gcp_mail.vault.yml.example for the vault template.

---
# ============================================================
# GCP PROJECT CONFIGURATION
# ============================================================

# Your GCP project ID (required) - REPLACE this example value with your real project ID
gcp_project: "example-gcp-project-id"

# GCP region and zone
gcp_region: "us-east1"
gcp_zone: "us-east1-b"

# ============================================================
# VM PROVISIONING
# ============================================================

# Whether to provision a new VM or use an existing one
# Set to false if VM already exists and you just want to configure mail
gcp_vm_provision: true

# VM instance name
gcp_vm_name: "m2s-mail"

# Machine type - mail servers are lightweight
# e2-micro: Minimal mail relay (2 vCPU shared, 1GB RAM) - usually sufficient
# e2-small: Higher volume (2 vCPU, 2GB RAM)
gcp_machine_type: "e2-micro"

# Boot disk size (GB) - mail queues are temporary, 10GB is plenty
gcp_boot_disk_size_gb: 10

# Static IP name (recommended for mail servers to avoid DNS changes)
# gcp_static_ip_name: "m2s-mail-ip"

# ============================================================
# NETWORK & SECURITY
# ============================================================

# VPC network (use 'default' or your custom VPC)
gcp_network: "default"

# Whether to allow SSH access (recommend: true for initial setup)
gcp_allow_ssh: true

# SSH source ranges - CENTRALLY MANAGED
# Admin IPs are defined in all.yml as the SINGLE SOURCE OF TRUTH
# See docs/runbooks/ansible-playbook-guide.md for instructions on adding co-webmasters
gcp_ssh_allowed_sources: "{{ admin_ssh_ips }}"

# SSH public keys - CENTRALLY MANAGED
# Admin SSH keys are defined in all.yml - this references that centralized list
# CRITICAL: You MUST define admin_ssh_keys in all.yml before deploying!
# Format: "username:ssh-type key-data username@hostname"
gcp_ssh_public_keys:
  - "{{ admin_ssh_keys[0].user }}:{{ admin_ssh_keys[0].key }}"
  # Add more co-webmaster keys by referencing admin_ssh_keys[1], [2], etc.
  # or add additional non-admin keys manually here

# Ansible SSH connection settings (optional - defaults to your local username)
# gcp_ansible_user: "pb"  # Must match the username in gcp_ssh_public_keys
# gcp_ansible_ssh_private_key_file: "~/.ssh/id_ed25519"

# Network tags for firewall rules
gcp_network_tags:
  - "m2s-mail"
  - "smtp-relay"

# Firewall rule prefix
gcp_firewall_name_prefix: "m2s-mail"

# Whether to create firewall rules
gcp_create_firewall_rules: true

# HTTP firewall rule for Let's Encrypt (optional)
# Enable this only if you plan to use Let's Encrypt HTTP-01 challenges for TLS certificates.
# WARNING: This opens port 80 to the entire internet (0.0.0.0/0).
# - Ensure your web server is properly configured (e.g., certbot standalone mode)
# - Consider DNS-01 challenge as a more secure alternative
# - Current setup uses self-signed certificates, so this is typically not needed
gcp_enable_http_firewall: false

# PostgreSQL source ranges (not needed for mail server, but required by gcp-vm role)
gcp_postgresql_allowed_sources: []

# ============================================================
# MAIL SERVER CONFIGURATION
# ============================================================

# Base domain for mail (e.g., manage2soar.com)
mail_domain: "manage2soar.com"

# Mail server hostname (FQDN)
# This will be used in HELO/EHLO and TLS certificates
mail_hostname: "mail.{{ mail_domain }}"

# ============================================================
# SPAM REJECTION MESSAGES
# ============================================================
# URLs and contact info shown in spam rejection messages

# URL where users can update their email address in their member profile
# This is shown when their email is rejected from mailing lists
# Example: "https://yourclub.manage2soar.com/members/profile/"
rejection_help_url: "https://yourclub.manage2soar.com/members/profile/"

# Contact form URL shown in rejection messages for user support
# Use a web form instead of email to avoid rejection loops (since the contact
# email address might also require whitelisting and would be rejected too)
# Example: "https://yoursoaringclub.org/contact/"
rejection_contact_url: "https://{{ mail_domain }}/contact/"

# ============================================================
# SMTP RELAY (SMTP2Go)
# ============================================================
# GCP blocks outbound port 25, so we relay through SMTP2Go.
# Get credentials from: https://app.smtp2go.com/settings/api_keys/

# SMTP2Go relay configuration
smtp_relay_host: "mail.smtp2go.com"
smtp_relay_port: 587

# Relay credentials - stored in vault.yml
smtp_relay_username: "{{ vault_smtp_relay_username }}"
smtp_relay_password: "{{ vault_smtp_relay_password }}"

# ============================================================
# DKIM CONFIGURATION
# ============================================================

# DKIM selector (used in DNS record: selector._domainkey.domain.com)
# Use a date-based or deployment-specific selector for easy rotation
# Example: "m2s-2024", "production", "default"
dkim_selector: "m2s"

# DKIM key size (2048 is recommended, 1024 for compatibility with old DNS)
dkim_key_size: 2048

# ============================================================
# MULTI-TENANT CONFIGURATION
# ============================================================
# Each club gets their own subdomain for sending mail.
# Mail is sent as noreply@clubprefix.manage2soar.com
#
# IMPORTANT: You must add each domain to SMTP2Go:
# Settings → Sender Domains → Add Domain

# List of tenant clubs
club_domains:
  - prefix: "ssc"
    name: "Skyline Soaring Club"

  - prefix: "masa"
    name: "Mid-Atlantic Soaring Association"

# ============================================================
# M2S API KEY (for mail sync)
# ============================================================
# API key for authenticating with the M2S Django API to fetch
# mailing list membership. Get this from Django admin:
# https://yourcluburl.manage2soar.com/admin/authtoken/tokenproxy/

# M2S API authentication token - stored in vault.yml for security
m2s_api_key: "{{ vault_m2s_api_key }}"

# Add more tenants as needed:
# - prefix: "nfss"
#   name: "Northern Florida Soaring Society"

# ============================================================
# SMTP AUTHENTICATION (Optional)
# ============================================================
# For Django applications to authenticate when sending through this server.
# Not typically needed when using SMTP2Go relay - Django can connect
# directly to SMTP2Go instead.

# Uncomment if you need local SMTP authentication:
# smtp_auth_users:
#   - username: m2s
#     password: "{{ vault_smtp_password }}"

# ============================================================
# TRUSTED RELAY IPS
# ============================================================
# IPs/networks that can relay mail without SASL authentication.
# CRITICAL: Must include GKE pod CIDR for Django app to send email!
#
# To find your GKE pod CIDR:
#   gcloud container clusters describe CLUSTER_NAME --zone=ZONE \
#     --format="value(clusterIpv4Cidr)"
#
# Example output: 10.4.0.0/14
trusted_relay_ips:
  - "10.0.0.0/14"     # GKE pod CIDR (internal addresses) - REQUIRED
  # Optionally add individual GKE node NAT IPs if needed
  # - "X.X.X.X"       # GKE node 1 NAT IP
  # - "X.X.X.X"       # GKE node 2 NAT IP

# ============================================================
# TLS SETTINGS (Optional)
# ============================================================
# By default, we skip TLS cert setup since we're just relaying to SMTP2Go.
# Django connects directly to SMTP2Go with their TLS certificates.

# If you want to receive mail on this server (not recommended for GCP):
# postfix_tls_cert_file: "/etc/letsencrypt/live/{{ mail_hostname }}/fullchain.pem"
# postfix_tls_key_file: "/etc/letsencrypt/live/{{ mail_hostname }}/privkey.pem"

# Use self-signed certificates for testing
postfix_use_self_signed_cert: true

# ============================================================
# SINGLE-HOST MODE
# ============================================================
# For GCP deployment, this is NOT single-host mode
single_host_mode: false

# ============================================================
# GCP AUTHENTICATION
# ============================================================
# Choose one authentication method:

# Option 1: Application Default Credentials (recommended)
# Run: gcloud auth application-default login
# No additional config needed - Ansible will use your gcloud credentials

# Option 2: Service Account Key File
# gcp_auth_kind: "serviceaccount"
# gcp_service_account_file: "/path/to/service-account-key.json"

---
# ============================================================
# Postfix Role - MTA Setup
# ============================================================

- name: Install Postfix and SASL
  ansible.builtin.apt:
    name:
      - postfix
      - postfix-pcre
      - libsasl2-modules
      - sasl2-bin
    state: present
  environment:
    DEBIAN_FRONTEND: noninteractive

- name: Create Postfix main.cf
  ansible.builtin.template:
    src: main.cf.j2
    dest: "{{ postfix_config_dir }}/main.cf"
    mode: "0644"
    backup: true
  notify: Restart Postfix

- name: Create Postfix master.cf
  ansible.builtin.template:
    src: master.cf.j2
    dest: "{{ postfix_config_dir }}/master.cf"
    mode: "0644"
    backup: true
  notify: Restart Postfix

- name: Create header_checks (From rewriting for mailing lists)
  ansible.builtin.template:
    src: header_checks.j2
    dest: "{{ postfix_config_dir }}/header_checks"
    mode: "0644"
  notify: Reload Postfix

- name: Create smtp_header_checks (List headers for outbound mail)
  ansible.builtin.template:
    src: smtp_header_checks.j2
    dest: "{{ postfix_config_dir }}/smtp_header_checks"
    mode: "0644"
  notify: Reload Postfix

- name: Validate Postfix configuration
  ansible.builtin.command:
    cmd: postfix check
  changed_when: false

- name: Create virtual alias domains file
  ansible.builtin.template:
    src: virtual_domains.j2
    dest: "{{ postfix_config_dir }}/virtual_domains"
    mode: "0644"
  notify: Postmap virtual domains

- name: Create initial empty virtual aliases file
  ansible.builtin.copy:
    dest: "{{ postfix_config_dir }}/virtual"
    content: |
      # Virtual aliases - generated by m2s-sync-aliases.py
      # DO NOT EDIT MANUALLY - will be overwritten
      #
      # Format: alias@domain.com  recipient1@gmail.com,recipient2@yahoo.com
    mode: "0644"
    force: false # Don't overwrite if exists
  notify: Postmap virtual aliases

- name: Create sender whitelist file
  ansible.builtin.copy:
    dest: "{{ postfix_config_dir }}/sender_whitelist"
    content: |
      # Sender whitelist - generated by m2s-sync-aliases.py
      # DO NOT EDIT MANUALLY - will be overwritten
      #
      # Format: sender@email.com  OK
    mode: "0644"
    force: false
  notify: Postmap sender whitelist

- name: Create SASL password database
  ansible.builtin.template:
    src: sasl_passwd.j2
    dest: "{{ postfix_config_dir }}/sasl_passwd"
    mode: "0600"
  notify: Postmap SASL passwords

# ============================================================
# SASL Authentication for M2S Django App
# ============================================================
# We use auxprop with sasldb (not saslauthd) because Postfix runs
# in a chroot and can't access the saslauthd socket. The sasldb
# file is copied into the chroot.

- name: Create SASL config directory in Postfix chroot
  ansible.builtin.file:
    path: /var/spool/postfix/etc/sasl2
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Configure SASL authentication (auxprop with sasldb)
  ansible.builtin.copy:
    dest: /var/spool/postfix/etc/sasl2/smtpd.conf
    content: |
      # SASL config for Postfix submission (port 587)
      # Uses sasldb for password lookup (not saslauthd)
      pwcheck_method: auxprop
      auxprop_plugin: sasldb
      mech_list: plain login
      # Path is relative to Postfix chroot (/var/spool/postfix)
      # Actual file location: /var/spool/postfix/etc/sasldb2
      sasldb_path: /etc/sasldb2
    mode: "0644"
  notify: Reload Postfix

- name: Create SASL users in sasldb
  ansible.builtin.shell: |
    if ! sasldblistusers2 2>/dev/null | grep -q "{{ item.username }}@{{ mail_domain }}"; then
      echo "{{ item.password }}" | saslpasswd2 -p -c -u {{ mail_domain }} {{ item.username }}
      echo "created"
    fi
  loop: "{{ smtp_auth_users }}"
  no_log: true
  register: sasl_result
  changed_when: "'created' in sasl_result.stdout"
  notify: Copy sasldb to chroot

- name: Copy sasldb to Postfix chroot
  ansible.builtin.copy:
    src: /etc/sasldb2
    dest: /var/spool/postfix/etc/sasldb2
    remote_src: true
    owner: root
    group: postfix
    mode: "0640"

- name: Add postfix to sasl group
  ansible.builtin.user:
    name: postfix
    groups: sasl
    append: true

- name: Ensure Postfix is enabled and running
  ansible.builtin.service:
    name: postfix
    enabled: true
    state: started

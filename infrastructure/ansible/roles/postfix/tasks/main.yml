---
# ============================================================
# Postfix Role - MTA Setup
# ============================================================

- name: Install Postfix and SASL
  ansible.builtin.apt:
    name:
      - postfix
      - libsasl2-modules
      - sasl2-bin
    state: present
  environment:
    DEBIAN_FRONTEND: noninteractive

- name: Create Postfix main.cf
  ansible.builtin.template:
    src: main.cf.j2
    dest: "{{ postfix_config_dir }}/main.cf"
    mode: "0644"
    backup: true
  notify: Restart Postfix

- name: Create Postfix master.cf
  ansible.builtin.template:
    src: master.cf.j2
    dest: "{{ postfix_config_dir }}/master.cf"
    mode: "0644"
    backup: true
  notify: Restart Postfix

- name: Create virtual alias domains file
  ansible.builtin.template:
    src: virtual_domains.j2
    dest: "{{ postfix_config_dir }}/virtual_domains"
    mode: "0644"
  notify: Postmap virtual domains

- name: Create initial empty virtual aliases file
  ansible.builtin.copy:
    dest: "{{ postfix_config_dir }}/virtual"
    content: |
      # Virtual aliases - generated by m2s-sync-aliases.py
      # DO NOT EDIT MANUALLY - will be overwritten
      #
      # Format: alias@domain.com  recipient1@gmail.com,recipient2@yahoo.com
    mode: "0644"
    force: false # Don't overwrite if exists
  notify: Postmap virtual aliases

- name: Create sender whitelist file
  ansible.builtin.copy:
    dest: "{{ postfix_config_dir }}/sender_whitelist"
    content: |
      # Sender whitelist - generated by m2s-sync-aliases.py
      # DO NOT EDIT MANUALLY - will be overwritten
      #
      # Format: sender@email.com  OK
    mode: "0644"
    force: false
  notify: Postmap sender whitelist

- name: Create SASL password database
  ansible.builtin.template:
    src: sasl_passwd.j2
    dest: "{{ postfix_config_dir }}/sasl_passwd"
    mode: "0600"
  notify: Postmap SASL passwords

- name: Configure SASL authentication
  ansible.builtin.copy:
    dest: /etc/postfix/sasl/smtpd.conf
    content: |
      pwcheck_method: saslauthd
      mech_list: plain login
    mode: "0644"

- name: Create saslauthd config
  ansible.builtin.copy:
    dest: /etc/default/saslauthd
    content: |
      START=yes
      DESC="SASL Authentication Daemon"
      NAME="saslauthd"
      MECHANISMS="sasldb"
      MECH_OPTIONS=""
      THREADS=5
      OPTIONS="-c -m /var/run/saslauthd"
    mode: "0644"
  notify: Restart saslauthd

- name: Create SASL users
  ansible.builtin.shell: |
    if ! sasldblistusers2 2>/dev/null | grep -q "{{ item.username }}@{{ mail_domain }}"; then
      echo "{{ item.password }}" | saslpasswd2 -p -c -u {{ mail_domain }} {{ item.username }}
      echo "created"
    fi
  loop: "{{ smtp_auth_users }}"
  no_log: true # Don't log passwords
  register: sasl_result
  changed_when: "'created' in sasl_result.stdout"

- name: Add postfix to sasl group
  ansible.builtin.user:
    name: postfix
    groups: sasl
    append: true

- name: Ensure Postfix is enabled and running
  ansible.builtin.service:
    name: postfix
    enabled: true
    state: started

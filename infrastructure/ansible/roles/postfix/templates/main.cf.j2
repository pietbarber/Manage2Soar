# ============================================================
# Postfix main.cf - Generated by Ansible
# ============================================================
# DO NOT EDIT MANUALLY - changes will be overwritten
# Managed by: infrastructure/ansible/roles/postfix/

# Basic settings
smtpd_banner = $myhostname ESMTP
biff = no
append_dot_mydomain = no
readme_directory = no

# Hostname and domain
myhostname = {{ mail_hostname }}
mydomain = {{ mail_domain }}
myorigin = $mydomain

# Network settings
inet_interfaces = all
inet_protocols = ipv4
mydestination = $myhostname, localhost.$mydomain, localhost

# Trusted networks (for relaying)
# WARNING: Be careful with broad CIDR ranges (e.g., /16 or larger).
# Only include IPs that should be trusted to send mail through this server.
# Each trusted IP can send mail without SASL authentication.
mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128 {{ trusted_relay_ips | join(' ') }}

# Mailbox settings (we don't store mail locally)
mailbox_size_limit = 0
recipient_delimiter = +

# ============================================================
# VIRTUAL DOMAINS AND ALIASES
# ============================================================
# This is the key to mailing list functionality

# List of domains we handle mail for
virtual_alias_domains = hash:{{ postfix_config_dir }}/virtual_domains

# Alias mappings (members@ -> list of recipients)
virtual_alias_maps = hash:{{ postfix_config_dir }}/virtual

# ============================================================
# TLS SETTINGS
# ============================================================
# Enable TLS for both sending and receiving
# Uses Let's Encrypt certificates obtained by certbot

# Incoming TLS
smtpd_tls_cert_file = /etc/letsencrypt/live/{{ mail_hostname }}/fullchain.pem
smtpd_tls_key_file = /etc/letsencrypt/live/{{ mail_hostname }}/privkey.pem
smtpd_tls_security_level = may
smtpd_tls_loglevel = 1

# Outgoing TLS
smtp_tls_security_level = may
smtp_tls_loglevel = 1

# ============================================================
# SASL AUTHENTICATION (for M2S to send)
# ============================================================
smtpd_sasl_auth_enable = yes
smtpd_sasl_type = cyrus
smtpd_sasl_path = smtpd
smtpd_sasl_security_options = noanonymous
smtpd_sasl_local_domain = $mydomain
broken_sasl_auth_clients = yes

# ============================================================
# SECURITY RESTRICTIONS
# ============================================================

# Who can connect
smtpd_client_restrictions =
    permit_mynetworks,
    permit_sasl_authenticated,
    reject_unknown_client_hostname

# Who can send HELO/EHLO
smtpd_helo_required = yes
smtpd_helo_restrictions =
    permit_mynetworks,
    permit_sasl_authenticated,
    reject_invalid_helo_hostname,
    reject_non_fqdn_helo_hostname

# Who can send mail (envelope sender)
smtpd_sender_restrictions =
    permit_mynetworks,
    permit_sasl_authenticated,
    check_sender_access hash:{{ postfix_config_dir }}/sender_whitelist,
    reject_unknown_sender_domain,
    reject_non_fqdn_sender

# Who can receive mail (envelope recipient)
smtpd_recipient_restrictions =
    permit_mynetworks,
    permit_sasl_authenticated,
    reject_unauth_destination,
    reject_unknown_recipient_domain,
    reject_non_fqdn_recipient

# Relay restrictions
smtpd_relay_restrictions =
    permit_mynetworks,
    permit_sasl_authenticated,
    defer_unauth_destination

# ============================================================
# DKIM (OpenDKIM milter)
# ============================================================
milter_default_action = accept
milter_protocol = 6
smtpd_milters = unix:/run/opendkim/opendkim.sock
non_smtpd_milters = $smtpd_milters

# ============================================================
# OUTBOUND RELAY (SMTP2GO)
# ============================================================
# GCP blocks outbound port 25, so we relay through SMTP2GO
{% if smtp_relay_host is defined and smtp_relay_host %}
relayhost = [{{ smtp_relay_host }}]:{{ smtp_relay_port | default(587) }}
smtp_sasl_auth_enable = yes
smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
smtp_sasl_security_options = noanonymous
smtp_tls_security_level = encrypt
smtp_tls_CAfile = /etc/ssl/certs/ca-certificates.crt
{% endif %}

# ============================================================
# PERFORMANCE TUNING
# ============================================================
default_process_limit = 100
smtpd_client_connection_count_limit = 10
smtpd_client_connection_rate_limit = 30

# ============================================================
# HEADER REWRITING (Mailing Lists)
# ============================================================
# Rewrite From headers for mailing list traffic.
# SMTP2GO requires verified sender domains, so we rewrite
# external From addresses to use our domain.
header_checks = pcre:{{ postfix_config_dir }}/header_checks

# Add mailing list headers (List-Id, Reply-To, etc.) on outbound mail
smtp_header_checks = pcre:{{ postfix_config_dir }}/smtp_header_checks

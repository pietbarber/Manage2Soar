# GKE Deploy Role

Ansible role for deploying Django applications to Google Kubernetes Engine (GKE).

## Overview

This role automates the deployment of Django applications to GKE, replacing manual shell scripts with reproducible, version-controlled Ansible playbooks. It supports both single-tenant and multi-tenant deployments.

## Features

- **Docker Image Management**: Build and push images to Google Container Registry (GCR)
- **Kubernetes Secrets**: Manage secrets from Ansible Vault (no more hardcoded base64!)
- **Multi-Tenant Support**: Deploy multiple clubs to separate namespaces
- **Automatic Rollback**: Rolls back on deployment failure
- **CronJob Management**: Deploy scheduled management commands
- **Health Checks**: Verify deployment with liveness/readiness probes
- **Versioned Deployments**: Auto-generated image tags with git commit hash

## Requirements

### Ansible Collections

```bash
ansible-galaxy collection install kubernetes.core
ansible-galaxy collection install google.cloud
```

### GCP Authentication

```bash
# Authenticate with GCP
gcloud auth application-default login

# Configure Docker for GCR
gcloud auth configure-docker
```

### kubectl

```bash
# Install kubectl
gcloud components install kubectl

# Get cluster credentials
gcloud container clusters get-credentials CLUSTER_NAME --zone ZONE --project PROJECT
```

## Role Variables

### Required Variables

| Variable | Description |
|----------|-------------|
| `gcp_project` | GCP project ID |
| `gke_cluster_name` | GKE cluster name |
| `vault_django_secret_key` | Django SECRET_KEY |
| `vault_postgresql_password` | Database password (single-tenant) |
| `vault_postgresql_password_<prefix>` | Database password per tenant (multi-tenant) |

### Optional Variables

See `defaults/main.yml` for all available variables with defaults.

#### Container Resources

```yaml
gke_replicas: 2
gke_cpu_request: "100m"
gke_cpu_limit: "250m"
gke_memory_request: "192Mi"
gke_memory_limit: "384Mi"
```

#### Deployment Options

```yaml
gke_build_image: true      # Build Docker image
gke_push_image: true       # Push to GCR
gke_apply_config: true     # Apply K8s configs
gke_run_migrations: false  # Run Django migrations
gke_deploy_cronjobs: true  # Deploy CronJobs
```

## Usage

### Single-Tenant Deployment

```bash
ansible-playbook -i inventory/gcp_app.yml \
  --vault-password-file ~/.ansible_vault_pass \
  playbooks/gcp-app-deploy.yml
```

### Multi-Tenant Deployment

```bash
# Deploy all tenants
ansible-playbook -i inventory/gcp_app.yml \
  --vault-password-file ~/.ansible_vault_pass \
  playbooks/gcp-app-deploy.yml

# Deploy specific tenant
ansible-playbook -i inventory/gcp_app.yml \
  --vault-password-file ~/.ansible_vault_pass \
  playbooks/gcp-app-deploy.yml \
  -e gke_deploy_tenant=ssc
```

### Update Secrets Only

```bash
ansible-playbook -i inventory/gcp_app.yml \
  --vault-password-file ~/.ansible_vault_pass \
  playbooks/gcp-app-deploy.yml \
  --tags secrets
```

### Deploy Existing Image

```bash
ansible-playbook -i inventory/gcp_app.yml \
  --vault-password-file ~/.ansible_vault_pass \
  playbooks/gcp-app-deploy.yml \
  -e gke_build_image=false \
  -e gke_push_image=false \
  -e gke_image_tag=20251229-1200-abc1234
```

## Multi-Tenant Configuration

```yaml
gke_multi_tenant: true

gke_tenants:
  - prefix: "ssc"
    name: "Skyline Soaring Club"
    domain: "m2s.skylinesoaring.org"

  - prefix: "masa"
    name: "Mid-Atlantic Soaring Association"
    domain: "m2s.midatlanticsoaring.org"
```

Each tenant gets:
- Separate Kubernetes namespace (`tenant-<prefix>`)
- Own deployment and service (`django-app-<prefix>`)
- Tenant-specific secrets (`manage2soar-env-<prefix>`)
- Own database (`m2s_<prefix>` / user `m2s_<prefix>`)
- Separate CronJobs

## Image Tagging

Image tags are auto-generated by default:

| Type | Format | Example |
|------|--------|---------|
| `auto` (default) | `YYYYMMDD-HHMM-<git-hash>` | `20251229-1430-abc1234` |
| `timestamp` | `YYYYMMDD-HHMM` | `20251229-1430` |
| `git` | `<git-hash>` | `abc1234` |
| `git-tag` | `<tag>` or `<git-hash>` | `v1.2.3` |

```yaml
# Use specific tag type
gke_image_tag_type: "git-tag"

# Or specify exact tag
gke_image_tag: "v1.2.3"
```

## Files Generated

The role generates Kubernetes manifests from templates:

| Template | Output | Description |
|----------|--------|-------------|
| `k8s-deployment.yml.j2` | Deployment + Service | Django app containers |
| `k8s-secrets.yml.j2` | Secret | Environment variables from Vault |
| `k8s-cronjobs.yml.j2` | CronJobs | Scheduled management commands |

## Tags

| Tag | Description |
|-----|-------------|
| `docker` | Docker build and push |
| `build` | Build Docker image only |
| `push` | Push image to registry only |
| `secrets` | Kubernetes secrets management |
| `deploy` | Apply Kubernetes configurations |
| `cronjobs` | Deploy CronJob configurations |
| `verify` | Verification and health checks |
| `gke-auth` | GKE authentication |

## Comparison with pushy-enhanced-v4.sh

| Feature | Shell Script | Ansible Role |
|---------|--------------|--------------|
| Secrets | Hardcoded base64 | Ansible Vault |
| Multi-tenant | No | Yes |
| Rollback | Manual | Automatic |
| Idempotent | No | Yes |
| Version Control | Script only | Full configuration |
| Documentation | Comments | Structured docs |

## Troubleshooting

### Authentication Issues

```bash
# Re-authenticate with GCP
gcloud auth application-default login
gcloud auth configure-docker

# Get cluster credentials
gcloud container clusters get-credentials CLUSTER_NAME --zone ZONE
```

### Deployment Failures

```bash
# Check pod status
kubectl get pods -n NAMESPACE

# Check pod logs
kubectl logs -l app=django-app -n NAMESPACE

# Describe deployment
kubectl describe deployment django-app -n NAMESPACE
```

### Manual Rollback

```bash
# View rollout history
kubectl rollout history deployment/django-app -n NAMESPACE

# Rollback to previous version
kubectl rollout undo deployment/django-app -n NAMESPACE

# Rollback to specific revision
kubectl rollout undo deployment/django-app -n NAMESPACE --to-revision=3
```

## License

MIT

# GKE Deploy Role

Ansible role for deploying Django applications to Google Kubernetes Engine (GKE).

## Overview

This role automates the deployment of Django applications to GKE, replacing manual shell scripts with reproducible, version-controlled Ansible playbooks. It supports both single-tenant and multi-tenant deployments.

## Features

- **Docker Image Management**: Build and push images to Google Container Registry (GCR)
- **Kubernetes Secrets**: Manage secrets from Ansible Vault (no more hardcoded base64!)
- **Multi-Tenant Support**: Deploy multiple clubs to separate namespaces
- **Automatic Rollback**: Rolls back on deployment failure
- **CronJob Management**: Deploy scheduled management commands
- **Health Checks**: Verify deployment with liveness/readiness probes
- **Versioned Deployments**: Auto-generated image tags with git commit hash

## Requirements

### Ansible Collections

```bash
ansible-galaxy collection install kubernetes.core
ansible-galaxy collection install google.cloud
```

### GCP Authentication

```bash
# Authenticate with GCP
gcloud auth application-default login

# Configure Docker for GCR
gcloud auth configure-docker
```

### kubectl

```bash
# Install kubectl
gcloud components install kubectl

# Get cluster credentials
gcloud container clusters get-credentials CLUSTER_NAME --zone ZONE --project PROJECT
```

## Role Variables

### Required Variables

| Variable | Description |
|----------|-------------|
| `gcp_project` | GCP project ID |
| `gke_cluster_name` | GKE cluster name |
| `vault_django_secret_key` | Django SECRET_KEY (shared fallback for all tenants) |
| `vault_django_secret_key_<prefix>` | Per-tenant Django SECRET_KEY (recommended; overrides shared key when defined) |
| `vault_postgresql_password` | Database password (single-tenant) |
| `vault_postgresql_password_<prefix>` | Database password per tenant (multi-tenant) |

### Optional Variables

See `defaults/main.yml` for all available variables with defaults.

#### Container Resources

```yaml
gke_replicas: 2
gke_cpu_request: "250m"
gke_cpu_limit: "500m"
gke_memory_request: "512Mi"
gke_memory_limit: "1Gi"
```

#### Deployment Options

```yaml
gke_build_image: true      # Build Docker image
gke_push_image: true       # Push to GCR
gke_apply_config: true     # Apply K8s configs
gke_run_migrations: false  # Run Django migrations
gke_deploy_cronjobs: true  # Deploy CronJobs
```

## Usage

### Single-Tenant Deployment

```bash
ansible-playbook -i inventory/gcp_app.yml \
  --vault-password-file ~/.ansible_vault_pass \
  playbooks/gcp-app-deploy.yml
```

### Multi-Tenant Deployment

```bash
# Deploy all tenants
ansible-playbook -i inventory/gcp_app.yml \
  --vault-password-file ~/.ansible_vault_pass \
  playbooks/gcp-app-deploy.yml

# Deploy specific tenant
ansible-playbook -i inventory/gcp_app.yml \
  --vault-password-file ~/.ansible_vault_pass \
  playbooks/gcp-app-deploy.yml \
  -e gke_deploy_tenant=ssc
```

### Update Secrets Only

```bash
ansible-playbook -i inventory/gcp_app.yml \
  --vault-password-file ~/.ansible_vault_pass \
  playbooks/gcp-app-deploy.yml \
  --tags secrets
```

### Deploy Existing Image

```bash
ansible-playbook -i inventory/gcp_app.yml \
  --vault-password-file ~/.ansible_vault_pass \
  playbooks/gcp-app-deploy.yml \
  -e gke_build_image=false \
  -e gke_push_image=false \
  -e gke_image_tag=20251229-1200-abc1234
```

## Multi-Tenant Configuration

```yaml
gke_multi_tenant: true

gke_tenants:
  - prefix: "ssc"
    name: "Skyline Soaring Club"
    domain: "m2s.skylinesoaring.org"

  - prefix: "masa"
    name: "Mid-Atlantic Soaring Association"
    domain: "m2s.midatlanticsoaring.org"
```

> **Note:** This role assumes that the per-tenant PostgreSQL databases and users (following the `m2s_<prefix>` naming convention, e.g. `m2s_ssc`) have already been created. The GKE deploy role only configures Kubernetes secrets that point to these existing databases; it does **not** provision the databases themselves. Database provisioning should be handled separately, either manually or via the dedicated PostgreSQL role referenced in the comparison table.

Each tenant gets:
- Separate Kubernetes namespace (`tenant-<prefix>`)
- Own deployment and service (`django-app-<prefix>`)
- Tenant-specific secrets (`manage2soar-env-<prefix>`)
- Own database (`m2s_<prefix>` / user `m2s_<prefix>`)
- Separate CronJobs

## Image Tagging

Image tags are auto-generated by default:

| Type | Format | Example |
|------|--------|---------|
| `auto` (default) | `YYYYMMDD-HHMM-<git-hash>` | `20251229-1430-abc1234` |
| `timestamp` | `YYYYMMDD-HHMM` | `20251229-1430` |
| `git` | `<git-hash>` | `abc1234` |
| `git-tag` | `<tag>` or `<git-hash>` | `v1.2.3` |

```yaml
# Use specific tag type
gke_image_tag_type: "git-tag"

# Or specify exact tag
gke_image_tag: "v1.2.3"
```

## Files Generated

The role generates Kubernetes manifests from templates:

| Template | Output | Description |
|----------|--------|-------------|
| `k8s-deployment.yml.j2` | Deployment + Service | Django app containers |
| `k8s-secrets.yml.j2` | Secret | Environment variables from Vault |
| `k8s-cronjobs.yml.j2` | CronJobs | Scheduled management commands |

## Tags

| Tag | Description |
|-----|-------------|
| `docker` | Docker build and push |
| `build` | Build Docker image only |
| `push` | Push image to registry only |
| `secrets` | Kubernetes secrets management |
| `deploy` | Apply Kubernetes configurations |
| `cronjobs` | Deploy CronJob configurations |
| `verify` | Verification and health checks |
| `gke-auth` | GKE authentication |

## Comparison with pushy-enhanced-v4.sh

| Feature | Shell Script | Ansible Role |
|---------|--------------|--------------|
| Secrets | Hardcoded base64 | Ansible Vault |
| Multi-tenant | No | Yes |
| Rollback | Manual | Automatic |
| Idempotent | No | Yes |
| Version Control | Script only | Full configuration |
| Documentation | Comments | Structured docs |

## Troubleshooting

### Authentication Issues

```bash
# Re-authenticate with GCP
gcloud auth application-default login
gcloud auth configure-docker

# Get cluster credentials
gcloud container clusters get-credentials CLUSTER_NAME --zone ZONE
```

### Deployment Failures

```bash
# Check pod status
kubectl get pods -n NAMESPACE

# Check pod logs
kubectl logs -l app=django-app -n NAMESPACE

# Describe deployment
kubectl describe deployment django-app -n NAMESPACE
```

### Manual Rollback

```bash
# View rollout history
kubectl rollout history deployment/django-app -n NAMESPACE

# Rollback to previous version
kubectl rollout undo deployment/django-app -n NAMESPACE

# Rollback to specific revision
kubectl rollout undo deployment/django-app -n NAMESPACE --to-revision=3
```

## Known Limitations & Manual Steps

### IPv6 Forwarding Rules

When deploying with `gke_enable_ipv6: true`, GKE Gateway API does not automatically create IPv6 forwarding rules. After Gateway deployment, you must manually create them:

```bash
# See infrastructure/ansible/docs/ipv6-dual-stack-guide.md for complete instructions
gcloud compute forwarding-rules create manage2soar-gateway-ipv6-https \
  --address=manage2soar-cluster-ingress-ipv6 \
  --target-https-proxy=<gateway-https-proxy-name> \
  --ports=443 --global --ip-version=IPV6
```

**Future Enhancement**: Consider adding post-Gateway task to detect and create IPv6 forwarding rules automatically.

### Gateway Health Check Paths

GKE Gateway API creates health checks with path `/` by default. If your application redirects this path (e.g., `SECURE_SSL_REDIRECT=True`), health checks will fail. After Gateway deployment, update health check paths:

```bash
# See infrastructure/ansible/docs/gke-post-deployment.md for complete instructions
gcloud compute health-checks update http <health-check-name> \
  --global --request-path=/health/
```

**Future Enhancement**: Consider adding post-Gateway task to update health check paths automatically.

### Gateway SSL Certificate References

If multiple managed certificates exist, the Gateway may reference an older certificate. After Gateway deployment, verify the correct certificate is used:

```bash
kubectl patch gateway manage2soar-gateway \
  --type=json \
  -p='[{"op": "replace", "path": "/spec/listeners/0/tls/options/networking.gke.io~1pre-shared-certs", "value": "manage2soar-ssl-cert-v2"}]'
```

**Future Enhancement**: Consider adding validation task to ensure Gateway references the ACTIVE certificate.

## License

MIT

# GKE HTTPRoute Configuration for {{ ingress_tenant.prefix }}
# Generated by Ansible - DO NOT EDIT DIRECTLY
#
# This HTTPRoute defines the routing rules for tenant {{ ingress_tenant.prefix }}.
# It's like an nginx location block that routes traffic to the backend
# service based on the hostname.
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: {{ gke_app_name }}-{{ ingress_tenant.prefix }}-route
  namespace: tenant-{{ ingress_tenant.prefix }}
  labels:
    app: {{ gke_app_name }}
    tenant: "{{ ingress_tenant.prefix }}"
    managed-by: ansible
spec:
  parentRefs:
    # Reference the shared Gateway in the default namespace
    - name: {{ gke_app_name }}-gateway
      namespace: default
      sectionName: https
  hostnames:
{# Support both plural 'domains' list and singular 'domain' string #}
{% set tenant_domains = ingress_tenant.domains | default([ingress_tenant.domain] if ingress_tenant.domain is defined else []) %}
{% for domain in tenant_domains %}
    - "{{ domain }}"
{% endfor %}
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        # Service name follows convention: django-app-{prefix}
        - name: django-app-{{ ingress_tenant.prefix }}
          port: 8000
---
# HTTP to HTTPS redirect route
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: {{ gke_app_name }}-{{ ingress_tenant.prefix }}-redirect
  namespace: tenant-{{ ingress_tenant.prefix }}
  labels:
    app: {{ gke_app_name }}
    tenant: "{{ ingress_tenant.prefix }}"
    managed-by: ansible
spec:
  parentRefs:
    - name: {{ gke_app_name }}-gateway
      namespace: default
      sectionName: http
  hostnames:
{% for domain in tenant_domains %}
    - "{{ domain }}"
{% endfor %}
  rules:
    - filters:
        - type: RequestRedirect
          requestRedirect:
            scheme: https
            statusCode: 301

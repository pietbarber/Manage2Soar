# GKE HTTPRoute Configuration for {{ ingress_tenant.prefix }}
# Generated by Ansible - DO NOT EDIT DIRECTLY
#
# This HTTPRoute defines the routing rules for tenant {{ ingress_tenant.prefix }}.
# It's like an nginx location block that routes traffic to the backend
# service based on the hostname.
{# Support both plural 'domains' list and singular 'domain' string - computed once #}
{% set tenant_domains = ingress_tenant.domains | default([ingress_tenant.domain] if ingress_tenant.domain is defined else []) %}
{# Validate that at least one domain is configured to prevent a catch-all HTTPRoute #}
{% if tenant_domains | length == 0 %}
{{   missing_tenant_domain | mandatory('Tenant ' ~ ingress_tenant.prefix ~ ' must define at least one domain (via domains list or domain string) when ingress is enabled.') }}
{% endif %}
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: {{ gke_app_name }}-{{ ingress_tenant.prefix }}-route
  namespace: tenant-{{ ingress_tenant.prefix }}
  labels:
    app: {{ gke_app_name }}
    tenant: "{{ ingress_tenant.prefix }}"
    managed-by: ansible
spec:
  parentRefs:
    # Reference the shared Gateway in the default namespace
    - name: {{ gke_app_name }}-gateway
      namespace: default
      sectionName: https
  hostnames:
{% for domain in tenant_domains %}
    - "{{ domain }}"
{% endfor %}
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        # Service name is configurable via playbook inventory for per-tenant
        # naming conventions (e.g. django-app-{prefix})
        - name: django-app-{{ ingress_tenant.prefix }}
          port: {{ gke_container_port }}
---
# HTTP to HTTPS redirect route
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: {{ gke_app_name }}-{{ ingress_tenant.prefix }}-redirect
  namespace: tenant-{{ ingress_tenant.prefix }}
  labels:
    app: {{ gke_app_name }}
    tenant: "{{ ingress_tenant.prefix }}"
    managed-by: ansible
spec:
  parentRefs:
    - name: {{ gke_app_name }}-gateway
      namespace: default
      sectionName: http
  hostnames:
{% for domain in tenant_domains %}
    - "{{ domain }}"
{% endfor %}
  rules:
    - filters:
        - type: RequestRedirect
          requestRedirect:
            scheme: https
            port: 443
            statusCode: 301

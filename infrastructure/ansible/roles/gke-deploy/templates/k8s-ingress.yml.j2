# GKE Ingress Configuration
# Generated by Ansible - DO NOT EDIT DIRECTLY
#
# This Ingress routes traffic from configured domains to tenant Services.
# Supports multiple domains per tenant for migration scenarios.
#
# Example:
#   - ssc.manage2soar.com → django-app-ssc
#   - www.skylinesoaring.org → django-app-ssc (alias during migration)
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ gke_app_name }}-ingress
  namespace: {{ gke_namespace }}
  annotations:
    # Use GCE ingress controller (GKE native)
    kubernetes.io/ingress.class: "{{ gke_ingress_class }}"
    # Reserve static IP for consistent DNS
    kubernetes.io/ingress.global-static-ip-name: "{{ gke_static_ip_name }}"
{% if gke_enable_tls | default(true) | bool %}
    # Reference Google-managed SSL certificate
    networking.gke.io/managed-certificates: "{{ gke_app_name }}-cert"
    # Redirect HTTP to HTTPS
    kubernetes.io/ingress.allow-http: "false"
{% else %}
    # Allow HTTP (TLS not enabled)
    kubernetes.io/ingress.allow-http: "true"
{% endif %}
    # GCE-specific: Use container-native load balancing for better performance
    cloud.google.com/neg: '{"ingress": true}'
  labels:
    app: {{ gke_app_name }}
    managed-by: ansible
spec:
  rules:
{% if gke_multi_tenant | bool %}
{#- Multi-tenant mode: create rules for each tenant's domains -#}
{% for tenant in gke_tenants %}
{% set tenant_domains = tenant.domains | default([tenant.domain] if tenant.domain is defined else []) %}
{% set tenant_service = gke_service_name ~ '-' ~ tenant.prefix %}
{% for domain in tenant_domains %}
    - host: {{ domain }}
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: {{ tenant_service }}
                port:
                  number: {{ gke_container_port }}
{% endfor %}
{% endfor %}
{% else %}
{#- Single-tenant mode -#}
{% set domains = gke_domains | default([gke_domain] if gke_domain is defined else [gke_base_domain]) %}
{% for domain in domains %}
    - host: {{ domain }}
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: {{ gke_service_name }}
                port:
                  number: {{ gke_container_port }}
{% endfor %}
{% endif %}

# Kubernetes CronJobs for Django Management Commands
# Generated by Ansible gke-deploy role
# DO NOT EDIT MANUALLY - managed by Ansible
#
# Tenant: {{ gke_club_prefix | default('default') }}
# Generated: {{ ansible_date_time.iso8601 | default(lookup('pipe', 'date -Iseconds')) }}

---
# ============================================================
# DAILY MAINTENANCE TASKS
# ============================================================

# Clear expired sessions
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ gke_deployment_name }}-clearsessions
  namespace: {{ gke_namespace }}
  labels:
    app: {{ gke_deployment_name }}
    cronjob: clearsessions
{% if gke_multi_tenant %}
    tenant: {{ gke_club_prefix }}
{% endif %}
spec:
  schedule: "0 3 * * *"  # Daily at 3 AM
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: clearsessions
              image: {{ gke_image_name }}:{{ gke_computed_image_tag | trim }}
              command: ["python", "manage.py", "clearsessions"]
              envFrom:
                - secretRef:
                    name: {{ gke_secret_name }}
              volumeMounts:
                - name: gcp-sa-key
                  mountPath: {{ gke_gcp_credentials_path }}
                  subPath: gcp-credentials.json
                  readOnly: true
              env:
                - name: GOOGLE_APPLICATION_CREDENTIALS
                  value: {{ gke_gcp_credentials_path }}
          volumes:
            - name: gcp-sa-key
              secret:
                secretName: {{ gke_gcp_sa_secret_name }}
          restartPolicy: OnFailure

---
# Send notification emails
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ gke_deployment_name }}-send-notifications
  namespace: {{ gke_namespace }}
  labels:
    app: {{ gke_deployment_name }}
    cronjob: send-notifications
{% if gke_multi_tenant %}
    tenant: {{ gke_club_prefix }}
{% endif %}
spec:
  schedule: "*/10 * * * *"  # Every 10 minutes
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: send-notifications
              image: {{ gke_image_name }}:{{ gke_computed_image_tag | trim }}
              command: ["python", "manage.py", "send_pending_notifications"]
              envFrom:
                - secretRef:
                    name: {{ gke_secret_name }}
              volumeMounts:
                - name: gcp-sa-key
                  mountPath: {{ gke_gcp_credentials_path }}
                  subPath: gcp-credentials.json
                  readOnly: true
              env:
                - name: GOOGLE_APPLICATION_CREDENTIALS
                  value: {{ gke_gcp_credentials_path }}
          volumes:
            - name: gcp-sa-key
              secret:
                secretName: {{ gke_gcp_sa_secret_name }}
          restartPolicy: OnFailure

---
# Check duty assignments
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ gke_deployment_name }}-check-duty
  namespace: {{ gke_namespace }}
  labels:
    app: {{ gke_deployment_name }}
    cronjob: check-duty
{% if gke_multi_tenant %}
    tenant: {{ gke_club_prefix }}
{% endif %}
spec:
  schedule: "0 6 * * *"  # Daily at 6 AM
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: check-duty
              image: {{ gke_image_name }}:{{ gke_computed_image_tag | trim }}
              command: ["python", "manage.py", "check_duty_assignments"]
              envFrom:
                - secretRef:
                    name: {{ gke_secret_name }}
              volumeMounts:
                - name: gcp-sa-key
                  mountPath: {{ gke_gcp_credentials_path }}
                  subPath: gcp-credentials.json
                  readOnly: true
              env:
                - name: GOOGLE_APPLICATION_CREDENTIALS
                  value: {{ gke_gcp_credentials_path }}
          volumes:
            - name: gcp-sa-key
              secret:
                secretName: {{ gke_gcp_sa_secret_name }}
          restartPolicy: OnFailure

---
# Generate duty roster (weekly)
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ gke_deployment_name }}-generate-roster
  namespace: {{ gke_namespace }}
  labels:
    app: {{ gke_deployment_name }}
    cronjob: generate-roster
{% if gke_multi_tenant %}
    tenant: {{ gke_club_prefix }}
{% endif %}
spec:
  schedule: "0 0 * * 0"  # Weekly on Sunday at midnight
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: generate-roster
              image: {{ gke_image_name }}:{{ gke_computed_image_tag | trim }}
              command: ["python", "manage.py", "generate_duty_roster", "--weeks=4"]
              envFrom:
                - secretRef:
                    name: {{ gke_secret_name }}
              volumeMounts:
                - name: gcp-sa-key
                  mountPath: {{ gke_gcp_credentials_path }}
                  subPath: gcp-credentials.json
                  readOnly: true
              env:
                - name: GOOGLE_APPLICATION_CREDENTIALS
                  value: {{ gke_gcp_credentials_path }}
          volumes:
            - name: gcp-sa-key
              secret:
                secretName: {{ gke_gcp_sa_secret_name }}
          restartPolicy: OnFailure

---
# Update membership status
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ gke_deployment_name }}-update-membership
  namespace: {{ gke_namespace }}
  labels:
    app: {{ gke_deployment_name }}
    cronjob: update-membership
{% if gke_multi_tenant %}
    tenant: {{ gke_club_prefix }}
{% endif %}
spec:
  schedule: "0 1 * * *"  # Daily at 1 AM
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: update-membership
              image: {{ gke_image_name }}:{{ gke_computed_image_tag | trim }}
              command: ["python", "manage.py", "update_membership_status"]
              envFrom:
                - secretRef:
                    name: {{ gke_secret_name }}
              volumeMounts:
                - name: gcp-sa-key
                  mountPath: {{ gke_gcp_credentials_path }}
                  subPath: gcp-credentials.json
                  readOnly: true
              env:
                - name: GOOGLE_APPLICATION_CREDENTIALS
                  value: {{ gke_gcp_credentials_path }}
          volumes:
            - name: gcp-sa-key
              secret:
                secretName: {{ gke_gcp_sa_secret_name }}
          restartPolicy: OnFailure

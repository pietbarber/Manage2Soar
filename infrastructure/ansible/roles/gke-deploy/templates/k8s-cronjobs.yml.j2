# Kubernetes CronJobs for Django Management Commands
# Generated by Ansible gke-deploy role
# DO NOT EDIT MANUALLY - managed by Ansible
#
# Tenant: {{ gke_club_prefix | default('default') }}
# Generated: {{ ansible_date_time.iso8601 | default(lookup('pipe', 'date -Iseconds')) }}
#
# These CronJobs match the actual production k8s-cronjobs.yaml configuration
#
# Resource Allocation Strategy:
#   - Small tasks (clearsessions, duty emails): 64Mi/50m CPU
#   - Medium tasks (aging logsheets, maintenance): 128Mi/100m CPU
#   - Large tasks (SPRs, delinquents): 256Mi/200m CPU
# Resource limits are based on observed production usage patterns and may need
# tuning for datasets with significantly different sizes or email volumes.
#
# Rationale:
#   - Small tasks: Minimal DB queries, few emails (< 10)
#   - Medium tasks: Moderate DB queries, batch email processing (10-50 emails)
#   - Large tasks: Complex queries, many emails (50+ emails), monthly reports
# Consider overriding via gke_cronjob_resources_* variables in group_vars for
# clubs with significantly larger member counts or duty roster sizes.

---
# ============================================================
# DAILY MAINTENANCE TASKS
# ============================================================

# Clear expired sessions (daily at 3 AM UTC)
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ gke_deployment_name }}-clearsessions
  namespace: {{ gke_namespace }}
  labels:
    app: {{ gke_deployment_name }}
    cronjob: clearsessions
{% if gke_multi_tenant %}
    tenant: {{ gke_club_prefix }}
{% endif %}
spec:
  schedule: "0 3 * * *"  # Daily at 3 AM UTC
  timeZone: "UTC"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 300  # 5 minute timeout
      template:
        spec:
          restartPolicy: Never
          containers:
            - name: clearsessions
              image: {{ gke_image_name }}:{{ gke_computed_image_tag | trim }}
              command:
                - python
                - manage.py
                - clearsessions
              workingDir: /app
              envFrom:
                - secretRef:
                    name: {{ gke_secret_name }}
              env:
                - name: GOOGLE_APPLICATION_CREDENTIALS
                  value: {{ gke_gcp_credentials_path }}
              volumeMounts:
                - name: gcp-sa-key
                  mountPath: {{ gke_gcp_credentials_path }}
                  subPath: gcp-credentials.json
                  readOnly: true
              resources:
                requests:
                  memory: "64Mi"
                  cpu: "50m"
                limits:
                  memory: "128Mi"
                  cpu: "100m"
          volumes:
            - name: gcp-sa-key
              secret:
                secretName: {{ gke_gcp_sa_secret_name }}

---
# ============================================================
# NOTIFICATION TASKS (PRODUCTION)
# ============================================================

# Daily: Aging Logsheet Notifications (8:00 AM UTC)
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ gke_deployment_name }}-notify-aging-logsheets
  namespace: {{ gke_namespace }}
  labels:
    app: {{ gke_deployment_name }}
    cronjob: notify-aging-logsheets
{% if gke_multi_tenant %}
    tenant: {{ gke_club_prefix }}
{% endif %}
spec:
  schedule: "0 8 * * *"  # Daily at 8:00 AM UTC
  timeZone: "UTC"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 900  # 15 minute timeout
      template:
        spec:
          restartPolicy: Never
          containers:
            - name: notify-aging-logsheets
              image: {{ gke_image_name }}:{{ gke_computed_image_tag | trim }}
              command:
                - python
                - manage.py
                - notify_aging_logsheets
                - --verbosity=1
              workingDir: /app
              envFrom:
                - secretRef:
                    name: {{ gke_secret_name }}
              env:
                - name: GOOGLE_APPLICATION_CREDENTIALS
                  value: {{ gke_gcp_credentials_path }}
              volumeMounts:
                - name: gcp-sa-key
                  mountPath: {{ gke_gcp_credentials_path }}
                  subPath: gcp-credentials.json
                  readOnly: true
              resources:
                requests:
                  memory: "64Mi"
                  cpu: "50m"
                limits:
                  memory: "128Mi"
                  cpu: "100m"
          volumes:
            - name: gcp-sa-key
              secret:
                secretName: {{ gke_gcp_sa_secret_name }}

---
# ============================================================
# DUTY ROSTER TASKS (PRODUCTION)
# ============================================================

# Daily: Pre-operation Duty Emails (6:00 AM UTC for next day)
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ gke_deployment_name }}-send-duty-preop-emails
  namespace: {{ gke_namespace }}
  labels:
    app: {{ gke_deployment_name }}
    cronjob: send-duty-preop-emails
{% if gke_multi_tenant %}
    tenant: {{ gke_club_prefix }}
{% endif %}
spec:
  schedule: "0 6 * * *"  # Daily at 6:00 AM UTC
  timeZone: "UTC"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 600  # 10 minute timeout
      template:
        spec:
          restartPolicy: Never
          containers:
            - name: send-duty-preop-emails
              image: {{ gke_image_name }}:{{ gke_computed_image_tag | trim }}
              command:
                - python
                - manage.py
                - send_duty_preop_emails
                - --verbosity=1
              workingDir: /app
              envFrom:
                - secretRef:
                    name: {{ gke_secret_name }}
              env:
                - name: GOOGLE_APPLICATION_CREDENTIALS
                  value: {{ gke_gcp_credentials_path }}
              volumeMounts:
                - name: gcp-sa-key
                  mountPath: {{ gke_gcp_credentials_path }}
                  subPath: gcp-credentials.json
                  readOnly: true
              resources:
                requests:
                  memory: "64Mi"
                  cpu: "50m"
                limits:
                  memory: "128Mi"
                  cpu: "100m"
          volumes:
            - name: gcp-sa-key
              secret:
                secretName: {{ gke_gcp_sa_secret_name }}

---
# Daily: Instructor Summary Emails (6:00 AM UTC, 48 hours ahead)
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ gke_deployment_name }}-send-instructor-summary-emails
  namespace: {{ gke_namespace }}
  labels:
    app: {{ gke_deployment_name }}
    cronjob: send-instructor-summary-emails
{% if gke_multi_tenant %}
    tenant: {{ gke_club_prefix }}
{% endif %}
spec:
  schedule: "0 6 * * *"  # Daily at 6:00 AM UTC
  timeZone: "UTC"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 600  # 10 minute timeout
      template:
        spec:
          restartPolicy: Never
          containers:
            - name: send-instructor-summary-emails
              image: {{ gke_image_name }}:{{ gke_computed_image_tag | trim }}
              command:
                - python
                - manage.py
                - send_instructor_summary_emails
                - --hours-ahead=48
                - --verbosity=1
              workingDir: /app
              envFrom:
                - secretRef:
                    name: {{ gke_secret_name }}
              env:
                - name: GOOGLE_APPLICATION_CREDENTIALS
                  value: {{ gke_gcp_credentials_path }}
              volumeMounts:
                - name: gcp-sa-key
                  mountPath: {{ gke_gcp_credentials_path }}
                  subPath: gcp-credentials.json
                  readOnly: true
              resources:
                requests:
                  memory: "64Mi"
                  cpu: "50m"
                limits:
                  memory: "128Mi"
                  cpu: "100m"
          volumes:
            - name: gcp-sa-key
              secret:
                secretName: {{ gke_gcp_sa_secret_name }}

---
# Daily: Expire Ad-hoc Days (6:00 PM UTC for tomorrow)
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ gke_deployment_name }}-expire-ad-hoc-days
  namespace: {{ gke_namespace }}
  labels:
    app: {{ gke_deployment_name }}
    cronjob: expire-ad-hoc-days
{% if gke_multi_tenant %}
    tenant: {{ gke_club_prefix }}
{% endif %}
spec:
  schedule: "0 18 * * *"  # Daily at 6:00 PM UTC
  timeZone: "UTC"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 300  # 5 minute timeout
      template:
        spec:
          restartPolicy: Never
          containers:
            - name: expire-ad-hoc-days
              image: {{ gke_image_name }}:{{ gke_computed_image_tag | trim }}
              command:
                - python
                - manage.py
                - expire_ad_hoc_days
                - --verbosity=1
              workingDir: /app
              envFrom:
                - secretRef:
                    name: {{ gke_secret_name }}
              env:
                - name: GOOGLE_APPLICATION_CREDENTIALS
                  value: {{ gke_gcp_credentials_path }}
              volumeMounts:
                - name: gcp-sa-key
                  mountPath: {{ gke_gcp_credentials_path }}
                  subPath: gcp-credentials.json
                  readOnly: true
              resources:
                requests:
                  memory: "64Mi"
                  cpu: "50m"
                limits:
                  memory: "128Mi"
                  cpu: "100m"
          volumes:
            - name: gcp-sa-key
              secret:
                secretName: {{ gke_gcp_sa_secret_name }}

---
# Weekly: Late SPR Notifications (Monday 10:00 AM UTC)
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ gke_deployment_name }}-notify-late-sprs
  namespace: {{ gke_namespace }}
  labels:
    app: {{ gke_deployment_name }}
    cronjob: notify-late-sprs
{% if gke_multi_tenant %}
    tenant: {{ gke_club_prefix }}
{% endif %}
spec:
  schedule: "0 10 * * 1"  # Weekly on Monday at 10:00 AM UTC
  timeZone: "UTC"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 1200  # 20 minute timeout
      template:
        spec:
          restartPolicy: Never
          containers:
            - name: notify-late-sprs
              image: {{ gke_image_name }}:{{ gke_computed_image_tag | trim }}
              command:
                - python
                - manage.py
                - notify_late_sprs
                - --verbosity=1
              workingDir: /app
              envFrom:
                - secretRef:
                    name: {{ gke_secret_name }}
              env:
                - name: GOOGLE_APPLICATION_CREDENTIALS
                  value: {{ gke_gcp_credentials_path }}
              volumeMounts:
                - name: gcp-sa-key
                  mountPath: {{ gke_gcp_credentials_path }}
                  subPath: gcp-credentials.json
                  readOnly: true
              resources:
                requests:
                  memory: "128Mi"
                  cpu: "100m"
                limits:
                  memory: "256Mi"
                  cpu: "200m"
          volumes:
            - name: gcp-sa-key
              secret:
                secretName: {{ gke_gcp_sa_secret_name }}

---
# Weekly: Maintenance Digest (Sunday 9:00 AM UTC)
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ gke_deployment_name }}-send-maintenance-digest
  namespace: {{ gke_namespace }}
  labels:
    app: {{ gke_deployment_name }}
    cronjob: send-maintenance-digest
{% if gke_multi_tenant %}
    tenant: {{ gke_club_prefix }}
{% endif %}
spec:
  schedule: "0 9 * * 0"  # Weekly on Sunday at 9:00 AM UTC
  timeZone: "UTC"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 600  # 10 minute timeout
      template:
        spec:
          restartPolicy: Never
          containers:
            - name: send-maintenance-digest
              image: {{ gke_image_name }}:{{ gke_computed_image_tag | trim }}
              command:
                - python
                - manage.py
                - send_maintenance_digest
                - --verbosity=1
              workingDir: /app
              envFrom:
                - secretRef:
                    name: {{ gke_secret_name }}
              env:
                - name: GOOGLE_APPLICATION_CREDENTIALS
                  value: {{ gke_gcp_credentials_path }}
              volumeMounts:
                - name: gcp-sa-key
                  mountPath: {{ gke_gcp_credentials_path }}
                  subPath: gcp-credentials.json
                  readOnly: true
              resources:
                requests:
                  memory: "64Mi"
                  cpu: "50m"
                limits:
                  memory: "128Mi"
                  cpu: "100m"
          volumes:
            - name: gcp-sa-key
              secret:
                secretName: {{ gke_gcp_sa_secret_name }}

---
# Monthly: Duty Delinquent Report (1st of month, 7:00 AM UTC)
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ gke_deployment_name }}-report-duty-delinquents
  namespace: {{ gke_namespace }}
  labels:
    app: {{ gke_deployment_name }}
    cronjob: report-duty-delinquents
{% if gke_multi_tenant %}
    tenant: {{ gke_club_prefix }}
{% endif %}
spec:
  schedule: "0 7 1 * *"  # Monthly on 1st at 7:00 AM UTC
  timeZone: "UTC"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 1800  # 30 minute timeout
      template:
        spec:
          restartPolicy: Never
          containers:
            - name: report-duty-delinquents
              image: {{ gke_image_name }}:{{ gke_computed_image_tag | trim }}
              command:
                - python
                - manage.py
                - report_duty_delinquents
                - --verbosity=1
              workingDir: /app
              envFrom:
                - secretRef:
                    name: {{ gke_secret_name }}
              env:
                - name: GOOGLE_APPLICATION_CREDENTIALS
                  value: {{ gke_gcp_credentials_path }}
              volumeMounts:
                - name: gcp-sa-key
                  mountPath: {{ gke_gcp_credentials_path }}
                  subPath: gcp-credentials.json
                  readOnly: true
              resources:
                requests:
                  memory: "128Mi"
                  cpu: "100m"
                limits:
                  memory: "256Mi"
                  cpu: "200m"
          volumes:
            - name: gcp-sa-key
              secret:
                secretName: {{ gke_gcp_sa_secret_name }}

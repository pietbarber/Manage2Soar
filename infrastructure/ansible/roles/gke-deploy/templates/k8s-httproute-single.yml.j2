# GKE HTTPRoute Configuration (Single-Tenant)
# Generated by Ansible - DO NOT EDIT DIRECTLY
#
# This HTTPRoute defines the routing rules for a single-tenant deployment.
# It's like an nginx location block that routes traffic to the backend
# service based on the hostname.
{# Support both plural 'domains' list and singular 'domain' string #}
{% set single_domains = [] %}
{% if gke_domains is defined and gke_domains %}
  {% if gke_domains is string %}
    {% set single_domains = [gke_domains] %}
  {% else %}
    {% set single_domains = gke_domains %}
  {% endif %}
{% elif gke_domain is defined and gke_domain %}
  {% set single_domains = [gke_domain] %}
{% endif %}
{# Validate that at least one domain is configured to avoid a catch-all HTTPRoute #}
{% if single_domains | length == 0 %}
{{   required_httproute_domains | mandatory('You must define at least one of gke_domains or gke_domain for HTTPRoute hostnames when ingress is enabled.') }}
{% endif %}
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: {{ gke_app_name }}-route
  namespace: {{ gke_namespace }}
  labels:
    app: {{ gke_app_name }}
    managed-by: ansible
spec:
  parentRefs:
    # Reference the shared Gateway in the default namespace
    - name: {{ gke_app_name }}-gateway
      namespace: default
      sectionName: https
  hostnames:
{% for domain in single_domains %}
    - "{{ domain }}"
{% endfor %}
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        # Reference the single-tenant service
        - name: {{ gke_service_name }}
          port: {{ gke_container_port }}
---
# HTTP to HTTPS redirect route
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: {{ gke_app_name }}-redirect
  namespace: {{ gke_namespace }}
  labels:
    app: {{ gke_app_name }}
    managed-by: ansible
spec:
  parentRefs:
    - name: {{ gke_app_name }}-gateway
      namespace: default
      sectionName: http
  hostnames:
{% for domain in single_domains %}
    - "{{ domain }}"
{% endfor %}
  rules:
    - filters:
        - type: RequestRedirect
          requestRedirect:
            scheme: https
            port: 443
            statusCode: 301

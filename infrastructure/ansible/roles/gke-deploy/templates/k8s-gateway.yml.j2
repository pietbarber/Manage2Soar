# GKE Gateway Configuration
# Generated by Ansible - DO NOT EDIT DIRECTLY
#
# This Gateway acts as the shared entry point for all tenants.
# Like an nginx server block listening on port 443, it accepts
# traffic on a single IP and routes based on hostname.
#
# HTTPRoute resources in each tenant namespace define the
# virtual host routing (like nginx server_name directives).
#
# TLS is handled via Google-managed SSL certificates created with:
#   gcloud compute ssl-certificates create <name> --domains=<domains> --global
# The certificate name is referenced in the pre-shared-certs annotation.
---
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: {{ gke_app_name }}-gateway
  namespace: default
  labels:
    app: {{ gke_app_name }}
    managed-by: ansible
  annotations:
    # Reference the reserved static IP address by name (GKE Gateway resolves the name to the actual IP)
    # If gke_static_ip_name is not set, GKE will auto-assign an ephemeral IP address
{% if gke_static_ip_name is defined and gke_static_ip_name | trim %}
    networking.gke.io/addresses: {{ gke_static_ip_name }}
{% endif %}
spec:
  gatewayClassName: gke-l7-global-external-managed
  listeners:
{% if gke_enable_tls | default(true) | bool %}
    # HTTPS listener - accepts traffic on port 443
    - name: https
      protocol: HTTPS
      port: 443
      tls:
        mode: Terminate
        options:
          # Reference Google-managed SSL certificate created via gcloud
          networking.gke.io/pre-shared-certs: {{ gke_ssl_cert_name | default(gke_app_name ~ '-ssl-cert') }}
      allowedRoutes:
        namespaces:
          from: All  # Allow HTTPRoutes from any namespace
{% endif %}
    # HTTP listener - for redirect to HTTPS
    - name: http
      protocol: HTTP
      port: 80
      allowedRoutes:
        namespaces:
          from: All

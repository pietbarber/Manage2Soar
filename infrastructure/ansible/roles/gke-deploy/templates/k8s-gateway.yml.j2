# GKE Gateway Configuration
# Generated by Ansible - DO NOT EDIT DIRECTLY
#
# This Gateway acts as the shared entry point for all tenants.
# Like an nginx server block listening on port 443, it accepts
# traffic on a single IP and routes based on hostname.
#
# HTTPRoute resources in each tenant namespace define the
# virtual host routing (like nginx server_name directives).
#
# TLS is handled via Google-managed SSL certificates created with:
#   gcloud compute ssl-certificates create <name> --domains=<domains> --global
# The certificate name is referenced in the pre-shared-certs annotation.
---
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: {{ gke_app_name }}-gateway
  namespace: default
  labels:
    app: {{ gke_app_name }}
    managed-by: ansible
  annotations:
    # Reference the reserved static IP address(es) by name (GKE Gateway resolves the name to the actual IP)
    # If gke_static_ip_name is not set, GKE will auto-assign an ephemeral IP address
{% if gke_static_ip_name is defined and gke_static_ip_name | trim %}
{% if gke_enable_ipv6 | default(false) | bool and gke_static_ipv6_name is defined and gke_static_ipv6_name | trim %}
    # Dual-stack: Reference both IPv4 and IPv6 static addresses
    networking.gke.io/addresses: {{ gke_static_ip_name }},{{ gke_static_ipv6_name }}
{% else %}
    # Use only the IPv4 static address. If IPv6 is enabled but gke_static_ipv6_name is
    # empty or undefined, we intentionally fall back to IPv4-only here.
    networking.gke.io/addresses: {{ gke_static_ip_name }}
{% endif %}
{% endif %}
spec:
  gatewayClassName: gke-l7-global-external-managed
  listeners:
{% if gke_enable_tls | default(true) | bool %}
    # HTTPS listener - accepts traffic on port 443
    - name: https
      protocol: HTTPS
      port: 443
      tls:
        mode: Terminate
        options:
          # Reference Google-managed SSL certificate(s) created via gcloud.
          # gke_ssl_cert_annotation may be a comma-separated list during cert
          # rotation (old,new) to preserve HTTPS on existing domains while a
          # new cert provisions. Once the new cert is ACTIVE, run:
          #   ansible-playbook ... --tags cert-cleanup
          networking.gke.io/pre-shared-certs: {{ gke_ssl_cert_annotation | default(gke_ssl_cert_name) | default(gke_app_name ~ '-ssl-cert') }}
      allowedRoutes:
        namespaces:
          from: All  # Allow HTTPRoutes from any namespace
{% endif %}
    # HTTP listener - for redirect to HTTPS
    - name: http
      protocol: HTTP
      port: 80
      allowedRoutes:
        namespaces:
          from: All
{% if gke_multi_tenant | default(false) | bool %}
---
# ReferenceGrants for multi-tenant cross-namespace routing
# Required for HTTPRoutes in tenant namespaces to reference the Gateway in default namespace
# See: https://gateway-api.sigs.k8s.io/api-types/referencegrant/
#
# IMPORTANT: Uses tenant.prefix (e.g., "ssc", "masa") not tenant.name (e.g., "Skyline Soaring Club")
# because Kubernetes resource names must be lowercase alphanumeric with hyphens only.
{% for tenant in gke_tenants %}
apiVersion: gateway.networking.k8s.io/v1beta1
kind: ReferenceGrant
metadata:
  name: allow-{{ tenant.prefix }}-to-gateway
  namespace: default
  labels:
    app: {{ gke_app_name }}
    managed-by: ansible
    tenant: {{ tenant.prefix }}
spec:
  from:
  - group: gateway.networking.k8s.io
    kind: HTTPRoute
    namespace: tenant-{{ tenant.prefix }}
  to:
  - group: gateway.networking.k8s.io
    kind: Gateway
    name: {{ gke_app_name }}-gateway
{% if not loop.last %}
---
{% endif %}
{% endfor %}
{% endif %}

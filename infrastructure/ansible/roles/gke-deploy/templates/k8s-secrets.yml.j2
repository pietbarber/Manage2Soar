# Kubernetes Secrets for Django Application
# Generated by Ansible gke-deploy role
# DO NOT EDIT MANUALLY - managed by Ansible
#
# WARNING: This file contains sensitive data
# It should be deleted after applying to Kubernetes
#
# Tenant: {{ gke_club_prefix | default('default') }}
# Generated: {{ ansible_date_time.iso8601 | default(lookup('pipe', 'date -Iseconds')) }}

{#-
  Build ALLOWED_HOSTS from configured domains when ingress is enabled.
  This supports both 'domain' (string) and 'domains' (list) configurations.
  Falls back to gke_django_allowed_hosts if ingress is disabled.

  NOTE: gke_ingress_ip may be undefined on first deployment because secrets
  are rendered before ingress resources are created. This is acceptable because:
  1. DNS should be configured to point to domain names, not the ingress IP
  2. Health checks use readiness/liveness probes on the Service, not the Gateway IP
  3. Direct IP access is only for troubleshooting and is not required for normal operation

  If at any later point you want to allow direct access via the ingress IP (for
  troubleshooting, etc.), set gke_ingress_ip in your inventory/variables and run
  the standard deployment workflow; the value will then be included in ALLOWED_HOSTS.
  A special two-phase deployment is not required for correct operation.
-#}
{%- set allowed_hosts_list = [] -%}
{%- if gke_enable_ingress | default(false) | bool -%}
  {%- if gke_multi_tenant | default(false) | bool -%}
    {#- Multi-tenant: collect domains from current tenant -#}
    {%- for tenant in gke_tenants -%}
      {%- if tenant.prefix == gke_club_prefix -%}
        {%- set tenant_domains = tenant.domains | default([tenant.domain] if tenant.domain is defined else []) -%}
        {%- for d in tenant_domains -%}
          {%- set _ = allowed_hosts_list.append(d) -%}
        {%- endfor -%}
      {%- endif -%}
    {%- endfor -%}
  {%- else -%}
    {#- Single-tenant: use gke_domains or gke_domain -#}
    {%- set tenant_domains = gke_domains | default([gke_domain] if gke_domain is defined else []) -%}
    {%- for d in tenant_domains -%}
      {%- set _ = allowed_hosts_list.append(d) -%}
    {%- endfor -%}
  {%- endif -%}
  {#- Add localhost and Gateway IP for health checks and troubleshooting -#}
  {%- set _ = allowed_hosts_list.append('localhost') -%}
  {%- set _ = allowed_hosts_list.append('127.0.0.1') -%}
  {%- if gke_ingress_ip is defined and (gke_ingress_ip | trim | length) > 0 -%}
    {%- set _ = allowed_hosts_list.append(gke_ingress_ip) -%}
  {%- endif -%}
{%- endif -%}
{%- set fallback_allowed_hosts = gke_django_allowed_hosts | default('localhost,127.0.0.1', true) -%}
{%- set computed_allowed_hosts = allowed_hosts_list | join(',') if allowed_hosts_list | length > 0 else fallback_allowed_hosts -%}

{#-
  Email Dev Mode: Per-tenant override support

  Priority order:
  1. Per-tenant setting: tenant.email_dev_mode (in gke_tenants list)
  2. Global setting: gke_email_dev_mode

  This allows SSC to be in production mode while MASA is still in dev mode.

  Note: Using namespace to preserve variable values across loop scope (Jinja2 limitation)
-#}
{%- set ns = namespace(email_dev_mode = gke_email_dev_mode | default(false), email_dev_mode_redirect_to = gke_email_dev_mode_redirect_to | default('')) -%}
{%- if gke_multi_tenant | default(false) | bool -%}
  {%- for tenant in gke_tenants -%}
    {%- if tenant.prefix == gke_club_prefix -%}
      {#- Check for per-tenant email_dev_mode override -#}
      {%- if tenant.email_dev_mode is defined -%}
        {%- set ns.email_dev_mode = tenant.email_dev_mode -%}
      {%- endif -%}
      {#- Check for per-tenant email_dev_mode_redirect_to override -#}
      {%- if tenant.email_dev_mode_redirect_to is defined -%}
        {%- set ns.email_dev_mode_redirect_to = tenant.email_dev_mode_redirect_to -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}

---
apiVersion: v1
kind: Secret
metadata:
  name: {{ gke_secret_name }}
  namespace: {{ gke_namespace }}
  labels:
    app: {{ gke_deployment_name }}
{% if gke_multi_tenant %}
    tenant: {{ gke_club_prefix }}
{% endif %}
type: Opaque
stringData:
  # ============================================================
  # DJANGO SETTINGS
  # ============================================================
  DJANGO_DEBUG: "{{ gke_django_debug | string | lower }}"
  DJANGO_SETTINGS_MODULE: "{{ gke_django_settings_module }}"
  DJANGO_ALLOWED_HOSTS: "{{ computed_allowed_hosts }}"
{% if gke_multi_tenant %}
  DJANGO_SECRET_KEY: "{{ lookup('vars', 'vault_django_secret_key_' + gke_club_prefix, default=vault_django_secret_key) }}"
{% else %}
  DJANGO_SECRET_KEY: "{{ vault_django_secret_key }}"
{% endif %}

  # ============================================================
  # SITE URL & CSRF CONFIGURATION
  # ============================================================
  # Site URL used in emails, notifications, and absolute URL generation
  # CSRF_TRUSTED_ORIGINS protects against CSRF attacks from unauthorized domains
  #
  # Issue #536: These must be set for Django to start in production (DEBUG=False)
  # They are built from the tenant's domain configuration
{% if gke_multi_tenant -%}
  {#- Multi-tenant: build SITE_URL from tenant's primary domain -#}
  {%- set ns_site = namespace(site_url='', csrf_origins='') %}
  {%- for tenant in gke_tenants %}
    {%- if tenant.prefix == gke_club_prefix %}
      {#- Support both 'domain' (single) and 'domains' (array) -#}
      {%- if tenant.domain is defined and tenant.domain | length > 0 %}
        {%- set tenant_domain = tenant.domain %}
      {%- elif tenant.domains is defined and tenant.domains | length > 0 %}
        {%- set tenant_domain = tenant.domains[0] %}
      {%- else %}
        {%- set tenant_domain = '' %}
      {%- endif %}
      {%- if tenant_domain | length > 0 %}
        {%- set ns_site.site_url = 'https://' + tenant_domain %}
        {#- For CSRF, join all domains if array, or use single domain -#}
        {%- if tenant.domains is defined and tenant.domains | length > 0 %}
          {%- set ns_site.csrf_origins = (tenant.domains | map('regex_replace', '^', 'https://') | list | join(',')) %}
        {%- else %}
          {%- set ns_site.csrf_origins = 'https://' + tenant_domain %}
        {%- endif %}
      {%- endif %}
    {%- endif %}
  {%- endfor %}
  SITE_URL: "{{ ns_site.site_url }}"
  CSRF_TRUSTED_ORIGINS: "{{ ns_site.csrf_origins }}"
{%- else -%}
  {#- Single-tenant: use configured domain or fallback -#}
  {%- set site_domain = gke_domain | default(gke_app_domain, true) %}
  SITE_URL: "https://{{ site_domain }}"
  CSRF_TRUSTED_ORIGINS: "https://{{ site_domain }}"
{%- endif %}

  # ============================================================
  # COOKIE SECURITY SETTINGS
  # ============================================================
  # SameSite cookie settings (default: Lax)
  # - Lax: cookies sent with same-site requests and top-level navigation (recommended)
  # - Strict: cookies only sent with same-site requests (more restrictive, may break functionality)
  # - None: cookies sent with all requests (requires Secure flag, only for cross-domain scenarios)
  #
  # These settings help prevent CSRF attacks and Safari/iOS cookie issues
  # Override in inventory if needed: gke_session_cookie_samesite, gke_csrf_cookie_samesite
  SESSION_COOKIE_SAMESITE: "{{ gke_session_cookie_samesite | default('Lax') }}"
  CSRF_COOKIE_SAMESITE: "{{ gke_csrf_cookie_samesite | default('Lax') }}"

  # ============================================================
  # DATABASE CONNECTION
  # ============================================================
{% if gke_multi_tenant %}
  DB_NAME: "m2s_{{ gke_club_prefix }}"
  DB_USER: "m2s_{{ gke_club_prefix }}"
  DB_PASSWORD: "{{ lookup('vars', 'vault_postgresql_password_' + gke_club_prefix, default='MISSING_PASSWORD_FOR_' + gke_club_prefix) }}"
{% else %}
  DB_NAME: "{{ gke_db_name }}"
  DB_USER: "{{ gke_db_user }}"
  DB_PASSWORD: "{{ vault_postgresql_password }}"
{% endif %}
  DB_HOST: "{{ gke_db_host }}"
  DB_PORT: "{{ gke_db_port | string }}"
  DB_SSLMODE: "{{ gke_db_sslmode }}"
  DB_CONN_MAX_AGE: "{{ gke_db_conn_max_age | string }}"

  # ============================================================
  # GOOGLE CLOUD STORAGE
  # ============================================================
  GS_BUCKET_NAME: "{{ gke_gcs_bucket }}"
  GS_PROJECT_ID: "{{ gke_gcs_project_id }}"
  GS_DEFAULT_ACL: "{{ gke_gcs_default_acl | default('private') }}"
  CLUB_PREFIX: "{{ gke_club_prefix }}"
  GS_MEDIA_LOCATION: "{{ gke_gcs_media_location }}"
  GS_STATIC_LOCATION: "{{ gke_gcs_static_location }}"
  MEDIA_URL: "{{ gke_media_url }}"
  STATIC_URL: "{{ gke_static_url }}"

  # ============================================================
  # EMAIL CONFIGURATION
  # ============================================================
  EMAIL_BACKEND: "{{ gke_email_backend }}"
  EMAIL_HOST: "{{ gke_email_host }}"
  EMAIL_PORT: "{{ gke_email_port | string }}"
  EMAIL_USE_TLS: "{{ gke_email_use_tls | string | lower }}"
  EMAIL_TIMEOUT: "{{ gke_email_timeout | default(20) | string }}"
  DEFAULT_FROM_EMAIL: "{{ gke_default_from_email }}"
{% if vault_email_host_user is defined %}
  EMAIL_HOST_USER: "{{ vault_email_host_user }}"
  EMAIL_HOST_PASSWORD: "{{ vault_email_host_password }}"
{% endif %}

  # Email Dev Mode - Safety Valve (see issue #350, #457)
  # When true, ALL emails are redirected to EMAIL_DEV_MODE_REDIRECT_TO addresses
  # Supports per-tenant override: set email_dev_mode in tenant config to override global
  EMAIL_DEV_MODE: "{{ ns.email_dev_mode | string | lower }}"
  EMAIL_DEV_MODE_REDIRECT_TO: "{{ ns.email_dev_mode_redirect_to }}"

  # ============================================================
  # GOOGLE OAUTH (if configured)
  # ============================================================
{% if gke_multi_tenant %}
  {#- Multi-tenant: Use per-tenant OAuth2 credentials -#}
  {%- set oauth_client_id_var = 'vault_google_oauth_client_id_' + gke_club_prefix -%}
  {%- set oauth_client_secret_var = 'vault_google_oauth_client_secret_' + gke_club_prefix -%}
  {%- set oauth_client_id = lookup('vars', oauth_client_id_var, default='') -%}
  {%- set oauth_client_secret = lookup('vars', oauth_client_secret_var, default='') -%}
  {%- if oauth_client_id | length > 0 %}
  SOCIAL_AUTH_GOOGLE_OAUTH2_KEY: "{{ oauth_client_id }}"
  SOCIAL_AUTH_GOOGLE_OAUTH2_SECRET: "{{ oauth_client_secret }}"
  {%- endif %}
{% else %}
  {#- Single-tenant: Use global OAuth2 credentials -#}
  {%- if vault_google_oauth_client_id is defined %}
  SOCIAL_AUTH_GOOGLE_OAUTH2_KEY: "{{ vault_google_oauth_client_id }}"
  SOCIAL_AUTH_GOOGLE_OAUTH2_SECRET: "{{ vault_google_oauth_client_secret }}"
  {%- endif %}
{% endif %}

  # ============================================================
  # CLUB-SPECIFIC SETTINGS
  # ============================================================
{% if gke_multi_tenant %}
  CLUB_NAME: "{{ (gke_tenants | selectattr('prefix', 'equalto', gke_club_prefix) | first).name | default(gke_club_prefix) }}"
{% else %}
  CLUB_NAME: "{{ club_name | default('Soaring Club') }}"
{% endif %}

{% if mail_domain is defined %}
  MAIL_DOMAIN: "{{ mail_domain }}"
{% endif %}

  # ============================================================
  # MAIL SERVER API AUTHENTICATION
  # ============================================================
  # API key for mail server to fetch mailing list membership
  # This must match the key configured in the mail server's
  # /opt/m2s-mail-sync/config.yml (m2s_api_key variable)
{% if m2s_api_key is defined %}
  M2S_MAIL_API_KEY: "{{ m2s_api_key }}"
{% endif %}

  # ============================================================
  # ADDITIONAL SETTINGS
  # ============================================================
{% if gke_extra_env is defined %}
{% for key, value in gke_extra_env.items() %}
  {{ key }}: "{{ value }}"
{% endfor %}
{% endif %}

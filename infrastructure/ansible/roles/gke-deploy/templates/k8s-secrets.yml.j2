# Kubernetes Secrets for Django Application
# Generated by Ansible gke-deploy role
# DO NOT EDIT MANUALLY - managed by Ansible
#
# WARNING: This file contains sensitive data
# It should be deleted after applying to Kubernetes
#
# Tenant: {{ gke_club_prefix | default('default') }}
# Generated: {{ ansible_date_time.iso8601 | default(lookup('pipe', 'date -Iseconds')) }}

{#-
  Build ALLOWED_HOSTS from configured domains when ingress is enabled.
  This supports both 'domain' (string) and 'domains' (list) configurations.
  Falls back to gke_django_allowed_hosts if ingress is disabled.

  NOTE: gke_ingress_ip may be undefined on first deployment because secrets
  are rendered before ingress resources are created. This is acceptable because:
  1. DNS should be configured to point to domain names, not the ingress IP
  2. Health checks use readiness/liveness probes on the Service, not the Gateway IP
  3. Direct IP access is only for troubleshooting and is not required for normal operation

  If at any later point you want to allow direct access via the ingress IP (for
  troubleshooting, etc.), set gke_ingress_ip in your inventory/variables and run
  the standard deployment workflow; the value will then be included in ALLOWED_HOSTS.
  A special two-phase deployment is not required for correct operation.
-#}
{%- set allowed_hosts_list = [] -%}
{%- if gke_enable_ingress | default(false) | bool -%}
  {%- if gke_multi_tenant | default(false) | bool -%}
    {#- Multi-tenant: collect domains from current tenant -#}
    {%- for tenant in gke_tenants -%}
      {%- if tenant.prefix == gke_club_prefix -%}
        {%- set tenant_domains = tenant.domains | default([tenant.domain] if tenant.domain is defined else []) -%}
        {%- for d in tenant_domains -%}
          {%- set _ = allowed_hosts_list.append(d) -%}
        {%- endfor -%}
      {%- endif -%}
    {%- endfor -%}
  {%- else -%}
    {#- Single-tenant: use gke_domains or gke_domain -#}
    {%- set tenant_domains = gke_domains | default([gke_domain] if gke_domain is defined else []) -%}
    {%- for d in tenant_domains -%}
      {%- set _ = allowed_hosts_list.append(d) -%}
    {%- endfor -%}
  {%- endif -%}
  {#- Add localhost and Gateway IP for health checks and troubleshooting -#}
  {%- set _ = allowed_hosts_list.append('localhost') -%}
  {%- set _ = allowed_hosts_list.append('127.0.0.1') -%}
  {%- if gke_ingress_ip is defined and (gke_ingress_ip | trim | length) > 0 -%}
    {%- set _ = allowed_hosts_list.append(gke_ingress_ip) -%}
  {%- endif -%}
{%- endif -%}
{%- set fallback_allowed_hosts = gke_django_allowed_hosts | default('localhost,127.0.0.1', true) -%}
{%- set computed_allowed_hosts = allowed_hosts_list | join(',') if allowed_hosts_list | length > 0 else fallback_allowed_hosts -%}

---
apiVersion: v1
kind: Secret
metadata:
  name: {{ gke_secret_name }}
  namespace: {{ gke_namespace }}
  labels:
    app: {{ gke_deployment_name }}
{% if gke_multi_tenant %}
    tenant: {{ gke_club_prefix }}
{% endif %}
type: Opaque
stringData:
  # ============================================================
  # DJANGO SETTINGS
  # ============================================================
  DJANGO_DEBUG: "{{ gke_django_debug | string | lower }}"
  DJANGO_SETTINGS_MODULE: "{{ gke_django_settings_module }}"
  DJANGO_ALLOWED_HOSTS: "{{ computed_allowed_hosts }}"
  DJANGO_SECRET_KEY: "{{ vault_django_secret_key }}"

  # ============================================================
  # DATABASE CONNECTION
  # ============================================================
{% if gke_multi_tenant %}
  DB_NAME: "m2s_{{ gke_club_prefix }}"
  DB_USER: "m2s_{{ gke_club_prefix }}"
  DB_PASSWORD: "{{ lookup('vars', 'vault_postgresql_password_' + gke_club_prefix, default='MISSING_PASSWORD_FOR_' + gke_club_prefix) }}"
{% else %}
  DB_NAME: "{{ gke_db_name }}"
  DB_USER: "{{ gke_db_user }}"
  DB_PASSWORD: "{{ vault_postgresql_password }}"
{% endif %}
  DB_HOST: "{{ gke_db_host }}"
  DB_PORT: "{{ gke_db_port | string }}"
  DB_SSLMODE: "{{ gke_db_sslmode }}"

  # ============================================================
  # GOOGLE CLOUD STORAGE
  # ============================================================
  GS_BUCKET_NAME: "{{ gke_gcs_bucket }}"
  GS_PROJECT_ID: "{{ gke_gcs_project_id }}"
  GS_DEFAULT_ACL: "{{ gke_gcs_default_acl | default('private') }}"
  CLUB_PREFIX: "{{ gke_club_prefix }}"
  GS_MEDIA_LOCATION: "{{ gke_gcs_media_location }}"
  GS_STATIC_LOCATION: "{{ gke_gcs_static_location }}"
  MEDIA_URL: "{{ gke_media_url }}"
  STATIC_URL: "{{ gke_static_url }}"

  # ============================================================
  # EMAIL CONFIGURATION
  # ============================================================
  EMAIL_BACKEND: "{{ gke_email_backend }}"
  EMAIL_HOST: "{{ gke_email_host }}"
  EMAIL_PORT: "{{ gke_email_port | string }}"
  EMAIL_USE_TLS: "{{ gke_email_use_tls | string | lower }}"
  DEFAULT_FROM_EMAIL: "{{ gke_default_from_email }}"
{% if vault_email_host_user is defined %}
  EMAIL_HOST_USER: "{{ vault_email_host_user }}"
  EMAIL_HOST_PASSWORD: "{{ vault_email_host_password }}"
{% endif %}

  # Email Dev Mode - Safety Valve (see issue #350)
  # When true, ALL emails are redirected to EMAIL_DEV_MODE_REDIRECT_TO addresses
  EMAIL_DEV_MODE: "{{ gke_email_dev_mode | string | lower }}"
  EMAIL_DEV_MODE_REDIRECT_TO: "{{ gke_email_dev_mode_redirect_to }}"

  # ============================================================
  # GOOGLE OAUTH (if configured)
  # ============================================================
{% if vault_google_oauth_client_id is defined %}
  GOOGLE_OAUTH_CLIENT_ID: "{{ vault_google_oauth_client_id }}"
  GOOGLE_OAUTH_CLIENT_SECRET: "{{ vault_google_oauth_client_secret }}"
{% endif %}

  # ============================================================
  # CLUB-SPECIFIC SETTINGS
  # ============================================================
{% if gke_multi_tenant %}
  CLUB_NAME: "{{ (gke_tenants | selectattr('prefix', 'equalto', gke_club_prefix) | first).name | default(gke_club_prefix) }}"
{% else %}
  CLUB_NAME: "{{ club_name | default('Soaring Club') }}"
{% endif %}

{% if mail_domain is defined %}
  MAIL_DOMAIN: "{{ mail_domain }}"
{% endif %}

  # ============================================================
  # ADDITIONAL SETTINGS
  # ============================================================
{% if gke_extra_env is defined %}
{% for key, value in gke_extra_env.items() %}
  {{ key }}: "{{ value }}"
{% endfor %}
{% endif %}

# GKE HealthCheckPolicy Configuration (Single-Tenant)
# Generated by Ansible - DO NOT EDIT DIRECTLY
#
# This HealthCheckPolicy tells the GCP load balancer to use /health/ instead of /
# for backend health checks. Without this, GCP sends health probes with the pod IP
# as the Host header, which Django rejects with 400 (pod IP not in ALLOWED_HOSTS),
# causing all backends to be marked UNHEALTHY and serving "no healthy upstream".
#
# The /health/ endpoint returns 200 unconditionally regardless of Host header,
# making it suitable for infrastructure probes.
---
apiVersion: networking.gke.io/v1
kind: HealthCheckPolicy
metadata:
  name: django-health-check
  namespace: {{ gke_namespace }}
  labels:
    app: {{ gke_app_name }}
    managed-by: ansible
spec:
  default:
    checkIntervalSec: 10
    config:
      httpHealthCheck:
        port: {{ gke_container_port }}
        requestPath: /health/
      type: HTTP
    healthyThreshold: 2
    timeoutSec: 5
    unhealthyThreshold: 3
  targetRef:
    group: ""
    kind: Service
    name: {{ gke_service_name }}

---
# Superuser Creation Tasks
#
# Creates Django superuser account using kubectl exec on the Django deployment.
# This ensures superuser creation is idempotent and follows IaC principles.

- name: Check if superuser should be created
  ansible.builtin.set_fact:
    should_create_superuser: "{{ gke_create_superuser | default(false) | bool }}"
  tags: [superuser]

- name: Display superuser creation plan
  ansible.builtin.debug:
    msg: |
      ========================================
      Superuser Creation
      ========================================
      Create: {{ should_create_superuser }}
      Username: {{ django_superuser_username | default('admin') }}
      {% if should_create_superuser %}
      Email: {{ django_superuser_email | default('admin@' + gke_base_domain) }}
      {% endif %}
      ========================================
  when: should_create_superuser
  tags: [superuser]

# NOTE: The password is passed via environment variable in the kubectl exec command.
# The no_log directive prevents Ansible from logging the command.
# Alternative approaches considered but not implemented:
# - Kubernetes Job with secrets: More complex, requires additional RBAC
# - Piping password via stdin: createsuperuser doesn't support stdin password
# The current approach is acceptable for initial deployment as the command is
# executed within the pod context and passwords are vault-managed.
#
# LIMITATION: The changed_when/failed_when conditions parse Django's output messages.
# If Django changes these messages in future versions, these conditions may need updating.
# Current patterns: 'Superuser created successfully', 'already exists'

- name: Create superuser using kubectl exec
  ansible.builtin.command:
    # Using argv to avoid shell injection vulnerabilities from variable interpolation
    argv:
      - kubectl
      - exec
      - -n
      - "{{ gke_namespace }}"
      - "deployment/{{ gke_deployment_name }}"
      - --
      - env
      - "DJANGO_SUPERUSER_USERNAME={{ django_superuser_username }}"
      - "DJANGO_SUPERUSER_EMAIL={{ django_superuser_email | default('admin@' + gke_base_domain) }}"
      - "DJANGO_SUPERUSER_PASSWORD={{ vault_django_superuser_password }}"
      - python
      - manage.py
      - createsuperuser
      - --noinput
  delegate_to: localhost
  run_once: true
  register: superuser_result
  changed_when: "'Superuser created successfully' in superuser_result.stdout"
  failed_when: superuser_result.rc != 0 and 'already exists' not in superuser_result.stdout and 'already exists' not in superuser_result.stderr
  no_log: true
  when: should_create_superuser
  tags: [superuser]

- name: Display superuser creation result
  ansible.builtin.debug:
    msg: |
      {% if 'Superuser created successfully' in superuser_result.stdout %}
      ✓ Superuser created successfully
      {% elif 'already exists' in superuser_result.stdout %}
      ℹ Superuser already exists (no changes made)
      {% else %}
      ⚠ Superuser creation completed with warnings (check logs)
      {% endif %}
  when: should_create_superuser and superuser_result is defined
  tags: [superuser]

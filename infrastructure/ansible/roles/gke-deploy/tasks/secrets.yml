---
# GKE Deploy Role - Kubernetes Secrets Management
#
# Creates/updates Kubernetes secrets from Ansible Vault variables

- name: Generate secrets manifest
  ansible.builtin.template:
    src: k8s-secrets.yml.j2
    dest: "/tmp/k8s-secrets-{{ gke_namespace }}.yml"
    mode: "0600"
  delegate_to: localhost
  run_once: true
  no_log: true

- name: Apply secrets
  ansible.builtin.command:
    cmd: kubectl apply -f /tmp/k8s-secrets-{{ gke_namespace }}.yml
  delegate_to: localhost
  run_once: true
  register: secrets_result
  changed_when: "'configured' in secrets_result.stdout or 'created' in secrets_result.stdout"
  no_log: true

- name: Clean up secrets manifest
  ansible.builtin.file:
    path: "/tmp/k8s-secrets-{{ gke_namespace }}.yml"
    state: absent
  delegate_to: localhost
  run_once: true
  no_log: true

# ============================================================
# CLEANUP: Secrets manifest
# ============================================================
# NOTE: Secrets manifest is always cleaned immediately after creation for security.
# Deployment manifests are cleaned at the end of deploy.yml via gke_keep_manifests flag.

- name: Display secrets status
  ansible.builtin.debug:
    msg: "Kubernetes secrets updated for namespace: {{ gke_namespace }}"
  delegate_to: localhost
  run_once: true

# ============================================================
# GCP SERVICE ACCOUNT SECRET
# ============================================================

- name: Check if GCP service account key file exists
  ansible.builtin.stat:
    path: "{{ gke_gcp_sa_key_file }}"
  register: gcp_sa_key_stat
  delegate_to: localhost
  run_once: true
  when:
    - gke_gcp_sa_key_file is defined
    - gke_gcp_sa_key_file | length > 0

- name: Create or update GCP service account secret from key file
  ansible.builtin.shell:
    cmd: >
      kubectl create secret generic {{ gke_gcp_sa_secret_name }}
      --from-file=gcp-credentials.json={{ gcp_sa_key_stat.stat.path }}
      -n {{ gke_namespace }}
      --dry-run=client -o yaml | kubectl apply -f -
  delegate_to: localhost
  run_once: true
  when:
    - gke_gcp_sa_key_file is defined
    - gke_gcp_sa_key_file | length > 0
    - gcp_sa_key_stat.stat.exists
  no_log: true
  register: gcp_secret_result
  failed_when: false  # Don't fail if secret already exists

- name: Display GCP secret creation status
  ansible.builtin.debug:
    msg: "GCP service account secret: {{ 'updated' if gcp_secret_result.changed else 'already exists' }}"
  when:
    - gke_gcp_sa_key_file is defined
    - gke_gcp_sa_key_file | length > 0
    - gcp_sa_key_stat.stat.exists
  delegate_to: localhost
  run_once: true

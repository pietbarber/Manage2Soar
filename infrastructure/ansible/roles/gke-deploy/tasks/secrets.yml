---
# GKE Deploy Role - Kubernetes Secrets Management
#
# Creates/updates Kubernetes secrets from Ansible Vault variables

- name: Generate secrets manifest
  ansible.builtin.template:
    src: k8s-secrets.yml.j2
    dest: "/tmp/k8s-secrets-{{ gke_namespace }}.yml"
    mode: "0600"
  delegate_to: localhost
  run_once: true
  no_log: true

- name: Apply secrets
  ansible.builtin.command:
    cmd: kubectl apply -f /tmp/k8s-secrets-{{ gke_namespace }}.yml
  delegate_to: localhost
  run_once: true
  register: secrets_result
  changed_when: "'configured' in secrets_result.stdout or 'created' in secrets_result.stdout"
  no_log: true

- name: Clean up secrets manifest
  ansible.builtin.file:
    path: "/tmp/k8s-secrets-{{ gke_namespace }}.yml"
    state: absent
  delegate_to: localhost
  run_once: true
  no_log: true

# ============================================================
# CLEANUP: Secrets manifest
# ============================================================
# NOTE: Secrets manifest is cleaned immediately after creation
# for security. Deployment manifests are cleaned at the end
# of deploy.yml via gke_keep_manifests flag.

- name: Clean up secrets manifest
  ansible.builtin.file:
    path: "/tmp/k8s-secrets-{{ gke_namespace }}.yml"
    state: absent
  delegate_to: localhost
  run_once: true
  when: not (gke_keep_manifests | default(false))

- name: Display secrets status
  ansible.builtin.debug:
    msg: "Kubernetes secrets updated for namespace: {{ gke_namespace }}"
  delegate_to: localhost
  run_once: true

# ============================================================
# GCP SERVICE ACCOUNT SECRET
# ============================================================

- name: Create or update GCP service account secret from key file
  ansible.builtin.shell:
    cmd: >
      kubectl create secret generic {{ gke_gcp_sa_secret_name }}
      --from-file=gcp-credentials.json={{ gke_gcp_sa_key_file }}
      -n {{ gke_namespace }}
      --dry-run=client -o yaml | kubectl apply -f -
  delegate_to: localhost
  run_once: true
  when: gke_gcp_sa_key_file is defined
  no_log: true

---
# GKE Deploy Role - Kubernetes Secrets Management
#
# Creates/updates Kubernetes secrets from Ansible Vault variables

- name: Generate secrets manifest
  ansible.builtin.template:
    src: k8s-secrets.yml.j2
    dest: "/tmp/k8s-secrets-{{ gke_namespace }}.yml"
    mode: "0600"
  delegate_to: localhost
  run_once: true
  no_log: true

- name: Apply secrets
  ansible.builtin.command:
    cmd: kubectl apply -f /tmp/k8s-secrets-{{ gke_namespace }}.yml
  delegate_to: localhost
  run_once: true
  register: secrets_result
  changed_when: "'configured' in secrets_result.stdout or 'created' in secrets_result.stdout"
  no_log: true

- name: Clean up secrets manifest
  ansible.builtin.file:
    path: "/tmp/k8s-secrets-{{ gke_namespace }}.yml"
    state: absent
  delegate_to: localhost
  run_once: true
  no_log: true

- name: Display secrets status
  ansible.builtin.debug:
    msg: "Kubernetes secrets updated for namespace: {{ gke_namespace }}"
  delegate_to: localhost
  run_once: true

# ============================================================
# GCP SERVICE ACCOUNT SECRET
# ============================================================

- name: Check if GCP SA secret exists
  ansible.builtin.command:
    cmd: kubectl get secret {{ gke_gcp_sa_secret_name }} -n {{ gke_namespace }}
  delegate_to: localhost
  run_once: true
  register: gcp_sa_check
  failed_when: false
  changed_when: false

- name: Create GCP SA secret from file
  ansible.builtin.command:
    cmd: >
      kubectl create secret generic {{ gke_gcp_sa_secret_name }}
      --from-file=gcp-credentials.json={{ gke_gcp_sa_key_file }}
      -n {{ gke_namespace }}
  delegate_to: localhost
  run_once: true
  when:
    - gcp_sa_check.rc != 0
    - gke_gcp_sa_key_file is defined
  no_log: true

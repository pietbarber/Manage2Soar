# GKE Gateway API Deployment Tasks
#
# This file handles:
# - Static IP reservation
# - Google-managed SSL certificate creation
# - Gateway resource deployment (single shared gateway)
# - HTTPRoute deployment per tenant
# - Verification and DNS instructions
#
# Architecture:
# - One Gateway in 'default' namespace with static IP
# - HTTPRoute per tenant in their respective namespaces
# - Like nginx: single IP, host-based routing to different backends
---
# ============================================================
# STATIC IP RESERVATION
# ============================================================

- name: Check if static IP exists
  ansible.builtin.command:
    cmd: >
      gcloud compute addresses describe {{ gke_static_ip_name }}
      --global
      --project={{ gcp_project }}
      --format="value(address)"
  register: static_ip_check
  failed_when: false
  changed_when: false
  delegate_to: localhost
  run_once: true
  tags: [ingress, ip]

- name: Reserve global static IP
  ansible.builtin.command:
    cmd: >
      gcloud compute addresses create {{ gke_static_ip_name }}
      --global
      --project={{ gcp_project }}
  register: static_ip_create
  when: static_ip_check.rc != 0
  changed_when: static_ip_create.rc == 0
  delegate_to: localhost
  run_once: true
  tags: [ingress, ip]

- name: Get static IP address
  ansible.builtin.command:
    cmd: >
      gcloud compute addresses describe {{ gke_static_ip_name }}
      --global
      --project={{ gcp_project }}
      --format="value(address)"
  register: static_ip_address
  changed_when: false
  delegate_to: localhost
  run_once: true
  tags: [ingress, ip]

- name: Set static IP fact
  ansible.builtin.set_fact:
    gke_ingress_ip: "{{ static_ip_address.stdout | trim }}"
  run_once: true
  tags: [ingress, ip]

# ============================================================
# GOOGLE-MANAGED SSL CERTIFICATE (via gcloud, not ManagedCertificate CRD)
#
# Gateway API does NOT support ManagedCertificate CRD.
# We must use gcloud compute ssl-certificates instead.
# ============================================================

- name: Set SSL certificate name
  ansible.builtin.set_fact:
    gke_ssl_cert_name: "{{ gke_ssl_cert_name | default(gke_app_name ~ '-ssl-cert') }}"
  run_once: true
  when: gke_enable_tls | default(true) | bool
  tags: [ingress, tls]

- name: Collect all domains for SSL certificate
  ansible.builtin.set_fact:
    ssl_cert_domains: >-
      {%- set domains = [] -%}
      {%- for tenant in gke_tenants -%}
        {%- set tenant_domains = tenant.domains | default([tenant.domain] if tenant.domain is defined else []) -%}
        {%- for d in tenant_domains -%}
          {%- set _ = domains.append(d) -%}
        {%- endfor -%}
      {%- endfor -%}
      {{ domains | unique | join(',') }}
  run_once: true
  when:
    - gke_enable_tls | default(true) | bool
    - gke_multi_tenant | bool
  tags: [ingress, tls]

- name: Check if SSL certificate exists
  ansible.builtin.shell: |
    gcloud compute ssl-certificates describe {{ gke_ssl_cert_name }} \
      --global \
      --project={{ gcp_project }} \
      --format="value(name)" 2>/dev/null || echo ""
  register: ssl_cert_check
  changed_when: false
  delegate_to: localhost
  run_once: true
  when: gke_enable_tls | default(true) | bool
  tags: [ingress, tls]

- name: Display SSL certificate status
  ansible.builtin.debug:
    msg: "SSL certificate '{{ gke_ssl_cert_name }}' {{ 'exists' if ssl_cert_check.stdout | trim else 'does not exist - will be created' }}"
  run_once: true
  when: gke_enable_tls | default(true) | bool
  tags: [ingress, tls]

- name: Create Google-managed SSL certificate
  ansible.builtin.command:
    cmd: >-
      gcloud compute ssl-certificates create {{ gke_ssl_cert_name }}
      --domains={{ ssl_cert_domains }}
      --global
      --project={{ gcp_project }}
  register: ssl_cert_create
  changed_when: "'Created' in ssl_cert_create.stderr"
  delegate_to: localhost
  run_once: true
  when:
    - gke_enable_tls | default(true) | bool
    - ssl_cert_check.stdout | trim == ""
  tags: [ingress, tls]

- name: Display SSL certificate creation result
  ansible.builtin.debug:
    msg: "{{ ssl_cert_create.stderr_lines | default(['Certificate already exists']) }}"
  when:
    - gke_enable_tls | default(true) | bool
    - ssl_cert_create is defined
  run_once: true
  tags: [ingress, tls]

# ============================================================
# GATEWAY DEPLOYMENT (Single shared gateway)
# ============================================================

- name: Generate Gateway manifest
  ansible.builtin.template:
    src: k8s-gateway.yml.j2
    dest: "/tmp/k8s-gateway.yml"
    mode: "0600"
  delegate_to: localhost
  run_once: true
  tags: [ingress, gateway]

- name: Apply Gateway configuration
  ansible.builtin.command:
    cmd: kubectl apply -f /tmp/k8s-gateway.yml
  register: gateway_result
  changed_when: "'created' in gateway_result.stdout or 'configured' in gateway_result.stdout"
  delegate_to: localhost
  run_once: true
  tags: [ingress, gateway]

- name: Display Gateway result
  ansible.builtin.debug:
    msg: "{{ gateway_result.stdout_lines }}"
  when: gateway_result is defined
  run_once: true
  tags: [ingress, gateway]

- name: Clean up Gateway manifest
  ansible.builtin.file:
    path: "/tmp/k8s-gateway.yml"
    state: absent
  delegate_to: localhost
  run_once: true
  when: not (gke_keep_manifests | default(false))
  tags: [ingress, gateway]

# ============================================================
# HTTPROUTE DEPLOYMENT (Per-tenant routes)
# ============================================================

- name: Generate HTTPRoute manifest for tenant
  ansible.builtin.template:
    src: k8s-httproute.yml.j2
    dest: "/tmp/k8s-httproute-{{ ingress_tenant.prefix }}.yml"
    mode: "0600"
  delegate_to: localhost
  loop: "{{ gke_tenants }}"
  loop_control:
    loop_var: ingress_tenant
  when: gke_multi_tenant | bool
  tags: [ingress, httproute]

- name: Apply HTTPRoute configuration for tenant
  ansible.builtin.command:
    cmd: kubectl apply -f /tmp/k8s-httproute-{{ ingress_tenant.prefix }}.yml
  register: httproute_result
  changed_when: "'created' in httproute_result.stdout or 'configured' in httproute_result.stdout"
  delegate_to: localhost
  loop: "{{ gke_tenants }}"
  loop_control:
    loop_var: ingress_tenant
  when: gke_multi_tenant | bool
  tags: [ingress, httproute]

- name: Display HTTPRoute results
  ansible.builtin.debug:
    msg: "{{ item.stdout_lines }}"
  loop: "{{ httproute_result.results | default([]) }}"
  when:
    - gke_multi_tenant | bool
    - item.stdout_lines is defined
  tags: [ingress, httproute]

- name: Clean up HTTPRoute manifests
  ansible.builtin.file:
    path: "/tmp/k8s-httproute-{{ ingress_tenant.prefix }}.yml"
    state: absent
  delegate_to: localhost
  loop: "{{ gke_tenants }}"
  loop_control:
    loop_var: ingress_tenant
  when:
    - gke_multi_tenant | bool
    - not (gke_keep_manifests | default(false))
  tags: [ingress, httproute]

# ============================================================
# VERIFICATION
# ============================================================

- name: Wait for Gateway to be ready
  ansible.builtin.command:
    cmd: kubectl get gateway {{ gke_app_name }}-gateway -n default -o jsonpath='{.status.conditions[?(@.type=="Programmed")].status}'
  register: gateway_ready
  until: gateway_ready.stdout == "True"
  retries: 30
  delay: 10
  changed_when: false
  failed_when: false
  delegate_to: localhost
  run_once: true
  tags: [ingress, verify]

- name: Get Gateway IP address
  ansible.builtin.command:
    cmd: kubectl get gateway {{ gke_app_name }}-gateway -n default -o jsonpath='{.status.addresses[0].value}'
  register: gateway_ip
  changed_when: false
  failed_when: false
  delegate_to: localhost
  run_once: true
  tags: [ingress, verify]

- name: Update ingress IP from Gateway status
  ansible.builtin.set_fact:
    gke_ingress_ip: "{{ gateway_ip.stdout | trim | default(gke_ingress_ip, true) }}"
  run_once: true
  when: gateway_ip.stdout | trim | length > 0
  tags: [ingress, verify]

- name: Get Gateway status
  ansible.builtin.command:
    cmd: kubectl get gateway {{ gke_app_name }}-gateway -n default -o wide
  register: gateway_status
  changed_when: false
  failed_when: false
  delegate_to: localhost
  run_once: true
  tags: [ingress, verify]

- name: Get HTTPRoute status
  ansible.builtin.command:
    cmd: kubectl get httproute -A -o wide
  register: httproute_status
  changed_when: false
  failed_when: false
  delegate_to: localhost
  run_once: true
  tags: [ingress, verify]

- name: Get SSL certificate status
  ansible.builtin.shell: |
    gcloud compute ssl-certificates describe {{ gke_ssl_cert_name }} \
      --global \
      --project={{ gcp_project }} \
      --format="table(name,type,managed.status,managed.domainStatus)"
  register: cert_status
  changed_when: false
  failed_when: false
  delegate_to: localhost
  run_once: true
  when: gke_enable_tls | default(true) | bool
  tags: [ingress, verify]

- name: Collect all configured domains
  ansible.builtin.set_fact:
    all_domains: >-
      {%- set domains = [] -%}
      {%- for tenant in gke_tenants -%}
        {%- set tenant_domains = tenant.domains | default([tenant.domain] if tenant.domain is defined else []) -%}
        {%- for d in tenant_domains -%}
          {%- set _ = domains.append(d) -%}
        {%- endfor -%}
      {%- endfor -%}
      {{ domains | unique | list }}
  run_once: true
  tags: [ingress, verify]

- name: Display Gateway configuration summary
  ansible.builtin.debug:
    msg: |
      ========================================
      Gateway API Deployed Successfully!
      ========================================

      Static IP: {{ gke_ingress_ip }}
      GatewayClass: gke-l7-global-external-managed

      Gateway Status:
      {{ gateway_status.stdout | default('Gateway not found') }}

      HTTPRoute Status:
      {{ httproute_status.stdout | default('No HTTPRoutes found') }}

      {% if gke_enable_tls | default(true) | bool %}
      Certificate Status:
      {{ cert_status.stdout | default('Certificate not found') }}
      {% endif %}

      ========================================
      DNS CONFIGURATION REQUIRED
      ========================================

      Add the following DNS A records pointing to {{ gke_ingress_ip }}:

      {% for domain in all_domains %}
        {{ domain }} â†’ {{ gke_ingress_ip }}
      {% endfor %}

      ========================================
      CERTIFICATE PROVISIONING
      ========================================
      {% if gke_enable_tls | default(true) | bool %}
      Google-managed SSL certificate will be automatically provisioned
      once DNS records are configured and propagated.

      This typically takes 10-15 minutes after DNS is set up.

      Check status:
        kubectl get gateway -n default
        kubectl get httproute -A
        gcloud compute ssl-certificates describe {{ gke_ssl_cert_name }} --global

      Certificate states:
        - PROVISIONING: DNS not yet verified or certificate being issued
        - ACTIVE: Certificate is ready and serving HTTPS traffic
        - FAILED_NOT_VISIBLE: DNS verification failed
      {% else %}
      TLS is disabled. Traffic will be HTTP only.
      {% endif %}

      ========================================
  run_once: true
  tags: [ingress, verify]

---
# GKE Deploy Role - Default Variables
#
# These can be overridden in group_vars/gcp_app/vars.yml

# ============================================================
# CONTAINER REGISTRY
# ============================================================

# GCP project for Container Registry
gke_gcr_project: "{{ gcp_project }}"

# Docker image name (without tag)
gke_image_name: "gcr.io/{{ gke_gcr_project }}/{{ gke_app_name | default('manage2soar') }}"

# Image tag (auto-generated if not specified)
# Options: auto, timestamp, git, git-tag, or a manual version string
gke_image_tag_type: "auto"

# Manual image tag (overrides gke_image_tag_type if set)
# gke_image_tag: "v1.2.3"

# ============================================================
# KUBERNETES CLUSTER
# ============================================================

# GKE cluster name
gke_cluster_name: "manage2soar-cluster"

# GKE cluster zone
gke_cluster_zone: "{{ gcp_zone | default('us-central1-c') }}"

# Kubernetes namespace (per-tenant in multi-tenant mode)
gke_namespace: "default"

# Deployment name
gke_deployment_name: "django-app"

# Service name
gke_service_name: "django-app"

# Number of replicas
gke_replicas: 2

# ============================================================
# CONTAINER RESOURCES
# ============================================================

# CPU requests and limits (tune per workload; these are safe defaults for Django)
gke_cpu_request: "250m"
gke_cpu_limit: "500m"

# Memory requests and limits (Django typically needs 512Mi–1Gi under load)
gke_memory_request: "512Mi"
gke_memory_limit: "1Gi"

# Container port
gke_container_port: 8000

# ============================================================
# APPLICATION CONFIGURATION
# ============================================================

# Application name
gke_app_name: "manage2soar"

# Django settings module
gke_django_settings_module: "manage2soar.settings"

# Django debug mode (NEVER true in production)
gke_django_debug: false

# Allowed hosts (comma-separated, e.g. "example.com,www.example.com")
# IMPORTANT: Do NOT use "*" in production. This placeholder value MUST be overridden
# in real deployments with the actual public hostnames used by ingress. Leaving this
# as-is will cause Django to only accept "CONFIGURE_ALLOWED_HOSTS" as a valid host.
gke_django_allowed_hosts: "CONFIGURE_ALLOWED_HOSTS"

# ============================================================
# DATABASE CONNECTION
# ============================================================

# Database host (internal GCP IP recommended)
# BREAKING CHANGE: Previous default was 10.128.0.2 (GCP default network internal IP).
# New default uses RFC 5737 documentation IP (192.0.2.1) to force explicit configuration.
# All real deployments MUST override this via `postgresql_host` in inventory/group_vars.
gke_db_host: "{{ postgresql_host | default('192.0.2.1') }}"

# Database port
gke_db_port: "{{ postgresql_port | default(5432) }}"

# Database name (uses tenant prefix in multi-tenant mode)
gke_db_name: "{{ postgresql_db | default('m2s') }}"

# Database user (uses tenant prefix in multi-tenant mode)
gke_db_user: "{{ postgresql_user | default('m2s') }}"

# Database SSL mode
gke_db_sslmode: "{{ 'require' if (postgresql_ssl_enabled | default(false)) else 'prefer' }}"

# Database connection max age (seconds)
# Enables Django's persistent connections to reduce connection overhead.
# 0 = new connection per request (default Django behavior)
# 300 = reuse connections for 5 minutes (recommended for production)
# 600 = reuse connections for 10 minutes (aggressive pooling)
# None = infinite lifetime (use with caution, can lead to stale connections)
gke_db_conn_max_age: "{{ postgresql_conn_max_age | default(300) }}"

# ============================================================
# GOOGLE CLOUD STORAGE
# ============================================================

# GCS bucket name
gke_gcs_bucket: "{{ gcp_project }}"

# GCS project ID
gke_gcs_project_id: "{{ gcp_project }}"

# GCS default ACL (private or publicRead)
# SECURITY: Keep this as 'private' for ANY user-uploaded or potentially sensitive media.
# Only use 'publicRead' for non-user static assets (e.g. CSS, JS, logos) that are intended
# to be world-readable. NEVER use 'publicRead' for user-uploaded media files.
gke_gcs_default_acl: "private"

# Club prefix for media/static paths
gke_club_prefix: "{{ club_prefix | default('club') }}"

# Media and static locations
gke_gcs_media_location: "{{ gke_club_prefix }}/media"
gke_gcs_static_location: "{{ gke_club_prefix }}/static"

# Public URLs
gke_media_url: "https://storage.googleapis.com/{{ gke_gcs_bucket }}/{{ gke_gcs_media_location }}/"
gke_static_url: "https://storage.googleapis.com/{{ gke_gcs_bucket }}/{{ gke_gcs_static_location }}/"

# ============================================================
# EMAIL CONFIGURATION
# ============================================================

# Email backend
gke_email_backend: "django.core.mail.backends.smtp.EmailBackend"

# SMTP settings
gke_email_host: "{{ mail_host | default('localhost') }}"
gke_email_port: "{{ mail_port | default(587) }}"
gke_email_use_tls: true

# Default from address
gke_default_from_email: "noreply@{{ mail_domain | default('example.com') }}"

# Email Dev Mode - SAFETY VALVE for testing/staging environments
# When enabled, ALL outgoing emails are redirected to test addresses
# CRITICAL: Set to false for production deployments
# See issues #350 and #457 for implementation details
#
# MULTI-TENANT: Per-tenant override is supported. Add email_dev_mode and
# email_dev_mode_redirect_to to individual tenant configs in gke_tenants:
#
#   gke_tenants:
#     - prefix: "ssc"
#       name: "Skyline Soaring Club"
#       # Uses global gke_email_dev_mode (production ready)
#
#     - prefix: "masa"
#       name: "Mid-Atlantic Soaring Association"
#       email_dev_mode: true  # Override: MASA still in dev mode
#       email_dev_mode_redirect_to: "masa-test@example.com"
#
gke_email_dev_mode: false

# Comma-separated list of email addresses to receive ALL emails when dev mode is enabled
# Only used when gke_email_dev_mode is true (or per-tenant email_dev_mode is true)
# Example: "test1@example.com,test2@example.com"
gke_email_dev_mode_redirect_to: ""

# ============================================================
# SECRETS MANAGEMENT
# ============================================================

# Kubernetes secret name for environment variables
gke_secret_name: "{{ gke_app_name }}-env"

# Kubernetes secret name for GCP service account
gke_gcp_sa_secret_name: "gcp-sa-key"

# Local path to GCP service account JSON key file (required for secrets task)
# This file is used to create the Kubernetes secret containing GCP credentials.
# The file must exist locally and be accessible by Ansible during deployment.
# Override in group_vars with a relative path from playbook_dir, e.g.:
#   gke_gcp_sa_key_file: "{{ playbook_dir }}/../../../your-key.json"
# NOTE: playbook_dir = infrastructure/ansible/playbooks/, so ../../.. = project root
gke_gcp_sa_key_file: ""

# Path to GCP service account key in container
gke_gcp_credentials_path: "/app/gcp-credentials.json"

# Filename of GCP credentials within the secret (for backward compatibility)
# Override this if migrating from existing deployments using different filenames
gke_gcp_credentials_filename: "gcp-credentials.json"

# ============================================================
# MULTI-TENANT CONFIGURATION
# ============================================================

# Enable multi-tenant deployment
gke_multi_tenant: "{{ postgresql_multi_tenant | default(false) }}"

# List of tenants (from postgresql_tenants or gke_tenants)
gke_tenants: "{{ postgresql_tenants | default([]) }}"

# ============================================================
# DEPLOYMENT OPTIONS
# ============================================================

# Build Docker image locally
gke_build_image: true

# Push image to registry
gke_push_image: true

# Apply Kubernetes configurations
gke_apply_config: true

# Wait for rollout to complete
gke_wait_for_rollout: true

# Rollout timeout (seconds)
gke_rollout_timeout: 600  # 10 minutes - increased from 5 to handle slow startups and image pulls

# Run database migrations
gke_run_migrations: false

# Collect static files to GCS after deployment.
# Enabled by default — skipping this causes missing CSS/JS on the site if new static files were added.
# The cost and time overhead is minimal (~10s); the risk of skipping is a broken site.
gke_collect_static: true

# Keep generated manifest files for debugging (default: clean up after deployment)
gke_keep_manifests: false

# Docker build context directory (relative to playbook or absolute path)
gke_docker_context: "."

# ============================================================
# GATEWAY API / INGRESS CONFIGURATION
# ============================================================

# Enable Gateway API deployment for external access
# Uses GKE's Gateway API (successor to Ingress) for host-based routing
# Single IP serves all tenants with routing based on hostname
gke_enable_ingress: false

# Static IP name for Gateway (will be created if doesn't exist)
gke_static_ip_name: "{{ gke_cluster_name }}-ingress-ip"

# Enable IPv6 for Gateway/Ingress
# When true, reserves both IPv4 and IPv6 global static IPs
# Requires GKE cluster with IPv6 enabled (--stack-type=IPV4_IPV6)
gke_enable_ipv6: false

# Static IPv6 IP name for Gateway (only used when gke_enable_ipv6 is true)
gke_static_ipv6_name: "{{ gke_cluster_name }}-ingress-ipv6"

# Enable TLS/HTTPS using Google-managed certificates
# Google-managed certs are free, automatic, and don't require cert-manager
gke_enable_tls: true

# SSL certificate (Google-managed Certificate) resource name
# Defaults to {{ gke_app_name }}-ssl-cert computed at runtime
# Override this if you need a custom certificate name
gke_ssl_cert_name: "{{ gke_app_name }}-ssl-cert"

# ============================================================
# CRONJOB CONFIGURATION
# ============================================================

# Enable CronJob deployment
gke_deploy_cronjobs: true

# CronJob image (defaults to same as deployment)
gke_cronjob_image: "{{ gke_image_name }}:{{ gke_computed_image_tag }}"

# ============================================================
# SUPERUSER CONFIGURATION
# ============================================================

# Enable automatic superuser creation
# When true, creates a Django superuser account on first deployment
# Safe to run multiple times - will skip if user already exists
gke_create_superuser: false

# Superuser credentials (MUST be defined in vault/inventory when enabled)
# django_superuser_username: "admin"
# django_superuser_email: "admin@example.com"  # Optional, defaults to admin@{{ gke_base_domain }}
# vault_django_superuser_password: Must be defined in vault.yml (NEVER in plain text)
# ============================================================
# PRE-DEPLOYMENT VALIDATION (Issue #529)
# ============================================================
# These controls enable/disable pre-deployment configuration checks.
# All validations are enabled by default for safety.

# Enable/disable all email configuration validation
# When true, validates that email_dev_mode is properly set for the environment
gke_validate_email_config: true

# Enable/disable security validations (DEBUG mode, ALLOWED_HOSTS)
gke_validate_security: true

# Environment type (production, staging, development)
# Validation rules are stricter for production
gke_environment: "production"

# PostgreSQL Multi-Tenant Database/User Creation Tasks
# Called in a loop for each tenant
---
- name: "Create database user for tenant: {{ tenant.prefix }}"
  community.postgresql.postgresql_user:
    name: "m2s_{{ tenant.prefix }}"
    password: "{{ tenant.password }}"
    role_attr_flags: "NOSUPERUSER,NOCREATEDB"
    state: present
  become: true
  become_user: postgres
  no_log: true

- name: "Create database for tenant: {{ tenant.prefix }}"
  community.postgresql.postgresql_db:
    name: "m2s_{{ tenant.prefix }}"
    owner: "m2s_{{ tenant.prefix }}"
    encoding: UTF8
    lc_collate: "{{ postgresql_locale }}"
    lc_ctype: "{{ postgresql_locale }}"
    template: template0
    state: present
  become: true
  become_user: postgres

- name: "Grant privileges to tenant user: {{ tenant.prefix }}"
  community.postgresql.postgresql_privs:
    db: "m2s_{{ tenant.prefix }}"
    privs: ALL
    type: database
    role: "m2s_{{ tenant.prefix }}"
    state: present
  become: true
  become_user: postgres

- name: "Display tenant database info: {{ tenant.prefix }}"
  ansible.builtin.debug:
    msg: |
      ----------------------------------------
      Tenant: {{ tenant.name }}
      Database: m2s_{{ tenant.prefix }}
      User: m2s_{{ tenant.prefix }}
      ----------------------------------------

# PostgreSQL Backup Configuration
---
- name: Create backup directory
  ansible.builtin.file:
    path: "{{ postgresql_backup_dir }}"
    state: directory
    owner: postgres
    group: postgres
    mode: "0750"
  become: true

- name: Create daily backup subdirectory
  ansible.builtin.file:
    path: "{{ postgresql_backup_dir }}/daily"
    state: directory
    owner: postgres
    group: postgres
    mode: "0750"
  become: true

- name: Install google-cloud-sdk (for GCS backup uploads)
  block:
    - name: Download Google Cloud SDK APT key
      ansible.builtin.get_url:
        url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
        dest: /usr/share/keyrings/google-cloud-sdk-archive-keyring.gpg
        mode: "0644"

    - name: Add Google Cloud SDK repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/google-cloud-sdk-archive-keyring.gpg] https://packages.cloud.google.com/apt cloud-sdk main"
        state: present
        filename: google-cloud-sdk

    - name: Install google-cloud-sdk package
      ansible.builtin.apt:
        name: google-cloud-sdk
        state: present
        update_cache: true
  become: true
  when: postgresql_backup_gcs_enabled | default(false)

- name: Validate GCS bucket configuration
  ansible.builtin.assert:
    that:
      - postgresql_backup_gcs_bucket is defined
      - postgresql_backup_gcs_bucket | length > 0
    fail_msg: "GCS backup enabled but postgresql_backup_gcs_bucket is not set. Please configure the bucket name."
    success_msg: "GCS backup bucket configured: {{ postgresql_backup_gcs_bucket }}"
  when: postgresql_backup_gcs_enabled | default(false)

- name: Validate encryption passphrase length
  ansible.builtin.assert:
    that:
      - vault_postgresql_backup_passphrase | length >= 64
    fail_msg: "Encryption passphrase must be at least 64 characters. Current length: {{ vault_postgresql_backup_passphrase | length }}"
    success_msg: "Encryption passphrase meets minimum length requirement (64+ characters)"
  when:
    - postgresql_backup_encryption_enabled | default(false)
    - vault_postgresql_backup_passphrase is defined

- name: Deploy backup encryption passphrase
  ansible.builtin.copy:
    content: "{{ vault_postgresql_backup_passphrase }}"
    dest: /var/lib/postgresql/.backup_passphrase
    owner: postgres
    group: postgres
    mode: "0400"
  become: true
  no_log: true
  when:
    - postgresql_backup_encryption_enabled | default(true)
    - vault_postgresql_backup_passphrase is defined

- name: Verify passphrase file exists (encryption check)
  ansible.builtin.stat:
    path: /var/lib/postgresql/.backup_passphrase
  register: passphrase_file_check
  become: true
  when: postgresql_backup_encryption_enabled | default(true)

- name: Assert passphrase file exists when encryption enabled
  ansible.builtin.assert:
    that:
      - vault_postgresql_backup_passphrase is defined
      - passphrase_file_check.stat.exists
      - passphrase_file_check.stat.mode == '0400'
    fail_msg: "Encryption enabled but passphrase file not found, misconfigured, or has incorrect permissions. Set vault_postgresql_backup_passphrase in Ansible Vault."
    success_msg: "Backup encryption passphrase deployed correctly"
  when:
    - postgresql_backup_encryption_enabled | default(true)
    - passphrase_file_check is defined

- name: Deploy backup script
  ansible.builtin.template:
    src: backup.sh.j2
    dest: "/usr/local/bin/m2s-pg-backup.sh"
    owner: root
    group: root
    mode: "0750"
  become: true

- name: Create backup cron job
  ansible.builtin.cron:
    name: "M2S PostgreSQL daily backup"
    user: postgres
    hour: "{{ postgresql_backup_hour }}"
    minute: "{{ postgresql_backup_minute }}"
    job: "/usr/local/bin/m2s-pg-backup.sh >> /var/log/m2s-pg-backup.log 2>&1"
    state: present
  become: true

- name: Create backup log file
  ansible.builtin.file:
    path: /var/log/m2s-pg-backup.log
    state: touch
    owner: postgres
    group: postgres
    mode: "0640"
  become: true
  changed_when: false

- name: Configure logrotate for backup logs
  ansible.builtin.template:
    src: backup-logrotate.j2
    dest: /etc/logrotate.d/m2s-pg-backup
    owner: root
    group: root
    mode: "0644"
  become: true

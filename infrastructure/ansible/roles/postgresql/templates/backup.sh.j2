#!/bin/bash
# M2S PostgreSQL Backup Script
# Managed by Ansible - do not edit manually

set -euo pipefail

# Configuration
BACKUP_DIR="{{ postgresql_backup_dir }}/daily"
DB_NAME="{{ postgresql_db }}"
RETENTION_DAYS="{{ postgresql_backup_retention_days }}"
DATE=$(date +%Y-%m-%d_%H%M%S)
BACKUP_FILE="${BACKUP_DIR}/${DB_NAME}_${DATE}.pgdump"

echo "$(date '+%Y-%m-%d %H:%M:%S') - Starting backup of ${DB_NAME}"

# Create backup using pg_dump with custom format (already compressed)
pg_dump -U {{ postgresql_user }} -h localhost -Fc "${DB_NAME}" > "${BACKUP_FILE}"

# Verify backup was created and has content
if [[ -s "${BACKUP_FILE}" ]]; then
    BACKUP_SIZE=$(du -h "${BACKUP_FILE}" | cut -f1)
    echo "$(date '+%Y-%m-%d %H:%M:%S') - Backup completed: ${BACKUP_FILE} (${BACKUP_SIZE})"
else
    echo "$(date '+%Y-%m-%d %H:%M:%S') - ERROR: Backup file is empty or was not created"
    exit 1
fi

# Create latest symlink
ln -sf "${BACKUP_FILE}" "${BACKUP_DIR}/${DB_NAME}_latest.pgdump"

# Remove old backups
echo "$(date '+%Y-%m-%d %H:%M:%S') - Removing backups older than ${RETENTION_DAYS} days"
find "${BACKUP_DIR}" -name "${DB_NAME}_*.pgdump" -type f -mtime +${RETENTION_DAYS} -delete

# Count remaining backups
BACKUP_COUNT=$(find "${BACKUP_DIR}" -name "${DB_NAME}_*.pgdump" -type f | wc -l)
echo "$(date '+%Y-%m-%d %H:%M:%S') - Backup complete. ${BACKUP_COUNT} backups retained."

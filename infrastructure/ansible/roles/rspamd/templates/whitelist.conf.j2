# ============================================================
# Sender Whitelist - Generated by Ansible
# ============================================================
# Per-club whitelists for multi-tenant isolation.
# Each club has its own whitelist map file that only applies
# when the recipient is in that club's domain.
#
# This prevents a malicious club admin from whitelisting spammers
# that could affect other clubs.
#
# Whitelist files are synced from M2S API by m2s-sync-aliases.py

rules {
{% for club in club_domains %}
  M2S_{{ club.prefix | upper }}_WHITELIST {
    valid_dkim = false;
    # Only whitelist if SPF passes (prevents spoofing via SPF validation)
    valid_spf = true;
    domains = false;
    from = true;
    prefilter = true;
    action = "no action";
    map = "file:///etc/rspamd/local.d/whitelists/{{ club.prefix }}_whitelist.map";
    # Only apply to mail destined for this club's domain
    rcpt = "/.*@{{ club.prefix }}\.{{ mail_domain | replace('.', '\\.') }}$/";
    description = "{{ club.name }} member whitelist - bypass spam checks (requires SPF pass)";
  }
{% endfor %}
}

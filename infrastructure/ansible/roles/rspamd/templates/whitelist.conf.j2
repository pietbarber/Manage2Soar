# ============================================================
# Sender Whitelist - Generated by Ansible
# ============================================================
# Per-club whitelists for multi-tenant isolation.
# Each club has its own whitelist map file that only applies
# when the recipient is in that club's domain.
#
# This prevents a malicious club admin from whitelisting spammers
# that could affect other clubs.
#
# Whitelist files are synced from M2S API by m2s-sync-aliases.py

rules {
{% for club in club_domains %}
  M2S_{{ club.prefix | upper }}_WHITELIST {
    valid_dkim = false;
    # Only whitelist if SPF passes (prevents spoofing via SPF validation)
    valid_spf = "allow";
    domains = false;
    from = true;
    prefilter = true;
    action = "no action";
    map = "file:///etc/rspamd/local.d/whitelists/{{ club.prefix }}_whitelist.map";
    # Only apply to mail destined for this club's domain
    rcpt = "/.*@{{ club.prefix }}\.{{ mail_domain | replace('.', '\\.') }}$/";
    description = "{{ club.name }} member whitelist - bypass spam checks (requires SPF pass)";
  }
{% endfor %}

  # ============================================================
  # Bypass Lists (Issue #492)
  # ============================================================
  # Some mailing lists (e.g., treasurer@, webmaster@) need to receive mail
  # from anyone, not just whitelisted senders. This allows external services
  # like Zelle, password reset emails, etc. to reach these addresses.
  #
  # SPF PASS is still required (prevents spoofing), but sender whitelist
  # is bypassed for recipients listed in bypass_lists.map
  M2S_BYPASS_LISTS {
    valid_dkim = false;
    # Still require SPF PASS (prevents spoofing)
    valid_spf = "allow";
    domains = false;
    from = false;
    prefilter = true;
    action = "no action";
    # Match any sender when recipient is in bypass list
    rcpt_map = "file:///etc/rspamd/local.d/whitelists/bypass_lists.map";
    description = "Bypass whitelist for service accounts (treasurer, webmaster, etc.) - requires SPF pass";
  }
}

---
# ============================================================
# Rspamd Role - Spam Filtering
# ============================================================
# Installs and configures Rspamd as a milter for Postfix.
# Spam is REJECTED during SMTP (no greylisting, no soft actions).
# Whitelisted senders (synced from M2S API) bypass spam checks.

- name: Install Rspamd
  ansible.builtin.apt:
    name:
      - rspamd
      - redis-server
    state: present
  environment:
    DEBIAN_FRONTEND: noninteractive

- name: Enable Redis (required for Rspamd)
  ansible.builtin.service:
    name: redis-server
    enabled: true
    state: started

- name: Create Redis config directory
  ansible.builtin.file:
    path: /etc/redis/redis.conf.d
    state: directory
    mode: "0755"

- name: Ensure Redis includes conf.d directory
  ansible.builtin.lineinfile:
    path: /etc/redis/redis.conf
    line: 'include /etc/redis/redis.conf.d/*.conf'
    state: present
  notify: Restart Redis

- name: Configure Redis security (bind to localhost, protected mode)
  ansible.builtin.copy:
    dest: /etc/redis/redis.conf.d/security.conf
    content: |
      # Security settings - bind to localhost only
      bind 127.0.0.1 ::1
      protected-mode yes
    mode: "0644"
  notify: Restart Redis

# ============================================================
# RSPAMD CONFIGURATION
# ============================================================
# We use local.d/ to override defaults without modifying core files

- name: Configure Rspamd worker (milter mode)
  ansible.builtin.copy:
    dest: /etc/rspamd/local.d/worker-proxy.inc
    content: |
      # Milter mode for Postfix integration
      milter = yes;
      timeout = 30s;
      upstream "local" {
        default = yes;
        self_scan = yes;
      }
      # Listen on localhost for Postfix
      bind_socket = "localhost:11332";
    mode: "0644"
  notify: Restart Rspamd

- name: Configure Rspamd actions (REJECT spam)
  ansible.builtin.copy:
    dest: /etc/rspamd/local.d/actions.conf
    content: |
      # ============================================================
      # Rspamd Actions - Generated by Ansible
      # ============================================================
      # REJECT spam during SMTP - no soft actions, no greylisting
      #
      # Score thresholds:
      #   15+ = Reject (definite spam)
      #   6+  = Add header (suspicious, let recipient decide)
      #   4+  = Rewrite subject (borderline)
      #
      # We use high thresholds because whitelisted senders bypass all checks.
      # Only non-member mail gets scanned, so we can be aggressive.

      reject = 15;
      add_header = 6;
      rewrite_subject = 4;

      # Disable greylisting - spammers always retry anyway
      greylist = null;
    mode: "0644"
  notify: Restart Rspamd

- name: Configure Rspamd milter headers
  ansible.builtin.copy:
    dest: /etc/rspamd/local.d/milter_headers.conf
    content: |
      # Add headers for debugging/filtering
      use = ["x-spamd-bar", "x-spam-status", "authentication-results"];
      extended_spam_headers = true;
    mode: "0644"
  notify: Restart Rspamd

- name: Create Rspamd whitelist directory for per-club maps
  ansible.builtin.file:
    path: /etc/rspamd/local.d/whitelists
    state: directory
    owner: _rspamd
    group: _rspamd
    mode: "0755"

- name: Configure Rspamd whitelist module (per-club isolation)
  ansible.builtin.template:
    src: whitelist.conf.j2
    dest: /etc/rspamd/local.d/whitelist.conf
    mode: "0644"
  notify: Restart Rspamd

- name: Create initial empty whitelist maps for each club
  ansible.builtin.copy:
    dest: /etc/rspamd/local.d/whitelists/{{ item.prefix }}_whitelist.map
    content: |
      # Sender whitelist for {{ item.name }} - synced from M2S API
      # DO NOT EDIT MANUALLY - will be overwritten
      # Format: one email address per line
    owner: _rspamd
    group: _rspamd
    mode: "0644"
    force: false
  loop: "{{ club_domains }}"
  notify: Reload Rspamd

- name: Disable modules we don't need (reduce CPU on e2-micro)
  ansible.builtin.copy:
    dest: /etc/rspamd/local.d/{{ item }}.conf
    content: |
      enabled = false;
    mode: "0644"
  loop:
    - neural       # Neural network learning - too heavy for e2-micro
    - greylist     # Disabled per policy
    - ratelimit    # We have Postfix rate limits
  notify: Restart Rspamd

# ============================================================
# AUTOMATIC UPDATES
# ============================================================

- name: Configure Rspamd automatic updates
  ansible.builtin.copy:
    dest: /etc/rspamd/local.d/rspamd_update.conf
    content: |
      # Enable built-in periodic rule updates from Rspamd project
      # Rspamd downloads updated spam rules automatically
      enabled = true;
    mode: "0644"
  notify: Restart Rspamd

- name: Ensure Rspamd is enabled and running
  ansible.builtin.service:
    name: rspamd
    enabled: true
    state: started

---
# ============================================================
# Rspamd Role - Spam Filtering
# ============================================================
# Installs and configures Rspamd as a milter for Postfix.
# Spam is REJECTED during SMTP (no greylisting, no soft actions).
# Whitelisted senders (synced from M2S API) bypass spam checks.

- name: Install Rspamd
  ansible.builtin.apt:
    name:
      - rspamd
      - redis-server
    state: present
  environment:
    DEBIAN_FRONTEND: noninteractive

- name: Enable Redis (required for Rspamd)
  ansible.builtin.service:
    name: redis-server
    enabled: true
    state: started

- name: Create Redis config directory
  ansible.builtin.file:
    path: /etc/redis/redis.conf.d
    state: directory
    mode: "0755"

- name: Configure Redis security (bind to localhost, protected mode)
  ansible.builtin.copy:
    dest: /etc/redis/redis.conf.d/security.conf
    content: |
      # Security settings - bind to localhost only
      bind 127.0.0.1 ::1
      protected-mode yes
    mode: "0644"
  notify: Restart Redis

# ============================================================
# RSPAMD CONFIGURATION
# ============================================================
# We use local.d/ to override defaults without modifying core files

- name: Configure Rspamd worker (milter mode)
  ansible.builtin.copy:
    dest: /etc/rspamd/local.d/worker-proxy.inc
    content: |
      # Milter mode for Postfix integration
      milter = yes;
      timeout = 120s;
      upstream "local" {
        default = yes;
        self_scan = yes;
      }
      # Listen on localhost for Postfix
      bind_socket = "localhost:11332";
    mode: "0644"
  notify: Restart Rspamd

- name: Configure Rspamd actions (REJECT spam)
  ansible.builtin.copy:
    dest: /etc/rspamd/local.d/actions.conf
    content: |
      # ============================================================
      # Rspamd Actions - Generated by Ansible
      # ============================================================
      # REJECT spam during SMTP - no soft actions, no greylisting
      #
      # Score thresholds:
      #   15+ = Reject (definite spam)
      #   6+  = Add header (suspicious, let recipient decide)
      #   4+  = Rewrite subject (borderline)
      #
      # We use high thresholds because whitelisted senders bypass all checks.
      # Only non-member mail gets scanned, so we can be aggressive.

      reject = 15;
      add_header = 6;
      rewrite_subject = 4;

      # Disable greylisting - spammers always retry anyway
      greylist = null;
    mode: "0644"
  notify: Restart Rspamd

- name: Configure Rspamd milter headers
  ansible.builtin.copy:
    dest: /etc/rspamd/local.d/milter_headers.conf
    content: |
      # Add headers for debugging/filtering
      use = ["x-spamd-bar", "x-spam-status", "authentication-results"];
      extended_spam_headers = true;
    mode: "0644"
  notify: Restart Rspamd

- name: Configure Rspamd whitelist module
  ansible.builtin.copy:
    dest: /etc/rspamd/local.d/whitelist.conf
    content: |
      # ============================================================
      # Sender Whitelist - Generated by Ansible
      # ============================================================
      # Whitelisted senders bypass ALL spam checks.
      # The whitelist file is synced from M2S API by m2s-sync-aliases.py
      #
      # This provides a "precheck" action that skips all other modules.

      rules {
        M2S_WHITELIST {
          valid_dkim = false;
          valid_spf = false;
          domains = false;
          from = true;
          prefilter = true;
          action = "no action";
          score = -100.0;
          map = "file:///etc/rspamd/local.d/sender_whitelist.map";
          description = "M2S club member whitelist - bypass spam checks";
        }
      }
    mode: "0644"
  notify: Restart Rspamd

- name: Create initial empty whitelist map
  ansible.builtin.copy:
    dest: /etc/rspamd/local.d/sender_whitelist.map
    content: |
      # Sender whitelist - synced from M2S API by m2s-sync-aliases.py
      # DO NOT EDIT MANUALLY - will be overwritten
      # Format: one email address per line
    owner: _rspamd
    group: _rspamd
    mode: "0644"
    force: false
  notify: Reload Rspamd

- name: Disable modules we don't need (reduce CPU on e2-micro)
  ansible.builtin.copy:
    dest: /etc/rspamd/local.d/{{ item }}.conf
    content: |
      enabled = false;
    mode: "0644"
  loop:
    - neural       # Neural network learning - too heavy for e2-micro
    - greylist     # Disabled per policy
    - ratelimit    # We have Postfix rate limits
  notify: Restart Rspamd

# ============================================================
# AUTOMATIC UPDATES
# ============================================================

- name: Configure Rspamd automatic updates
  ansible.builtin.copy:
    dest: /etc/rspamd/local.d/rspamd_update.conf
    content: |
      # Enable automatic rule updates
      enabled = true;
    mode: "0644"
  notify: Restart Rspamd

- name: Create Rspamd update cron job
  ansible.builtin.cron:
    name: "Rspamd rule updates"
    minute: "30"
    hour: "3"
    job: "/usr/bin/rspamadm configwizard --update >> /var/log/rspamd-update.log 2>&1"
    user: root

- name: Install logrotate config for rspamd-update.log
  ansible.builtin.copy:
    dest: /etc/logrotate.d/rspamd-update
    content: |
      /var/log/rspamd-update.log {
          daily
          rotate 14
          compress
          missingok
          notifempty
          create 0640 root adm
      }
    mode: "0644"

- name: Ensure Rspamd is enabled and running
  ansible.builtin.service:
    name: rspamd
    enabled: true
    state: started

# M2S NGINX Configuration - With SSL
# Managed by Ansible - do not edit manually

upstream {{ nginx_upstream_name }} {
    server {{ nginx_upstream_server }};
}

# Redirect HTTP to HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name {{ nginx_server_name }};

    # For Let's Encrypt certificate renewal
    location /.well-known/acme-challenge/ {
        root /var/www/html;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

# HTTPS server
server {
{% if nginx_http2_enabled %}
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
{% else %}
    listen 443 ssl;
    listen [::]:443 ssl;
{% endif %}
    server_name {{ nginx_server_name }};

    # SSL certificates
    ssl_certificate {{ nginx_ssl_certificate }};
    ssl_certificate_key {{ nginx_ssl_certificate_key }};

    # SSL parameters
    include /etc/nginx/snippets/ssl-params.conf;

{% if nginx_security_headers_enabled %}
    # Security headers
    include /etc/nginx/snippets/security-headers.conf;
{% endif %}

    # Logging
    access_log {{ nginx_access_log }} main;
    error_log {{ nginx_error_log }};

    # Static files
    location {{ nginx_static_url }} {
        alias {{ nginx_static_root }}/;
        expires {{ nginx_static_cache_time }};
        add_header Cache-Control "public, immutable";

        # Gzip static files
        gzip_static on;
    }

    # Media files (user uploads)
    location {{ nginx_media_url }} {
        alias {{ nginx_media_root }}/;
        expires {{ nginx_media_cache_time }};
        add_header Cache-Control "public";
    }

    # Favicon
    location = /favicon.ico {
        alias {{ nginx_static_root }}/favicon.ico;
        access_log off;
        log_not_found off;
    }

    # Robots.txt
    location = /robots.txt {
        alias {{ nginx_static_root }}/robots.txt;
        access_log off;
        log_not_found off;
    }

{% if nginx_rate_limit_enabled %}
    # Rate-limited endpoints
    location /accounts/login/ {
        limit_req zone={{ nginx_rate_limit_zone }} burst={{ nginx_rate_limit_burst }} nodelay;
        include /etc/nginx/proxy_params;
        proxy_pass http://{{ nginx_upstream_name }};
    }

    location /api/ {
        limit_req zone={{ nginx_rate_limit_zone }} burst={{ nginx_rate_limit_burst }} nodelay;
        include /etc/nginx/proxy_params;
        proxy_pass http://{{ nginx_upstream_name }};
    }
{% endif %}

    # Django application
    location / {
        include /etc/nginx/proxy_params;
        proxy_pass http://{{ nginx_upstream_name }};

        # WebSocket support (if needed)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}

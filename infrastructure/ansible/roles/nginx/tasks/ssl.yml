# NGINX Role - SSL Certificate Tasks
---
- name: Obtain Let's Encrypt certificate
  ansible.builtin.command: >
    certbot certonly --nginx --non-interactive --agree-tos
    --email {{ letsencrypt_email }}
    --domains {{ nginx_server_name }}
  args:
    creates: "{{ nginx_ssl_certificate }}"
  become: true
  register: certbot_result
  failed_when: false

- name: Check if certificate was successfully obtained
  ansible.builtin.stat:
    path: "{{ nginx_ssl_certificate }}"
  register: cert_check
  become: true

- name: Fail if certificate was not obtained
  ansible.builtin.fail:
    msg: |
      Failed to obtain SSL certificate from Let's Encrypt.
      Certbot output: {{ certbot_result.stdout | default('No output') }}
      Error: {{ certbot_result.stderr | default('No error output') }}
      Please check:
      1. DNS records are correct for {{ nginx_server_name }}
      2. Port 80 is accessible from the internet
      3. No firewall blocking Let's Encrypt validation
  when: certbot_result.rc != 0 and not cert_check.stat.exists

- name: Display certbot result
  ansible.builtin.debug:
    msg: "Certbot result: {{ certbot_result.stdout | default('No output') }}"
  when: certbot_result.rc == 0

- name: Deploy SSL site configuration after certificate obtained
  ansible.builtin.template:
    src: m2s-ssl.conf.j2
    dest: /etc/nginx/sites-available/m2s.conf
    owner: root
    group: root
    mode: "0644"
  become: true
  when: cert_check.stat.exists
  notify: Reload NGINX

- name: Set up automatic certificate renewal
  ansible.builtin.cron:
    name: "Certbot renewal"
    minute: "0"
    hour: "3"
    day: "*"
    month: "*"
    weekday: "*"
    job: "certbot renew --quiet --post-hook 'systemctl reload nginx'"
    user: root
  become: true

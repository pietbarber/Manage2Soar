#!/usr/bin/env python3
"""
M2S Mail Alias Sync Script - Generated by Ansible
==================================================
Fetches mailing list membership from M2S API and updates Postfix virtual aliases.

This script is run by cron every 15 minutes.
"""

import hashlib
import os
import subprocess
import sys
from datetime import datetime

import requests
import yaml


def load_config():
    """Load configuration from YAML file."""
    config_path = os.path.join(os.path.dirname(__file__), 'config.yml')
    with open(config_path, 'r') as f:
        return yaml.safe_load(f)


def fetch_club_lists(club, api_key):
    """
    Fetch email lists from M2S API for a club.

    Expected response format:
    {
        "domain": "ssc.manage2soar.com",
        "lists": {
            "members": ["alice@gmail.com", "bob@yahoo.com", ...],
            "instructors": ["alice@gmail.com", ...],
            "towpilots": ["charlie@outlook.com", ...],
            "board": ["alice@gmail.com", "david@icloud.com", ...]
        },
        "whitelist": ["alice@gmail.com", "bob@yahoo.com", ...]
    }
    """
    try:
        headers = {
            'Authorization': f'Bearer {api_key}',
            'Accept': 'application/json',
        }
        response = requests.get(club['api_url'], headers=headers, timeout=30)
        response.raise_for_status()
        return response.json()
    except requests.RequestException as e:
        print(f"[{datetime.now()}] ERROR: Failed to fetch lists for {club['prefix']}: {e}")
        return None


def generate_virtual_aliases(clubs_data):
    """Generate Postfix virtual alias file content."""
    lines = [
        "# ============================================================",
        "# Virtual Aliases - Generated by m2s-sync-aliases.py",
        "# ============================================================",
        f"# Generated: {datetime.now().isoformat()}",
        "# DO NOT EDIT MANUALLY - will be overwritten by cron",
        "",
    ]

    for domain, data in clubs_data.items():
        if not data or 'lists' not in data:
            continue

        lines.append(f"# --- {domain} ---")

        for list_name, recipients in data['lists'].items():
            if recipients:
                # Postfix format: alias@domain  recipient1,recipient2,...
                recipients_str = ','.join(sorted(set(recipients)))
                lines.append(f"{list_name}@{domain}  {recipients_str}")

        lines.append("")

    return '\n'.join(lines)


def generate_whitelist(clubs_data):
    """Generate Postfix sender whitelist file content."""
    lines = [
        "# ============================================================",
        "# Sender Whitelist - Generated by m2s-sync-aliases.py",
        "# ============================================================",
        f"# Generated: {datetime.now().isoformat()}",
        "# DO NOT EDIT MANUALLY - will be overwritten by cron",
        "",
    ]

    all_senders = set()

    for domain, data in clubs_data.items():
        if data and 'whitelist' in data:
            all_senders.update(data['whitelist'])

    for sender in sorted(all_senders):
        lines.append(f"{sender}  OK")

    return '\n'.join(lines)


def file_changed(filepath, new_content):
    """Check if file content has changed using hash comparison."""
    if not os.path.exists(filepath):
        return True

    with open(filepath, 'r') as f:
        old_content = f.read()

    old_hash = hashlib.md5(old_content.encode()).hexdigest()
    new_hash = hashlib.md5(new_content.encode()).hexdigest()

    return old_hash != new_hash


def write_and_postmap(filepath, content):
    """Write file and run postmap if content changed."""
    if not file_changed(filepath, content):
        return False

    # Write new content
    with open(filepath, 'w') as f:
        f.write(content)

    # Run postmap to rebuild hash database
    subprocess.run(['postmap', filepath], check=True)

    return True


def main():
    print(f"[{datetime.now()}] Starting M2S mail alias sync...")

    config = load_config()

    # Fetch lists from all clubs
    clubs_data = {}
    for club in config['clubs']:
        data = fetch_club_lists(club, config['api_key'])
        if data:
            clubs_data[club['domain']] = data
            print(f"[{datetime.now()}] Fetched {len(data.get('lists', {}))} lists for {club['prefix']}")

    if not clubs_data:
        print(f"[{datetime.now()}] WARNING: No club data fetched, keeping existing aliases")
        sys.exit(1)

    # Generate and update virtual aliases
    virtual_content = generate_virtual_aliases(clubs_data)
    if write_and_postmap(config['postfix_virtual_file'], virtual_content):
        print(f"[{datetime.now()}] Updated virtual aliases")
    else:
        print(f"[{datetime.now()}] Virtual aliases unchanged")

    # Generate and update whitelist
    whitelist_content = generate_whitelist(clubs_data)
    if write_and_postmap(config['postfix_whitelist_file'], whitelist_content):
        print(f"[{datetime.now()}] Updated sender whitelist")
    else:
        print(f"[{datetime.now()}] Sender whitelist unchanged")

    print(f"[{datetime.now()}] Sync complete")


if __name__ == '__main__':
    main()

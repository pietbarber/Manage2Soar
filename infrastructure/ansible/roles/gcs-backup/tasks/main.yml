---
- name: Ensure required APIs are enabled
  ansible.builtin.command:
    cmd: "gcloud services enable cloudkms.googleapis.com storage.googleapis.com --project={{ gcs_backup_project }}"
  changed_when: false
  delegate_to: localhost
  become: false

- name: Determine KMS next rotation time when not provided
  ansible.builtin.command:
    cmd: "date -u -d '+90 days' +%Y-%m-%dT%H:%M:%SZ"
  register: kms_next_rotation_time
  changed_when: false
  when: gcs_backup_kms_next_rotation_time | default('') | length == 0
  delegate_to: localhost
  become: false

- name: Set KMS rotation time fact
  ansible.builtin.set_fact:
    gcs_backup_kms_rotation_time: "{{ gcs_backup_kms_next_rotation_time | default(kms_next_rotation_time.stdout) }}"

- name: Check if KMS keyring exists
  ansible.builtin.command:
    cmd: "gcloud kms keyrings describe {{ gcs_backup_kms_keyring }} --location={{ gcs_backup_location }} --project={{ gcs_backup_project }}"
  register: kms_keyring_check
  failed_when: false
  changed_when: false
  delegate_to: localhost
  become: false

- name: Create KMS keyring
  ansible.builtin.command:
    cmd: "gcloud kms keyrings create {{ gcs_backup_kms_keyring }} --location={{ gcs_backup_location }} --project={{ gcs_backup_project }}"
  when: kms_keyring_check.rc != 0
  delegate_to: localhost
  become: false

- name: Check if KMS key exists
  ansible.builtin.command:
    cmd: "gcloud kms keys describe {{ gcs_backup_kms_key }} --keyring={{ gcs_backup_kms_keyring }} --location={{ gcs_backup_location }} --project={{ gcs_backup_project }}"
  register: kms_key_check
  failed_when: false
  changed_when: false
  delegate_to: localhost
  become: false

- name: Create KMS key with rotation
  ansible.builtin.command:
    cmd: >
      gcloud kms keys create {{ gcs_backup_kms_key }}
      --keyring={{ gcs_backup_kms_keyring }}
      --location={{ gcs_backup_location }}
      --purpose=encryption
      --rotation-period={{ gcs_backup_kms_rotation_period }}
      --next-rotation-time={{ gcs_backup_kms_rotation_time }}
      --project={{ gcs_backup_project }}
  when: kms_key_check.rc != 0
  delegate_to: localhost
  become: false

- name: Ensure backup bucket exists with uniform access
  google.cloud.gcp_storage_bucket:
    name: "{{ gcs_backup_bucket }}"
    project: "{{ gcs_backup_project }}"
    location: "{{ gcs_backup_location }}"
    storage_class: "{{ gcs_backup_storage_class | default('STANDARD') }}"
    iam_configuration:
      uniform_bucket_level_access:
        enabled: true
    state: present
    auth_kind: "{{ gcp_auth_kind | default('application') }}"
    service_account_file: "{{ gcp_service_account_file | default(omit) }}"
  delegate_to: localhost
  become: false

- name: Enforce public access prevention
  ansible.builtin.command:
    cmd: "gsutil pap set enforced gs://{{ gcs_backup_bucket }}"
  changed_when: false
  delegate_to: localhost
  become: false

- name: Set default CMEK encryption key on bucket
  ansible.builtin.command:
    cmd: "gcloud storage buckets update gs://{{ gcs_backup_bucket }} --default-encryption-key=projects/{{ gcs_backup_project }}/locations/{{ gcs_backup_location }}/keyRings/{{ gcs_backup_kms_keyring }}/cryptoKeys/{{ gcs_backup_kms_key }}"
  changed_when: false
  delegate_to: localhost
  become: false

- name: Enable bucket versioning
  ansible.builtin.command:
    cmd: "gcloud storage buckets update gs://{{ gcs_backup_bucket }} --versioning"
  changed_when: false
  delegate_to: localhost
  become: false

- name: Configure lifecycle policy when enabled
  ansible.builtin.copy:
    dest: /tmp/gcs-backup-lifecycle.json
    content: |
      {
        "rule": [
          {
            "action": {"type": "SetStorageClass", "storageClass": "COLDLINE"},
            "condition": {"age": {{ gcs_backup_coldline_days }} }
          },
          {
            "action": {"type": "Delete"},
            "condition": {"age": {{ gcs_backup_delete_days }} }
          }
        ]
      }
  when:
    - gcs_backup_coldline_days is defined
    - gcs_backup_delete_days is defined
  delegate_to: localhost
  become: false

- name: Apply lifecycle policy
  ansible.builtin.command:
    cmd: "gcloud storage buckets update gs://{{ gcs_backup_bucket }} --lifecycle-file=/tmp/gcs-backup-lifecycle.json"
  when:
    - gcs_backup_coldline_days is defined
    - gcs_backup_delete_days is defined
  changed_when: false
  delegate_to: localhost
  become: false

- name: Get GCS project number
  ansible.builtin.command:
    cmd: "gcloud projects describe {{ gcs_backup_project }} --format=value(projectNumber)"
  register: gcs_project_number
  changed_when: false
  delegate_to: localhost
  become: false

- name: Set GCS service account fact
  ansible.builtin.set_fact:
    gcs_service_account_email: "service-{{ gcs_project_number.stdout }}@gs-project-accounts.iam.gserviceaccount.com"

- name: Grant GCS service account KMS encrypt/decrypt permission
  ansible.builtin.command:
    cmd: >
      gcloud kms keys add-iam-policy-binding {{ gcs_backup_kms_key }}
      --keyring={{ gcs_backup_kms_keyring }}
      --location={{ gcs_backup_location }}
      --member=serviceAccount:{{ gcs_service_account_email }}
      --role=roles/cloudkms.cryptoKeyEncrypterDecrypter
      --project={{ gcs_backup_project }}
  changed_when: false
  delegate_to: localhost
  become: false

- name: Grant VM service account write-only access to bucket
  ansible.builtin.command:
    cmd: "gcloud storage buckets add-iam-policy-binding gs://{{ gcs_backup_bucket }} --member=serviceAccount:{{ gcs_backup_vm_service_account }} --role=roles/storage.objectCreator"
  when:
    - gcs_backup_vm_service_account is defined
    - gcs_backup_vm_service_account | length > 0
  changed_when: false
  delegate_to: localhost
  become: false

{% extends "base.html" %}
{% block title %}Training Grid{% endblock %}
{% block content %}
<style>
/* Scrollable grid container and sticky columns */
.training-grid-scroll {
  overflow-x: auto;
  overflow-y: visible;
  width: 100%;
  max-height: 80vh;
  min-height: 400px;
  position: relative;
  background: #fff;
}
table.training-grid {
  min-width: 1200px;
  width: max-content;
}
th.sticky-col, td.sticky-col {
  position: sticky;
  left: 0;
  background: #fff;
  z-index: 2;
}
th.sticky-max, td.sticky-max {
  position: sticky;
  right: 0;
  background: #fff;
  z-index: 2;
}
</style>
<div class="d-flex justify-content-between align-items-center mb-2">
  <h2 class="mb-0">Training Progress for {{ member.full_display_name }}</h2>
  <a href="{% url 'instructors:member_instruction_record' member.id %}" class="btn btn-outline-primary btn-sm ms-3">üìò View Instruction Record</a>
</div>
{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  {% endfor %}
{% endif %}

<div class="training-grid-scroll" id="training-grid-scroll">
<table class="table table-bordered table-sm border-dark-subtle training-grid">
  <thead>
    <tr>
  <th rowspan="3" class="sticky-col">Lesson</th>
      {% for meta in column_metadata %}
        <th>
          {{ meta.date|date:"M d" }}<br>
          <span class="text-muted small">{{ meta.date|date:"Y" }}</span>
        </th>
      {% endfor %}
  <th rowspan="3" class="max_score sticky-max">‚≠ê Max</th>
    </tr>
    <tr>
        {% for meta in column_metadata %}
          <th class="small text-muted" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ meta.instructor_name }}{% if meta.days_ago %} ‚Äî {{ meta.days_ago }} days ago{% endif %}">
            {% if meta.initials %}
              {{ meta.initials }}<br>
            {% else %}
              &mdash;<br>
            {% endif %}
            {{ meta.days_ago }}<br>
            {% if meta.altitudes %}{{ meta.altitudes }}{% endif %}
          </th>
        {% endfor %}
    </tr>
    <tr>
        {% for meta in column_metadata %}
          <th>
            {% if meta.num_flights > 0 %}
              <span class="badge bg-secondary text-light fs-6" style="min-width:2em;" title="{{ meta.flights_tooltip }}">{{ meta.num_flights }}</span>
            {% endif %}
          </th>
        {% endfor %}
        <th></th>
    </tr>
  </thead>
  
  <tbody>
    {% regroup lesson_data by phase as phase_groups %}
  
    {% for group in phase_groups %}
      <tr class="table-secondary">
  <th class="text-start sticky-col" colspan="1">{{ group.grouper }}</th>
  {% for _ in report_dates %}<td></td>{% endfor %}
  <th class="sticky-max"></th>
      </tr>
  
        {% for row in group.list %}
          <tr>
            <td class="text-end pe-2 sticky-col">
              {% if row.code %}
                <a href="/TRAINING/Syllabus/{{ row.code }}/" target="_blank">{{ row.label }}</a>
              {% else %}
                {{ row.label }}
              {% endif %}
            </td>
            {% for cell in row.scores %}
            <td class="text-center
                {% if cell.score == '1' %}score-1
                {% elif cell.score == '2' %}score-2
                {% elif cell.score == '3' %}score-3
                {% elif cell.score == '4' %}score-4
                {% elif cell.score == '!' %}score-attn
                {% endif %}
            " title="{{ cell.tooltip }}">
              {% if cell.score == "1" %} <img src="/static/images/blob1.png">
              {% elif cell.score == "2" %} <img src="/static/images/blob2.png">
              {% elif cell.score == "3" %} <img src="/static/images/blob3.png">
              {% elif cell.score == "4" %} <img src="/static/images/blob4.png">
              {% elif cell.score == "!" %}Ô∏è <img src="/static/images/blob5.png">
              {% else %}&mdash;
              {% endif %}
            </td>
          {% endfor %}
           
       
          <td class="text-center border border-2 border-primary fw-bold max_score sticky-max">
              {% if row.max_score == "1" %} <img src="/static/images/blob1.png">
              {% elif row.max_score == "2" %} <img src="/static/images/blob2.png">
              {% elif row.max_score == "3" %} <img src="/static/images/blob3.png">
              {% elif row.max_score == "4" %} <img src="/static/images/blob4.png">
            {% else %}&mdash;{% endif %}
          </td>
        </tr>
      {% endfor %}
    {% endfor %}
  </tbody>
</table>
</div>
<script>
document.addEventListener('DOMContentLoaded', function () {
  if (window.bootstrap) {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
      new bootstrap.Tooltip(tooltipTriggerEl);
    });
  }
  // Auto-scroll to right on load
  var gridScroll = document.getElementById('training-grid-scroll');
  if (gridScroll) {
    gridScroll.scrollLeft = gridScroll.scrollWidth;
  }
});
</script>
{% endblock %}

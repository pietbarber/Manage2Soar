{% extends "base.html" %}
{% load static %}
{% block content %}
<h2>Instruction Record for {{ member.full_display_name }}</h2>

<div id="charts-container"
     data-dates='{{ chart_dates_json|safe }}'
     data-solo='{{ chart_solo_json|safe }}'
     data-rating='{{ chart_rating_json|safe }}'
     data-anchors='{{ chart_anchors_json|safe }}'
     data-firstsolo="{{ first_solo_str }}"
     style="overflow-x:auto; white-space:nowrap; margin-bottom:2rem;"
>
<div style="overflow-x:auto; margin-bottom:1rem;">
  <div id="solo_chart"   style="height:150px; min-width:2000px;"></div>
</div>
<div style="overflow-x:auto; margin-bottom:2rem;">
  <div id="rating_chart" style="height:150px; min-width:2000px;"></div>
</div>



<script src="https://www.gstatic.com/charts/loader.js"></script>
<script src="{% static 'js/instruction_charts.js' %}"></script>



{% for block in report_blocks %}
  {% if block.type == "flight" %}
    <div id="flight-{{ block.report.report_date }}">
      {# existing flightâ€report markup #}
    </div>
    {% else %}
    <div id="ground-{{ block.report.date }}">
      {# existing groundâ€session markup #}
    </div>
  {% endif %}

  <div class="card mb-4">
    <div class="card-header bg-light">
      <strong>
        {% if block.type == "ground" %}
          ğŸ§  Ground Instruction - {{ block.report.date|date:"F j, Y" }}
        {% else %}
          âœˆï¸ Flight Instruction - {{ block.report.report_date|date:"F j, Y" }}
        {% endif %}
      </strong>
      <span class="text-muted">({{ block.days_ago }} days ago)</span>
    </div>

    <div class="card-body">

      {% if block.flights %}
        <h5>ğŸ›« Flights</h5>
        <ul class="list-group mb-3">
          {% for flight in block.flights %}
            <li class="list-group-item">
              <strong>Glider:</strong> {{ flight.glider.n_number }} â€“
              <strong>Instructor:</strong> {{ flight.instructor.full_display_name }} â€“
              <strong>Release Altitude:</strong> {{ flight.release_altitude|default:"?" }} ft â€“
              <strong>Duration:</strong> {{ flight.duration|default:"?" }}
            </li>
          {% endfor %}
        </ul>
      {% endif %}
    
      {% if block.scores_by_code %}
        <h5>ğŸ¯ Performance Results</h5>
        {% for score, codes in block.scores_by_code.items %}
          {% if codes %}
            <p>
              <strong>
                {% if score == "1" %}Introduced:
                {% elif score == "2" %}Practiced:
                {% elif score == "3" %}Solo Proficient:
                {% elif score == "4" %}Checkride Standard:
                {% elif score == "!" %}Critical Issue:
                {% else %}{{ score }}:
                {% endif %}
              </strong>
              {{ codes|join:", " }}
            </p>
          {% endif %}
        {% endfor %}
      {% elif block.type == "ground" %}
        <p class="text-muted"><em>No performance scores recorded for this ground session.</em></p>
      {% endif %}
    
      {% if block.report.report_text %}
        <h5>ğŸ“ Instructor Essay</h5>
        <div class="border p-3 bg-white">
          {{ block.report.report_text|safe }}
        </div>
      {% elif block.report.notes %}
        <h5>ğŸ“ Notes</h5>
        <div class="border p-3 bg-white">
          {{ block.report.notes|safe }}
        </div>
      {% elif block.type == "ground" %}
        <p class="text-muted"><em>No notes provided for this ground session.</em></p>
      {% endif %}
    
    </div>
    
    <div class="card-footer text-muted small">
      Submitted by {{ block.report.instructor.full_display_name }}.
      {% if block.type == "flight" %}
        Created on {{ block.report.created_at|date:"Y-m-d H:i:s" }}
        {% if block.report.updated_at %}
          â€“ Updated {{ block.report.updated_at|date:"Y-m-d H:i:s" }}
        {% endif %}
      {% else %}
        {% if block.report.created_at %}
          Created on {{ block.report.created_at|date:"Y-m-d H:i:s" }}
        {% endif %}
      {% endif %}
    </div>
  </div>
{% endfor %}
{% endblock %}

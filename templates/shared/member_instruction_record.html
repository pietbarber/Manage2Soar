{% extends "base.html" %}
{% load static %}
{% load dict_extras %}
{% block content %}
<div id="top"></div>
<div class="d-flex justify-content-between align-items-center mb-2">
  <div class="d-flex align-items-center">
    {% if member.profile_photo %}
      <img src="{{ member.profile_image_url }}" alt="{{ member.full_display_name }}" class="rounded-circle me-3" style="height:3.5em; width:3.5em; object-fit:cover; border:1px solid #ccc;" />
    {% endif %}
    <h2 class="mb-0">Instruction Record for {{ member.full_display_name }}</h2>
  </div>
  <div class="d-flex align-items-center">
  {% comment %}Issue #258: Only show ground instruction button for instructors viewing OTHER members' records{% endcomment %}
  {% if request.user.instructor and request.user != member %}
    <a href="{% url 'instructors:log_ground_instruction' %}?student_id={{ member.id }}" class="btn btn-outline-primary btn-sm me-2">‚úçÔ∏è Log Ground Instruction</a>
  {% endif %}
    <a href="{% url 'instructors:member_training_grid' member.id %}" class="btn btn-outline-primary btn-sm me-2">üìä View Training Grid</a>
    {% if request.user == member %}
      <a href="{% url 'knowledgetest:member-test-history' %}" class="btn btn-outline-info btn-sm me-2">üìù My Written Tests</a>
      <a href="{% url 'knowledgetest:quiz-pending' %}" class="btn btn-outline-warning btn-sm">üìã Pending Tests</a>
    {% endif %}
  </div>
</div>
<div id="charts-container" data-dates='{{ chart_dates_json|safe }}' data-solo='{{ chart_solo_json|safe }}'
  data-rating='{{ chart_rating_json|safe }}' data-anchors='{{ chart_anchors_json|safe }}'
  data-firstsolo="{{ first_solo_str }}" style="overflow-x:auto; margin-bottom:2rem;">
  <div style="width:100%; overflow-x:auto; margin-bottom:1rem;">
    <div id="solo_chart" style="height:150px; width:100%;"></div>
  </div>
  <div style="width:100%; overflow-x:auto; margin-bottom:2rem;">
    <div id="rating_chart" style="height:150px; width:100%;"></div>
  </div>



  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="{% static 'js/instruction_charts.js' %}"></script>

  <!-- Badges -->
  {# ‚Äî Badges Earned ‚Äî #}
  {% if member.badges.all %}
  <h5>Badges:</h5>
  <div class="mb-3">
    {% for mb in member.badges.all %}
    {% if mb.badge.image %}
    <img src="{{ mb.badge.image.url }}" alt="{{ mb.badge.name }}" title="{{ mb.badge.name }}" class="me-2"
      style="height:2rem; width:auto;" data-bs-toggle="tooltip" data-bs-placement="top" />
    {% else %}
    <span class="badge bg-secondary me-1" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ mb.badge.name }}">
      {{ mb.badge.name }}
    </span>
    {% endif %}
    {% endfor %}
  </div>
  {% endif %}

  <!-- Qualifications Summary -->
  {% with qs=member.memberqualification_set.all %}
  {% if qs %}
  <h5>Qualifications:</h5>
  <div class="mb-4">
    {% for mq in qs %}
    {% with q=mq.qualification %}
    {% if q.icon %}
    <img src="{{ q.icon.url }}" alt="{{ q.name }}"
      title="{{ q.name }}{% if mq.expiration_date %} (exp. {{ mq.expiration_date }}){% endif %}" class="me-2"
      style="height:2rem; width:auto;" data-bs-toggle="tooltip" data-bs-placement="top" />
    {% else %}
    <span class="badge bg-info text-dark me-1" data-bs-toggle="tooltip" data-bs-placement="top"
      title="{{ q.name }}{% if mq.expiration_date %} (exp. {{ mq.expiration_date }}){% endif %}">
      {{ q.code }}
    </span>
    {% endif %}
    {% endwith %}
    {% endfor %}
  </div>
  {% endif %}
  {% endwith %}

  <!-- Flying Summary -->
  <h3>Flying Summary:</h3>
  <table class="table table-sm table-bordered mb-4">
    <thead class="table-dark">
      <tr>
        <th rowspan="2">Glider</th>
        <th colspan="3">Solo Flights</th>
        <th colspan="3">With Instructor</th>
        {% if member.is_instructor %}
        <th colspan="3">Instruction Given</th>
        {% endif %}
        <th colspan="3">Total Flights</th>
      </tr>
      <tr>
        <th>#</th>
        <th>Time</th>
        <th>Last Flight</th>
        <th>#</th>
        <th>Time</th>
        <th>Last Flight</th>
        {% if member.is_instructor %}
        <th>#</th>
        <th>Time</th>
        <th>Last Flight</th>
        {% endif %}
        <th>#</th>
        <th>Time</th>
        <th>Last Flight</th>
      </tr>
    </thead>
    <tbody>
      {% for s in flights_summary %}
      <tr class="{% if forloop.last %}table-secondary fw-bold{% endif %}">
        <td>{{ s.n_number }}</td>
        <td class="text-end">{{ s.solo_count }}</td>
        <td class="text-end">{{ s.solo_time }}</td>
        <td class="text-end">{{ s.solo_last|default_if_none:"" }}</td>

        <td class="text-end">{{ s.with_count }}</td>
        <td class="text-end">{{ s.with_time }}</td>
        <td class="text-end">{{ s.with_last|default_if_none:"" }}</td>

        {% if member.is_instructor %}
        <td class="text-end">{{ s.given_count }}</td>
        <td class="text-end">{{ s.given_time }}</td>
        <td class="text-end">{{ s.given_last|default_if_none:"" }}</td>
        {% endif %}

        <td class="text-end">{{ s.total_count }}</td>
        <td class="text-end">{{ s.total_time }}</td>
        <td class="text-end">{{ s.total_last|default_if_none:"" }}</td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="{% if member.is_instructor %}13{% else %}10{% endif %}" class="text-center">No flights on record</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {# --- Show 'still needs' for the most recent report block only --- #}
  {% comment %}Issue #258: Only show training requirements for students, not for already-rated pilots{% endcomment %}
  {% if member.glider_rating == "student" or member.glider_rating == "transition" or member.glider_rating == "none" %}
  {% with latest_block=report_blocks.0 %}
  {% if latest_block.missing_solo or latest_block.missing_rating %}
  <div class="alert alert-warning mb-4">
    {% if latest_block.missing_solo %}
    <p class="mb-1">
      Solo progress: still needs a (3) or (4) in
      {% for lesson in latest_block.missing_solo %}
      <a href="{% url 'public_syllabus_detail' lesson.code %}" class="lesson-code-tooltip" data-bs-toggle="tooltip"
        data-bs-placement="top" title="{{ lesson_titles|dict_get:lesson.code }}">{{ lesson.code }}</a>
      {% if not forloop.last %}, {% endif %}
      {% endfor %}
    </p>
    {% endif %}
    {% if latest_block.missing_rating %}
    <p class="mb-0">
      Rating progress: still needs a (4) in
      {% for lesson in latest_block.missing_rating %}
      <a href="{% url 'public_syllabus_detail' lesson.code %}" class="lesson-code-tooltip" data-bs-toggle="tooltip"
        data-bs-placement="top" title="{{ lesson_titles|dict_get:lesson.code }}">{{ lesson.code }}</a>
      {% if not forloop.last %}, {% endif %}
      {% endfor %}
    </p>
    {% endif %}
  </div>
  {% endif %}
  {% endwith %}
  {% endif %}

  {% comment %}
  Instruction records grouped by date, starting at line 148.
  Requires: daily_blocks in context (see view patch).
  {% endcomment %}

  {% for day in daily_blocks %}
  <div class="card mb-4" id="day-{{ day.date|date:'Y-m-d' }}">
    <div class="card-header">
      <strong>{{ day.date|date:"l, F j, Y" }}</strong>
      ({{ day.blocks.0.days_ago }} days ago)
    </div>
    <div class="card-body">
      {# Mini progress bars for the first block of the day #}
      {% with block=day.blocks.0 %}
      {% if member.glider_rating != 'private' and member.glider_rating != 'commercial' %}
      <div style="min-width:160px;">
        <div class="progress mb-1" style="--pct: {{ block.solo_pct }}%; height:1em; max-width:300px;">
          <div class="progress-bar bg-success" style="width: var(--pct);"></div>
          <div class="progress-bar bg-secondary" style="width: calc(100% - var(--pct));"></div>
        </div>
        <div class="progress" style="--pct: {{ block.rating_pct }}%; height:1em; max-width:300px;">
          <div class="progress-bar bg-success" style="width: var(--pct);"></div>
          <div class="progress-bar bg-secondary" style="width: calc(100% - var(--pct));"></div>
        </div>
      </div>
      {% endif %}
      {% endwith %}

      {# Flights table for all blocks that have flights #}

      <h5>üõ´ Flights</h5>
      <table class="table table-sm table-bordered mb-3">
        <thead class="table-primary">
          <tr>
            <th>Glider</th>
            <th>Instructor</th>
            <th>Release Altitude</th>
            <th>Duration</th>
          </tr>
        </thead>
        <tbody>
          {% for block in day.blocks %}
          {% if block.flights %}
          {% for flight in block.flights %}
          <tr id="flight-{{ flight.logsheet.log_date|date:'Y-m-d' }}">
            <td>{{ flight.glider.n_number }}</td>
            <td>{{ flight.instructor.full_display_name }}</td>
            <td>{{ flight.release_altitude|default:"?" }} ft</td>
            <td>{{ flight.duration|default:"?" }}</td>
          </tr>
          {% endfor %}
          {% endif %}
          {% endfor %}
        </tbody>
      </table>

      {# Lesson Scores Grid - show heading once per day #}
      {% for block in day.blocks %}
        {% if block.report.lesson_scores.all %}
          {% if forloop.first %}
            <h5>üìä Syllabus Items Covered</h5>
          {% endif %}
          <div class="mb-3">
            {% regroup block.report.lesson_scores.all by score as score_groups %}
            {% for score_group in score_groups %}
            <div class="mb-2">
              <strong>
                {% if score_group.grouper == '1' %}Introduced:
                {% elif score_group.grouper == '2' %}Practiced:
                {% elif score_group.grouper == '3' %}Solo Standard:
                {% elif score_group.grouper == '4' %}Checkride Standard:
                {% elif score_group.grouper == '!' %}Needs Attention:
                {% else %}{{ score_group.grouper }}:
                {% endif %}
              </strong>
              {% for lesson_score in score_group.list %}
                <a href="{% url 'public_syllabus_detail' lesson_score.lesson.code %}"
                   class="text-decoration-none me-1"
                   data-bs-toggle="tooltip"
                   data-bs-placement="top"
                   title="{{ lesson_score.lesson.title }}">{{ lesson_score.lesson.code }}</a>{% if not forloop.last %},{% endif %}
              {% endfor %}
            </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endfor %}

      {# Essays for all blocks that have them #}
      {% for block in day.blocks %}
      {% if block.report.report_text %}
      <div class="d-flex justify-content-between align-items-center">
        <h5>üìù Instructor Essay</h5>
        {# Edit button - only show if current user is the instructor and report is within 7 days #}
        {% if request.user == block.report.instructor and block.days_ago <= 7 %}
          <a href="{% url 'instructors:fill_instruction_report' member.id block.report.report_date|date:'Y-m-d' %}"
             class="btn btn-sm btn-outline-primary ms-2"
             title="Edit this report (available for 7 days after creation)">
            <i class="fas fa-edit"></i> Edit
          </a>
        {% endif %}
      </div>
      <div class="border p-3 bg-white card-body mb-2" id="report-{{ block.report.report_date|date:'Y-m-d' }}">
        {{ block.report.report_text|safe }}
        <div class="mt-2 small text-muted">
          Written by:
          {% if block.report.instructor.profile_photo %}
            <img src="{{ block.report.instructor.profile_photo.url }}" alt="{{ block.report.instructor.full_display_name }}" class="rounded-circle me-1" style="height:2.4em; width:2.4em; object-fit:cover; vertical-align:middle; border:1px solid #ccc;" />
          {% endif %}
          {{ block.report.instructor.full_display_name }} on {{ block.report.created_at|date:"Y-m-d H:i" }}
          {# Show edit indicator if report was modified #}
          {% if block.report.updated_at > block.report.created_at %}
            <em class="text-info">(edited {{ block.report.updated_at|date:"Y-m-d H:i" }})</em>
          {% endif %}
        </div>
      </div>
      {% elif block.report.notes %}
      <h5>üìù Notes</h5>
      <div class="border p-3 bg-white card-body mb-2" id="report-{{ block.report.report_date|date:'Y-m-d' }}">
        {{ block.report.notes|safe }}
        <div class="mt-2 small text-muted">
          Written by: {{ block.report.instructor.full_display_name }} on {{ block.report.created_at|date:"Y-m-d H:i" }}
        </div>
      </div>
      {% endif %}
      {% endfor %}
    </div>
  </div>
  {% endfor %}


  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('.lesson-code-tooltip'));
      tooltipTriggerList.forEach(function (tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl);
      });
    });
  </script>

  <!-- Back to Top Button -->
  <button class="back-to-top" onclick="document.getElementById('top').scrollIntoView({behavior: 'smooth'})"
    title="Back to Top">
    ‚Üë
  </button>

  {% endblock %}

{% load static %}

{% load siteconfig_tags %}
{% load member_extras %}

<!DOCTYPE html>
<html lang="en">

<head>
  <link href="{% static 'css/logbook.css' %}" rel="stylesheet">
  {% comment %}Favicon: use generated one from media if club logo exists, otherwise use static default{% endcomment %}
  {% get_siteconfig as siteconfig %}
  {% if siteconfig.club_logo %}
    <link rel="icon" type="image/x-icon" href="{{ MEDIA_URL }}favicon.ico?v={{ siteconfig.club_logo.name|slice:'-12:' }}">
  {% else %}
    <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">
  {% endif %}

  <!-- PWA Support -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#212529">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="{{ siteconfig.club_name|default:'Manage2Soar' }}">
  <link rel="apple-touch-icon" href="{% static 'images/pwa-icon-192.png' %}">

  {% block head_extra %}{% endblock %}

  <meta charset="UTF-8">
  <title>
    {% block title %}{% endblock %}{% if block.title %} - {% endif %} {{ siteconfig.club_name|default:'Manage2Soar' }}
  </title>
      <!-- Font Awesome for icons -->
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Flatpickr CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <!-- Bootstrap 5 CSS from CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <!-- Custom localized CSS -->
  <link href="{% static 'css/baseline.css' %}" rel="stylesheet">
  <link href="{% static 'css/progress.css' %}" rel="stylesheet">
  <link href="{% static 'css/members.css' %}" rel="stylesheet">
  <link href="{% static 'analytics/analytics.css' %}" rel="stylesheet">
  <link href="{% static 'css/cms-responsive.css' %}" rel="stylesheet">
  <link href="{% static 'css/cms.css' %}" rel="stylesheet">
  <link href="{% static 'css/mobile-fixes.css' %}" rel="stylesheet">
  <link href="{% static 'css/navbar-enhanced.css' %}" rel="stylesheet">

  {% block extra_css %}{% endblock %}

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const csrfToken = '{{ csrf_token }}';
      function csrfSafeMethod(method) {
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
      }
    });
  </script>
</head>
  <style>
    @media print {
      .no-print-nav, .navbar-spacer { display: none !important; }
    }
  </style>

<body>

  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top no-print-nav" id="main-navbar">
    <div class="container-fluid">
      {% get_siteconfig as siteconfig %}
  <a class="navbar-brand" href="{% url 'home' %}">
        {% if siteconfig and siteconfig.club_logo %}
          <img src="{{ siteconfig.club_logo.url }}" alt="{{ siteconfig.club_name }} Logo" height="30" class="d-inline-block align-text-top me-2">
        {% else %}
          <img src="{% static 'images/Manage2Soar-square-Logo-black.png' %}" alt="Manage2Soar Logo" height="30" class="d-inline-block align-text-top me-2">
        {% endif %}
        {{ siteconfig.club_name|default:'Manage2Soar' }}
      </a>

      <!-- Hamburger toggle button - triggers off-canvas on mobile -->
      <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#navbarOffcanvas"
        aria-controls="navbarOffcanvas" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <!-- Off-canvas sidebar for mobile, regular navbar for desktop -->
      <div class="offcanvas offcanvas-start navbar-offcanvas" tabindex="-1" id="navbarOffcanvas" aria-labelledby="navbarOffcanvasLabel">
        <div class="offcanvas-header bg-dark">
          <span class="offcanvas-title text-white" id="navbarOffcanvasLabel">
            {% if siteconfig and siteconfig.club_logo %}
              <img src="{{ siteconfig.club_logo.url }}" alt="{{ siteconfig.club_name }} Logo" height="24" class="me-2">
            {% endif %}
            {{ siteconfig.club_name|default:'Menu' }}
          </span>
          {# tabindex="-1" is Bootstrap default for offcanvas. Focus management (to offcanvas when opened, ESC to close, focus return to toggle) is handled by Bootstrap. Manual keyboard testing recommended after CSS changes. #}
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="membersDropdown" role="button" data-bs-toggle="dropdown"
              aria-expanded="false">
              Members
            </a>
            <ul class="dropdown-menu" aria-labelledby="membersDropdown">
              <li><a class="dropdown-item" href="{% url 'members:member_list' %}"><i class="fas fa-list me-1"></i> Member List</a></li>
              {% if user.is_authenticated %}
                {% if user.member_manager or user.webmaster or user.is_superuser %}
              <li><a class="dropdown-item" href="{% url 'members:membership_applications_list' %}"><i class="fas fa-user-plus"></i> Membership Applications</a></li>
                {% endif %}
              {% endif %}
              <li><a class="dropdown-item" href="{% url 'members:badge_board' %}">ğŸ¥‡ Badge Board</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="{% url 'cms:resources' %}">ğŸ“š Documents</a></li>
              <li><a class="dropdown-item" href="{% url 'public_syllabus_overview' %}"><i class="fas fa-book me-1"></i> Syllabus</a></li>
              {% webcam_enabled as webcam_feature_on %}
              {% if user.is_authenticated and webcam_feature_on %}
              <li><a class="dropdown-item" href="{% url 'siteconfig:webcam' %}">ğŸ“· Webcam</a></li>
              {% endif %}
            </ul>
          </li>

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="dutyrosterDropdown" role="button" data-bs-toggle="dropdown"
              aria-expanded="false">
              Duty Roster
            </a>
            <ul class="dropdown-menu" aria-labelledby="dutyrosterDropdown">
              <li class="nav-item">
                <a class="dropdown-item" href="{% url 'duty_roster:duty_calendar' %}"><i class="fas fa-calendar-alt me-1"></i> Calendar</a>
              </li>
              <li class="nav-item">
                <a class="dropdown-item" href="{% url 'duty_roster:duty_calendar' %}?view=agenda"><i class="fas fa-list me-1"></i> Roster Agenda</a>
              </li>
              {% if user.is_authenticated %}
              <li class="nav-item">
                <a class="dropdown-item" href="{% url 'duty_roster:my_swap_requests' %}"><i class="fas fa-exchange-alt me-1"></i> My Swap Requests</a>
              </li>
              <li class="nav-item">
                <a class="dropdown-item" href="{% url 'duty_roster:open_swap_requests' %}"><i class="fas fa-hands-helping me-1"></i> Help Others</a>
              </li>
              <li class="nav-item">
                <a class="dropdown-item" href="{% url 'duty_roster:reservation_list' %}"><i class="fas fa-plane me-1"></i> Glider Reservations</a>
              </li>
              {% endif %}
              {% if user.is_authenticated %}
                {% if user.rostermeister or user.member_manager or user.director or user.is_superuser %}
              <li><hr class="dropdown-divider"></li>
              <li class="nav-item">
                <a class="dropdown-item" href="{% url 'duty_roster:blackout_manage' %}">ğŸš« Blackout Dates</a>
              </li>
              <li class="nav-item">
                <a class="dropdown-item" href="{% url 'duty_roster:duty_delinquents_detail' %}">
                  <i class="fas fa-exclamation-triangle text-warning"></i> Duty Delinquents Report
                </a>
              </li>
                {% endif %}
              {% endif %}
            </ul>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="logsheetDropdown" role="button" data-bs-toggle="dropdown"
              aria-expanded="false">
              Log Sheets
            </a>
            <ul class="dropdown-menu" aria-labelledby="logsheetDropdown">
              <li><a class="dropdown-item" href="{% url 'logsheet:index' %}"><i class="bi bi-journal-text me-1"></i> Manage Log Sheets</a></li>
              {% if user.is_authenticated %}
              <li><a class="dropdown-item" href="{% url 'analytics:dashboard' %}">ğŸ“ˆ Analytics</a></li>
              {% endif %}
            </ul>
          </li>

          <!-- Resources (CMS) - moved into Members dropdown -->

          {% if user.is_authenticated and user.instructor %}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="instructorDropdown" role="button" data-bs-toggle="dropdown"
              aria-expanded="false">
              Instructor Tools
              {% if instructor_pending_count %}
                <span class="badge bg-warning text-dark" aria-label="{{ instructor_pending_count }} pending student requests">{{ instructor_pending_count }}</span>
              {% endif %}
            </a>
            <ul class="dropdown-menu" aria-labelledby="instructorDropdown">
              <li class="nav-item">
                <a class="dropdown-item" href="{% url 'duty_roster:instructor_requests' %}">
                  <i class="fas fa-chalkboard-teacher me-1"></i>Student Requests
                  {% if instructor_pending_count %}
                    <span class="badge bg-warning text-dark ms-1" aria-label="{{ instructor_pending_count }} pending student requests">{{ instructor_pending_count }}</span>
                  {% endif %}
                </a>
              </li>
              <li><hr class="dropdown-divider"></li>
              <li class="nav-item">
                <a class="dropdown-item" href="{% url 'instructors:instructors-dashboard' %}">ğŸ  Instructor Home</a>
              </li>
              <li class="nav-item">
                <a class="dropdown-item" href="{% url 'instructors:syllabus_overview' %}">ğŸ“š Syllabus Overview</a>
              </li>
              <li class="nav-item">
                <a class="dropdown-item" href="{% url 'instructors:create-written-test' %}">ğŸ“‹ Create Written Test</a>
              </li>
              <li class="nav-item">
                <a class="dropdown-item" href="{% url 'knowledgetest:instructor-recent-tests' %}">ğŸ“Š Recent Written Tests</a>
              </li>
              <li class="nav-item">
                <!--<a class="dropdown-item" href="{% url 'admin:knowledgetest_question_changelist' %}">ğŸ“‹ Update Test Bank</a>-->
              </li>

            </ul>
          </li>
          {% endif %}

          {% if user.is_authenticated %}
            {% if user.safety_officer or user.is_superuser %}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="safetyDropdown" role="button" data-bs-toggle="dropdown"
              aria-expanded="false">
              <i class="bi bi-shield-exclamation"></i> Safety
            </a>
            <ul class="dropdown-menu" aria-labelledby="safetyDropdown">
              <li class="nav-item">
                <a class="dropdown-item" href="{% url 'members:safety_officer_dashboard' %}">
                  <i class="bi bi-speedometer2"></i> Safety Dashboard
                </a>
              </li>
              <li class="nav-item">
                <a class="dropdown-item" href="{% url 'members:safety_report_list' %}">
                  <i class="bi bi-list-ul"></i> Suggestion Box Reports
                </a>
              </li>
            </ul>
          </li>
            {% endif %}
          {% endif %}

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="equipmentDropdown" role="button" data-bs-toggle="dropdown"
              aria-expanded="false">
              Equipment
            </a>
            <ul class="dropdown-menu" aria-labelledby="equipmentDropdown">
              <li class="nav-item">
                <a class="dropdown-item" href="{% url 'logsheet:equipment_list' %}">ğŸ›©ï¸ Gliders & Towplanes</a>
              </li>
              <li class="nav-item">
                <a class="dropdown-item" href="{% url 'logsheet:maintenance_issues' %}">ğŸ”§ Maintenance Issues</a>
              </li>
              <li class="nav-item">
                <a class="dropdown-item" href="{% url 'logsheet:maintenance_deadlines' %}">â° Maintenance Deadlines</a>
              </li>

            </ul>
          </li>

        </ul>

        <!-- Right side: User dropdown + Logout -->
        {% if user.is_authenticated %}
        {% is_kiosk_session as kiosk_mode %}
        <ul class="navbar-nav mb-2 mb-lg-0 d-flex flex-row align-items-center">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button"
               data-bs-toggle="dropdown" aria-expanded="false">
              <img src="{{ user.profile_image_url_small }}" class="nav-avatar me-2" alt="Profile Photo">
              Welcome, {{ user.full_display_name }}
              {% if kiosk_mode %}<small class="text-warning ms-1">(Kiosk)</small>{% endif %}
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
              <li><a class="dropdown-item" href="{% url 'members:member_view' member_id=user.pk %}">
                <i class="fas fa-user me-1"></i> View my Profile
              </a></li>
              <li><a class="dropdown-item" href="{% url 'members:biography_view' member_id=user.pk %}">
                <i class="fas fa-pen me-1"></i> Edit my Biography
              </a></li>
              <li><a class="dropdown-item" href="{% url 'instructors:member_training_grid' member_id=user.pk %}">
                <i class="fas fa-th me-1"></i> View my Training Grid
              </a></li>
              <li><a class="dropdown-item" href="{% url 'instructors:member_instruction_record' member_id=user.pk %}">
                <i class="fas fa-clipboard-list me-1"></i> View my Instruction Record
              </a></li>
              <li><a class="dropdown-item" href="{% url 'public_syllabus_overview' %}">
                <i class="fas fa-book me-1"></i> View Training Syllabus
              </a></li>
              <li><a class="dropdown-item" href="{% url 'instructors:member_logbook' %}">ğŸ—’ï¸ My Logbook</a></li>
              {% if user.glider_rating != "private" and user.glider_rating != "commercial" %}
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="{% url 'instructors:needed_for_solo' member_id=user.pk %}">
                <i class="fas fa-plane-departure me-1"></i> What's needed to solo?
              </a></li>
              <li><a class="dropdown-item" href="{% url 'instructors:needed_for_checkride' member_id=user.pk %}">
                <i class="fas fa-check-circle me-1"></i> What's needed for checkride?
              </a></li>
              {% endif %}
            </ul>
          </li>
          {% if user.is_staff or user.webmaster or user.rostermeister or user.member_manager or user.instructor %}
          <li class="nav-item">
            <a href="/admin/" class="nav-link" title="Admin interface" data-bs-toggle="tooltip" data-bs-placement="bottom">
              <span style="font-size:1.5em; vertical-align:middle; cursor:pointer;">ğŸ› ï¸</span>
            </a>
          </li>
          {% endif %}
        </ul>
        {% if not kiosk_mode %}
        <form action="{% url 'logout' %}" method="post" class="d-flex ms-2">
          {% csrf_token %}
          <button class="btn btn-outline-light btn-sm" type="submit">Logout</button>
        </form>
        {% endif %}
        {% else %}
        <a class="btn btn-outline-light btn-sm" href="{% url 'login' %}">Login</a>
        {% endif %}

        </div><!-- /.offcanvas-body -->
      </div><!-- /.offcanvas -->
    </div><!-- /.container-fluid -->
  </nav>

  <!-- Spacer to prevent content from hiding behind fixed navbar -->
  <div class="navbar-spacer"></div>

  <div class="container">
    {% if user.is_authenticated %}
      {% include "notifications/notifications_dropdown.html" %}
    {% endif %}
    {% block content %}
    <!-- page-specific content here -->
    {% endblock %}
  </div>

  <!-- Site Footer -->
  {% include "footer.html" %}

  <!-- Offline Indicator Banner -->
  <div id="offline-indicator" class="d-none align-items-center justify-content-center bg-warning text-dark py-2 position-fixed bottom-0 start-0 end-0" style="z-index: 9999;">
    <i class="bi bi-wifi-off me-2"></i>
    <span>You're offline. Some features may be unavailable.</span>
  </div>

  <!-- Optional Bootstrap JS for interactivity (dropdowns, etc.) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- HTMX include -->
  <script src="https://unpkg.com/htmx.org@1.9.5"></script>
  <!-- Tablesort: use vendored local file for deterministic loading -->
  <script src="{% static 'vendor/tablesort.min.js' %}"></script>
  <script src="{% static 'js/tablesort-init.js' %}"></script>
  <!-- PWA Service Worker Registration -->
  <script src="{% static 'js/service-worker-register.js' %}"></script>
  <script src="{% static 'js/navbar-enhanced.js' %}"></script>
  <script src="{% static 'js/banner-brightness-detection.js' %}"></script>
  <script>
    document.body.addEventListener('htmx:configRequest', (event) => {
      const token = document.cookie
        .split('; ')
        .find(row => row.startsWith('csrftoken='))
        ?.split('=')[1];
      if (token) {
        event.detail.headers['X-CSRFToken'] = token;
      }
    });
  </script>

  {% block extra_scripts %}{% endblock %}

</body>

</html>
